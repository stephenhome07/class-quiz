<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Circuit Builder V2</title>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #2c3e50;
        color: white;
        text-align: center;
        padding: 10px;
        margin: 0;
        overflow-x: hidden;
    }
    .container {
        max-width: 600px;
        margin: 0 auto;
        background: #34495e;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    h2 { color: #f1c40f; margin: 0 0 10px 0; }
    
    .mission-box {
        background: #e67e22; color: white; padding: 10px; border-radius: 10px;
        margin-bottom: 20px; font-weight: bold; animation: popIn 0.5s; border: 2px solid #d35400;
    }

    /* --- é›»è·¯ç•«å¸ƒå€åŸŸ --- */
    .circuit-board {
        background: #ecf0f1; 
        border-radius: 15px; 
        height: 250px;
        position: relative; 
        margin-bottom: 20px;
        border: 4px solid #bdc3c7;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    /* é›»è·¯è¿´è·¯å®¹å™¨ (æœƒéš¨é•·åº¦è®Šå¯¬) */
    .circuit-loop {
        position: relative;
        width: 200px; /* åˆå§‹å¯¬åº¦ (Short) */
        height: 160px;
        transition: width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* æ¨™æº–å°ç·š (é»‘ç·š) */
    .wire-std {
        position: absolute;
        background: #333;
        z-index: 1;
    }
    /* å·¦é‚Šè±ç·š */
    .wire-left { width: 4px; height: 100%; left: 0; top: 0; }
    /* å³é‚Šè±ç·š */
    .wire-right { width: 4px; height: 100%; right: 0; top: 0; }
    /* åº•éƒ¨æ©«ç·š */
    .wire-bottom { width: 100%; height: 4px; bottom: 0; left: 0; }
    /* é ‚éƒ¨å·¦å°æ®µ (é€£æ¥æ¸¬è©¦ç·š) */
    .wire-top-l { width: 10px; height: 4px; top: 0; left: 0; }
    /* é ‚éƒ¨å³å°æ®µ */
    .wire-top-r { width: 10px; height: 4px; top: 0; right: 0; }

    /* --- æ¸¬è©¦å°ç·š (User Wire) --- */
    .test-wire {
        position: absolute;
        top: 0; left: 10px; right: 10px; /* æ’æ»¿ä¸­é–“ */
        height: 20px; /* åˆå§‹ (Thick) */
        background: #95a5a6;
        border: 2px solid #7f8c8d;
        transform: translateY(-50%); /* å±…ä¸­å°é½Šç·šè·¯ */
        transition: height 0.3s ease, background-color 0.3s;
        z-index: 2;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        overflow: hidden;
    }
    
    /* å…ƒä»¶ */
    .battery {
        position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%);
        font-size: 30px; background: #ecf0f1; padding: 0 5px; z-index: 5;
    }
    .bulb-container {
        position: absolute; top: 50%; right: -25px; transform: translateY(-50%);
        z-index: 5; text-align: center;
    }
    .bulb {
        font-size: 50px; color: #444;
        transition: color 0.3s, text-shadow 0.3s;
        filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
    }

    /* é›»å­å‹•ç•«é» */
    .electron-dot {
        position: absolute;
        width: 6px; height: 6px; 
        background: #f1c40f; 
        border-radius: 50%;
        opacity: 0;
        z-index: 10;
        box-shadow: 0 0 4px #f1c40f;
    }

    /* --- æ§åˆ¶é¢æ¿ --- */
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .control-group { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; }
    .control-label { font-size: 0.9rem; color: #bdc3c7; margin-bottom: 5px; display: block; }
    
    .btn-group { display: flex; gap: 5px; }
    .btn {
        flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer;
        font-weight: bold; font-size: 0.9rem; transition: 0.2s;
        background: #2c3e50; color: white; border: 2px solid #2c3e50;
    }
    .btn.active { background: #3498db; border-color: #3498db; }
    
    /* æ•¸å€¼é¡¯ç¤º */
    .stats {
        display: flex; justify-content: space-around; margin-top: 20px;
        background: #22313f; padding: 10px; border-radius: 10px;
    }
    .stat-val { font-size: 1.2rem; font-weight: bold; color: #f1c40f; }

    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

</style>
</head>
<body>

<div class="container">
    <h2>âš¡ Circuit Builder V2</h2>
    
    <div class="mission-box" id="mission-text">
        Mission 1: Make the bulb BRIGHTEST!<br>ä»»å‹™ 1ï¼šè®“ç‡ˆæ³¡è®Šå¾—æœ€äº®ï¼
    </div>

    <div class="circuit-board">
        <div class="circuit-loop" id="loop-container">
            <div class="wire-std wire-left"></div>
            <div class="wire-std wire-bottom"></div>
            <div class="wire-std wire-right"></div>
            <div class="wire-std wire-top-l"></div>
            <div class="wire-std wire-top-r"></div>

            <div class="test-wire" id="test-wire">
                <div style="width:100%; text-align:center; color:#555; font-size:10px; font-weight:bold;">TEST WIRE</div>
            </div>

            <div class="battery">ğŸ”‹</div>
            <div class="bulb-container">
                <div class="bulb" id="bulb-obj">ğŸ’¡</div>
            </div>
            
            <div id="electron-layer"></div>
        </div>
    </div>

    <div class="controls">
        <div class="control-group">
            <span class="control-label">Length (é•·åº¦)</span>
            <div class="btn-group">
                <button class="btn active" onclick="setProp('len', 'short', this)">Short (çŸ­)</button>
                <button class="btn" onclick="setProp('len', 'long', this)">Long (é•·)</button>
            </div>
        </div>

        <div class="control-group">
            <span class="control-label">Thickness (ç²—å¹¼)</span>
            <div class="btn-group">
                <button class="btn" onclick="setProp('thick', 'thin', this)">Thin (å¹¼)</button>
                <button class="btn active" onclick="setProp('thick', 'thick', this)">Thick (ç²—)</button>
            </div>
        </div>
    </div>

    <div class="stats">
        <div>Resistance: <span class="stat-val" id="res-val">Low</span></div>
        <div>Current: <span class="stat-val" id="curr-val">High</span></div>
    </div>

    <button onclick="checkMission()" style="width:100%; margin-top:20px; padding:15px; background:#27ae60; color:white; border:none; border-radius:10px; font-size:1.1rem; font-weight:bold; cursor:pointer;">Check Mission (æª¢æŸ¥ä»»å‹™)</button>
</div>

<script>
    // ç‹€æ…‹
    let currentLen = 'short';
    let currentThick = 'thick';
    let missionStage = 1;
    let electrons = [];
    let animationId;

    const loopContainer = document.getElementById('loop-container');
    const testWire = document.getElementById('test-wire');
    const bulb = document.getElementById('bulb-obj');
    const resVal = document.getElementById('res-val');
    const currVal = document.getElementById('curr-val');
    const missionText = document.getElementById('mission-text');
    const electronLayer = document.getElementById('electron-layer');

    function setProp(type, val, btn) {
        // åˆ‡æ›æŒ‰éˆ•
        const parent = btn.parentElement;
        Array.from(parent.children).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        if (type === 'len') currentLen = val;
        if (type === 'thick') currentThick = val;

        updateCircuit();
    }

    function updateCircuit() {
        // 1. è¦–è¦ºè®ŠåŒ– (å¹¾ä½•)
        // é•·åº¦è®ŠåŒ– -> æ”¹è®Šæ•´å€‹è¿´è·¯çš„å¯¬åº¦
        if (currentLen === 'short') {
            loopContainer.style.width = "200px";
        } else {
            loopContainer.style.width = "350px"; // æ‹‰é•·è¿´è·¯
        }

        // ç²—å¹¼è®ŠåŒ– -> æ”¹è®Š Test Wire çš„é«˜åº¦
        if (currentThick === 'thick') {
            testWire.style.height = "25px";
            testWire.style.background = "#bdc3c7"; // ç²—ç·šé¡è‰²æ·ºä¸€é»
        } else {
            testWire.style.height = "6px";
            testWire.style.background = "#7f8c8d"; // å¹¼ç·šé¡è‰²æ·±ä¸€é»
        }

        // 2. ç‰©ç†é‡è¨ˆç®—
        let rScore = 0;
        if (currentLen === 'long') rScore += 2;
        if (currentThick === 'thin') rScore += 2;

        let speed = 2; // åƒç´ /å¹€
        let density = 50; // ç”¢ç”Ÿé »ç‡
        let brightness = 1;

        if (rScore === 0) { // Short Thick (Best)
            resVal.innerText = "Very Low"; currVal.innerText = "Max";
            brightness = 1; speed = 3; density = 10; 
        } else if (rScore === 2) { // Mixed
            resVal.innerText = "Medium"; currVal.innerText = "Medium";
            brightness = 0.5; speed = 1.5; density = 30;
        } else { // Long Thin (Worst)
            resVal.innerText = "Very High"; currVal.innerText = "Tiny";
            brightness = 0.1; speed = 0.5; density = 60;
        }

        // 3. ç‡ˆæ³¡äº®åº¦
        if (brightness > 0.8) {
            bulb.style.color = "#f1c40f"; bulb.style.textShadow = "0 0 30px #f1c40f, 0 0 60px orange";
        } else if (brightness > 0.4) {
            bulb.style.color = "#f39c12"; bulb.style.textShadow = "0 0 10px #f39c12";
        } else {
            bulb.style.color = "#444"; bulb.style.textShadow = "none";
        }

        // é‡å•Ÿé›»å­å‹•ç•«
        startElectronFlow(speed, density);
    }

    // --- é›»å­æµå‹•å‹•ç•«ç³»çµ± ---
    function startElectronFlow(speed, spawnRate) {
        // æ¸…é™¤èˆŠé›»å­
        electronLayer.innerHTML = '';
        electrons = [];
        if (animationId) cancelAnimationFrame(animationId);

        let frameCount = 0;

        function loop() {
            frameCount++;
            const w = loopContainer.offsetWidth;
            const h = loopContainer.offsetHeight;

            // ç”¢ç”Ÿæ–°é›»å­
            if (frameCount % spawnRate === 0) {
                const el = document.createElement('div');
                el.className = 'electron-dot';
                // èµ·é»ï¼šé›»æ± æ­£æ¥µ (åº•éƒ¨ä¸­é–“)
                // ç‚ºäº†è¦–è¦ºæ•ˆæœï¼Œæˆ‘å€‘è¨­å®šç‚ºé †æ™‚é‡æµå‹• (çœŸå¯¦é›»æµæ˜¯æ­£->è² ï¼Œé›»å­æ˜¯è² ->æ­£ï¼Œé€™è£¡æ¨¡æ“¬é›»æµæ–¹å‘æ¯”è¼ƒç›´è§€)
                // é›»æµï¼šé›»æ± æ­£æ¥µ(å³ä¸‹) -> ç‡ˆæ³¡ -> ä¸Šæ–¹ -> å·¦æ–¹ -> é›»æ± è² æ¥µ
                // é€™è£¡æˆ‘å€‘ç”¨ã€Œé›»æµã€æ–¹å‘ (Conventional Current)
                
                // åº§æ¨™å®šç¾©: 0,0 æ˜¯å·¦ä¸Šè§’
                // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘å®šç¾©è·¯å¾‘ï¼šBottom-Left -> Top-Left -> Top-Right -> Bottom-Right -> Bottom-Left
                // é€™è£¡æ˜¯é›»æ± å‡ºç™¼ (Bottom-Center -> Left)
                
                el.dataset.pos = 0; // 0 to TotalPerimeter
                el.dataset.section = 1; // 1:Bot-Left, 2:Left-Up, 3:Top-Right, 4:Right-Down, 5:Bot-Center
                
                // åˆå§‹ä½ç½®ï¼šé›»æ± å·¦å´ (Bottom, 50%)
                el.style.left = (w/2) + 'px';
                el.style.top = (h - 2) + 'px'; // åº•éƒ¨ç·š
                
                electronLayer.appendChild(el);
                electrons.push({ dom: el, dist: 0 });
            }

            // ç§»å‹•é›»å­
            for (let i = 0; i < electrons.length; i++) {
                let e = electrons[i];
                e.dist += speed;
                
                // è¨ˆç®—åº§æ¨™ (é€†æ™‚é‡ï¼šé›»æ± ->å·¦->ä¸Š->å³->é›»æ± )
                // 1. Bottom (Center to Left)
                // 2. Left (Bottom to Top)
                // 3. Top (Left to Right)
                // 4. Right (Top to Bottom)
                // 5. Bottom (Right to Center)
                
                let x, y;
                const halfW = w / 2;
                
                if (e.dist < halfW) { // åº•éƒ¨å‘å·¦
                    x = halfW - e.dist;
                    y = h - 2;
                } else if (e.dist < halfW + h) { // å·¦å´å‘ä¸Š
                    x = 0;
                    y = (h - 2) - (e.dist - halfW);
                } else if (e.dist < halfW + h + w) { // é ‚éƒ¨å‘å³ (ç¶“éæ¸¬è©¦ç·š!)
                    x = (e.dist - (halfW + h));
                    y = 0;
                } else if (e.dist < halfW + h + w + h) { // å³å´å‘ä¸‹ (ç¶“éç‡ˆæ³¡)
                    x = w - 4; // ç·šå¯¬ä¿®æ­£
                    y = (e.dist - (halfW + h + w));
                } else if (e.dist < halfW + h + w + h + halfW) { // åº•éƒ¨å‘å·¦ (å›é›»æ± )
                    x = w - (e.dist - (halfW + h + w + h));
                    y = h - 2;
                } else {
                    // è·‘å®Œä¸€åœˆ
                    e.dom.remove();
                    electrons.splice(i, 1);
                    i--;
                    continue;
                }
                
                e.dom.style.left = x + 'px';
                e.dom.style.top = y + 'px';
            }

            animationId = requestAnimationFrame(loop);
        }
        loop();
    }

    function checkMission() {
        let success = false;
        let msg = "";

        if (missionStage === 1) {
            if (currentLen === 'short' && currentThick === 'thick') {
                success = true;
                msg = "Correct! Short & Thick = Low Resistance = Bright Bulb!<br>ç­”å°äº†ï¼çŸ­è€Œç²— = é›»é˜»å° = ç‡ˆæ³¡æœ€äº®ï¼";
            } else {
                msg = "Not quite! Look at the current flow.<br>It's too slow! Make the path easier (Short & Thick).";
            }
        } else if (missionStage === 2) {
            if (currentLen === 'long' && currentThick === 'thin') {
                success = true;
                msg = "Correct! Long & Thin = High Resistance = Dim Bulb.<br>ç­”å°äº†ï¼é•·è€Œå¹¼ = é›»é˜»å¤§ = ç‡ˆæ³¡æœ€æš—ã€‚";
            } else {
                msg = "Not quite! We need to make it harder for current to flow.<br>Make the path longer and narrower.";
            }
        }

        if (success) {
            alert("ğŸ‰ " + msg.replace(/<br>/g, "\n"));
            if (missionStage === 1) {
                missionStage = 2;
                missionText.innerHTML = "Mission 2: Make the bulb DIMMEST!<br>ä»»å‹™ 2ï¼šè®“ç‡ˆæ³¡è®Šå¾—æœ€æš—ï¼";
                missionText.style.background = "#34495e";
                missionText.style.border = "2px solid #2c3e50";
            } else {
                missionText.innerHTML = "ğŸ† Circuit Master!<br>ä½ æ˜¯é›»è·¯å¤§å¸«ï¼";
                missionText.style.background = "#27ae60";
                missionText.style.border = "none";
            }
        } else {
            alert("âŒ " + msg.replace(/<br>/g, "\n"));
        }
    }

    // Init
    updateCircuit();

</script>
</body>
</html>
