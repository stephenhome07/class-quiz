<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>綜合科學科 - 試卷電子化工具 (AI Digitizer v39)</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CSV Parser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Document Parsers -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f2f5; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); transition: all 0.3s ease; }
        .card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #10b981; color: white; }
        .btn-secondary:hover { background-color: #059669; }
        .btn-outline { background-color: white; border: 1px solid #d1d5db; color: #374151; }
        .btn-outline:hover { background-color: #f3f4f6; }
        
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="min-h-screen text-gray-800">

    <!-- Top Navigation -->
    <nav class="bg-white shadow sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-robot text-indigo-600 text-3xl mr-3"></i>
                    <div>
                        <h1 class="font-bold text-xl text-gray-900 tracking-tight">試卷電子化工具 (AI Digitizer)</h1>
                        <p class="text-xs text-gray-500 font-medium">Standalone Version 39</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <span class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full border border-green-200">
                        <i class="fas fa-wifi mr-1"></i> K12GPT 已連線
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="max-w-5xl mx-auto px-4 py-8 space-y-8">

        <!-- Info Banner -->
        <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded shadow-sm flex items-start">
            <i class="fas fa-info-circle text-indigo-500 mt-1 mr-3"></i>
            <div>
                <p class="text-sm text-indigo-800 font-bold">使用說明</p>
                <p class="text-xs text-indigo-700">此工具專用於產生 CSV 數據。請先使用 <b>功能一</b> 生成試卷結構 (MAP)，再使用 <b>功能二</b> 批改學生答卷。生成的 CSV 可匯入 Excel 或舊有的分析系統。</p>
            </div>
        </div>

        <!-- ========================================================================================== -->
        <!-- Feature 1: MAP Generator -->
        <!-- ========================================================================================== -->
        <div class="card p-6 border-t-4 border-blue-500 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                <i class="fas fa-map-marked-alt text-9xl text-blue-500"></i>
            </div>
            
            <div class="flex items-center justify-between mb-6 relative z-10">
                <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-map mr-2 text-blue-600"></i>1. 試卷結構 (MAP) 生成</h2>
                <span class="text-xs font-bold bg-blue-100 text-blue-700 px-3 py-1 rounded-full">老師專用</span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10">
                <div class="space-y-4">
                    <!-- Step 1 -->
                    <div class="p-3 bg-gray-50 rounded border border-gray-200">
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Step 1: 課程大綱 (Syllabus) <span class="font-normal text-gray-400">(選填)</span></label>
                        <input type="file" id="syllabus-file-upload" accept=".docx,.txt" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300"/>
                        <p class="text-[10px] text-gray-400 mt-1">AI 將參考大綱的 Topic ID (如 7.1) 進行分類。</p>
                    </div>

                    <!-- Step 2 -->
                    <div class="p-3 bg-gray-50 rounded border border-gray-200">
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Step 2: 空白試卷 (Exam Paper) <span class="text-red-500">*</span></label>
                        <input type="file" id="map-file-upload" accept=".docx,.txt,.pdf" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200"/>
                        <p class="text-[10px] text-gray-400 mt-1">支援 Word (.docx) 或 PDF。</p>
                    </div>
                    
                    <textarea id="map-prompt-extra" rows="2" class="w-full border rounded p-3 text-xs focus:ring-2 focus:ring-blue-500 focus:outline-none transition-shadow" placeholder="額外提示 (例如: 這是中三級綜合科學科, 包含物理/化學/生物)"></textarea>

                    <!-- Editable Prompt -->
                    <details class="bg-white border rounded shadow-sm">
                        <summary class="p-2 text-xs font-semibold cursor-pointer hover:bg-gray-50 text-gray-600 flex justify-between select-none items-center">
                            <span><i class="fas fa-code mr-2 text-blue-400"></i> 進階：修改 AI 指令 (System Prompt)</span>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </summary>
                        <div class="p-2 border-t bg-gray-50">
                            <textarea id="prompt-system-map" rows="6" class="w-full text-[10px] font-mono border rounded p-2 text-gray-600 focus:outline-none focus:border-blue-400"></textarea>
                            <div class="text-right mt-1"><button onclick="resetPrompt('map')" class="text-xs text-blue-600 hover:underline">恢復預設</button></div>
                        </div>
                    </details>
                </div>

                <div class="flex flex-col h-full">
                    <button onclick="generateMAP()" id="btn-gen-map" class="w-full btn-primary py-3 rounded-lg font-bold shadow-md flex justify-center items-center hover:shadow-lg transition-all mb-4">
                        <span><i class="fas fa-magic mr-2"></i>生成 MAP CSV</span>
                    </button>

                    <div class="relative flex-grow">
                        <textarea id="map-output" class="w-full h-full min-h-[250px] bg-gray-800 text-green-400 border border-gray-700 rounded-lg p-3 text-xs font-mono shadow-inner resize-none" placeholder="等待生成...&#10;Question_ID,Full_Mark,Topic_ID..."></textarea>
                        <button onclick="copyToClipboard('map-output')" class="absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 text-white text-xs px-2 py-1 rounded transition-colors border border-gray-600"><i class="fas fa-copy"></i> 複製</button>
                    </div>

                    <!-- NEW FEATURE: Marksheet Generator -->
                    <div class="mt-4 pt-4 border-t border-blue-100">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-blue-800"><i class="fas fa-table mr-1"></i>入分表首欄生成 (Marksheet Header)</label>
                        </div>
                        <button onclick="generateMarksheet()" class="w-full btn-outline py-2 rounded text-xs font-bold text-gray-600 mb-2 shadow-sm hover:bg-blue-50 transition-colors">
                            從上方 MAP 生成 Marksheet Template
                        </button>
                        <div class="relative">
                            <textarea id="marksheet-output" rows="2" class="w-full bg-blue-50 border border-blue-200 rounded p-2 text-xs font-mono text-gray-700" placeholder="Class,ClassNumber,Name,1a,1b..." readonly></textarea>
                            <button onclick="copyToClipboard('marksheet-output')" class="absolute top-2 right-2 bg-white border shadow-sm text-gray-600 hover:text-blue-600 text-xs px-2 py-1 rounded"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================================================================== -->
        <!-- Feature 2: Script Analysis -->
        <!-- ========================================================================================== -->
        <div class="card p-6 border-t-4 border-emerald-500 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                <i class="fas fa-user-graduate text-9xl text-emerald-500"></i>
            </div>

            <div class="flex items-center justify-between mb-6 relative z-10">
                <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-pen-fancy mr-2 text-emerald-600"></i>2. 學生答卷識別</h2>
                <span class="text-xs font-bold bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full">批改輔助</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10">
                <div class="space-y-4">
                    <!-- Step 1 -->
                    <div class="p-3 bg-gray-50 rounded border border-gray-200">
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Step 1: 匯入 MAP 資料 <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <textarea id="script-map-context" rows="4" class="w-full border rounded p-2 text-xs font-mono focus:ring-2 focus:ring-emerald-500 focus:outline-none transition-shadow" placeholder="請在此貼上上方生成的 MAP CSV..."></textarea>
                            <label class="absolute bottom-2 right-2 cursor-pointer bg-white border shadow-sm px-2 py-1 rounded text-[10px] font-bold text-gray-600 hover:bg-emerald-50 transition-colors">
                                <i class="fas fa-upload mr-1"></i> 載入 CSV 檔
                                <input type="file" id="map-csv-upload" accept=".csv,.txt" class="hidden" onchange="handleMapCsvUpload(this)"/>
                            </label>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div class="p-3 bg-gray-50 rounded border border-gray-200">
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-2">Step 2: 上傳學生答卷 <span class="text-red-500">*</span></label>
                        <input type="file" id="script-file-upload" accept=".docx,.txt,.pdf,.jpg,.jpeg,.png" multiple class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-emerald-100 file:text-emerald-700 hover:file:bg-emerald-200 transition-colors"/>
                        <p class="text-[10px] text-gray-500 mt-2"><i class="fas fa-check-circle text-emerald-500"></i> 支援 Word / PDF / 多張圖片 (JPG/PNG)。</p>
                    </div>

                     <!-- Editable Prompt -->
                     <details class="bg-white border rounded shadow-sm">
                        <summary class="p-2 text-xs font-semibold cursor-pointer hover:bg-gray-50 text-gray-600 flex justify-between select-none items-center">
                            <span><i class="fas fa-code mr-2 text-emerald-400"></i> 進階：修改 AI 指令 (System Prompt)</span>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </summary>
                        <div class="p-2 border-t bg-gray-50">
                            <textarea id="prompt-system-script" rows="6" class="w-full text-[10px] font-mono border rounded p-2 text-gray-600 focus:outline-none focus:border-emerald-400"></textarea>
                            <div class="text-right mt-1"><button onclick="resetPrompt('script')" class="text-xs text-emerald-600 hover:underline">恢復預設</button></div>
                        </div>
                    </details>
                </div>

                <div class="flex flex-col h-full">
                    <button onclick="analyzeScript()" id="btn-analyze-script" class="w-full btn-secondary py-3 rounded-lg font-bold shadow-md flex justify-center items-center hover:shadow-lg transition-all mb-4">
                        <span><i class="fas fa-file-export mr-2"></i>分析並生成 CSV</span>
                    </button>

                    <div class="flex-grow space-y-2">
                        <div class="relative h-1/2">
                            <label class="text-[10px] font-bold text-gray-500 uppercase block mb-1">區塊 A: 選擇題 (MC)</label>
                            <textarea id="script-out-mc" class="w-full h-24 bg-gray-50 border border-gray-300 rounded p-2 text-xs font-mono resize-none focus:ring-1 focus:ring-emerald-500" readonly></textarea>
                            <button onclick="copyToClipboard('script-out-mc')" class="absolute top-6 right-2 bg-white border hover:bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded transition-colors"><i class="fas fa-copy"></i></button>
                        </div>
                        <div class="relative h-1/2">
                            <label class="text-[10px] font-bold text-gray-500 uppercase block mb-1">區塊 B: 文字題 (Answers)</label>
                            <textarea id="script-out-ans" class="w-full h-24 bg-gray-50 border border-gray-300 rounded p-2 text-xs font-mono resize-none focus:ring-1 focus:ring-emerald-500" readonly></textarea>
                            <button onclick="copyToClipboard('script-out-ans')" class="absolute top-6 right-2 bg-white border hover:bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded transition-colors"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ==========================================
        // CONFIGURATION & CONSTANTS
        // ==========================================
        const PROXY_URL = 'https://apiproxy.k12gpt.ai/NPcj-7_';
        
        const DEFAULT_PROMPT_MAP = `你是一個專業的考試數據分析師。你的任務是讀取「試卷內容」並根據「課程大綱」生成一個標準化的 CSV 表格 (MAP)。

### 嚴格完整性要求
1. **必須讀取到文件的最後一行**：請確保分析所有頁面、所有題目，直到試卷結束。
2. **不可遺漏子題目**：務必列出所有子題目，例如 4di, 4dii, 5a, 5b 等，這非常重要。
3. **不可中途停止**：即使題目很多，也必須完整列出。

### 輸出規則
只輸出 CSV 內容，不要有 markdown 標記、不要有 csv 開頭或結尾，也不要有任何額外文字。

### CSV 欄位結構
Question_ID,Full_Mark,Topic_ID,Topic_Name,Difficulty,Concept_Detail

### 欄位填寫規則 (必須嚴格遵守)
1. **Question_ID (題號格式)**:
   - **選擇題 (Multiple Choice)**: 必須命名為 MC1, MC2, MC3...
   - **填充題 (Fill in the blanks)**: 必須命名為 FILL1, FILL2, FILL3...
   - **是非題 (True/False)**: 必須命名為 TF1, TF2...
   - **配對題 (Matching)**: 必須命名為 MATCH1, MATCH2...
   - **短答/長答/結構題 (重要修正)**: 
     - **忽略試卷分區的中文數字**：如果試卷出現「(五) 問答題」或「五、問答題」，請忽略那個「五」。
     - **必須以題目本身的阿拉伯數字開始**：如果「(五) 問答題」下方第一題寫著「1. xxx」，該題 Question_ID 應為 1 (或 1a)，**絕對不是 5a**。
     - 請仔細區分大標題 (Section Header) 與題號 (Question Number)。

2. **Topic_ID (課題編號)**:
   - 必須與提供的「課程大綱」完全一致 (例如 7.1, 7.2, 11.5)。
   - 如果試卷題目跨課題，選擇最主要的一個。

3. **Topic_Name (課題名稱)**:
   - 對應大綱中的名稱。

4. **Difficulty**: Low, Medium, High。
5. **Concept_Detail**: 簡短考核重點 (10字內)。`;

        const DEFAULT_PROMPT_SCRIPT = `你是一個試卷數據化助理。你的任務是將學生的答卷內容轉換為兩個 CSV 表格。

### 任務要求
1. **識別學生身份 (Critical)**:
   - 請在文件或圖片的 **頂部 / 角落** 仔細尋找 班級 (Class), 班號 (No), 姓名 (Name)。
   - 如果是圖片，請識別手寫字跡。
   - 如果完全找不到，Class/No/Name 請填 "UNKNOWN" (不要填 null)。

2. **識別答案**:
   - 根據 MAP 中的題號，找出學生對應的答案。
   - 如果學生該題空白，填 "No Answer"。

3. **輸出格式 (兩個區塊，用 ###SECTION_SPLIT### 分隔)**:

   區塊 1 (MC):
   CLASS,CLASSNUMBER,NAME,MC1,MC2,MC3...
   (MC值應為 A/B/C/D)
   
   ###SECTION_SPLIT###
   
   區塊 2 (Answers):
   CLASS,CLASSNUMBER,NAME,FILL1,FILL2,TF1,MATCH1,1a,1b...

### 注意
- 嚴格遵守 MAP 的題號。
- 只輸出 CSV，不要有 Markdown。`;

        // ==========================================
        // INIT
        // ==========================================
        function init() {
            document.getElementById('prompt-system-map').value = DEFAULT_PROMPT_MAP;
            document.getElementById('prompt-system-script').value = DEFAULT_PROMPT_SCRIPT;
        }

        function resetPrompt(type) {
            if (type === 'map') document.getElementById('prompt-system-map').value = DEFAULT_PROMPT_MAP;
            if (type === 'script') document.getElementById('prompt-system-script').value = DEFAULT_PROMPT_SCRIPT;
        }

        function copyToClipboard(id) {
            const el = document.getElementById(id);
            el.select();
            document.execCommand('copy');
            const btn = document.querySelector(`button[onclick="copyToClipboard('${id}')"]`);
            if(btn) {
                const oldHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> 已複製';
                setTimeout(() => btn.innerHTML = oldHTML, 1500);
            }
        }

        // ==========================================
        // AI CORE FUNCTION
        // ==========================================
        async function callAI(systemPrompt, userPrompt, imagePayloads = []) {
            let messages = [{ role: "system", content: systemPrompt }];
            let userContent = [{ type: "text", text: userPrompt }];

            if (imagePayloads && imagePayloads.length > 0) {
                imagePayloads.forEach(img => {
                    userContent.push({ type: "image_url", image_url: { url: img } });
                });
                messages.push({ role: "user", content: userContent });
            } else {
                messages.push({ role: "user", content: userPrompt });
            }

            const payload = {
                model: "deepseek-chat", 
                messages: messages, 
                temperature: 0.1, 
                max_tokens: 4000 
            };

            try {
                const res = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                return data.choices[0].message.content;
            } catch (e) {
                console.error(e);
                throw e;
            }
        }

        // ==========================================
        // FILE HANDLING & LOGIC
        // ==========================================
        
        function readFile(file, method) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader[method](file);
            });
        }

        async function extractText(file) {
            const name = file.name.toLowerCase();
            if (name.endsWith('.docx')) {
                const buff = await readFile(file, 'readAsArrayBuffer');
                const res = await mammoth.extractRawText({ arrayBuffer: buff });
                return res.value;
            } else if (name.endsWith('.pdf')) {
                const buff = await readFile(file, 'readAsArrayBuffer');
                const pdf = await pdfjsLib.getDocument(buff).promise;
                let txt = "";
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    txt += content.items.map(item => item.str).join(' ') + "\n";
                }
                return txt;
            } else if (file.type.startsWith('image/')) {
                return { type: 'image', file: file };
            } else {
                return await readFile(file, 'readAsText');
            }
        }

        async function handleMapCsvUpload(input) {
            if (input.files.length > 0) {
                try {
                    const txt = await readFile(input.files[0], 'readAsText');
                    document.getElementById('script-map-context').value = txt;
                } catch(e) {
                    alert("讀取 CSV 失敗: " + e.message);
                }
            }
        }

        // --- Feature 1: MAP Generator ---
        async function generateMAP() {
            const syllabusInput = document.getElementById('syllabus-file-upload');
            const examInput = document.getElementById('map-file-upload');
            const btn = document.getElementById('btn-gen-map');
            const output = document.getElementById('map-output');
            const extra = document.getElementById('map-prompt-extra').value;
            let sysPrompt = document.getElementById('prompt-system-map').value;

            if (examInput.files.length === 0) { alert("請上傳空白試卷"); return; }

            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="loader"></span> 深度分析中 (支援長文本)...`;
            btn.disabled = true;

            try {
                const examText = await extractText(examInput.files[0]);
                let sylText = "無";
                if (syllabusInput.files.length > 0) sylText = await extractText(syllabusInput.files[0]);

                sysPrompt += `\n\n### 課程大綱\n${sylText.substring(0,5000)}`;
                const userPrompt = `額外提示: ${extra}\n\n試卷內容:\n${examText.substring(0, 40000)}\n\n(請確保完整)`;

                let res = await callAI(sysPrompt, userPrompt);
                
                // Safe Regex Clean
                let cleanResult = res.trim();
                cleanResult = cleanResult.replace(new RegExp('^```csv\\s*', 'i'), '')
                                         .replace(new RegExp('^```\\s*', 'i'), '')
                                         .replace(new RegExp('\\s*```$', 'i'), '');
                
                output.value = cleanResult;
            } catch (e) {
                alert("Error: " + e.message);
                output.value = "Error: " + e.message;
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- New Feature: Marksheet Template Generator ---
        function generateMarksheet() {
            const mapText = document.getElementById('map-output').value.trim();
            if(!mapText) { alert("請先生成 MAP 或手動貼上 MAP CSV"); return; }

            Papa.parse(mapText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if(results.data.length === 0) return;
                    
                    // Try to find the Question_ID column
                    // Since AI output might have varied capitalization or extra spaces, we look for key containing 'Question' or 'ID'
                    let idKey = results.meta.fields.find(f => f.toLowerCase().includes('question') || f.toLowerCase().includes('id'));
                    
                    // Fallback to first column if key not found
                    if (!idKey) idKey = results.meta.fields[0];

                    let qIds = results.data.map(row => row[idKey]);
                    
                    // Clean up IDs
                    qIds = qIds.filter(id => id && id.trim() !== '');

                    const header = "Class,ClassNumber,Name," + qIds.join(",");
                    document.getElementById('marksheet-output').value = header;
                },
                error: function(err) {
                    alert("解析失敗: " + err.message);
                }
            });
        }

        // --- Feature 2: Script Analysis ---
        async function analyzeScript() {
            const fileInput = document.getElementById('script-file-upload');
            const mapContext = document.getElementById('script-map-context').value;
            const btn = document.getElementById('btn-analyze-script');
            const outMC = document.getElementById('script-out-mc');
            const outAns = document.getElementById('script-out-ans');
            let sysPrompt = document.getElementById('prompt-system-script').value;

            if (fileInput.files.length === 0) { alert("請上傳學生答卷"); return; }
            if (!mapContext) { alert("請輸入 MAP 資料"); return; }

            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="loader"></span> 識別與分析中...`;
            btn.disabled = true;

            try {
                let fullText = "";
                let images = [];

                for (let i=0; i<fileInput.files.length; i++) {
                    const extracted = await extractText(fileInput.files[i]);
                    if (extracted.type === 'image') {
                        images.push(await readFile(extracted.file, 'readAsDataURL'));
                    } else {
                        fullText += `\n--- FILE START ---\n${extracted}\n`;
                    }
                }

                sysPrompt += `\n\n### MAP 結構\n${mapContext}`;
                let instruction = "";
                if (images.length > 0) instruction = "(請注意：本答卷包含圖片，請結合圖片與文字進行分析)";
                
                const userPrompt = `${instruction}\n學生答卷內容(文字):\n${fullText.substring(0, 30000)}`;

                let res = await callAI(sysPrompt, userPrompt, images);

                const parts = res.split('###SECTION_SPLIT###');
                
                const clean = (t) => {
                    if (!t) return "";
                    return t.replace(new RegExp('```csv', 'gi'), '')
                            .replace(new RegExp('```', 'gi'), '')
                            .trim();
                };
                
                if (parts.length >= 2) {
                    outMC.value = clean(parts[0]);
                    outAns.value = clean(parts[1]);
                } else {
                    outMC.value = res;
                    outAns.value = "Format Error: No split marker found. AI output:\n" + res;
                }

            } catch (e) {
                alert("Error: " + e.message);
                outMC.value = "Error: " + e.message;
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Init
        init();
    </script>
</body>
</html>
