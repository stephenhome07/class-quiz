<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 試卷分析比較工具 (v5.0 Compat Fix)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const PDFJS_WORKER_URL = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

        // SVG Icons
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Icons = {
            Upload: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>,
            Play: (p) => <IconBase {...p}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>,
            ScanLine: (p) => <IconBase {...p}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><line x1="7" x2="17" y1="12" y2="12"/></IconBase>,
            SplitSquareHorizontal: (p) => <IconBase {...p}><path d="M8 19H5c-1 0-2-1-2-2V7c0-1 1-2 2-2h3"/><path d="M16 5h3c1 0 2 1 2 2v10c0 1-1 2-2 2h-3"/><line x1="12" x2="12" y1="4" y2="20"/></IconBase>,
            Table: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="3" x2="21" y1="15" y2="15"/><line x1="12" x2="12" y1="3" y2="21"/></IconBase>,
            Bug: (p) => <IconBase {...p}><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/></IconBase>,
            Wifi: (p) => <IconBase {...p}><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></IconBase>,
            Zap: (p) => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>
        };

        const App = () => {
            const [endpoint1, setEndpoint1] = useState("https://apiproxy.k12gpt.ai/hus_eRR");
            const [endpoint2, setEndpoint2] = useState("https://apiproxy.k12gpt.ai/XB3RZRq");
            const [apiKey1, setApiKey1] = useState('');
            const [apiKey2, setApiKey2] = useState('');
            
            const [file, setFile] = useState(null);
            const [previewImage, setPreviewImage] = useState(null);
            const [imageSizeInfo, setImageSizeInfo] = useState('');
            
            const [isProcessingPdf, setIsProcessingPdf] = useState(false);
            const [analyzing1, setAnalyzing1] = useState(false);
            const [analyzing2, setAnalyzing2] = useState(false);
            
            const [result1, setResult1] = useState(null);
            const [result2, setResult2] = useState(null);
            const [rawResponse1, setRawResponse1] = useState('');
            const [rawResponse2, setRawResponse2] = useState('');
            
            const [logs, setLogs] = useState([]);
            const [viewMode, setViewMode] = useState('comparison');
            const [connectionMode, setConnectionMode] = useState('direct'); 
            const [testStatus, setTestStatus] = useState('');
            
            // 新增: 兼容模式開關 (預設開啟，因為這是最可能的修復)
            const [compatMode, setCompatMode] = useState(true);

            useEffect(() => {
                if (window.pdfjsLib) window.pdfjsLib.GlobalWorkerOptions.workerSrc = PDFJS_WORKER_URL;
            }, []);

            const addLog = (msg) => {
                const time = new Date().toLocaleTimeString();
                setLogs(prev => [`[${time}] ${msg}`, ...prev]);
            };

            // 1. 純文字連線測試 (關鍵診斷)
            const testConnection = async () => {
                if (!apiKey1) { alert("請先輸入 API Key 1"); return; }
                setTestStatus('testing');
                addLog(`=== 純文字測試 (兼容模式: ${compatMode ? 'ON' : 'OFF'}) ===`);
                
                try {
                    const endpoint = connectionMode === 'proxy' 
                        ? `https://corsproxy.io/?${encodeURIComponent(endpoint1)}` 
                        : endpoint1;
                    
                    addLog(`目標: ${endpoint}`);
                    
                    // 根據相容模式決定 Payload
                    const payload = {
                        messages: [{ role: "user", content: "Say Hello" }]
                    };
                    
                    // 只有在非兼容模式下才送 model，因為有些 Proxy 會拒絕自帶 model 的請求
                    if (!compatMode) {
                        payload.model = "gpt-4o";
                        payload.max_tokens = 10;
                    }

                    const res = await fetch(endpoint, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${apiKey1.trim()}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        const data = await res.json();
                        addLog(`✅ 成功! 回應: ${JSON.stringify(data.choices?.[0]?.message?.content || data)}`);
                        setTestStatus('success');
                        alert("連線成功！");
                    } else {
                        const txt = await res.text();
                        addLog(`❌ 失敗 Status: ${res.status}, Body: ${txt}`);
                        setTestStatus('fail');
                    }
                } catch (e) {
                    addLog(`❌ 錯誤: ${e.message}`);
                    setTestStatus('fail');
                }
            };

            const handleFileChange = async (e) => {
                const selectedFile = e.target.files[0];
                if (!selectedFile) return;
                setFile(selectedFile);
                setResult1(null); setResult2(null);
                setRawResponse1(''); setRawResponse2('');
                setLogs([]);
                
                if (selectedFile.type === 'application/pdf') {
                    await convertPdfToImage(selectedFile);
                } else if (selectedFile.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (ev) => processImage(ev.target.result);
                    reader.readAsDataURL(selectedFile);
                }
            };

            // 暴力壓縮
            const processImage = (base64Str) => {
                resizeImage(base64Str, 500, 0.4).then(({dataUrl, sizeKB}) => { 
                    setPreviewImage(dataUrl);
                    setImageSizeInfo(`已壓縮: ${sizeKB} KB (寬500px)`);
                    addLog(`圖片處理完成: ${sizeKB} KB`);
                });
            };

            const resizeImage = (base64Str, maxWidth, quality) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = base64Str;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', quality); 
                        const sizeKB = Math.round(dataUrl.length / 1024 * 10) / 10;
                        resolve({ dataUrl, sizeKB });
                    };
                });
            };

            const convertPdfToImage = async (pdfFile) => {
                setIsProcessingPdf(true);
                addLog("轉換 PDF...");
                try {
                    const arrayBuffer = await pdfFile.arrayBuffer();
                    const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    const page = await pdf.getPage(1); 
                    const viewport = page.getViewport({ scale: 1.0 });
                    const canvas = document.createElement('canvas');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                    processImage(canvas.toDataURL('image/jpeg', 0.5));
                } catch (err) {
                    addLog("PDF 錯誤: " + err.message);
                } finally {
                    setIsProcessingPdf(false);
                }
            };

            const SYSTEM_PROMPT = `
你是一位專業的閱卷助教。你的任務是從試卷圖片中提取資訊。
請以純 JSON 格式輸出，結構:
{ "student_info": { "name": "", "class": "", "student_id": "" }, "analysis": [ { "question_id": "", "question_text": "", "student_answer": "", "teacher_score": "", "is_correct": true } ], "summary": "" }
若無分數填 "N/A"。`;

            const analyzeImage = async (originalEndpoint, apiKey, setAnalyzing, setResult, setRaw, modelName) => {
                if (!previewImage || !apiKey) return;
                setAnalyzing(true);
                setResult(null);
                setRaw('');

                const cleanApiKey = apiKey.trim();
                let finalEndpoint = originalEndpoint;
                if (connectionMode === 'proxy') {
                    finalEndpoint = `https://corsproxy.io/?${encodeURIComponent(originalEndpoint)}`;
                }

                addLog(`[${modelName}] 發送...`);

                try {
                    const payload = {
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            { role: "user", content: [
                                { type: "text", text: "分析試卷" },
                                { type: "image_url", image_url: { url: previewImage } }
                            ]}
                        ]
                    };

                    // 兼容模式修復：如果開啟，就不送 model 參數
                    if (!compatMode) {
                        payload.model = "gpt-4o";
                        payload.max_tokens = 1000;
                        payload.temperature = 0.1;
                    }

                    const response = await fetch(finalEndpoint, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${cleanApiKey}`
                        },
                        body: JSON.stringify(payload)
                    });

                    addLog(`[${modelName}] Status: ${response.status}`);

                    if (!response.ok) {
                        const errorText = await response.text().catch(() => 'No text');
                        throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                    }

                    const responseText = await response.text();
                    
                    try {
                        const data = JSON.parse(responseText);
                        const content = data.choices?.[0]?.message?.content;
                        if (!content) throw new Error("無 content");
                        
                        setRaw(content);
                        const jsonString = content.replace(/```json/g, '').replace(/```/g, '').trim();
                        setResult(JSON.parse(jsonString));
                        addLog(`[${modelName}] ✅ 成功`);
                    } catch (parseErr) {
                        setRaw(responseText);
                        addLog(`[${modelName}] JSON 解析失敗`);
                    }

                } catch (err) {
                    let msg = err.message;
                    if (msg.includes('Failed to fetch')) msg = "CORS 錯誤 (請確認 API Key 或開啟 Proxy 模式)";
                    setRaw(`Error: ${msg}`);
                    addLog(`[${modelName}] ❌ ${msg}`);
                } finally {
                    setAnalyzing(false);
                }
            };

            const handleStartAnalysis = () => {
                if (!apiKey1 || !apiKey2) { alert("請輸入兩組 API Key"); return; }
                if (!previewImage) { alert("請先上傳試卷"); return; }
                analyzeImage(endpoint1, apiKey1, setAnalyzing1, setResult1, setRawResponse1, "GPT-4o-mini");
                analyzeImage(endpoint2, apiKey2, setAnalyzing2, setResult2, setRawResponse2, "GPT-4o");
            };

            const safeRender = (val) => (typeof val === 'object' && val !== null) ? JSON.stringify(val) : val;

            return (
                <div className="min-h-screen bg-gray-50 text-gray-900 font-sans p-6">
                    <div className="max-w-7xl mx-auto space-y-6">
                        <header className="flex justify-between items-center border-b pb-4 bg-white p-6 rounded-xl shadow-sm">
                            <div>
                                <h1 className="text-2xl font-bold text-indigo-600 flex items-center gap-2">
                                    <Icons.ScanLine className="w-8 h-8" />
                                    AI 試卷批改分析 (v5.0 Compat Fix)
                                </h1>
                                <p className="text-gray-500 mt-1">獨立版 - 自動修正請求參數</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setConnectionMode('direct')} className={`px-3 py-1 rounded text-xs font-bold ${connectionMode==='direct' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-600'}`}>直接連線</button>
                                <button onClick={() => setConnectionMode('proxy')} className={`px-3 py-1 rounded text-xs font-bold ${connectionMode==='proxy' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-600'}`}>Proxy 模式</button>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-1 space-y-4">
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                                    
                                    <div className="mb-4">
                                        <div className="flex items-center gap-2 mb-2 p-2 bg-yellow-50 rounded border border-yellow-200 cursor-pointer" onClick={() => setCompatMode(!compatMode)}>
                                            <div className={`w-4 h-4 border rounded flex items-center justify-center ${compatMode ? 'bg-indigo-600 border-indigo-600' : 'bg-white border-gray-400'}`}>
                                                {compatMode && <Icons.Zap className="w-3 h-3 text-white" />}
                                            </div>
                                            <div className="text-xs select-none">
                                                <div className="font-bold text-gray-700">兼容模式 (推薦開啟)</div>
                                                <div className="text-gray-500">移除 model 參數以避免 Proxy 錯誤</div>
                                            </div>
                                        </div>

                                        <button onClick={testConnection} className="w-full bg-teal-600 hover:bg-teal-700 text-white py-2 rounded flex items-center justify-center gap-2 text-sm font-bold">
                                            <Icons.Wifi className="w-4 h-4" /> 1. 先按此測試連線
                                        </button>
                                        {testStatus === 'success' && <div className="text-center text-xs text-green-600 mt-1 font-bold">✅ 連線測試通過</div>}
                                        {testStatus === 'fail' && <div className="text-center text-xs text-red-600 mt-1 font-bold">❌ 連線測試失敗 (請看日誌)</div>}
                                    </div>
                                    
                                    <div className="p-2 bg-gray-800 text-green-400 text-xs rounded border border-gray-700 font-mono mb-4">
                                        <div className="h-32 overflow-y-auto">
                                            {logs.length === 0 ? "系統日誌..." : logs.map((l, i) => <div key={i} className="mb-1">{l}</div>)}
                                        </div>
                                    </div>

                                    <div className="space-y-4">
                                        <div className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                            <label className="block text-xs font-bold text-gray-700 mb-1">MODEL 1 Endpoint</label>
                                            <div className="text-[10px] text-gray-400 break-all mb-1">{endpoint1}</div>
                                            <input type="password" placeholder="API Key 1" className="w-full p-2 border rounded-lg bg-white outline-none text-xs" value={apiKey1} onChange={(e) => setApiKey1(e.target.value)} />
                                        </div>
                                        <div className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                            <label className="block text-xs font-bold text-gray-700 mb-1">MODEL 2 Endpoint</label>
                                            <div className="text-[10px] text-gray-400 break-all mb-1">{endpoint2}</div>
                                            <input type="password" placeholder="API Key 2" className="w-full p-2 border rounded-lg bg-white outline-none text-xs" value={apiKey2} onChange={(e) => setApiKey2(e.target.value)} />
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition cursor-pointer relative">
                                        <input type="file" accept=".pdf, image/*" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onChange={handleFileChange} />
                                        {isProcessingPdf ? <div className="text-indigo-600 text-sm">處理中...</div> : file ? 
                                            <div><div className="text-green-600 text-sm font-bold">{file.name}</div><div className="text-xs text-red-500 font-bold">{imageSizeInfo}</div></div> : 
                                            <div className="text-gray-500 text-sm">2. 上傳 PDF/圖片</div>
                                        }
                                    </div>
                                    <button onClick={handleStartAnalysis} disabled={!previewImage || !apiKey1 || !apiKey2 || analyzing1 || analyzing2} className={`w-full mt-4 py-3 rounded-lg text-white font-medium flex items-center justify-center gap-2 ${(!previewImage || !apiKey1) ? 'bg-gray-300' : 'bg-indigo-600 hover:bg-indigo-700 shadow-lg'}`}>
                                        {(analyzing1 || analyzing2) ? "分析中..." : <><Icons.Play className="w-4 h-4" /> 3. 開始雙模型分析</>}
                                    </button>
                                </div>
                            </div>

                            <div className="lg:col-span-2 space-y-6">
                                {previewImage && (
                                    <div className="bg-white p-4 rounded-xl shadow-sm border overflow-hidden">
                                        <div className="bg-gray-100 rounded-lg overflow-auto max-h-[150px] flex justify-center"><img src={previewImage} className="max-w-full object-contain" /></div>
                                    </div>
                                )}
                                {(result1 || result2 || rawResponse1 || rawResponse2) && (
                                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                        <div className="flex border-b">
                                            <button onClick={() => setViewMode('comparison')} className={`flex-1 py-3 text-sm font-medium ${viewMode==='comparison'?'bg-indigo-50 text-indigo-700 border-b-2 border-indigo-600':'text-gray-500'}`}><Icons.SplitSquareHorizontal className="w-3 h-3 inline" /> 比較</button>
                                            <button onClick={() => setViewMode('json')} className={`flex-1 py-3 text-sm font-medium ${viewMode==='json'?'bg-indigo-50 text-indigo-700 border-b-2 border-indigo-600':'text-gray-500'}`}><Icons.Table className="w-3 h-3 inline" /> 原始回應</button>
                                        </div>
                                        <div className="grid grid-cols-2 divide-x h-[600px] overflow-hidden">
                                            <ResultCol title="GPT-4o-mini" loading={analyzing1} result={result1} raw={rawResponse1} viewMode={viewMode} safeRender={safeRender} />
                                            <ResultCol title="GPT-4o" loading={analyzing2} result={result2} raw={rawResponse2} viewMode={viewMode} safeRender={safeRender} />
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ResultCol = ({ title, loading, result, raw, viewMode, safeRender }) => (
            <div className="flex flex-col h-full">
                <div className="p-3 bg-gray-50 border-b font-bold text-sm text-center flex justify-between">
                    <span>{title}</span>
                    {loading && <span className="text-xs text-blue-500 animate-pulse">Running...</span>}
                </div>
                <div className="overflow-y-auto flex-1 p-4">
                    {viewMode === 'comparison' ? (
                        <ResultCard data={result} loading={loading} raw={raw} safeRender={safeRender} />
                    ) : (
                        <pre className="text-xs bg-gray-50 p-2 rounded border whitespace-pre-wrap overflow-x-auto">{raw}</pre>
                    )}
                </div>
            </div>
        );

        const ResultCard = ({ data, loading, raw, safeRender }) => {
            if (loading) return <div className="space-y-3 animate-pulse"><div className="h-4 bg-gray-200 rounded w-1/3"></div><div className="h-20 bg-gray-200 rounded w-full"></div></div>;
            if (!data && raw) return <div className="bg-red-50 p-3 rounded border border-red-200 text-red-600 text-xs whitespace-pre-wrap break-all">{raw}</div>;
            if (!data) return <div className="text-gray-400 text-sm text-center mt-10">...</div>;

            return (
                <div className="space-y-4 text-sm">
                    <div className="bg-gray-50 p-3 rounded-lg border">
                        <div className="grid grid-cols-2 gap-2 text-xs">
                            <div><span className="text-gray-500">姓名:</span> {safeRender(data.student_info?.name) || '-'}</div>
                            <div><span className="text-gray-500">學號:</span> {safeRender(data.student_info?.student_id) || '-'}</div>
                        </div>
                    </div>
                    <div className="space-y-3">
                        {data.analysis?.map((item, idx) => (
                            <div key={idx} className="border rounded-lg p-3 bg-white">
                                <div className="flex justify-between items-start mb-2">
                                    <span className="font-bold text-indigo-600 bg-indigo-50 px-2 rounded">Q{safeRender(item.question_id)}</span>
                                    <span className={`px-2 py-0.5 rounded text-xs font-bold ${item.is_correct ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{safeRender(item.teacher_score)}</span>
                                </div>
                                <div className="mb-2 text-xs text-gray-500 line-clamp-2">{safeRender(item.question_text)}</div>
                                <div className="bg-yellow-50 p-2 rounded border border-yellow-100 text-gray-800 font-medium">{safeRender(item.student_answer)}</div>
                            </div>
                        ))}
                    </div>
                    {data.summary && <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-800">{safeRender(data.summary)}</div>}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
