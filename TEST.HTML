<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶œåˆç§‘å­¸ç§‘ - è©¦å·åˆ†æåŠAIå ±å‘Šç³»çµ± (Pro v39)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #e5e7eb; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); padding: 1.5rem; }
        .table-header { @apply px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50; }
        .table-cell { @apply px-6 py-4 whitespace-nowrap text-sm text-gray-900; }
        
        .nav-card { @apply flex flex-col items-center justify-center p-3 bg-white border-2 border-transparent rounded-xl shadow-sm cursor-pointer transition-all duration-200 hover:shadow-md hover:border-blue-200; }
        .nav-card.active { @apply border-blue-600 bg-blue-50 text-blue-800 ring-2 ring-blue-200 ring-opacity-50; }
        .nav-card i { @apply text-2xl mb-1 text-gray-400; }
        .nav-card.active i { @apply text-blue-600; }
        .nav-card h3 { @apply font-bold text-sm; }
        .nav-card p { @apply text-xs text-gray-500 mt-1 text-center hidden md:block; }

        .heatmap-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; }
        .heatmap-item { @apply p-3 rounded-lg text-center shadow-sm border border-gray-100 flex flex-col justify-center h-24 transition hover:shadow-md transform hover:-translate-y-1; }
        
        /* Markdown */
        .markdown-body h1 { font-size: 1.4em; font-weight: bold; margin-bottom: 0.5em; color: #1e3a8a; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.3em; }
        .markdown-body h2 { font-size: 1.2em; font-weight: bold; margin-top: 1.2em; margin-bottom: 0.5em; color: #2563eb; }
        .markdown-body h3 { font-size: 1.1em; font-weight: bold; margin-top: 1em; color: #4b5563; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body blockquote { border-left: 4px solid #e5e7eb; padding-left: 1em; color: #4b5563; font-style: italic; background-color: #f9fafb; padding: 0.5rem; }

        /* Report Page */
        .report-page-style { width: 210mm; min-height: 297mm; padding: 20mm; background: white; position: relative; overflow: hidden; font-size: 11pt; box-sizing: border-box; }
        .page-footer { margin-top: 40px; padding-top: 10px; border-top: 1px dashed #ccc; font-size: 10pt; color: #666; page-break-inside: avoid; }
        #report-preview-area, #summary-preview-area { display: flex; flex-direction: column; align-items: center; gap: 40px; padding-bottom: 50px; }
        .preview-wrapper { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); border: 1px solid #d1d5db; margin-bottom: 20px; }

        #print-container { display: none; }
        @media print {
            @page { size: A4 portrait; margin: 0; }
            body { background: white; -webkit-print-color-adjust: exact; }
            #app-container, nav, .no-print, #error-modal { display: none !important; }
            #print-container { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            .report-page-style { height: 296mm; width: 100%; page-break-after: always; break-after: page; margin: 0; box-shadow: none; border: none; float: none; }
            .page-footer { position: absolute; bottom: 20mm; left: 20mm; right: 20mm; }
        }
        #error-modal { background: rgba(0,0,0,0.5); }
        .distractor-card { @apply border-l-4 border-red-500 bg-red-50 p-4 rounded mb-4; }
        .analysis-box { @apply mt-3 p-3 bg-white rounded border border-gray-200 text-sm text-gray-700 hidden; }
        .badge-req { @apply bg-red-100 text-red-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase ml-1; }
        .badge-opt { @apply bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase ml-1; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full mx-4 border-l-4 border-red-500 relative animate-fade-in-up">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-red-600 mb-2"><i class="fas fa-bug mr-2"></i>ç”Ÿæˆå¤±æ•—</h3>
            <div class="bg-gray-100 p-3 rounded text-xs font-mono text-gray-800 overflow-auto max-h-60 mb-4 border border-gray-300" id="error-log-content">Waiting...</div>
            <div id="cors-advice" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                <strong>ğŸ’¡ é€£ç·šè¨ºæ–·å»ºè­°ï¼š</strong><br>
                1. æ‚¨çš„ Proxy URL å¯èƒ½ä¸æ”¯æ´ç€è¦½å™¨ç›´æ¥é€£ç·š (CORS)ã€‚ç€è¦½å™¨æ¯” Python æ›´åš´æ ¼ã€‚<br>
                2. è«‹å˜—è©¦ä½¿ç”¨ <strong>Google Gemini Key</strong> (ç›´æ¥é€£ç·š Google ä¼ºæœå™¨æœ€ç©©å®š)ã€‚<br>
                3. è«‹ç¢ºèª API Key æ˜¯å¦éœ€è¦å¡«å¯« (éƒ¨åˆ† Proxy å…§å« Key å‰‡ä¸éœ€å¡«å¯«)ã€‚
            </div>
            <button onclick="copyErrorLog()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded shadow transition flex items-center justify-center"><i class="fas fa-copy mr-2"></i> è¤‡è£½éŒ¯èª¤å ±å‘Š</button>
        </div>
    </div>

    <!-- WRAPPER -->
    <div id="app-container" class="max-w-7xl mx-auto">
        <!-- Navbar -->
        <nav class="bg-blue-700 text-white shadow-lg mb-6">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-microscope text-2xl mr-3"></i>
                        <span class="font-bold text-xl ml-2">ç¶œåˆç§‘å­¸ç§‘ - è©¦å·åˆ†æåŠAIå ±å‘Šç³»çµ± (Pro v39)</span>
                    </div>
                </div>
            </div>
        </nav>

        <div class="px-4 sm:px-6 lg:px-8 pb-12">
            
            <!-- File Upload Section -->
            <div class="card mb-8 animate-fade-in-up border-l-4 border-blue-500">
                <h2 class="text-lg font-bold text-gray-700 mb-4 pb-2 border-b"><i class="fas fa-file-upload mr-2"></i>1. è³‡æ–™åŒ¯å…¥</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Required Column -->
                    <div class="bg-red-50 p-4 rounded-lg border-2 border-red-100">
                        <h3 class="text-sm font-bold text-red-700 mb-3 flex items-center"><i class="fas fa-asterisk mr-2"></i>å¿…è¦è³‡æ–™ (Required)</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">1. åˆ†æ•¸è¡¨ (MARKSHEET.csv)</label>
                                <input id="marksheet-upload" type="file" accept=".csv" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:bg-white file:text-red-700 hover:file:bg-red-50 cursor-pointer border border-red-200 rounded"/>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">2. é¡Œç›®è¡¨ (MAP.csv)</label>
                                <input id="map-upload" type="file" accept=".csv" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:bg-white file:text-red-700 hover:file:bg-red-50 cursor-pointer border border-red-200 rounded"/>
                            </div>
                        </div>
                    </div>

                    <!-- Optional Column -->
                    <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-100">
                        <h3 class="text-sm font-bold text-blue-700 mb-3 flex items-center"><i class="fas fa-magic mr-2"></i>é€²éšåˆ†æè³‡æ–™ (æ¨è–¦)</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">3. è©¦å·å…§å®¹ (Word/Txt) <span class="badge-opt">æå‡AIç²¾æº–åº¦</span></label>
                                <input id="exam-paper-upload" type="file" accept=".docx,.txt" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:bg-white file:text-blue-700 hover:file:bg-blue-50 cursor-pointer border border-blue-200 rounded"/>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">4. MC é¸é …ç´€éŒ„ (MC.csv) <span class="badge-opt">èª˜ç­”é …åˆ†æ</span></label>
                                <input id="mc-upload" type="file" accept=".csv" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:bg-white file:text-blue-700 hover:file:bg-blue-50 cursor-pointer border border-blue-200 rounded"/>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">5. èª²ç¨‹å¤§ç¶± (Syllabus) <span class="badge-opt">é˜²æ­¢è¶…ç¶±</span></label>
                                <input id="syllabus-upload" type="file" accept=".docx,.txt,.csv" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:bg-white file:text-blue-700 hover:file:bg-blue-50 cursor-pointer border border-blue-200 rounded"/>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 pt-2 border-t border-gray-100 flex justify-between items-center text-xs text-gray-500">
                    <div>
                        <span class="font-bold">ç‹€æ…‹ï¼š</span> <span id="file-status" class="italic">ç­‰å¾…æª”æ¡ˆ...</span>
                        <span id="paper-status" class="ml-4 italic text-green-600 font-bold"></span>
                    </div>
                </div>
            </div>

            <!-- TABS -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-8 hidden" id="main-tabs">
                <div onclick="switchTab('analysis')" class="nav-card active" id="tab-analysis"><i class="fas fa-chart-pie"></i><h3>å…¨ç­æ•¸æ“š</h3></div>
                <div onclick="switchTab('mc')" class="nav-card" id="tab-mc"><i class="fas fa-list-ul"></i><h3>MC åˆ†æ</h3></div>
                <div onclick="switchTab('summary')" class="nav-card" id="tab-summary"><i class="fas fa-file-alt"></i><h3>ç¶œåˆå ±å‘Š</h3></div>
                <div onclick="switchTab('report')" class="nav-card" id="tab-report"><i class="fas fa-user-graduate"></i><h3>å­¸ç”Ÿå ±å‘Š</h3></div>
                <div onclick="switchTab('settings')" class="nav-card" id="tab-settings"><i class="fas fa-sliders-h"></i><h3>è¨­å®š</h3></div>
            </div>

            <!-- VIEW 1: ANALYSIS -->
            <div id="view-analysis" class="hidden space-y-8">
                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="card border-t-4 border-blue-500"><div class="text-gray-500 text-sm">å¹³å‡åˆ†</div><div class="text-3xl font-bold mt-1" id="stat-mean">--</div></div>
                    <div class="card border-t-4 border-green-500"><div class="text-gray-500 text-sm">åŠæ ¼ç‡</div><div class="text-3xl font-bold mt-1" id="stat-pass">--%</div></div>
                    <div class="card border-t-4 border-yellow-500"><div class="text-gray-500 text-sm">æœ€é«˜/æœ€ä½</div><div class="text-3xl font-bold mt-1"><span id="stat-max" class="text-green-600">--</span>/<span id="stat-min" class="text-red-600">--</span></div></div>
                    <div class="card border-t-4 border-purple-500"><div class="text-gray-500 text-sm">æ¨™æº–å·®</div><div class="text-3xl font-bold mt-1" id="stat-sd">--</div></div>
                </div>
                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card flex flex-col h-full"><h3 class="text-lg font-bold mb-4">å¼·å¼±èª²é¡Œç†±é»åœ–</h3><div id="heatmap-container" class="heatmap-grid overflow-y-auto max-h-64 p-1 flex-grow"></div></div>
                    <div class="card flex flex-col h-full"><h3 class="text-lg font-bold mb-4">æˆç¸¾åˆ†ä½ˆ</h3><div class="relative h-64 w-full"><canvas id="distChart"></canvas></div></div>
                </div>
                <!-- Table -->
                <div class="card overflow-hidden">
                    <div class="flex justify-between items-center mb-4 border-b pb-4"><h3 class="text-lg font-bold">é¡Œé …åˆ†æ</h3><select id="item-filter" class="p-1 border rounded text-sm"><option value="ALL">å…¨éƒ¨</option><option value="D_LOW">é‘‘åˆ¥åº¦ä½</option><option value="P_LOW">é¡Œç›®éé›£</option></select></div>
                    <div class="overflow-x-auto max-h-96 border rounded-lg"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="table-header">é¡Œè™Ÿ</th><th class="table-header">èª²é¡Œ</th><th class="table-header">é›£åº¦</th><th class="table-header">P</th><th class="table-header">D</th><th class="table-header">è©•åƒ¹</th></tr></thead><tbody class="bg-white divide-y divide-gray-200" id="itemTableBody"></tbody></table></div>
                </div>
            </div>

            <!-- VIEW 1.5: MC ANALYSIS -->
            <div id="view-mc" class="hidden space-y-8">
                <div class="card"><h3 class="text-lg font-bold mb-4">MC é¸é …åˆ†ä½ˆ</h3><div class="relative h-64 w-full"><canvas id="mcChart"></canvas></div><div class="mt-8" id="mc-distractor-list"></div></div>
            </div>

            <!-- VIEW 2: SUMMARY REPORT -->
            <div id="view-summary" class="hidden space-y-8">
                <div class="card bg-orange-50 border-l-4 border-orange-500">
                    <h2 class="text-lg font-bold text-gray-700 mb-2"><i class="fas fa-file-alt mr-2"></i>è€ƒè©¦æˆç¸¾èˆ‡æ•™å­¸æª¢è¨å ±å‘Š</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div><label class="block text-xs font-bold text-gray-600 mb-1">å­¸æ ¡</label><input id="school-name" type="text" value="å—‡è‰²åœ’ä¸»è¾¦å¯è­½ä¸­å­¸æš¨å°å­¸" class="w-full p-2 border rounded text-sm bg-white"></div>
                        <div><label class="block text-xs font-bold text-gray-600 mb-1">ç§‘ç›®</label><input id="subject-name" type="text" value="ç¶œåˆç§‘å­¸ç§‘" class="w-full p-2 border rounded text-sm bg-white"></div>
                        <div><label class="block text-xs font-bold text-gray-600 mb-1">å¹´ä»½/ç´šåˆ¥</label><input id="exam-info" type="text" placeholder="e.g. 2025-2026 ä¸­äºŒç´š" class="w-full p-2 border rounded text-sm bg-white"></div>
                    </div>
                    <div class="flex gap-4 justify-end"><button id="gen-summary-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-6 rounded shadow flex items-center"><i class="fas fa-magic mr-2"></i> ç”Ÿæˆç¶œåˆå ±å‘Š</button><button id="dl-summary-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded shadow disabled:opacity-50" disabled><i class="fas fa-download mr-2"></i> ä¸‹è¼‰</button></div>
                </div>
                <div id="summary-preview-area"></div>
            </div>

            <!-- VIEW 3: STUDENT REPORT -->
            <div id="view-report" class="hidden space-y-8">
                <div class="card">
                    <h2 class="text-lg font-bold mb-4 border-b pb-2"><i class="fas fa-user-graduate mr-2"></i>å­¸ç”Ÿå€‹åˆ¥å ±å‘Š</h2>
                    <div class="flex flex-col md:flex-row gap-4 items-end">
                        <div class="w-full md:w-1/4"><label class="block text-sm font-medium mb-1">èªè¨€</label><select id="report-language" class="w-full p-2 border rounded font-bold text-indigo-600"><option value="zh">ç¹é«”ä¸­æ–‡</option><option value="en">English</option></select></div>
                        <div class="flex-grow w-full"><label class="block text-sm font-medium mb-1">é¸æ“‡å­¸ç”Ÿ</label><select id="student-select" class="w-full p-2 border rounded"><option value="">è«‹é¸æ“‡...</option><option value="ALL">ã€ ğŸš€ æ‰¹é‡ç”Ÿæˆ ã€‘å…¨ç­</option></select></div>
                        <button id="generate-btn" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow"><i class="fas fa-play mr-2"></i>ç”Ÿæˆ</button>
                        <button onclick="window.print()" id="print-btn" class="w-full md:w-auto bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded shadow" disabled><i class="fas fa-print mr-2"></i>åˆ—å°/PDF</button>
                        <button id="download-btn" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow" disabled><i class="fas fa-file-download mr-2"></i>ä¸‹è¼‰HTML</button>
                    </div>
                    <div id="batch-progress" class="hidden mt-6 bg-gray-50 p-4 rounded border"><div class="flex justify-between text-xs font-bold mb-2"><span id="progress-text">ç”Ÿæˆä¸­...</span><span id="progress-count">0/0</span></div><div class="w-full bg-gray-200 rounded-full h-3"><div id="progress-bar" class="bg-indigo-600 h-3 rounded-full" style="width:0%"></div></div></div>
                </div>
                <div id="report-preview-area" class="w-full"></div>
            </div>

            <!-- VIEW 4: SETTINGS -->
            <div id="view-settings" class="hidden space-y-8">
                <div class="card border-l-4 border-green-500 mb-6">
                    <h2 class="text-lg font-bold text-gray-700 mb-2"><i class="fas fa-book mr-2"></i>èª²ç¨‹ç¯„åœ (Syllabus)</h2>
                    <textarea id="syllabus-content" class="w-full h-40 p-4 border border-gray-300 rounded font-mono text-sm bg-gray-50" placeholder="åœ¨æ­¤è¼¸å…¥èª²ç¨‹é‡é»..."></textarea>
                    <div class="flex justify-end mt-2"><button id="save-syllabus-btn" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-4 rounded shadow"><i class="fas fa-save mr-1"></i>å„²å­˜</button></div>
                </div>
                <div class="card bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 mb-6">
                    <h3 class="text-md font-bold text-gray-800 mb-3"><i class="fas fa-robot mr-2"></i>API è¨­å®š</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="block text-xs font-bold text-gray-600 mb-1">æ¨¡å‹</label><select id="model-provider" class="w-full text-sm border p-2 rounded"><option value="deepseek" selected>DeepSeek (Proxy)</option><option value="gemini">Google Gemini</option></select></div>
                        <div class="md:col-span-2" id="ds-config">
                            <div class="grid grid-cols-2 gap-2"><input id="ds-url" type="text" value="https://apiproxy.k12gpt.ai/NPcj-7_" class="text-xs p-2 border rounded" placeholder="Full API Endpoint"><input id="ds-model" type="text" value="deepseek-chat" class="text-xs p-2 border rounded" placeholder="Model"></div>
                            <div class="mt-2 flex items-center bg-white p-2 rounded border border-gray-200"><input type="checkbox" id="ds-auto-path" class="mr-2"><label for="ds-auto-path" class="text-xs font-bold cursor-pointer select-none">è‡ªå‹•è£œå…¨ /chat/completions (é è¨­é—œé–‰)</label></div>
                            <div class="mt-2"><input id="ds-key" type="password" placeholder="API Key (Optional)" class="w-full text-xs p-2 border rounded"></div>
                            <button id="test-conn-btn" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded">æ¸¬è©¦é€£ç·š</button>
                        </div>
                        <div class="md:col-span-2 hidden" id="gemini-config"><input id="gemini-key" type="password" placeholder="Gemini API Key" class="w-full text-xs p-2 border rounded"></div>
                    </div>
                </div>
                <div class="card border-l-4 border-purple-500">
                    <h2 class="text-lg font-bold text-gray-700 mb-4 pb-2 border-b"><i class="fas fa-edit mr-2"></i>è‡ªè¨‚å­¸ç”Ÿå ±å‘ŠæŒ‡ä»¤</h2>
                    <textarea id="prompt-template" class="w-full h-64 p-4 border border-gray-300 rounded font-mono text-sm bg-gray-50" spellcheck="false"></textarea>
                    <div class="flex justify-end gap-4 mt-4"><button id="reset-prompt-btn" class="text-gray-500 hover:text-gray-700 text-sm font-bold px-4 py-2">æ¢å¾©é è¨­</button><button id="save-prompt-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded shadow"><i class="fas fa-save mr-2"></i>å„²å­˜</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="print-container"></div>

    <script>
        // --- GLOBAL UTILS ---
        const renderer = new marked.Renderer();
        renderer.image = function(href, title, text) { return `<span style="color:#999; font-size:0.8em; border:1px dashed #ccc; padding:2px 5px;">[åœ–ç‰‡å·²ç§»é™¤]</span>`; };
        marked.setOptions({ renderer: renderer });

        // --- GLOBAL STATE ---
        let marksheetData=[], mapData=[], mcData=[], questionMap={}, totalPaperMark=0, chartInstances={}, analysisCache=null, colMap={name:'',class:'',no:''}, mcDistractors={};
        let examPaperText = "";
        let studentImages = [];

        // --- CORE FUNCTIONS (Top Level) ---
        function analyzeStudent(r){
            let t=0,w=[],b={},g={};
            Object.keys(questionMap).forEach(q=>{
                if(r[q] !== undefined){
                    let s=parseFloat(r[q])||0, i=questionMap[q];
                    t+=s;
                    if(s < i.fullMark * 0.5){
                        w.push(i.Concept_Detail || i.Topic_Name);
                        b[i.Topic_Name]=(b[i.Topic_Name]||0)+1;
                    } else if(s === i.fullMark){
                        g[i.Topic_Name]=(g[i.Topic_Name]||0)+1;
                    }
                }
            });
            return {totalScore:t,wrong:[...new Set(w)].slice(0,8),bad:Object.keys(b).sort((x,y)=>b[y]-b[x]).slice(0,3),good:Object.keys(g).sort((x,y)=>g[y]-g[x]).slice(0,3)};
        }

        // --- DEFINED FUNCTIONS ---
        function saveSyllabusToStorage() {
             const val = document.getElementById('syllabus-content').value;
             localStorage.setItem('science_exam_syllabus', val);
             alert("âœ… èª²ç¨‹å¤§ç¶±å·²å„²å­˜");
        }

        function buildPrompt(n,d, lang, syllabus, examPaperContext) {
            let tpl = document.getElementById('prompt-template').value;
            const L = {
                zh: { inst: "è«‹ç”¨ç¹é«”ä¸­æ–‡æ’°å¯«ã€‚", sec1: "æ•´é«”è¡¨ç¾å›é¡§", sec2: "é‡é»æ¦‚å¿µé‡æº«", sec3: "è‡ªæˆ‘æŒ‘æˆ°" },
                en: { inst: "Please write in English.", sec1: "Overall Performance Review", sec2: "Key Concept Review", sec3: "Self-Challenge" }
            };
            const LC = L[lang] || L['zh'];
            return tpl.replace('{{student_name}}', n)
                      .replace('{{total_score}}', d.totalScore)
                      .replace('{{full_mark}}', totalPaperMark)
                      .replace('{{weaknesses}}', d.bad.join(', '))
                      .replace('{{wrong_concepts}}', d.wrong.join(', '))
                      .replace('{{strengths}}', d.good.join(', '))
                      .replace('{{language_instruction}}', LC.inst)
                      .replace('{{section_1_title}}', LC.sec1)
                      .replace('{{section_2_title}}', LC.sec2)
                      .replace('{{section_3_title}}', LC.sec3)
                      .replace('{{syllabus}}', syllabus || "æœªæä¾›")
                      .replace('{{exam_paper_content}}', examPaperContext || "æœªæä¾›");
        }

        async function callAI(p) {
            const prov=document.getElementById('model-provider').value;
            const key=document.getElementById('ds-key').value || document.getElementById('gemini-key').value;
            
            if(prov==='gemini'){
                 const k=document.getElementById('gemini-key').value;
                 let r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${k}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:p}]}]})});
                 if(!r.ok) throw new Error(r.statusText); let d=await r.json(); return d.candidates[0].content.parts[0].text;
            } else {
                 let u = document.getElementById('ds-url').value.trim(); // Strict URL
                 
                 // Apply auto-path logic ONLY if checked
                 if(document.getElementById('ds-auto-path').checked) {
                    if(!u.includes('/chat/completions')) u = u.replace(/\/$/, "") + '/chat/completions';
                 }

                 console.log("Calling API Endpoint:", u);
                 
                 // Strict fetch: no Auth header if key is empty
                 let headers = { 'Content-Type': 'application/json' };
                 if(key && key.trim() !== "") headers['Authorization'] = `Bearer ${key}`;

                 let r=await fetch(u,{
                     method:'POST',
                     headers: headers,
                     body:JSON.stringify({
                         model: document.getElementById('ds-model').value,
                         messages:[{role:"user",content:p}]
                     })
                 });
                 
                 if(!r.ok) {
                    let txt = await r.text();
                    throw new Error(`API Error ${r.status}: ${txt}`);
                 }
                 let d=await r.json(); return d.choices[0].message.content;
            }
        }
        
        async function testConnection() {
            try {
                const res = await callAI("Say hello");
                alert("é€£ç·šæˆåŠŸï¼å›æ‡‰ï¼š" + res);
            } catch(e) {
                alert("é€£ç·šå¤±æ•—ï¼š" + e.message);
            }
        }

        async function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).value || document.getElementById(elementId).textContent;
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) { await navigator.clipboard.writeText(text); alert('Copied!'); } 
                else { throw new Error('Fallback'); }
            } catch (err) {
                const ta = document.createElement("textarea"); ta.value = text;
                ta.style.position = "fixed"; document.body.appendChild(ta); ta.focus(); ta.select();
                try { document.execCommand('copy'); alert('Copied!'); } catch (e) { alert('Copy failed'); }
                document.body.removeChild(ta);
            }
        }
        window.copyToClipboard = copyToClipboard;
        window.copyErrorLog = () => copyToClipboard('error-log-content');

        // --- INITIALIZATION ---
        const DEFAULT_PROMPT = `
ä½ æ˜¯ä¸€ä½ç§‘å­¸è€å¸«ã€‚è«‹ç‚ºå­¸ç”Ÿ {{student_name}} è£½ä½œä¸€ä»½å…©é çš„å­¸ç¿’å ±å‘Šã€‚
ç¸½åˆ†ï¼š{{total_score}} / {{full_mark}}ã€‚
å¼±é …ï¼š{{weaknesses}}ã€‚
éŒ¯é¡Œæ¦‚å¿µï¼š{{wrong_concepts}}ã€‚
å¼·é …ï¼š{{strengths}}ã€‚

{{language_instruction}}

ã€èª²ç¨‹ç¯„åœåƒè€ƒ (Syllabus Scope)ã€‘ï¼š
{{syllabus}}

è«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¼¸å‡ºï¼Œå¿…é ˆåŒ…å«åˆ†éš”ç¬¦è™Ÿï¼ï¼š
ç¸½åˆ†ï¼š{{total_score}} / {{full_mark}}ã€‚
å¼±é …ï¼š{{weaknesses}}ã€‚
éŒ¯é¡Œæ¦‚å¿µï¼š{{wrong_concepts}}ã€‚
å¼·é …ï¼š{{strengths}}ã€‚


1. **{{section_1_title}}**
   - ç°¡çŸ­é¼“å‹µ
   - é»åˆ—æŒ‡å‡ºå¼·é …
   - é»åˆ—æŒ‡å‡ºéœ€æ”¹å–„ä¹‹è™•
   (æ–‡å­—ç°¡è¦)

2. **{{section_2_title}}**
   (é‡å°æ¯ä¸€å€‹ã€Œéœ€æ”¹å–„çš„èª²é¡Œã€ï¼Œä»¥ã€Œç­†è¨˜å½¢å¼ã€è§£é‡‹é‡é»æ¦‚å¿µã€‚è«‹å‹™å¿…ä½¿ç”¨ç”Ÿæ´»æ¯”å–»ï¼Œç°¡æ˜“æ˜ç™½ã€‚ä¾‹å¦‚ï¼šã€Œæ‘©æ“¦åŠ›ï¼šå°±åƒåœ°é¢æœ‰çœ‹ä¸è¦‹çš„å°æ‰‹...ã€ã€‚æ³¨æ„ï¼šå…§å®¹ä¸å¯è¶…å‡ºä¸Šè¿°èª²ç¨‹ç¯„åœã€‚è‹¥æœ‰æä¾›è©¦å·å…§å®¹ï¼Œè«‹å¼•ç”¨ç›¸é—œé¡Œç›®æƒ…å¢ƒã€‚)

---PAGE_BREAK---

3. **{{section_3_title}}** (5 æ¢é¸æ“‡é¡Œï¼Œç´”æ–‡å­—)
   (é¡Œç›®å¿…é ˆåœ¨èª²ç¨‹ç¯„åœå…§)

---ANSWERS---

(ç­”æ¡ˆåŠç°¡çŸ­è§£é‡‹)
`.trim();

        const SUMMARY_PROMPT = `
ä½ æ˜¯ä¸€ä½è³‡æ·±çš„ {{subject}} ç§‘ä¸»ä»»ã€‚è«‹æ ¹æ“šä»¥ä¸‹å…¨ç­è€ƒè©¦æ•¸æ“šï¼Œç‚ºæ ¡é•·æ’°å¯«ä¸€ä»½å°ˆæ¥­çš„ã€Œè€ƒè©¦æˆç¸¾èˆ‡æ•™å­¸æª¢è¨å ±å‘Šã€ã€‚

å­¸æ ¡ï¼š{{school_name}}
è€ƒè©¦å¹´ä»½åŠç´šåˆ¥ï¼š{{exam_info}}
ç§‘ç›®ï¼š{{subject}}
å¹³å‡åˆ†ï¼š{{mean}} / {{full_mark}}
åŠæ ¼ç‡ï¼š{{pass_rate}}
æœ€é«˜/æœ€ä½åˆ†ï¼š{{max}} / {{min}}
æ¨™æº–å·®ï¼š{{sd}}

ã€å¼·é …èª²é¡Œã€‘ï¼š{{top_topics}}
ã€å¼±é …èª²é¡Œã€‘ï¼š{{bottom_topics}}
ã€éœ€é—œæ³¨é¡Œç›® (é‘‘åˆ¥åº¦ä½æˆ–éé›£)ã€‘ï¼š{{flagged_questions}}

ã€MC èª¤é»åˆ†æ (æœ€å¤šäººé¸éŒ¯çš„é¡Œç›®)ã€‘ï¼š
{{mc_distractors}}

ã€èª²ç¨‹ç¯„åœåƒè€ƒã€‘ï¼š
{{syllabus}}

ã€è©¦å·å…§å®¹åƒè€ƒã€‘ï¼š
{{exam_paper_content}}

è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œä»¥å°ˆæ¥­å…¬æ–‡èªæ°£æ’°å¯«ï¼Œæ ¼å¼å¦‚ä¸‹ï¼ˆä¸è¦åœ–ç‰‡ï¼‰ï¼š

# è€ƒè©¦æˆç¸¾èˆ‡æ•™å­¸æª¢è¨å ±å‘Š

**1. è€ƒè©¦æˆç¸¾æ‘˜è¦**
(ç°¡è¿°æ•´é«”è¡¨ç¾ï¼Œæ¯”è¼ƒå¹³å‡åˆ†èˆ‡åŠæ ¼ç‡æ˜¯å¦ç†æƒ³)

**2. å­¸ç”Ÿå¼·å¼±é …åˆ†æ**
* **å¼·é …**ï¼š(åˆ†æå­¸ç”Ÿåœ¨å“ªäº›èª²é¡Œè¡¨ç¾è¼ƒå¥½ï¼Œé¡¯ç¤ºæŒæ¡äº†ä»€éº¼æ¦‚å¿µ)
* **å¼±é …**ï¼š(æ·±å…¥åˆ†æå¼±é …èª²é¡Œï¼Œæ¨æ¸¬å­¸ç”Ÿæ¦‚å¿µä¸æ¸…çš„åŸå› ï¼Œä¾‹å¦‚ï¼šæ··æ·†äº†...ï¼Œæœªèƒ½æŒæ¡...)

**3. MC èª¤é»èˆ‡è©¦é¡Œè³ªç´ æª¢è¨**
(åƒè€ƒã€ŒMC èª¤é»åˆ†æã€ï¼Œåˆ†æå­¸ç”Ÿç‚ºä½•åœ¨æŸäº›é¡Œç›®æœƒé›†é«”é¸éŒ¯æŸå€‹é¸é …ã€‚æ˜¯æ¦‚å¿µä¸æ¸…ï¼Ÿé¡Œç›®æœ‰æ­§ç¾©ï¼Ÿé‚„æ˜¯å¸¸è¦‹è¿·æ€ï¼Ÿè«‹çµåˆè©¦å·é¡Œç›®å…§å®¹å…·é«”èªªæ˜ã€‚)

**4. å­¸èˆ‡æ•™åæ€åŠè·Ÿé€²å»ºè­°**
(å…·é«”å»ºè­°ä¸‹å­¸æœŸæˆ–è£œèª²æ™‚å¦‚ä½•æ”¹å–„ã€‚ä¾‹å¦‚ï¼šå¢åŠ å¯¦é©—ç’°ç¯€ã€åŠ å¼·é—œéµå­—æ“ç·´ã€é‡å°å¼±é …èª²é¡Œçš„å…·é«”é‡æº«ç­–ç•¥ã€‚å»ºè­°éœ€ç¬¦åˆèª²ç¨‹ç¯„åœã€‚)
`.trim();

        let customPrompt = localStorage.getItem('science_exam_prompt') || DEFAULT_PROMPT;
        let savedSyllabus = localStorage.getItem('science_exam_syllabus') || "";
        const pt = document.getElementById('prompt-template'); if(pt) pt.value = customPrompt;
        const st = document.getElementById('syllabus-content'); if(st) st.value = savedSyllabus;

        // --- HELPER ---
        const safeListen = (id, event, fn) => { const el = document.getElementById(id); if(el) el.addEventListener(event, fn); };
        
        // --- BUTTON HANDLERS ---
        safeListen('save-prompt-btn', 'click', () => {
            customPrompt = document.getElementById('prompt-template').value; localStorage.setItem('science_exam_prompt', customPrompt); alert("âœ… è¨­å®šå·²å„²å­˜");
        });
        
        safeListen('save-syllabus-btn', 'click', () => {
            saveSyllabusToStorage();
        });
        
        safeListen('reset-prompt-btn', 'click', () => {
            if(confirm("ç¢ºå®šè¦æ¢å¾©é è¨­æŒ‡ä»¤å—ï¼Ÿ")) { customPrompt = DEFAULT_PROMPT; document.getElementById('prompt-template').value = customPrompt; localStorage.setItem('science_exam_prompt', customPrompt); }
        });
        
        safeListen('test-conn-btn', 'click', testConnection);

        function switchTab(tab) {
            document.querySelectorAll('.nav-card').forEach(b=>b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            ['view-analysis','view-mc','view-summary','view-report','view-settings'].forEach(id => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); });
            const target = document.getElementById(`view-${tab}`); if(target) target.classList.remove('hidden');
        }

        document.getElementById('model-provider').addEventListener('change', (e)=>{
            const isDeep = e.target.value === 'deepseek';
            document.getElementById('ds-config').classList.toggle('hidden', !isDeep);
            document.getElementById('gemini-config').classList.toggle('hidden', isDeep);
        });

        function handleFile(file, type) {
            if(!file) return;
            Papa.parse(file, {header: type!=='mc', skipEmptyLines:true, complete:(res)=>{
                if(type==='marksheet') { marksheetData=res.data; detectColumns(res.meta.fields); }
                else if(type==='map') { 
                    mapData=res.data; 
                    let mapTxt = res.data.map(r => `${r.Question_ID} (Topic:${r.Topic_Name})`).join(', ');
                }
                else if(type==='mc') { mcData=res.data; }
                if(marksheetData.length && mapData.length) initSystem();
            }});
        }
        safeListen('marksheet-upload', 'change', (e)=>handleFile(e.target.files[0],'marksheet'));
        safeListen('map-upload', 'change', (e)=>handleFile(e.target.files[0],'map'));
        safeListen('mc-upload', 'change', (e)=>handleFile(e.target.files[0],'mc'));
        
        const readDocxOrText = (file, callback) => {
            if (file.name.endsWith('.docx')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    mammoth.extractRawText({arrayBuffer: e.target.result})
                        .then(r => callback(r.value))
                        .catch(err => { console.error(err); alert("DOCX è®€å–å¤±æ•—ï¼Œè«‹è½‰å­˜ .txt"); });
                };
                reader.readAsArrayBuffer(file);
            } else {
                const reader = new FileReader();
                reader.onload = (e) => callback(e.target.result);
                reader.readAsText(file);
            }
        };
        safeListen('syllabus-upload', 'change', (e) => { 
            if(e.target.files[0]) readDocxOrText(e.target.files[0], (txt) => { 
                document.getElementById('syllabus-content').value = txt; 
                saveSyllabusToStorage();
            }); 
        });
        
        safeListen('exam-paper-upload', 'change', (e) => { if(e.target.files[0]) readDocxOrText(e.target.files[0], (txt) => { examPaperText = txt; document.getElementById('paper-status').innerHTML = "âœ… è©¦å·å…§å®¹å·²è¼‰å…¥"; document.getElementById('paper-status').className = "text-xs text-green-600 mt-1 font-bold ml-2"; }); });

        function detectColumns(fields) { if(!fields) return; colMap.name = fields.find(f => f.trim().match(/^Name/i) || f.trim().match(/å§“å/)) || 'Name'; colMap.class = fields.find(f => f.trim().match(/^Class$/i) || f.trim().match(/ç­åˆ¥/)) || 'Class'; colMap.no = fields.find(f => f.trim().match(/Class.*No/i) || f.trim().match(/å­¸è™Ÿ/)) || 'Class_No'; }
        
        function initSystem() {
            document.getElementById('file-status').textContent="âœ… æª”æ¡ˆå·²è¼‰å…¥";
            document.getElementById('main-tabs').classList.remove('hidden');
            questionMap={}; totalPaperMark=0;
            mapData.forEach(row=>{ if(row.Question_ID) { questionMap[row.Question_ID]={ ...row, fullMark:parseFloat(row.Full_Mark)||0, Concept_Detail: row.Concept_Detail || row.Topic_Name }; totalPaperMark+=questionMap[row.Question_ID].fullMark; } });
            switchTab('analysis'); generateAnalysis(); if(mcData.length > 0) processMCData();
            const sel=document.getElementById('student-select');
            if(sel) { while(sel.options.length>2) sel.remove(2); marksheetData.forEach((row,i)=>{ if(row[colMap.name]) sel.add(new Option(`${row[colMap.no]||''} ${row[colMap.name]}`, i)); }); }
        }

        function processMCData() { 
             let cleanMC = mcData.filter(row => row.length > 5); if(cleanMC.length < 3) return;
            let answerKeyRow = cleanMC[1];
            let startRow = 2;
            let headers = cleanMC[0];
            let mcStats = {};
            
            Object.keys(questionMap).forEach(qId => {
                if(qId.startsWith('MC')) {
                    let shortId = qId.replace('MC', 'Q');
                    let colIdx = headers.indexOf(shortId);
                    if(colIdx === -1) colIdx = headers.indexOf(qId);
                    if(colIdx !== -1) {
                        let correctAns = answerKeyRow[colIdx]?.trim().toUpperCase();
                        mcStats[qId] = { A:0, B:0, C:0, D:0, correct: correctAns, total:0, id: qId };
                        for(let i=startRow; i<cleanMC.length; i++) {
                            let ans = cleanMC[i][colIdx]?.trim().toUpperCase();
                            if(['A','B','C','D'].includes(ans)) { mcStats[qId][ans]++; mcStats[qId].total++; }
                        }
                    }
                }
            });

            mcDistractors = {};
            let chartLabels=[], dsA=[], dsB=[], dsC=[], dsD=[], bgA=[], bgB=[], bgC=[], bgD=[];

            Object.keys(mcStats).forEach(qId => {
                let s = mcStats[qId];
                if(s.total > 0) {
                    chartLabels.push(qId);
                    dsA.push((s.A/s.total)*100); dsB.push((s.B/s.total)*100); dsC.push((s.C/s.total)*100); dsD.push((s.D/s.total)*100);
                    const getColor = (opt) => { if(opt === s.correct) return '#4ade80'; if((s[opt]/s.total) > 0.2) return '#f87171'; return '#e5e7eb'; };
                    bgA.push(getColor('A')); bgB.push(getColor('B')); bgC.push(getColor('C')); bgD.push(getColor('D'));
                    let wrongHigh = [];
                    ['A','B','C','D'].forEach(opt => { if(opt !== s.correct && (s[opt]/s.total) > 0.2) wrongHigh.push(`${opt} (${Math.round((s[opt]/s.total)*100)}%)`); });
                    if(wrongHigh.length > 0) { mcDistractors[qId] = { correct: s.correct, wrong: wrongHigh, topic: questionMap[qId].Topic_Name, concept: questionMap[qId].Concept_Detail }; }
                }
            });

            const ctxMC = document.getElementById('mcChart');
            if(ctxMC) {
                if(chartInstances.mc) chartInstances.mc.destroy();
                chartInstances.mc = new Chart(ctxMC, { type: 'bar', data: { labels: chartLabels, datasets: [ { label: 'A', data: dsA, backgroundColor: bgA }, { label: 'B', data: dsB, backgroundColor: bgB }, { label: 'C', data: dsC, backgroundColor: bgC }, { label: 'D', data: dsD, backgroundColor: bgD } ] }, options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true, max: 100 } } } });
            }
            const distList = document.getElementById('mc-distractor-list');
            if(distList) {
                let html = '<h4 class="font-bold text-gray-700 mb-2">ğŸš¨ é‡é»é—œæ³¨é¡Œç›® (é«˜èª˜ç­”åŠ›)</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-3">';
                Object.keys(mcDistractors).forEach(q => { let d = mcDistractors[q]; html += `<div class="distractor-card relative"><div class="font-bold text-red-700 flex justify-between"><span>${q} (æ­£ç¢º: ${d.correct})</span><span class="text-xs bg-red-200 px-2 py-1 rounded text-red-800">èª¤é¸: ${d.wrong.join(', ')}</span></div><div class="text-xs text-gray-600 mt-1"><strong>æ¦‚å¿µ:</strong> ${d.concept}</div><button onclick="analyzeDistractorWithAI('${q}')" class="mt-2 w-full bg-white border border-purple-300 text-purple-700 hover:bg-purple-50 text-xs py-1 rounded shadow-sm flex items-center justify-center"><i class="fas fa-search mr-1"></i> AI æ·±åº¦åˆ†æ</button><div id="analysis-${q}" class="analysis-box"></div></div>`; });
                html += '</div>'; distList.innerHTML = html;
            }
        }

        window.analyzeDistractorWithAI = async function(qId) { 
            const box = document.getElementById(`analysis-${qId}`); const d = mcDistractors[qId];
            if(!examPaperText) { alert("è«‹å…ˆåœ¨ã€Œè³‡æ–™åŒ¯å…¥ã€å€ä¸Šå‚³è©¦å·æª”æ¡ˆ"); return; }
            box.classList.remove('hidden'); box.innerHTML = `<p class="animate-pulse text-purple-600">AI åˆ†æä¸­...</p>`;
            const prompt = `åˆ†æ MC é¡Œ ${qId}ã€‚æ­£ç¢º:${d.correct}, èª¤é¸:${d.wrong.join(', ')}, æ¦‚å¿µ:${d.concept}ã€‚\nè©¦å·å…§å®¹:\n${examPaperText.substring(0,10000)}\n\nè«‹å›ç­”ï¼š1.é¡Œç›®å…§å®¹ 2.æ­£ç¢ºæ€è·¯ 3.èª¤é»åˆ†æ (ç¹é«”ä¸­æ–‡)`;
            try { const res = await callAI(prompt); box.innerHTML = `<div class="markdown-body text-xs">${marked.parse(res)}</div>`; } catch(e) { box.innerHTML = `<span class="text-red-500">${e.message}</span>`; }
        };

        function generateAnalysis() { 
            let students=[], qStats={}, topicAgg={}, diffAgg={Low:{e:0,m:0},Medium:{e:0,m:0},High:{e:0,m:0}};
            Object.keys(questionMap).forEach(q=>qStats[q]={sum:0,count:0,scores:[]});
            marksheetData.forEach(row=>{
                if(!row[colMap.name]) return;
                let sTotal=0, sRow={raw:row};
                Object.keys(questionMap).forEach(qId=>{
                    if(row.hasOwnProperty(qId)) {
                        let sc=parseFloat(row[qId])||0, info=questionMap[qId];
                        sTotal+=sc; qStats[qId].sum+=sc; qStats[qId].count++;
                        if(!topicAgg[info.Topic_ID]) topicAgg[info.Topic_ID]={e:0,m:0,name:info.Topic_Name,id:info.Topic_ID};
                        topicAgg[info.Topic_ID].e+=sc; topicAgg[info.Topic_ID].m+=info.fullMark;
                        if(diffAgg[info.Difficulty]) { diffAgg[info.Difficulty].e+=sc; diffAgg[info.Difficulty].m+=info.fullMark; }
                    }
                });
                sRow.total=sTotal; students.push(sRow);
            });
            const scores=students.map(s=>s.total), mean=scores.reduce((a,b)=>a+b,0)/scores.length;
            document.getElementById('stat-mean').textContent=mean.toFixed(1);
            document.getElementById('stat-pass').textContent=((scores.filter(s=>s/totalPaperMark>=0.5).length/scores.length)*100).toFixed(1)+"%";
            document.getElementById('stat-max').textContent=Math.max(...scores); document.getElementById('stat-min').textContent=Math.min(...scores);
            document.getElementById('stat-sd').textContent=Math.sqrt(scores.reduce((a,b)=>a+Math.pow(b-mean,2),0)/scores.length).toFixed(1);
            const hCont=document.getElementById('heatmap-container'); 
            if(hCont) {
                let hHTML = '';
                Object.values(topicAgg).sort((a,b)=>a.id.localeCompare(b.id)).forEach(t=>{
                    let pct=t.m?(t.e/t.m)*100:0, hue=Math.max(0,Math.min(120,pct*1.2));
                    hHTML+=`<div class="heatmap-item" style="background:hsla(${hue},85%,90%,1);border-color:hsla(${hue},80%,40%,0.5)"><div class="text-xs font-bold opacity-70">${t.id}</div><div class="text-xs truncate px-1" title="${t.name}">${t.name}</div><div class="text-xl font-bold">${pct.toFixed(0)}%</div></div>`;
                });
                hCont.innerHTML = hHTML;
            }
            const ctxDist = document.getElementById('distChart');
            if(ctxDist) { if(chartInstances.dist) chartInstances.dist.destroy(); let bins=new Array(10).fill(0); scores.forEach(s=>{let idx=Math.floor((s/totalPaperMark)*10);if(idx>=10)idx=9;bins[idx]++;}); chartInstances.dist=new Chart(ctxDist,{type:'bar',data:{labels:['0-10%','11-20%','21-30%','31-40%','41-50%','51-60%','61-70%','71-80%','81-90%','91-100%'],datasets:[{label:'äººæ•¸',data:bins,backgroundColor:'#60a5fa',borderRadius:4}]},options:{maintainAspectRatio:false}}); }
            const ctxDiff = document.getElementById('difficultyChart'); // Not in HTML but keep logic
            students.sort((a,b)=>b.total-a.total);
            let highG=students.slice(0,Math.ceil(students.length*0.27)), lowG=students.slice(students.length-Math.ceil(students.length*0.27));
            let items=[];
            Object.keys(questionMap).forEach(qId=>{ let info=questionMap[qId], p=(qStats[qId].sum/qStats[qId].count)/info.fullMark; let d=(highG.reduce((s,x)=>s+(parseFloat(x.raw[qId])||0),0)/highG.length - lowG.reduce((s,x)=>s+(parseFloat(x.raw[qId])||0),0)/lowG.length)/info.fullMark; items.push({id:qId,...info,p,d}); });
            analysisCache=items; renderItemTable('ALL');
        }

        function renderItemTable(f) {
            const tb=document.getElementById('itemTableBody'); if(!tb) return; tb.innerHTML='';
            analysisCache.forEach(i=>{
                if((f==='D_LOW'&&i.d>=0.2)||(f==='P_LOW'&&i.p>=0.3)) return;
                let b=i.Difficulty==='High'?'bg-red-100':(i.Difficulty==='Medium'?'bg-yellow-100':'bg-green-100');
                let dClass = 'text-gray-900'; if(i.d > 0.4) dClass = 'text-green-600 font-bold'; else if(i.d < 0.2) dClass = 'text-red-600 font-bold';
                let ev=[]; if(i.p<0.3)ev.push("é›£"); if(i.d<0.2)ev.push("é‘‘åˆ¥ä½");
                tb.innerHTML+=`<tr class="hover:bg-gray-50"><td class="table-cell font-bold">${i.id}</td><td class="table-cell text-xs">${i.Topic_ID}</td><td class="table-cell"><span class="px-2 rounded text-xs ${b}">${i.Difficulty}</span></td><td class="table-cell">${(i.p*100).toFixed(0)}%</td><td class="table-cell ${dClass}">${i.d.toFixed(2)}</td><td class="table-cell text-xs">${ev.join(', ')}</td></tr>`;
            });
        }
        safeListen('item-filter', 'change',(e)=>renderItemTable(e.target.value));

        // --- SUMMARY REPORT ---
        safeListen('gen-summary-btn', 'click', async () => { 
             const schoolName = document.getElementById('school-name').value;
             const subjectName = document.getElementById('subject-name').value;
             const examInfo = document.getElementById('exam-info').value;
             const syllabus = document.getElementById('syllabus-content').value;
             const examPaperContext = examPaperText ? examPaperText.substring(0, 15000) : "(æœªä¸Šå‚³)";
             document.getElementById('summary-preview-area').innerHTML = `<div class="card p-6"><p class="animate-pulse">ç”Ÿæˆä¸­...</p></div>`;
             
             // ... Prepare stats ...
             const stats = { school_name: schoolName, subject: subjectName, mean: document.getElementById('stat-mean').textContent, pass_rate: document.getElementById('stat-pass').textContent, max: document.getElementById('stat-max').textContent, min: document.getElementById('stat-min').textContent, sd: document.getElementById('stat-sd').textContent, full_mark: totalPaperMark };
             // ... Prepare top/bottom topics ...
             let tAgg={}; marksheetData.forEach(r=>{ if(r[colMap.name]) Object.keys(questionMap).forEach(q=>{ if(r[q]){ let sc=parseFloat(r[q])||0,i=questionMap[q]; if(!tAgg[i.Topic_Name])tAgg[i.Topic_Name]={e:0,m:0}; tAgg[i.Topic_Name].e+=sc;tAgg[i.Topic_Name].m+=i.fullMark;} }) });
             let sortedTopics = Object.keys(tAgg).map(k=>({name:k, pct: tAgg[k].m?tAgg[k].e/tAgg[k].m:0})).sort((a,b)=>b.pct-a.pct);
             stats.top_topics = sortedTopics.slice(0,3).map(t=>`${t.name}`).join(', '); stats.bottom_topics = sortedTopics.slice(-3).map(t=>`${t.name}`).join(', ');
             // ... Flagged ...
             let flagged = analysisCache.filter(i => i.d < 0.2 || i.p < 0.3).map(i => i.id).join(', '); stats.flagged_questions = flagged || "ç„¡";
             
             let mcInfo = "";
             Object.keys(mcDistractors).forEach(q => {
                let d = mcDistractors[q];
                mcInfo += `\n- ${q} (${d.topic}): æ­£ç¢º${d.correct}, èª¤é¸${d.wrong.join(', ')}ã€‚æ¦‚å¿µï¼š${d.concept}`;
             });
             if(!mcInfo) mcInfo = "ç„¡æ˜é¡¯é›†é«”è¿·æ€";

             let prompt = SUMMARY_PROMPT.replace(/{{school_name}}/g, stats.school_name).replace(/{{subject}}/g, stats.subject).replace(/{{exam_info}}/g, examInfo)
                 .replace(/{{mean}}/g, stats.mean).replace(/{{pass_rate}}/g, stats.pass_rate).replace(/{{max}}/g, stats.max).replace(/{{min}}/g, stats.min).replace(/{{sd}}/g, stats.sd)
                 .replace(/{{top_topics}}/g, stats.top_topics).replace(/{{bottom_topics}}/g, stats.bottom_topics).replace(/{{flagged_questions}}/g, stats.flagged_questions)
                 .replace(/{{syllabus}}/g, syllabus).replace(/{{mc_distractors}}/g, mcInfo).replace(/{{exam_paper_content}}/g, examPaperContext);

             try {
                 let md = await callAI(prompt);
                 document.getElementById('summary-preview-area').innerHTML = `<div class="report-page-style preview-wrapper bg-white"><div class="markdown-body text-sm">${marked.parse(md)}</div></div>`;
                 document.getElementById('dl-summary-btn').disabled = false;
                 document.getElementById('print-container').innerHTML = `<div class="report-page-style bg-white"><div class="markdown-body text-sm">${marked.parse(md)}</div></div>`;
             } catch(e) { showErrorModal(e); }
        });
        
        safeListen('dl-summary-btn', 'click', () => { 
            let c = document.getElementById('summary-preview-area').innerHTML;
            const h=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Summary Report</title><script src="https://cdn.tailwindcss.com"><\/script><style>@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap');body{font-family:'Noto Sans TC',sans-serif;padding:20px;background:#f3f4f6;}.report-page-style{width:210mm;min-height:297mm;padding:20mm;background:white;margin:0 auto;box-shadow:0 4px 6px rgba(0,0,0,0.1);}h1{font-size:1.8em;font-weight:bold;margin-bottom:0.5em;}h2{font-size:1.4em;font-weight:bold;margin-top:1em;color:#2563eb;}ul{padding-left:1.5em;list-style:disc;}p{margin-bottom:0.8em;line-height:1.6;}</style></head><body>${c}</body></html>`;
            const b=new Blob([h],{type:'text/html'}), u=URL.createObjectURL(b), a=document.createElement('a');
            a.href=u; a.download=`Summary_Report_${new Date().toISOString().slice(0,10)}.html`; document.body.appendChild(a); a.click();
            setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(u);},100);
        });

        // --- STUDENT REPORT ---
        safeListen('generate-btn', 'click', async()=>{
             const v=document.getElementById('student-select').value; if(!v) return alert("è«‹é¸æ“‡");
             document.getElementById('print-container').innerHTML=''; document.getElementById('report-preview-area').innerHTML='';
             if(v==='ALL') await batchGen(); else await singleGen(parseInt(v));
        });
        // ... (clear/download same as v30) ...
        safeListen('download-btn', 'click',()=>{ 
            let c=document.getElementById('print-container').innerHTML;
            if(!c.trim()) return;
            c = c.replace(/<img[^>]*>/g, "");
            const h=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Report</title><script src="https://cdn.tailwindcss.com"><\/script><style>@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap');body{font-family:'Noto Sans TC',sans-serif;background:#f3f4f6;padding:20px;}.report-page-style{width:210mm;min-height:296mm;padding:20mm;background:white;margin:0 auto 30px;position:relative;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,0.1);border:1px solid #ddd;box-sizing:border-box;}.page-footer{margin-top:40px;padding-top:10px;border-top:1px dashed #ccc;color:#666;font-size:10pt;}@media print{body{background:white;padding:0;}.report-page-style{width:100%;height:296mm;margin:0;box-shadow:none;border:none;break-after:page;page-break-after:always;overflow:hidden;}}h1{font-size:1.6em;color:#1e3a8a;border-bottom:2px solid #ddd;padding-bottom:10px;}h2{font-size:1.3em;color:#2563eb;margin-top:1em;}ul{padding-left:1.5em;list-style:disc;}blockquote{border-left:4px solid #e5e7eb;padding-left:1em;background:#f9fafb;padding:0.5rem;margin:10px 0;}</style></head><body>${c}</body></html>`;
            const b=new Blob([h],{type:'text/html'}), u=URL.createObjectURL(b), a=document.createElement('a');
            a.href=u; a.download=`Reports_${new Date().toISOString().slice(0,10)}.html`; document.body.appendChild(a); a.click();
            setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(u);},100);
        });

        async function batchGen(){
            let validIndices = []; marksheetData.forEach((r, i) => { if(r[colMap.name]) validIndices.push(i); });
            let pb=document.getElementById('progress-bar'), pc=document.getElementById('progress-count');
            document.getElementById('batch-progress').classList.remove('hidden');
            for(let i=0; i<validIndices.length; i++){
                pb.style.width=Math.round(((i+1)/validIndices.length)*100)+'%'; pc.textContent=`${i+1}/${validIndices.length}`;
                await singleGen(validIndices[i], true); await new Promise(r=>setTimeout(r,2000));
            }
            document.getElementById('batch-progress').classList.add('hidden'); alert("å®Œæˆï¼");
        }

        async function singleGen(idx,app=false){
            let row=marksheetData[idx], an=analyzeStudent(row), rid=`rep-${idx}-${Date.now()}`;
            let sName = row[colMap.name] || "æœªçŸ¥";
            let ph=`<div id="${rid}" class="card mb-4 border-l-4 border-gray-400 p-4"><p class="animate-pulse">æ­£åœ¨ç”Ÿæˆ ${sName}...</p></div>`;
            if(!app) document.getElementById('report-preview-area').innerHTML=ph; else document.getElementById('report-preview-area').insertAdjacentHTML('beforeend',ph);
            
            // ... Build prompt ...
            let prompt = DEFAULT_PROMPT.replace('{{student_name}}', sName).replace('{{total_score}}', an.totalScore).replace('{{full_mark}}', totalPaperMark)
                      .replace('{{weaknesses}}', an.bad.join(', ')).replace('{{wrong_concepts}}', an.wrong.join(', ')).replace('{{strengths}}', an.good.join(', '))
                      .replace('{{language_instruction}}', "è«‹ç”¨ç¹é«”ä¸­æ–‡ã€‚").replace('{{section_1_title}}', "æ•´é«”å›é¡§").replace('{{section_2_title}}', "æ¦‚å¿µé‡æº«").replace('{{section_3_title}}', "è‡ªæˆ‘æŒ‘æˆ°")
                      .replace('{{syllabus}}', document.getElementById('syllabus-content').value || "")
                      .replace('{{exam_paper_content}}', examPaperText || "");
            
            try {
                let txt=await callAI(prompt);
                let p1=txt.split('---PAGE_BREAK---')[0], p2=txt.split('---PAGE_BREAK---')[1]||"", ans=p2.split('---ANSWERS---')[1]||"";
                let h = `<div class="report-page-style preview-wrapper bg-white"><div class="markdown-body text-sm">${marked.parse(p1)}</div></div>
                         <div class="report-page-style preview-wrapper bg-white"><div class="markdown-body text-sm">${marked.parse(p2.split('---ANSWERS---')[0])}</div><div class="page-footer text-xs">${marked.parse(ans)}</div></div>`;
                
                if(!app) document.getElementById('report-preview-area').innerHTML=h; else document.getElementById(rid).outerHTML=h;
                let printDiv = document.createElement('div'); printDiv.innerHTML = h;
                while(printDiv.firstChild) document.getElementById('print-container').appendChild(printDiv.firstChild);
            } catch(e) { showErrorModal(e); }
        }

        function showErrorModal(e) { document.getElementById('error-log-content').textContent=e.message; document.getElementById('error-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('error-modal').classList.add('hidden'); }
    </script>
</body>
</html>
