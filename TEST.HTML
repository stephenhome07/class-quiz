<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶œåˆç§‘å­¸ç§‘ - è©¦å·åˆ†æåŠAIå ±å‘Šç³»çµ± (Pro v24)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Mammoth.js for DOCX reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #e5e7eb; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); padding: 1.5rem; }
        .table-header { @apply px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50; }
        .table-cell { @apply px-6 py-4 whitespace-nowrap text-sm text-gray-900; }
        
        .nav-card { @apply flex flex-col items-center justify-center p-4 bg-white border-2 border-transparent rounded-xl shadow-sm cursor-pointer transition-all duration-200 hover:shadow-md hover:border-blue-200; }
        .nav-card.active { @apply border-blue-600 bg-blue-50 text-blue-800 ring-2 ring-blue-200 ring-opacity-50; }
        .nav-card i { @apply text-2xl mb-2 text-gray-400; }
        .nav-card.active i { @apply text-blue-600; }
        .nav-card h3 { @apply font-bold text-base; }
        .nav-card p { @apply text-xs text-gray-500 mt-1 text-center hidden md:block; }

        .heatmap-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; }
        .heatmap-item { @apply p-3 rounded-lg text-center shadow-sm border border-gray-100 flex flex-col justify-center h-24 transition hover:shadow-md transform hover:-translate-y-1; }
        
        /* Markdown */
        .markdown-body h1 { font-size: 1.4em; font-weight: bold; margin-bottom: 0.5em; color: #1e3a8a; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.3em; }
        .markdown-body h2 { font-size: 1.2em; font-weight: bold; margin-top: 1.2em; margin-bottom: 0.5em; color: #2563eb; }
        .markdown-body h3 { font-size: 1.1em; font-weight: bold; margin-top: 1em; color: #4b5563; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body blockquote { border-left: 4px solid #e5e7eb; padding-left: 1em; color: #4b5563; font-style: italic; background-color: #f9fafb; padding: 0.5rem; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin-bottom: 1em; }
        .markdown-body th, .markdown-body td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.9em; }
        .markdown-body th { background-color: #f3f4f6; }

        .report-page-style {
            width: 210mm; min-height: 297mm; padding: 20mm; background: white;
            position: relative; overflow: hidden; font-size: 11pt; box-sizing: border-box;
        }
        .page-footer { margin-top: 40px; padding-top: 10px; border-top: 1px dashed #ccc; font-size: 10pt; color: #666; page-break-inside: avoid; }

        #report-preview-area, #summary-preview-area { display: flex; flex-direction: column; align-items: center; gap: 40px; padding-bottom: 50px; }
        .preview-wrapper { 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); 
            border: 1px solid #d1d5db; 
            margin-bottom: 20px;
        }

        #print-container { display: none; }
        @media print {
            @page { size: A4 portrait; margin: 0; }
            body { background: white; -webkit-print-color-adjust: exact; }
            #app-container, nav, .no-print, #error-modal { display: none !important; }
            #print-container { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            .report-page-style { 
                height: 296mm; width: 100%; page-break-after: always; break-after: page; 
                margin: 0; box-shadow: none; border: none; float: none; 
            }
            .page-footer { position: absolute; bottom: 20mm; left: 20mm; right: 20mm; }
        }

        #error-modal { background: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="text-gray-800">

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full mx-4 border-l-4 border-red-500 relative animate-fade-in-up">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold text-red-600 mb-2"><i class="fas fa-bug mr-2"></i>ç”Ÿæˆå¤±æ•— (Error Report)</h3>
            <div class="bg-gray-100 p-3 rounded text-xs font-mono text-gray-800 overflow-auto max-h-60 mb-4 border border-gray-300" id="error-log-content">Waiting...</div>
            <div id="cors-advice" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                <strong>ğŸ’¡ é€£ç·šè¨ºæ–·ï¼š</strong><br>Proxy é€£ç·šè¢«æ‹’ã€‚å»ºè­°ä½¿ç”¨å®˜æ–¹ Key æˆ–æª¢æŸ¥ç¶²å€ã€‚
            </div>
            <button onclick="copyErrorLog()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded shadow transition flex items-center justify-center">
                <i class="fas fa-copy mr-2"></i> è¤‡è£½å®Œæ•´éŒ¯èª¤å ±å‘Š
            </button>
        </div>
    </div>

    <!-- WRAPPER -->
    <div id="app-container" class="max-w-7xl mx-auto">
        <!-- Navbar -->
        <nav class="bg-blue-700 text-white shadow-lg mb-6">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-microscope text-2xl mr-3"></i>
                        <span class="font-bold text-xl ml-2">ç¶œåˆç§‘å­¸ç§‘ - è©¦å·åˆ†æåŠAIå ±å‘Šç³»çµ± (Pro v24)</span>
                    </div>
                </div>
            </div>
        </nav>

        <div class="px-4 sm:px-6 lg:px-8 pb-12">
            
            <!-- File Upload -->
            <div class="card mb-8 animate-fade-in-up border-l-4 border-blue-500">
                <h2 class="text-lg font-bold text-gray-700 mb-4 pb-2 border-b"><i class="fas fa-file-upload mr-2"></i>1. è³‡æ–™åŒ¯å…¥ (è«‹å…ˆä¸Šå‚³ CSV)</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä¸Šå‚³åˆ†æ•¸è¡¨ (MARKSHEET.csv)</label>
                        <input id="marksheet-upload" type="file" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä¸Šå‚³é¡Œç›®åƒæ•¸è¡¨ (MAP.csv)</label>
                        <input id="map-upload" type="file" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"/>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä¸Šå‚³èª²ç¨‹å¤§ç¶± (Optional)</label>
                        <input id="syllabus-upload" type="file" accept=".txt,.csv,.docx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100"/>
                    </div>
                </div>
                <div id="file-status" class="mt-2 text-sm text-gray-400 text-right italic">ç­‰å¾…æª”æ¡ˆ...</div>
            </div>

            <!-- TABS -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 hidden" id="main-tabs">
                <div onclick="switchTab('analysis')" class="nav-card active" id="tab-analysis">
                    <i class="fas fa-chart-pie"></i>
                    <h3>å…¨ç­æ•¸æ“šåˆ†æ</h3>
                    <p>ç†±é»åœ–ã€åˆ†ä½ˆåœ–</p>
                </div>
                <div onclick="switchTab('summary')" class="nav-card" id="tab-summary">
                    <i class="fas fa-file-alt"></i>
                    <h3>ç¶œåˆå ±å‘Š</h3>
                    <p>çµ¦æ ¡é•·/ç§‘ä¸»ä»»çš„å ±å‘Š</p>
                </div>
                <div onclick="switchTab('report')" class="nav-card" id="tab-report">
                    <i class="fas fa-user-graduate"></i>
                    <h3>å­¸ç”Ÿ AI å ±å‘Š</h3>
                    <p>å€‹åˆ¥è¨ºæ–·ã€ç­†è¨˜</p>
                </div>
                <div onclick="switchTab('settings')" class="nav-card" id="tab-settings">
                    <i class="fas fa-sliders-h"></i>
                    <h3>è¨­å®š</h3>
                    <p>Prompt & èª²ç¨‹ç¯„åœ</p>
                </div>
            </div>

            <!-- VIEW 1: ANALYSIS -->
            <div id="view-analysis" class="hidden space-y-8">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="card border-t-4 border-blue-500"><div class="text-gray-500 text-sm">å¹³å‡åˆ†</div><div class="text-3xl font-bold mt-1" id="stat-mean">--</div></div>
                    <div class="card border-t-4 border-green-500"><div class="text-gray-500 text-sm">åŠæ ¼ç‡</div><div class="text-3xl font-bold mt-1" id="stat-pass">--%</div></div>
                    <div class="card border-t-4 border-yellow-500"><div class="text-gray-500 text-sm">æœ€é«˜/æœ€ä½</div><div class="text-3xl font-bold mt-1"><span id="stat-max" class="text-green-600">--</span>/<span id="stat-min" class="text-red-600">--</span></div></div>
                    <div class="card border-t-4 border-purple-500"><div class="text-gray-500 text-sm">æ¨™æº–å·®</div><div class="text-3xl font-bold mt-1" id="stat-sd">--</div></div>
                </div>
                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card flex flex-col h-full">
                        <h3 class="text-lg font-bold mb-4"><i class="fas fa-fire-alt text-red-500 mr-2"></i>å¼·å¼±èª²é¡Œç†±é»åœ–</h3>
                        <div class="flex justify-between text-xs mb-2"><span><span class="w-3 h-3 bg-red-200 inline-block mr-1"></span>å¼±</span><span><span class="w-3 h-3 bg-green-200 inline-block mr-1"></span>å¼·</span></div>
                        <div id="heatmap-container" class="heatmap-grid overflow-y-auto max-h-64 p-1 flex-grow"></div>
                    </div>
                    <div class="card flex flex-col h-full">
                        <h3 class="text-lg font-bold mb-4"><i class="fas fa-chart-bar text-blue-500 mr-2"></i>æˆç¸¾åˆ†ä½ˆ</h3>
                        <div class="relative h-64 w-full"><canvas id="distChart"></canvas></div>
                    </div>
                </div>
                <!-- Item Table -->
                <div class="card overflow-hidden">
                    <div class="flex justify-between items-center mb-4 border-b pb-4">
                        <h3 class="text-lg font-bold"><i class="fas fa-list-ol text-purple-500 mr-2"></i>é¡Œé …åˆ†æ</h3>
                        <select id="item-filter" class="p-1 border rounded text-sm"><option value="ALL">å…¨éƒ¨</option><option value="D_LOW">é‘‘åˆ¥åº¦ä½</option><option value="P_LOW">é¡Œç›®éé›£</option></select>
                    </div>
                    <div class="overflow-x-auto max-h-96 border rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr><th class="table-header">é¡Œè™Ÿ</th><th class="table-header">èª²é¡Œ</th><th class="table-header">é›£åº¦</th><th class="table-header">P</th><th class="table-header">D</th><th class="table-header">è©•åƒ¹</th></tr></thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="itemTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: SUMMARY REPORT -->
            <div id="view-summary" class="hidden space-y-8">
                <div class="card bg-orange-50 border-l-4 border-orange-500">
                    <h2 class="text-lg font-bold text-gray-700 mb-2"><i class="fas fa-file-alt mr-2"></i>è€ƒè©¦æˆç¸¾èˆ‡æ•™å­¸æª¢è¨å ±å‘Š</h2>
                    <p class="text-sm text-gray-600 mb-4">æ­¤åŠŸèƒ½æœƒæ•´åˆå…¨ç­æ•¸æ“šï¼Œç‚ºç§‘ä¸»ä»»/æ ¡é•·ç”Ÿæˆä¸€ä»½å°ˆæ¥­çš„æ•™å­¸è©•ä¼°èˆ‡è·Ÿé€²å ±å‘Šã€‚</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">å­¸æ ¡åç¨±</label>
                            <input id="school-name" type="text" value="å—‡è‰²åœ’ä¸»è¾¦å¯è­½ä¸­å­¸æš¨å°å­¸" class="w-full p-2 border rounded text-sm bg-white">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ç§‘ç›®</label>
                            <input id="subject-name" type="text" value="ç¶œåˆç§‘å­¸ç§‘" class="w-full p-2 border rounded text-sm bg-white">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">è€ƒè©¦å¹´ä»½åŠç´šåˆ¥</label>
                            <input id="exam-info" type="text" placeholder="e.g. 2025-2026 å¹´åº¦ä¸Šå­¸æœŸ ä¸­äºŒç´š" class="w-full p-2 border rounded text-sm bg-white">
                        </div>
                    </div>

                    <div class="flex gap-4 justify-end">
                        <button id="gen-summary-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-6 rounded shadow transition flex items-center">
                            <i class="fas fa-magic mr-2"></i> ç”Ÿæˆç¶œåˆå ±å‘Š
                        </button>
                        <button id="dl-summary-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded shadow transition disabled:opacity-50" disabled>
                            <i class="fas fa-download mr-2"></i> ä¸‹è¼‰å ±å‘Š
                        </button>
                    </div>
                </div>
                <div id="summary-preview-area"></div>
            </div>

            <!-- VIEW 3: STUDENT AI REPORTS -->
            <div id="view-report" class="hidden space-y-8">
                <div class="card">
                    <h2 class="text-lg font-bold mb-4 border-b pb-2"><i class="fas fa-user-graduate mr-2"></i>å­¸ç”Ÿå€‹åˆ¥å ±å‘Š</h2>
                    <div class="flex flex-col md:flex-row gap-4 items-end">
                        <div class="w-full md:w-1/4">
                            <label class="block text-sm font-medium mb-1">å ±å‘Šèªè¨€</label>
                            <select id="report-language" class="w-full p-2 border rounded font-bold text-indigo-600">
                                <option value="zh">ç¹é«”ä¸­æ–‡</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <div class="flex-grow w-full">
                            <label class="block text-sm font-medium mb-1">é¸æ“‡å­¸ç”Ÿ</label>
                            <select id="student-select" class="w-full p-2 border rounded"><option value="">è«‹é¸æ“‡...</option><option value="ALL">ã€ ğŸš€ æ‰¹é‡ç”Ÿæˆ ã€‘å…¨ç­</option></select>
                        </div>
                        <button id="generate-btn" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow"><i class="fas fa-play mr-2"></i>ç”Ÿæˆ</button>
                        <button onclick="window.print()" id="print-btn" class="w-full md:w-auto bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded shadow" disabled><i class="fas fa-print mr-2"></i>åˆ—å°/PDF</button>
                        <button id="download-btn" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow" disabled><i class="fas fa-file-download mr-2"></i>ä¸‹è¼‰HTML</button>
                    </div>
                    <div id="batch-progress" class="hidden mt-6 bg-gray-50 p-4 rounded border"><div class="flex justify-between text-xs font-bold mb-2"><span id="progress-text">ç”Ÿæˆä¸­...</span><span id="progress-count">0/0</span></div><div class="w-full bg-gray-200 rounded-full h-3"><div id="progress-bar" class="bg-indigo-600 h-3 rounded-full" style="width:0%"></div></div></div>
                </div>
                <div id="report-preview-area" class="w-full"></div>
            </div>

            <!-- VIEW 4: SETTINGS (NEW SYLLABUS) -->
            <div id="view-settings" class="hidden space-y-8">
                <!-- Syllabus Config -->
                <div class="card border-l-4 border-green-500 mb-6">
                    <h2 class="text-lg font-bold text-gray-700 mb-2"><i class="fas fa-book mr-2"></i>èª²ç¨‹ç¯„åœ / å¤§ç¶± (Syllabus Scope)</h2>
                    <p class="text-sm text-gray-600 mb-3">åœ¨æ­¤è¼¸å…¥èª²ç¨‹å¤§ç¶±ï¼ŒAI ç”Ÿæˆå ±å‘Šæ™‚å°‡æœƒåƒè€ƒæ­¤ç¯„åœï¼Œé¿å…è¶…ç¶±ï¼ˆä¾‹å¦‚ï¼šé¿å…åœ¨ä¸­äºŒç´šä½¿ç”¨ F=maï¼‰ã€‚</p>
                    <textarea id="syllabus-content" class="w-full h-40 p-4 border border-gray-300 rounded font-mono text-sm bg-gray-50 focus:ring-2 focus:ring-green-500" placeholder="åœ¨æ­¤è²¼ä¸Šèª²ç¨‹å¤§ç¶±é‡é»ï¼Œä¾‹å¦‚ï¼š
1. é‹å‹•ï¼šåªæ¶‰åŠå¹³å‡é€Ÿç‡è¨ˆç®— (d/t)ï¼Œä¸æ¶‰åŠåŠ é€Ÿåº¦ã€‚
2. åŠ›ï¼šåªæ¶‰åŠåŠ›çš„é‡åº¦èˆ‡å¹³è¡¡ï¼Œä¸æ¶‰åŠç‰›é “ç¬¬äºŒå®šå¾‹å…¬å¼ã€‚
..."></textarea>
                    <div class="flex justify-end mt-2">
                        <button onclick="saveSyllabus()" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-4 rounded shadow"><i class="fas fa-save mr-1"></i>å„²å­˜å¤§ç¶±</button>
                    </div>
                </div>

                <!-- AI Config -->
                <div class="card bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 mb-6">
                    <h3 class="text-md font-bold text-gray-800 mb-3"><i class="fas fa-robot mr-2"></i>API è¨­å®š</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">æ¨¡å‹</label>
                            <select id="model-provider" class="w-full text-sm border p-2 rounded">
                                <option value="gemini">Google Gemini</option>
                                <option value="deepseek" selected>DeepSeek / OpenAI Compatible</option>
                            </select>
                        </div>
                        <div class="md:col-span-2 hidden" id="ds-config">
                            <div class="grid grid-cols-2 gap-2">
                                <input id="ds-url" type="text" value="https://apiproxy.k12gpt.ai/NPcj-7_" class="text-xs p-2 border rounded" placeholder="API URL">
                                <input id="ds-model" type="text" value="deepseek-chat" class="text-xs p-2 border rounded" placeholder="Model">
                            </div>
                            <div class="mt-2 flex items-center bg-white p-2 rounded border border-gray-200">
                                <input type="checkbox" id="ds-auto-path" class="mr-2" checked>
                                <label for="ds-auto-path" class="text-xs font-bold cursor-pointer select-none">è‡ªå‹•è£œå…¨ /chat/completions (å«æ™ºèƒ½é›™é‡è·¯å¾‘æ¸¬è©¦)</label>
                            </div>
                            <div class="mt-2"><input id="ds-key" type="password" placeholder="API Key (Optional)" class="w-full text-xs p-2 border rounded"></div>
                        </div>
                        <div class="md:col-span-2 hidden" id="gemini-config">
                            <input id="gemini-key" type="password" placeholder="Gemini API Key" class="w-full text-xs p-2 border rounded">
                        </div>
                    </div>
                </div>

                <!-- Prompt Config -->
                <div class="card border-l-4 border-purple-500">
                    <h2 class="text-lg font-bold text-gray-700 mb-4 pb-2 border-b"><i class="fas fa-edit mr-2"></i>è‡ªè¨‚å­¸ç”Ÿå ±å‘ŠæŒ‡ä»¤ (System Prompt)</h2>
                    <p class="text-sm text-gray-600 mb-2">ä¿ç•™ `{{student_name}}` å’Œ `{{syllabus}}` ç­‰è®Šæ•¸ã€‚</p>
                    <textarea id="prompt-template" class="w-full h-64 p-4 border border-gray-300 rounded font-mono text-sm bg-gray-50 focus:ring-2 focus:ring-purple-500" spellcheck="false"></textarea>
                    <div class="flex justify-end gap-4 mt-4">
                        <button onclick="resetPrompt()" class="text-gray-500 hover:text-gray-700 text-sm font-bold px-4 py-2">æ¢å¾©é è¨­</button>
                        <button onclick="savePrompt()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded shadow transition"><i class="fas fa-save mr-2"></i>å„²å­˜è¨­å®š</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="print-container"></div>

    <script>
        const renderer = new marked.Renderer();
        renderer.image = function(href, title, text) { return `<span style="color:#999; font-size:0.8em; border:1px dashed #ccc; padding:2px 5px;">[åœ–ç‰‡å·²ç§»é™¤]</span>`; };
        marked.setOptions({ renderer: renderer });

        let marksheetData=[], mapData=[], questionMap={}, totalPaperMark=0, chartInstances={}, analysisCache=null, colMap={name:'',class:'',no:''};
        
        // --- PROMPTS ---
        const DEFAULT_PROMPT = `
ä½ æ˜¯ä¸€ä½ç§‘å­¸è€å¸«ã€‚è«‹ç‚ºå­¸ç”Ÿ {{student_name}} è£½ä½œä¸€ä»½å…©é çš„å­¸ç¿’å ±å‘Šã€‚
ç¸½åˆ†ï¼š{{total_score}} / {{full_mark}}ã€‚
å¼±é …ï¼š{{weaknesses}}ã€‚
éŒ¯é¡Œæ¦‚å¿µï¼š{{wrong_concepts}}ã€‚
å¼·é …ï¼š{{strengths}}ã€‚

{{language_instruction}}

ã€èª²ç¨‹ç¯„åœåƒè€ƒ (Syllabus Scope)ã€‘ï¼š
{{syllabus}}

è«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¼¸å‡ºï¼Œå¿…é ˆåŒ…å«åˆ†éš”ç¬¦è™Ÿï¼Œçµ•å°ä¸è¦ç”Ÿæˆä»»ä½•åœ–ç‰‡ï¼š

1. **{{section_1_title}}**
   - ç°¡çŸ­é¼“å‹µ
   - é»åˆ—æŒ‡å‡ºå¼·é …
   - é»åˆ—æŒ‡å‡ºéœ€æ”¹å–„ä¹‹è™•
   (æ–‡å­—ç°¡è¦)

2. **{{section_2_title}}**
   (é‡å°æ¯ä¸€å€‹ã€Œéœ€æ”¹å–„çš„èª²é¡Œã€ï¼Œä»¥ã€Œç­†è¨˜å½¢å¼ã€è§£é‡‹é‡é»æ¦‚å¿µã€‚è«‹å‹™å¿…ä½¿ç”¨ç”Ÿæ´»æ¯”å–»ï¼Œç°¡æ˜“æ˜ç™½ã€‚ä¾‹å¦‚ï¼šã€Œæ‘©æ“¦åŠ›ï¼šå°±åƒåœ°é¢æœ‰çœ‹ä¸è¦‹çš„å°æ‰‹...ã€ã€‚æ³¨æ„ï¼šå…§å®¹ä¸å¯è¶…å‡ºä¸Šè¿°èª²ç¨‹ç¯„åœã€‚)

---PAGE_BREAK---

3. **{{section_3_title}}** (5 æ¢é¸æ“‡é¡Œï¼Œç´”æ–‡å­—)
   (é¡Œç›®å¿…é ˆåœ¨èª²ç¨‹ç¯„åœå…§)

---ANSWERS---

(ç­”æ¡ˆåŠç°¡çŸ­è§£é‡‹)
`.trim();

        const SUMMARY_PROMPT = `
ä½ æ˜¯ä¸€ä½è³‡æ·±çš„ {{subject}} ç§‘ä¸»ä»»ã€‚è«‹æ ¹æ“šä»¥ä¸‹å…¨ç­è€ƒè©¦æ•¸æ“šï¼Œç‚ºæ ¡é•·æ’°å¯«ä¸€ä»½å°ˆæ¥­çš„ã€Œè€ƒè©¦æˆç¸¾èˆ‡æ•™å­¸æª¢è¨å ±å‘Šã€ã€‚

å­¸æ ¡ï¼š{{school_name}}
è€ƒè©¦å¹´ä»½åŠç´šåˆ¥ï¼š{{exam_info}}
ç§‘ç›®ï¼š{{subject}}
å¹³å‡åˆ†ï¼š{{mean}} / {{full_mark}}
åŠæ ¼ç‡ï¼š{{pass_rate}}
æœ€é«˜/æœ€ä½åˆ†ï¼š{{max}} / {{min}}
æ¨™æº–å·®ï¼š{{sd}}

ã€å¼·é …èª²é¡Œã€‘ï¼š{{top_topics}}
ã€å¼±é …èª²é¡Œã€‘ï¼š{{bottom_topics}}
ã€éœ€é—œæ³¨é¡Œç›® (é‘‘åˆ¥åº¦ä½æˆ–éé›£)ã€‘ï¼š{{flagged_questions}}

ã€èª²ç¨‹ç¯„åœåƒè€ƒã€‘ï¼š
{{syllabus}}

è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œä»¥å°ˆæ¥­å…¬æ–‡èªæ°£æ’°å¯«ï¼Œæ ¼å¼å¦‚ä¸‹ï¼ˆä¸è¦åœ–ç‰‡ï¼‰ï¼š

# è€ƒè©¦æˆç¸¾èˆ‡æ•™å­¸æª¢è¨å ±å‘Š

**1. è€ƒè©¦æˆç¸¾æ‘˜è¦**
(ç°¡è¿°æ•´é«”è¡¨ç¾ï¼Œæ¯”è¼ƒå¹³å‡åˆ†èˆ‡åŠæ ¼ç‡æ˜¯å¦ç†æƒ³)

**2. å­¸ç”Ÿå¼·å¼±é …åˆ†æ**
* **å¼·é …**ï¼š(åˆ†æå­¸ç”Ÿåœ¨å“ªäº›èª²é¡Œè¡¨ç¾è¼ƒå¥½ï¼Œé¡¯ç¤ºæŒæ¡äº†ä»€éº¼æ¦‚å¿µ)
* **å¼±é …**ï¼š(æ·±å…¥åˆ†æå¼±é …èª²é¡Œï¼Œæ¨æ¸¬å­¸ç”Ÿæ¦‚å¿µä¸æ¸…çš„åŸå› ï¼Œä¾‹å¦‚ï¼šæ··æ·†äº†...ï¼Œæœªèƒ½æŒæ¡...)

**3. è©¦é¡Œè³ªç´ æª¢è¨**
(é‡å°ã€Œéœ€é—œæ³¨é¡Œç›®ã€é€²è¡Œåˆ†æï¼Œä¾‹å¦‚é¡Œç›®æ˜¯å¦è¨­è¨ˆæœ‰èª¤ï¼Œæˆ–æ˜¯å¦è¶…å‡ºå­¸ç”Ÿèƒ½åŠ›)

**4. å­¸èˆ‡æ•™åæ€åŠè·Ÿé€²å»ºè­°**
(å…·é«”å»ºè­°ä¸‹å­¸æœŸæˆ–è£œèª²æ™‚å¦‚ä½•æ”¹å–„ã€‚ä¾‹å¦‚ï¼šå¢åŠ å¯¦é©—ç’°ç¯€ã€åŠ å¼·é—œéµå­—æ“ç·´ã€é‡å°å¼±é …èª²é¡Œçš„å…·é«”é‡æº«ç­–ç•¥ã€‚å»ºè­°éœ€ç¬¦åˆèª²ç¨‹ç¯„åœã€‚)

`.trim();

        // Load Settings
        let customPrompt = localStorage.getItem('science_exam_prompt') || DEFAULT_PROMPT;
        let savedSyllabus = localStorage.getItem('science_exam_syllabus') || "";
        
        const pt = document.getElementById('prompt-template'); if(pt) pt.value = customPrompt;
        const st = document.getElementById('syllabus-content'); if(st) st.value = savedSyllabus;

        function savePrompt() {
            customPrompt = document.getElementById('prompt-template').value;
            localStorage.setItem('science_exam_prompt', customPrompt);
            alert("âœ… Prompt è¨­å®šå·²å„²å­˜");
        }

        function saveSyllabus() {
            savedSyllabus = document.getElementById('syllabus-content').value;
            localStorage.setItem('science_exam_syllabus', savedSyllabus);
            alert("âœ… èª²ç¨‹å¤§ç¶±å·²å„²å­˜");
        }

        function resetPrompt() {
            if(confirm("ç¢ºå®šè¦æ¢å¾©é è¨­æŒ‡ä»¤å—ï¼Ÿ")) {
                customPrompt = DEFAULT_PROMPT;
                document.getElementById('prompt-template').value = customPrompt;
                localStorage.setItem('science_exam_prompt', customPrompt);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-card').forEach(b=>b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            ['view-analysis','view-summary','view-report','view-settings'].forEach(id => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); });
            const target = document.getElementById(`view-${tab}`); if(target) target.classList.remove('hidden');
        }

        document.getElementById('model-provider').addEventListener('change', (e)=>{
            const isDeep = e.target.value === 'deepseek';
            document.getElementById('ds-config').classList.toggle('hidden', !isDeep);
            document.getElementById('gemini-config').classList.toggle('hidden', isDeep);
        });

        // --- SAFE LISTENER HELPER ---
        const safeListen = (id, event, fn) => {
            const el = document.getElementById(id);
            if(el) el.addEventListener(event, fn);
            else console.warn(`Element #${id} missing for event ${event}`);
        };

        function handleFile(file, type) {
            if(!file) return;
            Papa.parse(file, {header:true, skipEmptyLines:true, complete:(res)=>{
                if(type==='marksheet') { marksheetData=res.data; detectColumns(res.meta.fields); }
                else { mapData=res.data; }
                if(marksheetData.length && mapData.length) initSystem();
            }});
        }
        safeListen('marksheet-upload', 'change', (e)=>handleFile(e.target.files[0],'marksheet'));
        safeListen('map-upload', 'change', (e)=>handleFile(e.target.files[0],'map'));

        // --- SYLLABUS HANDLER ---
        safeListen('syllabus-upload', 'change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            
            if (file.name.endsWith('.docx')) {
                reader.onload = function(event) {
                    const arrayBuffer = event.target.result;
                    mammoth.extractRawText({arrayBuffer: arrayBuffer})
                        .then(function(result){
                            document.getElementById('syllabus-content').value = result.value;
                            saveSyllabus(); // Auto save
                        })
                        .catch(function(err){
                            console.log(err);
                            alert("DOCX è®€å–å¤±æ•—ï¼Œè«‹å˜—è©¦å­˜ç‚º .txt");
                        });
                };
                reader.readAsArrayBuffer(file);
            } else {
                reader.onload = function(event) {
                    document.getElementById('syllabus-content').value = event.target.result;
                    saveSyllabus(); // Auto save
                };
                reader.readAsText(file);
            }
        });

        function detectColumns(fields) {
            if(!fields) return;
            colMap.name = fields.find(f => f.trim().match(/^Name/i) || f.trim().match(/å§“å/)) || 'Name';
            colMap.class = fields.find(f => f.trim().match(/^Class$/i) || f.trim().match(/ç­åˆ¥/)) || 'Class';
            colMap.no = fields.find(f => f.trim().match(/Class.*No/i) || f.trim().match(/å­¸è™Ÿ/)) || 'Class_No';
        }

        function initSystem() {
            document.getElementById('file-status').textContent="âœ… æª”æ¡ˆå·²è¼‰å…¥";
            document.getElementById('main-tabs').classList.remove('hidden');
            questionMap={}; totalPaperMark=0;
            mapData.forEach(row=>{
                if(row.Question_ID) { 
                    questionMap[row.Question_ID]={
                        ...row, 
                        fullMark:parseFloat(row.Full_Mark)||0,
                        Concept_Detail: row.Concept_Detail || row.Topic_Name 
                    }; 
                    totalPaperMark+=questionMap[row.Question_ID].fullMark; 
                }
            });
            switchTab('analysis'); 
            generateAnalysis();
            const sel=document.getElementById('student-select');
            if(sel) {
                while(sel.options.length>2) sel.remove(2);
                marksheetData.forEach((row,i)=>{ if(row[colMap.name]) sel.add(new Option(`${row[colMap.no]||''} ${row[colMap.name]}`, i)); });
            }
        }

        function generateAnalysis() {
            let students=[], qStats={}, topicAgg={}, diffAgg={Low:{e:0,m:0},Medium:{e:0,m:0},High:{e:0,m:0}};
            Object.keys(questionMap).forEach(q=>qStats[q]={sum:0,count:0,scores:[]});
            marksheetData.forEach(row=>{
                if(!row[colMap.name]) return;
                let sTotal=0, sRow={raw:row};
                Object.keys(questionMap).forEach(qId=>{
                    if(row.hasOwnProperty(qId)) {
                        let sc=parseFloat(row[qId])||0, info=questionMap[qId];
                        sTotal+=sc; qStats[qId].sum+=sc; qStats[qId].count++;
                        if(!topicAgg[info.Topic_ID]) topicAgg[info.Topic_ID]={e:0,m:0,name:info.Topic_Name,id:info.Topic_ID};
                        topicAgg[info.Topic_ID].e+=sc; topicAgg[info.Topic_ID].m+=info.fullMark;
                        if(diffAgg[info.Difficulty]) { diffAgg[info.Difficulty].e+=sc; diffAgg[info.Difficulty].m+=info.fullMark; }
                    }
                });
                sRow.total=sTotal; students.push(sRow);
            });

            const scores=students.map(s=>s.total), mean=scores.reduce((a,b)=>a+b,0)/scores.length;
            document.getElementById('stat-mean').textContent=mean.toFixed(1);
            document.getElementById('stat-pass').textContent=((scores.filter(s=>s/totalPaperMark>=0.5).length/scores.length)*100).toFixed(1)+"%";
            document.getElementById('stat-max').textContent=Math.max(...scores); document.getElementById('stat-min').textContent=Math.min(...scores);
            document.getElementById('stat-sd').textContent=Math.sqrt(scores.reduce((a,b)=>a+Math.pow(b-mean,2),0)/scores.length).toFixed(1);

            const hCont=document.getElementById('heatmap-container'); 
            if(hCont) {
                let hHTML = '';
                Object.values(topicAgg).sort((a,b)=>a.id.localeCompare(b.id)).forEach(t=>{
                    let pct=t.m?(t.e/t.m)*100:0, hue=Math.max(0,Math.min(120,pct*1.2));
                    hHTML+=`<div class="heatmap-item" style="background:hsla(${hue},85%,90%,1);border-color:hsla(${hue},80%,40%,0.5)"><div class="text-xs font-bold opacity-70">${t.id}</div><div class="text-xs truncate px-1" title="${t.name}">${t.name}</div><div class="text-xl font-bold">${pct.toFixed(0)}%</div></div>`;
                });
                hCont.innerHTML = hHTML;
            }

            const ctxDist = document.getElementById('distChart');
            if (ctxDist) {
                if(chartInstances.dist) chartInstances.dist.destroy();
                let bins=new Array(10).fill(0); scores.forEach(s=>{let idx=Math.floor((s/totalPaperMark)*10);if(idx>=10)idx=9;bins[idx]++;});
                chartInstances.dist=new Chart(ctxDist,{type:'bar',data:{labels:['0-10%','11-20%','21-30%','31-40%','41-50%','51-60%','61-70%','71-80%','81-90%','91-100%'],datasets:[{label:'äººæ•¸',data:bins,backgroundColor:'#60a5fa',borderRadius:4}]},options:{maintainAspectRatio:false}});
            }

            const ctxDiff = document.getElementById('difficultyChart');
            if (ctxDiff) {
                if(chartInstances.diff) chartInstances.diff.destroy();
                let dL=['Low','Medium','High'];
                chartInstances.diff=new Chart(ctxDiff,{type:'bar',data:{labels:dL,datasets:[{label:'å¾—åˆ†ç‡%',data:dL.map(d=>diffAgg[d].m?(diffAgg[d].e/diffAgg[d].m)*100:0),backgroundColor:['#86efac','#fde047','#fca5a5'],borderRadius:4}]},options:{maintainAspectRatio:false,scales:{y:{max:100}}}});
            }

            students.sort((a,b)=>b.total-a.total);
            let highG=students.slice(0,Math.ceil(students.length*0.27)), lowG=students.slice(students.length-Math.ceil(students.length*0.27));
            let items=[];
            Object.keys(questionMap).forEach(qId=>{
                let info=questionMap[qId], p=(qStats[qId].sum/qStats[qId].count)/info.fullMark;
                let d=(highG.reduce((s,x)=>s+(parseFloat(x.raw[qId])||0),0)/highG.length - lowG.reduce((s,x)=>s+(parseFloat(x.raw[qId])||0),0)/lowG.length)/info.fullMark;
                items.push({id:qId,...info,p,d});
            });
            analysisCache=items; renderItemTable('ALL');
        }

        function renderItemTable(f) {
            const tb=document.getElementById('itemTableBody'); 
            if(!tb) return;
            tb.innerHTML='';
            analysisCache.forEach(i=>{
                if((f==='D_LOW'&&i.d>=0.2)||(f==='P_LOW'&&i.p>=0.3)) return;
                let b=i.Difficulty==='High'?'bg-red-100':(i.Difficulty==='Medium'?'bg-yellow-100':'bg-green-100');
                let dClass = 'text-gray-900';
                if(i.d > 0.4) dClass = 'text-green-600 font-bold'; else if(i.d < 0.2) dClass = 'text-red-600 font-bold';
                let ev=[]; if(i.p<0.3)ev.push("é›£"); if(i.d<0.2)ev.push("é‘‘åˆ¥ä½");
                tb.innerHTML+=`<tr class="hover:bg-gray-50"><td class="table-cell font-bold">${i.id}</td><td class="table-cell text-xs">${i.Topic_ID}</td><td class="table-cell"><span class="px-2 rounded text-xs ${b}">${i.Difficulty}</span></td><td class="table-cell">${(i.p*100).toFixed(0)}%</td><td class="table-cell ${dClass}">${i.d.toFixed(2)}</td><td class="table-cell text-xs">${ev.join(', ')}</td></tr>`;
            });
        }
        safeListen('item-filter', 'change',(e)=>renderItemTable(e.target.value));

        // --- SUMMARY REPORT ---
        safeListen('gen-summary-btn', 'click', async () => {
            const schoolName = document.getElementById('school-name').value || "å—‡è‰²åœ’ä¸»è¾¦å¯è­½ä¸­å­¸æš¨å°å­¸";
            const subjectName = document.getElementById('subject-name').value || "ç¶œåˆç§‘å­¸ç§‘";
            const examInfo = document.getElementById('exam-info').value || "ï¼ˆæœªå¡«å¯«è€ƒè©¦å¹´ä»½ï¼‰";
            const syllabus = document.getElementById('syllabus-content').value || "(æœªæä¾›èª²ç¨‹å¤§ç¶±)";
            
            document.getElementById('summary-preview-area').innerHTML = `<div class="card p-6"><p class="animate-pulse text-gray-600"><i class="fas fa-spinner fa-spin mr-2"></i>AI æ­£åœ¨æ’°å¯«ç¶œåˆå ±å‘Š...</p></div>`;
            
            const stats = {
                school_name: schoolName,
                subject: subjectName,
                mean: document.getElementById('stat-mean').textContent,
                pass_rate: document.getElementById('stat-pass').textContent,
                max: document.getElementById('stat-max').textContent,
                min: document.getElementById('stat-min').textContent,
                sd: document.getElementById('stat-sd').textContent,
                full_mark: totalPaperMark
            };

            if(!analysisCache) { alert("è«‹å…ˆè¼‰å…¥æ•¸æ“š"); return; }
            let tAgg = {};
            marksheetData.forEach(row => {
                if(!row[colMap.name]) return;
                Object.keys(questionMap).forEach(qId => {
                    if(row[qId]) {
                        let sc = parseFloat(row[qId])||0, info=questionMap[qId];
                        if(!tAgg[info.Topic_Name]) tAgg[info.Topic_Name] = {e:0, m:0};
                        tAgg[info.Topic_Name].e+=sc; tAgg[info.Topic_Name].m+=info.fullMark;
                    }
                });
            });
            let sortedTopics = Object.keys(tAgg).map(k=>({name:k, pct: tAgg[k].m?tAgg[k].e/tAgg[k].m:0})).sort((a,b)=>b.pct-a.pct);
            stats.top_topics = sortedTopics.slice(0,3).map(t=>`${t.name} (${(t.pct*100).toFixed(0)}%)`).join(', ');
            stats.bottom_topics = sortedTopics.slice(-3).map(t=>`${t.name} (${(t.pct*100).toFixed(0)}%)`).join(', ');
            let flagged = analysisCache.filter(i => i.d < 0.2 || i.p < 0.3).map(i => `${i.id} (P:${(i.p*100).toFixed(0)}%, D:${i.d.toFixed(2)})`).join(', ');
            stats.flagged_questions = flagged || "ç„¡æ˜é¡¯ç•°å¸¸é¡Œç›®";

            let prompt = SUMMARY_PROMPT.replace('{{school_name}}', stats.school_name)
                                       .replace('{{subject}}', stats.subject).replace(/{{subject}}/g, stats.subject)
                                       .replace('{{exam_info}}', examInfo)
                                       .replace('{{mean}}', stats.mean).replace('{{full_mark}}', stats.full_mark)
                                       .replace('{{pass_rate}}', stats.pass_rate)
                                       .replace('{{max}}', stats.max).replace('{{min}}', stats.min).replace('{{sd}}', stats.sd)
                                       .replace('{{top_topics}}', stats.top_topics)
                                       .replace('{{bottom_topics}}', stats.bottom_topics)
                                       .replace('{{flagged_questions}}', stats.flagged_questions)
                                       .replace('{{syllabus}}', syllabus);

            try {
                let md = await callAI(prompt);
                let html = `
                <div class="report-page-style preview-wrapper bg-white">
                    <div class="text-center border-b-2 border-gray-800 pb-4 mb-6">
                        <h1 class="text-3xl font-bold text-gray-900">${schoolName}</h1>
                        <h2 class="text-xl text-gray-700 mt-2">è€ƒè©¦æˆç¸¾èˆ‡æ•™å­¸æª¢è¨å ±å‘Š</h2>
                        <div class="text-sm text-gray-500 mt-2">
                            <p><strong>ç§‘ç›®ï¼š</strong>${subjectName}</p>
                            <p><strong>è€ƒè©¦å¹´ä»½åŠç´šåˆ¥ï¼š</strong>${examInfo}</p>
                            <p><strong>æ—¥æœŸï¼š</strong>${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="markdown-body text-sm">${marked.parse(md)}</div>
                    <div class="mt-12 flex justify-between px-10">
                        <div>ç§‘ä¸»ä»»ç°½ç½²: _________________</div>
                        <div>æ ¡é•·ç°½ç½²: _________________</div>
                    </div>
                </div>`;
                document.getElementById('summary-preview-area').innerHTML = html;
                document.getElementById('dl-summary-btn').disabled = false;
                document.getElementById('print-container').innerHTML = html;
            } catch(e) { console.error(e); showErrorModal(e, 'summary-preview-area'); }
        });

        safeListen('dl-summary-btn', 'click', () => {
            let c = document.getElementById('summary-preview-area').innerHTML;
            const h=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Summary Report</title><script src="https://cdn.tailwindcss.com"><\/script><style>@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap');body{font-family:'Noto Sans TC',sans-serif;padding:20px;background:#f3f4f6;}.report-page-style{width:210mm;min-height:297mm;padding:20mm;background:white;margin:0 auto;box-shadow:0 4px 6px rgba(0,0,0,0.1);}h1{font-size:1.8em;font-weight:bold;margin-bottom:0.5em;}h2{font-size:1.4em;font-weight:bold;margin-top:1em;color:#2563eb;}ul{padding-left:1.5em;list-style:disc;}p{margin-bottom:0.8em;line-height:1.6;}</style></head><body>${c}</body></html>`;
            const b=new Blob([h],{type:'text/html'}), u=URL.createObjectURL(b), a=document.createElement('a');
            a.href=u; a.download=`Summary_Report_${new Date().toISOString().slice(0,10)}.html`; document.body.appendChild(a); a.click();
            setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(u);},100);
        });

        // --- STUDENT REPORT GEN ---
        safeListen('generate-btn', 'click', async()=>{
            const v=document.getElementById('student-select').value;
            if(!v) return alert("è«‹é¸æ“‡");
            document.getElementById('print-container').innerHTML=''; document.getElementById('report-preview-area').innerHTML='';
            document.getElementById('print-btn').disabled=true; document.getElementById('download-btn').disabled=true;
            if(v==='ALL') await batchGen(); else await singleGen(parseInt(v));
        });
        safeListen('clear-btn', 'click',()=>{
            document.getElementById('print-container').innerHTML=''; document.getElementById('report-preview-area').innerHTML='';
            document.getElementById('print-btn').disabled=true; document.getElementById('download-btn').disabled=true;
        });

        safeListen('download-btn', 'click',()=>{
            let c=document.getElementById('print-container').innerHTML;
            if(!c.trim()) return;
            c = c.replace(/<img[^>]*>/g, "");
            const h=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Report</title><script src="https://cdn.tailwindcss.com"><\/script><style>@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap');body{font-family:'Noto Sans TC',sans-serif;background:#f3f4f6;padding:20px;}.report-page-style{width:210mm;min-height:296mm;padding:20mm;background:white;margin:0 auto 30px;position:relative;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,0.1);border:1px solid #ddd;box-sizing:border-box;}.page-footer{margin-top:40px;padding-top:10px;border-top:1px dashed #ccc;color:#666;font-size:10pt;}@media print{body{background:white;padding:0;}.report-page-style{width:100%;height:296mm;margin:0;box-shadow:none;border:none;break-after:page;page-break-after:always;overflow:hidden;}}h1{font-size:1.6em;color:#1e3a8a;border-bottom:2px solid #ddd;padding-bottom:10px;}h2{font-size:1.3em;color:#2563eb;margin-top:1em;}ul{padding-left:1.5em;list-style:disc;}blockquote{border-left:4px solid #e5e7eb;padding-left:1em;background:#f9fafb;padding:0.5rem;margin:10px 0;}</style></head><body>${c}</body></html>`;
            const b=new Blob([h],{type:'text/html'}), u=URL.createObjectURL(b), a=document.createElement('a');
            a.href=u; a.download=`Reports_${new Date().toISOString().slice(0,10)}.html`; document.body.appendChild(a); a.click();
            setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(u);},100);
        });

        async function batchGen(){
            let validIndices = [];
            marksheetData.forEach((r, i) => { if(r[colMap.name]) validIndices.push(i); });
            let pb=document.getElementById('progress-bar'), pc=document.getElementById('progress-count');
            document.getElementById('batch-progress').classList.remove('hidden'); document.getElementById('generate-btn').disabled=true;
            for(let i=0; i<validIndices.length; i++){
                let originalIndex = validIndices[i];
                pb.style.width=Math.round(((i+1)/validIndices.length)*100)+'%'; 
                pc.textContent=`${i+1}/${validIndices.length}`;
                await singleGen(originalIndex, true); 
                await new Promise(r=>setTimeout(r,2000));
            }
            document.getElementById('batch-progress').classList.add('hidden'); document.getElementById('generate-btn').disabled=false;
            document.getElementById('print-btn').disabled=false; document.getElementById('download-btn').disabled=false;
            alert("å®Œæˆï¼");
        }

        async function singleGen(idx,app=false){
            let row=marksheetData[idx], an=analyzeStudent(row), rid=`rep-${idx}-${Date.now()}`;
            let sName = row[colMap.name] || "æœªçŸ¥";
            let sClass = row[colMap.class] || "";
            let selectedLang = document.getElementById('report-language').value;
            let syllabus = document.getElementById('syllabus-content').value || "(æœªæä¾›èª²ç¨‹ç¯„åœ)";
            
            let ph=`<div id="${rid}" class="card mb-4 border-l-4 border-gray-400 p-4"><p class="animate-pulse">æ­£åœ¨ç”Ÿæˆ ${sName}...</p></div>`;
            if(!app) document.getElementById('report-preview-area').innerHTML=ph; else document.getElementById('report-preview-area').insertAdjacentHTML('beforeend',ph);
            try {
                let txt=await callAI(buildPrompt(sName, an, selectedLang, syllabus));
                let p1, p2;
                if(txt.includes('---PAGE_BREAK---')) {
                    let parts = txt.split('---PAGE_BREAK---'); p1 = parts[0]; p2 = parts[1];
                } else if(txt.includes('3. ')) { 
                    let parts = txt.split('3. '); p1 = parts[0]; p2 = "3. " + parts[1];
                } else {
                    p1 = txt; p2 = "ï¼ˆAI æœªç”¢ç”Ÿç¬¬äºŒé å…§å®¹ï¼Œè«‹é‡è©¦ï¼‰";
                }

                let ex, ans;
                if(p2.includes('---ANSWERS---')) {
                    let ep = p2.split('---ANSWERS---'); ex=ep[0]; ans=ep[1];
                } else {
                    ex = p2; ans = "ç„¡ç­”æ¡ˆ";
                }
                
                const L = {
                    title: selectedLang==='en' ? 'Science Diagnostic Report' : 'ç§‘å­¸ç§‘è¨ºæ–·å ±å‘Š',
                    good: selectedLang==='en' ? 'Strengths:' : 'ğŸ‘ è¼ƒä½³ï¼š',
                    bad: selectedLang==='en' ? 'To Improve:' : 'ğŸ’ª éœ€æ”¹å–„ï¼š',
                    challenge: selectedLang==='en' ? 'Self-Challenge' : 'ğŸ”¥ è‡ªæˆ‘æŒ‘æˆ°',
                    answers: selectedLang==='en' ? 'Answers:' : 'åƒè€ƒç­”æ¡ˆ:'
                };

                let h=`
                <div class="report-page-style preview-wrapper bg-white">
                    <div class="border-b-2 border-gray-800 pb-4 mb-6 flex justify-between items-end">
                        <div><h1 class="text-2xl font-bold">${L.title}</h1></div>
                        <div class="text-right"><div class="text-3xl font-bold text-blue-800">${an.totalScore} <span class="text-sm text-gray-500">/${totalPaperMark}</span></div><div class="font-bold text-lg">${sName} (${sClass})</div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6 text-sm bg-gray-50 p-4 rounded">
                        <div><span class="font-bold text-green-700">${L.good}</span> ${an.good.join(', ')||'-'}</div>
                        <div><span class="font-bold text-red-700">${L.bad}</span> ${an.bad.join(', ')||'-'}</div>
                    </div>
                    <div class="markdown-body text-sm">${marked.parse(p1)}</div>
                </div>
                
                <div class="report-page-style preview-wrapper bg-white">
                    <div class="border-b pb-2 mb-6"><h2 class="text-xl font-bold text-indigo-800">${L.challenge}</h2></div>
                    <div class="markdown-body text-sm">${marked.parse(ex)}</div>
                    <div class="page-footer">
                        <p class="font-bold mb-1">${L.answers}</p>
                        <div class="text-xs bg-gray-100 p-2 rounded inline-block transform rotate-180 origin-center">${marked.parse(ans)}</div>
                    </div>
                </div>`;
                
                let tempDiv = document.createElement('div'); tempDiv.innerHTML = h;
                while(tempDiv.firstChild) { document.getElementById('print-container').appendChild(tempDiv.firstChild); }

                let w=document.createElement('div'); w.innerHTML=h; document.getElementById(rid).replaceWith(w);
                document.getElementById('print-btn').disabled=false; document.getElementById('download-btn').disabled=false;
            } catch(e) {
                console.error(e); showErrorModal(e, rid);
                let el = document.getElementById(rid); if(el) el.innerHTML = `<div class="text-red-500 p-2">ç”Ÿæˆå¤±æ•—</div>`;
            }
        }

        // --- MODAL ---
        function showErrorModal(e, id) {
            const modal = document.getElementById('error-modal');
            const content = document.getElementById('error-log-content');
            const corsAdvice = document.getElementById('cors-advice');
            let logText = `Error: ${e.message}\n`;
            if(e.data) { logText += `URL: ${e.data.url}\nStatus: ${e.data.status}\nResponse: ${e.data.msg}\n`; }
            content.textContent = logText;
            if(e.message.includes('Network Error') || e.message.includes('Failed to fetch')) { corsAdvice.classList.remove('hidden'); } else { corsAdvice.classList.add('hidden'); }
            modal.classList.remove('hidden');
        }
        function closeModal() { document.getElementById('error-modal').classList.add('hidden'); }
        function copyErrorLog() { navigator.clipboard.writeText(document.getElementById('error-log-content').textContent).then(() => alert("å·²è¤‡è£½")); }

        function analyzeStudent(r){
            let t=0,w=[],b={},g={};
            Object.keys(questionMap).forEach(q=>{if(r[q]){let s=parseFloat(r[q])||0,i=questionMap[q];t+=s;if(s<i.fullMark*0.5){w.push(i.Concept_Detail || i.Topic_Name);b[i.Topic_Name]=(b[i.Topic_Name]||0)+1}else if(s===i.fullMark)g[i.Topic_Name]=(g[i.Topic_Name]||0)+1}});
            return {totalScore:t,wrong:[...new Set(w)].slice(0,8),bad:Object.keys(b).sort((x,y)=>b[y]-b[x]).slice(0,3),good:Object.keys(g).sort((x,y)=>g[y]-g[x]).slice(0,3)};
        }

        function buildPrompt(n,d, lang, syllabus) {
            let tpl = document.getElementById('prompt-template').value;
            const L = {
                zh: { inst: "è«‹ç”¨ç¹é«”ä¸­æ–‡æ’°å¯«ã€‚", sec1: "æ•´é«”è¡¨ç¾å›é¡§", sec2: "é‡é»æ¦‚å¿µé‡æº«", sec3: "è‡ªæˆ‘æŒ‘æˆ°" },
                en: { inst: "Please write in English.", sec1: "Overall Performance Review", sec2: "Key Concept Review", sec3: "Self-Challenge" }
            };
            const LC = L[lang] || L['zh'];
            return tpl.replace('{{student_name}}', n).replace('{{total_score}}', d.totalScore).replace('{{full_mark}}', totalPaperMark)
                      .replace('{{weaknesses}}', d.bad.join(', ')).replace('{{wrong_concepts}}', d.wrong.join(', ')).replace('{{strengths}}', d.good.join(', '))
                      .replace('{{language_instruction}}', LC.inst).replace('{{section_1_title}}', LC.sec1).replace('{{section_2_title}}', LC.sec2).replace('{{section_3_title}}', LC.sec3)
                      .replace('{{syllabus}}', syllabus || "æœªæä¾›");
        }

        async function callAI(p){
            const prov=document.getElementById('model-provider').value;
            if(prov==='gemini'){
                const k=document.getElementById('gemini-key').value; if(!k)throw new Error("ç„¡ API Key");
                let r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${k}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:p}]}]})});
                if(!r.ok) { let txt=await r.text(); let err=new Error(`Gemini Error: ${r.status}`); err.data={url:r.url, status:r.status, msg:txt}; throw err; }
                let d=await r.json(); return d.candidates[0].content.parts[0].text;
            }else{
                let u=document.getElementById('ds-url').value.replace(/\/$/,""), k=document.getElementById('ds-key').value, m=document.getElementById('ds-model').value, auto=document.getElementById('ds-auto-path').checked;
                const doFetch = async (url) => {
                    console.log("Attempting:", url);
                    return fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...(k ? { 'Authorization': `Bearer ${k}` } : {}) },
                        body: JSON.stringify({ model: m, messages: [{ role: "user", content: p }], temperature: 0.7 })
                    });
                };
                let urlRaw = u;
                let urlStandard = u.includes('/chat/completions') ? u : u + '/chat/completions';
                let firstUrl = auto ? urlStandard : urlRaw;
                let secondUrl = auto ? urlRaw : urlStandard;
                if(urlRaw === urlStandard) secondUrl = null;

                try {
                    let res = await doFetch(firstUrl);
                    if (res.ok) { let d = await res.json(); return d.choices[0].message.content; }
                    if (res.status === 404 && secondUrl) {
                        let res2 = await doFetch(secondUrl);
                        if (res2.ok) { let d = await res2.json(); return d.choices[0].message.content; }
                    }
                    let txt = await res.text().catch(()=>"");
                    throw new Error(`API Error ${res.status}: ${txt}`);
                } catch (e) {
                    if ((e.message.includes('Failed to fetch') || e.message.includes('NetworkError')) && secondUrl) {
                        try {
                            let res2 = await doFetch(secondUrl);
                            if (res2.ok) { let d = await res2.json(); return d.choices[0].message.content; }
                            let txt = await res2.text().catch(()=>"");
                            throw new Error(`API Error ${res2.status}: ${txt}`);
                        } catch (e2) {
                            let finalErr = new Error(`é€£ç·šå¤±æ•— (é›™é‡è·¯å¾‘æ¸¬è©¦ç„¡æ•ˆ)ã€‚\nä¸»è¦éŒ¯èª¤: ${e.message}`);
                            finalErr.data = { url: firstUrl + " & " + secondUrl, status: "Network Error", msg: e.message + " / " + e2.message };
                            throw finalErr;
                        }
                    }
                    if(!e.data) { e.data = { url: firstUrl, status: "Network Error", msg: e.message }; }
                    throw e;
                }
            }
        }
    </script>
</body>
</html>
