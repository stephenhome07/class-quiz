<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKDSE Physics Performance Analyzer Pro (v1.5)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #2563eb; color: white; transition: 0.2s; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms, transform 200ms; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 200ms, transform 200ms; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Helper Components ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons && window.lucide.icons[name] && containerRef.current) {
                    if (typeof window.lucide.createElement === 'function') {
                        const svg = window.lucide.createElement(window.lucide.icons[name]);
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        if (className) svg.setAttribute('class', `lucide lucide-${name.toLowerCase()} ${className}`);
                        containerRef.current.innerHTML = '';
                        containerRef.current.appendChild(svg);
                    }
                }
            }, [name, size, className]);
            return <span ref={containerRef} style={{ display: 'inline-flex', alignItems: 'center', verticalAlign: 'middle' }} />;
        };

        // --- Custom Modal Component ---
        const Modal = ({ isOpen, title, message, type = 'info', onConfirm, onCancel, content }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 transform transition-all flex flex-col max-h-[90vh]">
                        <div className="flex items-center gap-3 mb-4 flex-shrink-0">
                            {type === 'danger' && <Icon name="AlertTriangle" className="text-red-500" size={24}/>}
                            {type === 'success' && <Icon name="CheckCircle" className="text-green-500" size={24}/>}
                            {type === 'info' && <Icon name="Info" className="text-blue-500" size={24}/>}
                            <h3 className="text-lg font-bold text-gray-800">{title}</h3>
                        </div>
                        
                        {message && <p className="text-gray-600 mb-4 text-sm whitespace-pre-line flex-shrink-0">{message}</p>}
                        
                        {content && <div className="flex-1 overflow-hidden flex flex-col mb-4">{content}</div>}

                        <div className="flex justify-end gap-3 flex-shrink-0 pt-2 border-t mt-auto">
                            {onCancel && (
                                <button onClick={onCancel} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded">
                                    取消
                                </button>
                            )}
                            <button 
                                onClick={onConfirm} 
                                className={`px-4 py-2 text-sm text-white rounded shadow ${
                                    type === 'danger' ? 'bg-red-600 hover:bg-red-700' : 
                                    type === 'success' ? 'bg-green-600 hover:bg-green-700' : 
                                    'bg-blue-600 hover:bg-blue-700'
                                }`}
                            >
                                確定 / 複製
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Optimized Score Input Component ---
        const ScoreInput = ({ value, max, onSave }) => {
            const [localVal, setLocalVal] = useState(value);
            useEffect(() => setLocalVal(value), [value]);

            const handleBlur = () => {
                if (localVal !== value) onSave(localVal);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') e.target.blur();
            };

            return (
                <div className="flex items-center gap-1">
                    <input 
                        type="text" 
                        value={localVal} 
                        onChange={(e) => setLocalVal(e.target.value)}
                        onBlur={handleBlur}
                        onKeyDown={handleKeyDown}
                        placeholder="-"
                        className="w-12 text-center border-b border-gray-300 focus:border-blue-500 outline-none bg-transparent hover:bg-white focus:bg-white transition-colors rounded-sm"
                    />
                    <span className="text-gray-400 text-xs">/ {max}</span>
                </div>
            );
        };

        const FileUpload = ({ label, onUpload, accept = ".csv", id }) => (
            <div className="mb-4">
                <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                <input 
                    id={id}
                    type="file" 
                    accept={accept}
                    onChange={(e) => onUpload(e.target.files[0])}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
            </div>
        );

        // --- Main App ---
        const App = () => {
            const [view, setView] = useState('upload'); 
            const [exams, setExams] = useState([]); 
            const [students, setStudents] = useState([]);
            const [selectedStudentId, setSelectedStudentId] = useState('');
            const [history, setHistory] = useState([]);
            const [modalConfig, setModalConfig] = useState({ isOpen: false, title: '', message: '', type: 'info', onConfirm: null, onCancel: null, content: null });

            const showModal = (config) => setModalConfig({ ...config, isOpen: true });
            const closeModal = () => setModalConfig({ ...modalConfig, isOpen: false });

            // Persistence
            useEffect(() => {
                try {
                    const savedHistory = localStorage.getItem('hkdse_ex_history_v2');
                    if (savedHistory) setHistory(JSON.parse(savedHistory));
                    const savedExams = localStorage.getItem('hkdse_ex_exams_v2');
                    if (savedExams) setExams(JSON.parse(savedExams));
                } catch (e) { console.error(e); }
            }, []);

            useEffect(() => { localStorage.setItem('hkdse_ex_history_v2', JSON.stringify(history)); }, [history]);
            useEffect(() => { 
                try { localStorage.setItem('hkdse_ex_exams_v2', JSON.stringify(exams)); } 
                catch (e) { if (e.name === 'QuotaExceededError') alert('儲存空間不足，請備份並清除舊資料'); }
            }, [exams]);

            useEffect(() => {
                if (exams.length > 0) {
                    const allStudents = {};
                    exams.forEach(exam => {
                        exam.markSheetData.forEach(row => {
                            if (row.Class && row.Name) {
                                const sid = `${row.Class}-${row.ClassNumber}`;
                                if (!allStudents[sid]) {
                                    allStudents[sid] = {
                                        id: sid,
                                        label: `${row.Class} (${row.ClassNumber}) ${row.Name}`,
                                        class: row.Class,
                                        number: row.ClassNumber,
                                        name: row.Name
                                    };
                                }
                            }
                        });
                    });
                    const studList = Object.values(allStudents).sort((a,b) => a.id.localeCompare(b.id));
                    setStudents(studList);
                    if (studList.length > 0 && !selectedStudentId) setSelectedStudentId(studList[0].id);
                }
            }, [exams]);

            // Analysis
            const analyzeExam = (exam, studentId) => {
                const studentRow = exam.markSheetData.find(s => `${s.Class}-${s.ClassNumber}` === studentId);
                if (!studentRow) return null;
                const analysis = {};
                const conceptWeaknesses = [];
                let totalScore = 0, totalMax = 0;
                exam.mapData.forEach(q => {
                    const qId = q.Question_ID;
                    const topicId = q.Topic_ID || 'Unknown';
                    const topicName = q.Topic_Name || 'General';
                    const maxMark = parseFloat(q.Full_Mark) || 1;
                    const studentScore = parseFloat(studentRow[qId]) || 0;
                    if (!analysis[topicId]) analysis[topicId] = { name: topicName, score: 0, max: 0 };
                    analysis[topicId].score += studentScore;
                    analysis[topicId].max += maxMark;
                    totalScore += studentScore;
                    totalMax += maxMark;
                    if ((studentScore / maxMark) < 0.5) {
                        conceptWeaknesses.push({ topic: topicName, concept: q.Concept_Detail, difficulty: q.Difficulty, qId: qId });
                    }
                });
                Object.values(analysis).forEach(t => t.percentage = t.max > 0 ? (t.score / t.max) * 100 : 0);
                return { examName: exam.name, examId: exam.id, overallPercentage: totalMax > 0 ? (totalScore / totalMax) * 100 : 0, topics: analysis, weaknesses: conceptWeaknesses };
            };

            const studentTrend = useMemo(() => {
                if (!selectedStudentId || exams.length === 0) return null;
                return exams.map(exam => analyzeExam(exam, selectedStudentId)).filter(Boolean);
            }, [selectedStudentId, exams]);

            // Backup
            const exportData = () => {
                const data = { exams, history, exportedAt: new Date().toISOString(), version: "1.5" };
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `HKDSE_Tracker_Backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };
            const importData = (file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.exams && data.history) {
                            showModal({
                                title: '警告：覆蓋數據',
                                message: `確定要還原嗎？這將會清除現有數據。`,
                                type: 'danger',
                                onConfirm: () => { setExams(data.exams); setHistory(data.history); closeModal(); },
                                onCancel: closeModal
                            });
                        }
                    } catch (err) { alert('無效的備份檔案'); }
                };
                reader.readAsText(file);
            };

            const Sidebar = () => (
                <div className="w-64 bg-white h-screen fixed left-0 top-0 border-r flex flex-col z-10 shadow-lg">
                    <div className="p-6 border-b bg-blue-600 text-white">
                        <h1 className="text-xl font-bold flex items-center gap-2"><Icon name="Activity"/> 物理科追蹤系統</h1>
                    </div>
                    <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                        <button onClick={() => setView('upload')} className={`w-full flex items-center gap-3 px-4 py-3 text-left rounded-lg transition ${view === 'upload' ? 'bg-blue-50 text-blue-700 font-bold shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}><Icon name="Database" size={18} /> 數據庫</button>
                        <button onClick={() => setView('dashboard')} disabled={exams.length === 0} className={`w-full flex items-center gap-3 px-4 py-3 text-left rounded-lg transition ${view === 'dashboard' ? 'bg-blue-50 text-blue-700 font-bold shadow-sm' : 'text-gray-600 hover:bg-gray-50 disabled:opacity-50'}`}><Icon name="LineChart" size={18} /> 成績追蹤</button>
                        <button onClick={() => setView('generate')} disabled={exams.length === 0} className={`w-full flex items-center gap-3 px-4 py-3 text-left rounded-lg transition ${view === 'generate' ? 'bg-blue-50 text-blue-700 font-bold shadow-sm' : 'text-gray-600 hover:bg-gray-50 disabled:opacity-50'}`}><Icon name="Zap" size={18} /> 練習生成</button>
                        <button onClick={() => setView('history')} className={`w-full flex items-center gap-3 px-4 py-3 text-left rounded-lg transition ${view === 'history' ? 'bg-blue-50 text-blue-700 font-bold shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}><Icon name="ClipboardList" size={18} /> 練習管理</button>
                    </nav>
                </div>
            );

            const UploadView = () => {
                const [tempMap, setTempMap] = useState(null);
                const [tempMarks, setTempMarks] = useState(null);
                const [tempMc, setTempMc] = useState(null);
                const [examName, setExamName] = useState('');

                const handleParse = (file, setter) => {
                    Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => setter(results.data) });
                };
                const addExam = () => {
                    if (!tempMap || !tempMarks || !examName) return;
                    setExams([...exams, { id: Date.now().toString(), name: examName, mapData: tempMap, markSheetData: tempMarks, mcData: tempMc || [] }]);
                    setTempMap(null); setTempMarks(null); setTempMc(null); setExamName('');
                    showModal({ title: '成功', message: `已成功加入考試: ${examName}`, type: 'success', onConfirm: closeModal });
                };

                return (
                    <div className="max-w-4xl mx-auto mt-6 p-6 space-y-8">
                        <div className="card p-6 bg-slate-50 border border-slate-200">
                            <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><Icon name="Save" size={20} /> 數據管理</h2>
                            <div className="flex gap-4">
                                <button onClick={exportData} className="flex-1 bg-white border border-slate-300 py-3 rounded-lg flex justify-center gap-2 shadow-sm"><Icon name="Download" size={18} /> 匯出備份</button>
                                <div className="flex-1 relative">
                                    <input type="file" accept=".json" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onChange={(e) => importData(e.target.files[0])} />
                                    <button className="w-full bg-white border border-slate-300 py-3 rounded-lg flex justify-center gap-2 shadow-sm pointer-events-none"><Icon name="Upload" size={18} /> 匯入還原</button>
                                </div>
                            </div>
                        </div>
                        <div className="card p-8 border-l-4 border-blue-500 shadow-md">
                            <h2 className="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-2"><Icon name="PlusCircle" /> 新增考試數據</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div className="col-span-2"><input type="text" value={examName} onChange={e => setExamName(e.target.value)} className="w-full p-2 border rounded" placeholder="考試名稱 (如: S5 Mid-Term)" /></div>
                                <div><FileUpload id="map-upload" label="1. 題目對照表 (MAP)" onUpload={f => handleParse(f, setTempMap)} />{tempMap && <div className="text-xs text-green-600">已讀取</div>}</div>
                                <div><FileUpload id="mark-upload" label="2. 成績表 (Marksheet)" onUpload={f => handleParse(f, setTempMarks)} />{tempMarks && <div className="text-xs text-green-600">已讀取 {tempMarks.length} 學生</div>}</div>
                                <div className="col-span-2"><FileUpload id="mc-upload" label="3. MC 紀錄 (選填)" onUpload={f => handleParse(f, setTempMc)} /></div>
                            </div>
                            <button onClick={addExam} disabled={!tempMap || !tempMarks || !examName} className="w-full btn-primary py-3 rounded-lg font-bold shadow disabled:opacity-50">確認加入此考試</button>
                        </div>
                        {exams.length > 0 && (
                            <div className="card p-6">
                                <h3 className="font-bold text-gray-700 mb-4">現有考試</h3>
                                <table className="w-full text-sm"><tbody>{exams.map(e => (
                                    <tr key={e.id} className="border-t"><td className="p-3 font-medium">{e.name}</td><td className="p-3">{e.markSheetData.length} 人</td><td className="p-3 text-right"><button onClick={() => setExams(exams.filter(x => x.id !== e.id))} className="text-red-500 underline">移除</button></td></tr>
                                ))}</tbody></table>
                            </div>
                        )}
                    </div>
                );
            };

            const DashboardView = () => {
                const lineChartRef = useRef(null);
                const barChartRef = useRef(null);
                const [selectedExamIndex, setSelectedExamIndex] = useState(exams.length - 1); 
                const activeReport = studentTrend ? studentTrend[selectedExamIndex] : null;

                useEffect(() => {
                    if (studentTrend && lineChartRef.current) {
                        if (lineChartRef.current.chartInstance) lineChartRef.current.chartInstance.destroy();
                        const ctx = lineChartRef.current.getContext('2d');
                        lineChartRef.current.chartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: studentTrend.map(r => r.examName),
                                datasets: [{ label: '整體得分率 (%)', data: studentTrend.map(r => r.overallPercentage), borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true }]
                            },
                            options: { responsive: true, scales: { y: { min: 0, max: 100 } } }
                        });
                    }
                }, [studentTrend]);

                useEffect(() => {
                    if (activeReport && barChartRef.current) {
                        if (barChartRef.current.chartInstance) barChartRef.current.chartInstance.destroy();
                        const topics = Object.entries(activeReport.topics).sort((a, b) => a[0].localeCompare(b[0], undefined, { numeric: true, sensitivity: 'base' })).map(([_, t]) => t);
                        const ctx = barChartRef.current.getContext('2d');
                        barChartRef.current.chartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: topics.map(t => t.name.substring(0, 10)),
                                datasets: [{ label: '課題得分率 (%)', data: topics.map(t => t.percentage), backgroundColor: topics.map(t => t.percentage < 50 ? '#ef4444' : '#22c55e') }]
                            },
                            options: { responsive: true, scales: { y: { min: 0, max: 100 } } }
                        });
                    }
                }, [activeReport]);

                if (!studentTrend || studentTrend.length === 0) return <div className="p-8 text-center text-gray-500">請先在數據庫上傳資料。</div>;

                return (
                    <div className="p-6 space-y-6">
                        <div className="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm">
                            <h2 className="text-2xl font-bold text-gray-800">學生成績追蹤</h2>
                            <div className="flex gap-2"><Icon name="User" className="text-gray-500" /><select className="p-2 border rounded-md" value={selectedStudentId} onChange={(e) => setSelectedStudentId(e.target.value)}>{students.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}</select></div>
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="card p-6"><canvas ref={lineChartRef} height="150"></canvas></div>
                            <div className="card p-6 flex flex-col">
                                <div className="flex justify-between mb-4"><h3 className="font-bold">弱項分析</h3><select className="text-sm border rounded" value={selectedExamIndex} onChange={e => setSelectedExamIndex(Number(e.target.value))}>{studentTrend.map((r, i) => <option key={i} value={i}>{r.examName}</option>)}</select></div>
                                {activeReport && <div className="flex-1 overflow-y-auto space-y-2 custom-scrollbar" style={{maxHeight: '250px'}}>{activeReport.weaknesses.map((w, idx) => <div key={idx} className="p-3 bg-red-50 border-l-4 border-red-500 rounded text-sm"><div className="font-bold text-red-800">{w.topic}</div><div>{w.concept}</div></div>)}</div>}
                            </div>
                        </div>
                        <div className="card p-6"><div className="h-64 w-full"><canvas ref={barChartRef}></canvas></div></div>
                    </div>
                );
            };

            const GenerateView = () => {
                const [selectedTopics, setSelectedTopics] = useState([]);
                const [difficulty, setDifficulty] = useState('Medium');
                const [count, setCount] = useState(5);
                const [isGenerating, setIsGenerating] = useState(false);
                
                // New Prompt Settings State (Persistent)
                const [promptSettings, setPromptSettings] = useState({
                    language: 'English',
                    role: 'Experienced HKDSE Physics Marker',
                    questionType: 'Mixed (MC + SQ)',
                    weaknessFocusRatio: 20, // percentage
                    customInstructions: 'Provide full marking scheme. Explain answers in Cantonese style.'
                });

                // Load Settings
                useEffect(() => {
                    const savedSettings = localStorage.getItem('hkdse_prompt_settings');
                    if (savedSettings) setPromptSettings(JSON.parse(savedSettings));
                }, []);

                // Save Settings
                useEffect(() => {
                    localStorage.setItem('hkdse_prompt_settings', JSON.stringify(promptSettings));
                }, [promptSettings]);
                
                const latestExamReport = studentTrend && studentTrend.length > 0 ? studentTrend[studentTrend.length - 1] : null;

                useEffect(() => { setSelectedTopics([]); }, [selectedStudentId]);

                const toggleTopic = (id) => {
                    if (selectedTopics.includes(id)) setSelectedTopics(selectedTopics.filter(t => t !== id));
                    else setSelectedTopics([...selectedTopics, id]);
                };

                const autoSelectWeak = () => {
                    if (latestExamReport) {
                        const weakTopicNames = new Set(latestExamReport.weaknesses.map(w => w.topic));
                        const weakTopicIds = Object.entries(latestExamReport.topics).filter(([id, t]) => weakTopicNames.has(t.name)).map(([id]) => id);
                        setSelectedTopics(weakTopicIds);
                        showModal({ title: '已載入', message: `已選取 ${weakTopicIds.length} 個弱項。`, type: 'info', onConfirm: closeModal });
                    }
                };

                const handleGenerate = () => {
                    try {
                        if (!latestExamReport || selectedTopics.length === 0) {
                             showModal({ title: '注意', message: '請選擇至少一個課題。', type: 'info', onConfirm: closeModal });
                             return;
                        }

                        setIsGenerating(true);

                        const student = students.find(s => s.id === selectedStudentId);
                        const targetTopics = Object.entries(latestExamReport.topics)
                            .filter(([id]) => selectedTopics.includes(id))
                            .map(([_, t]) => t);
                        
                        const topicNames = targetTopics.map(t => t.name);
                        
                        // Extract specific weaknesses (Concept Detail) for the selected topics
                        const relevantWeaknesses = latestExamReport.weaknesses
                            .filter(w => topicNames.some(tName => tName.includes(w.topic) || w.topic.includes(tName)));
                        
                        // Deduplicate based on concept text
                        const uniqueWeaknesses = [...new Set(relevantWeaknesses.map(w => w.concept))];

                        // Calculate number of targeted questions
                        const targetedCount = Math.max(1, Math.ceil(count * (promptSettings.weaknessFocusRatio / 100)));

                        const prompt = `Role: ${promptSettings.role}
Language: ${promptSettings.language}
Task: Generate ${count} HKDSE Physics practice questions.
Difficulty: ${difficulty}
Question Type: ${promptSettings.questionType}
Selected Topics: ${topicNames.join(', ')}

[CRITICAL REQUIREMENT - TARGETED REMEDIAL]
The student has specific misconceptions/weaknesses in these areas:
${uniqueWeaknesses.length > 0 ? uniqueWeaknesses.map(w => `- ${w}`).join('\n') : "(No specific weakness recorded for selected topics, focus on general practice)"}

Constraint: You MUST ensure at least ${promptSettings.weaknessFocusRatio}% (approx. ${targetedCount} questions) explicitly address the misconceptions listed above to verify conceptual correction.

Custom Instructions:
${promptSettings.customInstructions}

Output Format:
1. Question
2. Answer & Detailed Marking Scheme
3. Concept Explanation (Why this is the answer)`;

                        const newEntry = {
                            id: Date.now(),
                            date: new Date().toISOString().split('T')[0],
                            studentId: selectedStudentId,
                            studentName: student.label,
                            topics: topicNames.join(', '),
                            difficulty,
                            count,
                            status: 'pending',
                            score: '',
                            maxScore: count
                        };
                        setHistory([newEntry, ...history]);
                        
                        setTimeout(() => {
                            setIsGenerating(false);
                            // Show the modal with the prompt content
                            showModal({ 
                                title: '生成成功', 
                                type: 'success',
                                content: (
                                    <div className="flex flex-col h-full">
                                        <p className="text-sm text-gray-500 mb-2">練習已記錄。請複製下方 Prompt 給 AI：</p>
                                        <textarea 
                                            className="w-full h-40 p-3 bg-gray-100 rounded text-xs font-mono border focus:ring-2 focus:ring-blue-500 outline-none resize-none"
                                            readOnly
                                            value={prompt}
                                        />
                                    </div>
                                ),
                                onConfirm: () => {
                                    navigator.clipboard.writeText(prompt);
                                    closeModal();
                                    alert('已複製到剪貼簿！');
                                },
                                onCancel: closeModal
                            });
                        }, 500); 

                    } catch (err) {
                        setIsGenerating(false);
                        console.error(err);
                        showModal({ title: '錯誤', message: '生成過程中發生錯誤，請檢查數據。', type: 'danger', onConfirm: closeModal });
                    }
                };

                if (!latestExamReport) return <div className="p-8 text-center text-gray-500">請先在數據庫加入考試資料。</div>;
                const sortedTopics = Object.entries(latestExamReport.topics).sort((a, b) => a[0].localeCompare(b[0], undefined, { numeric: true, sensitivity: 'base' }));

                return (
                    <div className="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                        {/* Left Column: Basic Settings */}
                        <div className="card p-6 flex flex-col h-full overflow-y-auto">
                            <h2 className="text-xl font-bold mb-4">1. 練習範圍</h2>
                            <div className="mb-4 p-2 bg-blue-50 text-blue-800 rounded font-medium">{students.find(s => s.id === selectedStudentId)?.label}</div>
                            <div className="mb-4 flex-1 overflow-hidden flex flex-col">
                                <div className="flex justify-between items-center mb-2"><label className="font-bold text-gray-700">選擇課題</label><button onClick={autoSelectWeak} className="text-xs bg-red-50 text-red-600 px-2 py-1 rounded border border-red-200">載入弱項</button></div>
                                <div className="border rounded-md overflow-y-auto p-2 space-y-1 flex-1 bg-gray-50 custom-scrollbar">{sortedTopics.map(([id, t]) => (
                                    <label key={id} className={`flex items-center gap-3 p-2 rounded hover:bg-white cursor-pointer ${selectedTopics.includes(id) ? 'bg-blue-50' : ''}`}><input type="checkbox" checked={selectedTopics.includes(id)} onChange={() => toggleTopic(id)} className="text-blue-600" /><div className="flex-1"><div className="text-xs font-bold text-gray-500">{id}</div><div className="text-sm">{t.name}</div></div><span className={`text-xs px-2 py-0.5 rounded ${t.percentage < 50 ? 'bg-red-100 text-red-800' : 'bg-gray-100'}`}>{t.percentage.toFixed(0)}%</span></label>
                                ))}</div>
                            </div>
                            <div className="grid grid-cols-2 gap-4 mt-4">
                                <select value={difficulty} onChange={e => setDifficulty(e.target.value)} className="border p-2 rounded"><option value="High">High (拔尖)</option><option value="Medium">Medium (鞏固)</option><option value="Low">Low (補底)</option></select>
                                <input type="number" value={count} onChange={e => setCount(e.target.value)} className="border p-2 rounded" min="1" max="20" placeholder="題數" />
                            </div>
                            <button onClick={handleGenerate} disabled={isGenerating} className={`mt-6 btn-primary py-3 rounded-lg font-bold flex justify-center items-center gap-2 ${isGenerating ? 'opacity-75 cursor-wait' : ''}`}>
                                {isGenerating ? <><Icon name="Loader2" className="animate-spin"/> 生成中...</> : <><Icon name="Cpu" /> 生成 Prompt</>}
                            </button>
                        </div>
                        
                        {/* Right Column: Advanced Settings (Persistent) */}
                        <div className="card p-6 flex flex-col h-full bg-slate-50 border border-slate-200">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-slate-800">
                                <Icon name="Sliders" /> AI 提示詞進階設定
                            </h2>
                            <p className="text-xs text-gray-500 mb-4">此處設定會自動儲存 (Auto-save)，無需每次重複輸入。</p>
                            
                            <div className="space-y-4 overflow-y-auto flex-1 custom-scrollbar pr-2">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-1">AI 角色 (Role)</label>
                                    <input type="text" className="w-full p-2 border rounded text-sm" value={promptSettings.role} onChange={e => setPromptSettings({...promptSettings, role: e.target.value})} />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-1">語言 (Language)</label>
                                    <select className="w-full p-2 border rounded text-sm" value={promptSettings.language} onChange={e => setPromptSettings({...promptSettings, language: e.target.value})}>
                                        <option value="English">English</option>
                                        <option value="Traditional Chinese">繁體中文</option>
                                        <option value="Bilingual (Eng/Chi)">中英對照</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-1">題型 (Type)</label>
                                    <select className="w-full p-2 border rounded text-sm" value={promptSettings.questionType} onChange={e => setPromptSettings({...promptSettings, questionType: e.target.value})}>
                                        <option value="Mixed (MC + SQ)">混合 (MC + 長題目)</option>
                                        <option value="MC Only">純 MC</option>
                                        <option value="Long Questions Only">純長題目</option>
                                    </select>
                                </div>

                                <div>
                                    <div className="flex justify-between items-center mb-1">
                                        <label className="text-sm font-semibold text-gray-700">弱項針對比例 (Weakness Focus)</label>
                                        <span className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">{promptSettings.weaknessFocusRatio}%</span>
                                    </div>
                                    <input 
                                        type="range" min="0" max="100" step="10" 
                                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                        value={promptSettings.weaknessFocusRatio} 
                                        onChange={e => setPromptSettings({...promptSettings, weaknessFocusRatio: Number(e.target.value)})} 
                                    />
                                    <p className="text-xs text-gray-500 mt-1">AI 將確保至少 {promptSettings.weaknessFocusRatio}% 的題目直接對應學生的 Concept Detail 弱點。</p>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-1">自訂指令 (Custom Instructions)</label>
                                    <textarea 
                                        className="w-full p-2 border rounded text-sm h-32 resize-none" 
                                        placeholder="例如: 解釋請用廣東話口語 / 必須包含 Marking Scheme..."
                                        value={promptSettings.customInstructions} 
                                        onChange={e => setPromptSettings({...promptSettings, customInstructions: e.target.value})} 
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const HistoryView = () => {
                const [filter, setFilter] = useState('all'); 
                const [searchTerm, setSearchTerm] = useState('');
                const filteredHistory = history.filter(h => {
                    if (filter !== 'all' && h.status !== filter) return false;
                    if (searchTerm && !h.studentName.includes(searchTerm) && !h.topics.includes(searchTerm)) return false;
                    return true;
                });
                const updateStatus = (id, s) => setHistory(history.map(h => h.id === id ? { ...h, status: s } : h));
                const updateScore = (id, s) => setHistory(history.map(h => h.id === id ? { ...h, score: s } : h));
                
                return (
                    <div className="p-6 h-screen flex flex-col">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">練習管理</h2>
                            <div className="flex gap-2"><input type="text" placeholder="搜尋..." className="p-2 border rounded-lg text-sm w-48" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /><select className="p-2 border rounded-lg text-sm" value={filter} onChange={e => setFilter(e.target.value)}><option value="all">全部</option><option value="pending">未完成</option><option value="submitted">已提交</option><option value="graded">已評分</option></select></div>
                        </div>
                        <div className="card flex-1 overflow-hidden flex flex-col shadow-md">
                            <div className="overflow-auto flex-1 custom-scrollbar">
                                <table className="w-full text-sm text-left"><thead className="bg-gray-100 text-gray-600 uppercase sticky top-0"><tr><th className="px-4 py-3">日期</th><th className="px-4 py-3">學生</th><th className="px-4 py-3">課題</th><th className="px-4 py-3">狀態</th><th className="px-4 py-3">分數</th><th className="px-4 py-3"></th></tr></thead><tbody>{filteredHistory.map(h => (
                                    <tr key={h.id} className="hover:bg-blue-50 border-b"><td className="px-4 py-3">{h.date}</td><td className="px-4 py-3 font-medium">{h.studentName}</td><td className="px-4 py-3"><div className="truncate max-w-xs">{h.topics}</div></td>
                                    <td className="px-4 py-3"><select value={h.status} onChange={e => updateStatus(h.id, e.target.value)} className={`text-xs px-2 py-1 rounded-full ${h.status==='pending'?'bg-gray-200':h.status==='submitted'?'bg-yellow-100':'bg-green-100'}`}><option value="pending">未完成</option><option value="submitted">已提交</option><option value="graded">已評分</option></select></td>
                                    <td className="px-4 py-3"><ScoreInput value={h.score} max={h.maxScore} onSave={s => updateScore(h.id, s)} /></td>
                                    <td className="px-4 py-3 text-right"><button onClick={() => { if(confirm('刪除?')) setHistory(history.filter(x => x.id !== h.id)) }} className="text-gray-400 hover:text-red-500"><Icon name="Trash2" size={16}/></button></td></tr>
                                ))}</tbody></table>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex min-h-screen bg-gray-100 text-gray-800 relative">
                    <Sidebar />
                    <div className="flex-1 ml-64 overflow-hidden">{view === 'upload' && <UploadView />}{view === 'dashboard' && <DashboardView />}{view === 'generate' && <GenerateView />}{view === 'history' && <HistoryView />}</div>
                    <Modal {...modalConfig} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
