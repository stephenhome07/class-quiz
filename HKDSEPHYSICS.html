<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKDSE Physics Performance Analyzer Pro</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #2563eb; color: white; transition: 0.2s; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms, transform 200ms; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 200ms, transform 200ms; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Helper Components ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons && window.lucide.icons[name] && containerRef.current) {
                    if (typeof window.lucide.createElement === 'function') {
                        const svg = window.lucide.createElement(window.lucide.icons[name]);
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        if (className) svg.setAttribute('class', `lucide lucide-${name.toLowerCase()} ${className}`);
                        containerRef.current.innerHTML = '';
                        containerRef.current.appendChild(svg);
                    }
                }
            }, [name, size, className]);
            return <span ref={containerRef} style={{ display: 'inline-flex', alignItems: 'center', verticalAlign: 'middle' }} />;
        };

        // --- Custom Modal Component (Replaces alert/confirm) ---
        const Modal = ({ isOpen, title, message, type = 'info', onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                    <div className="bg-white rounded-lg shadow-xl w-96 p-6 transform transition-all">
                        <div className="flex items-center gap-3 mb-4">
                            {type === 'danger' && <Icon name="AlertTriangle" className="text-red-500" size={24}/>}
                            {type === 'success' && <Icon name="CheckCircle" className="text-green-500" size={24}/>}
                            {type === 'info' && <Icon name="Info" className="text-blue-500" size={24}/>}
                            <h3 className="text-lg font-bold text-gray-800">{title}</h3>
                        </div>
                        <p className="text-gray-600 mb-6 text-sm">{message}</p>
                        <div className="flex justify-end gap-3">
                            {onCancel && (
                                <button onClick={onCancel} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded">
                                    取消
                                </button>
                            )}
                            <button 
                                onClick={onConfirm} 
                                className={`px-4 py-2 text-sm text-white rounded shadow ${
                                    type === 'danger' ? 'bg-red-600 hover:bg-red-700' : 
                                    type === 'success' ? 'bg-green-600 hover:bg-green-700' : 
                                    'bg-blue-600 hover:bg-blue-700'
                                }`}
                            >
                                確定
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Optimized Score Input Component ---
        const ScoreInput = ({ value, max, onSave }) => {
            const [localVal, setLocalVal] = useState(value);
            
            // Sync with prop if it changes externally
            useEffect(() => {
                setLocalVal(value);
            }, [value]);

            const handleBlur = () => {
                if (localVal !== value) {
                    onSave(localVal);
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    e.target.blur();
                }
            };

            return (
                <div className="flex items-center gap-1">
                    <input 
                        type="text" 
                        value={localVal} 
                        onChange={(e) => setLocalVal(e.target.value)}
                        onBlur={handleBlur}
                        onKeyDown={handleKeyDown}
                        placeholder="-"
                        className="w-12 text-center border-b border-gray-300 focus:border-blue-500 outline-none bg-transparent hover:bg-white focus:bg-white transition-colors rounded-sm"
                    />
                    <span className="text-gray-400 text-xs">/ {max}</span>
                </div>
            );
        };

        const FileUpload = ({ label, onUpload, accept = ".csv", id }) => (
            <div className="mb-4">
                <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
                <input 
                    id={id}
                    type="file" 
                    accept={accept}
                    onChange={(e) => onUpload(e.target.files[0])}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
            </div>
        );

        // --- Main App ---
        const App = () => {
            const [view, setView] = useState('upload'); 
            
            // --- Data State ---
            const [exams, setExams] = useState([]); 
            const [students, setStudents] = useState([]);
            const [selectedStudentId, setSelectedStudentId] = useState('');
            
            // --- History State ---
            const [history, setHistory] = useState([]);

            // --- UI State (Modal) ---
            const [modalConfig, setModalConfig] = useState({ isOpen: false, title: '', message: '', type: 'info', onConfirm: null, onCancel: null });

            const showModal = (config) => setModalConfig({ ...config, isOpen: true });
            const closeModal = () => setModalConfig({ ...modalConfig, isOpen: false });

            // Load history
            useEffect(() => {
                const savedHistory = localStorage.getItem('hkdse_ex_history_v2');
                if (savedHistory) setHistory(JSON.parse(savedHistory));
            }, []);

            // Save history
            useEffect(() => {
                localStorage.setItem('hkdse_ex_history_v2', JSON.stringify(history));
            }, [history]);

            // Update student list
            useEffect(() => {
                if (exams.length > 0) {
                    const allStudents = {};
                    exams.forEach(exam => {
                        exam.markSheetData.forEach(row => {
                            if (row.Class && row.Name) {
                                const sid = `${row.Class}-${row.ClassNumber}`;
                                if (!allStudents[sid]) {
                                    allStudents[sid] = {
                                        id: sid,
                                        label: `${row.Class} (${row.ClassNumber}) ${row.Name}`,
                                        class: row.Class,
                                        number: row.ClassNumber,
                                        name: row.Name
                                    };
                                }
                            }
                        });
                    });
                    const studList = Object.values(allStudents).sort((a,b) => a.id.localeCompare(b.id));
                    setStudents(studList);
                    if (studList.length > 0 && !selectedStudentId) {
                        setSelectedStudentId(studList[0].id);
                    }
                }
            }, [exams]);

            // --- Analysis Logic ---
            const analyzeExam = (exam, studentId) => {
                const studentRow = exam.markSheetData.find(s => `${s.Class}-${s.ClassNumber}` === studentId);
                if (!studentRow) return null;

                const analysis = {};
                const conceptWeaknesses = [];
                let totalScore = 0;
                let totalMax = 0;

                exam.mapData.forEach(q => {
                    const qId = q.Question_ID;
                    const topicId = q.Topic_ID || 'Unknown';
                    const topicName = q.Topic_Name || 'General';
                    const maxMark = parseFloat(q.Full_Mark) || 1;
                    const studentScore = parseFloat(studentRow[qId]) || 0;
                    
                    if (!analysis[topicId]) {
                        analysis[topicId] = { name: topicName, score: 0, max: 0 };
                    }

                    analysis[topicId].score += studentScore;
                    analysis[topicId].max += maxMark;
                    totalScore += studentScore;
                    totalMax += maxMark;

                    if ((studentScore / maxMark) < 0.5) {
                        conceptWeaknesses.push({
                            topic: topicName,
                            concept: q.Concept_Detail,
                            difficulty: q.Difficulty,
                            qId: qId
                        });
                    }
                });

                Object.values(analysis).forEach(t => {
                    t.percentage = t.max > 0 ? (t.score / t.max) * 100 : 0;
                });

                return {
                    examName: exam.name,
                    examId: exam.id,
                    overallPercentage: totalMax > 0 ? (totalScore / totalMax) * 100 : 0,
                    topics: analysis,
                    weaknesses: conceptWeaknesses
                };
            };

            const studentTrend = useMemo(() => {
                if (!selectedStudentId || exams.length === 0) return null;
                return exams.map(exam => analyzeExam(exam, selectedStudentId)).filter(Boolean);
            }, [selectedStudentId, exams]);

            // --- Backup Logic ---
            const exportData = () => {
                const data = {
                    exams: exams,
                    history: history,
                    exportedAt: new Date().toISOString(),
                    version: "1.1"
                };
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `HKDSE_Tracker_Backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const importData = (file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.exams && data.history) {
                            showModal({
                                title: '警告：覆蓋數據',
                                message: `備份日期: ${data.exportedAt || '未知'}\n考試數: ${data.exams.length}\n紀錄數: ${data.history.length}\n確定要還原嗎？這將會清除現有數據。`,
                                type: 'danger',
                                onConfirm: () => {
                                    setExams(data.exams);
                                    setHistory(data.history);
                                    closeModal();
                                    showModal({ title: '成功', message: '數據已成功還原！', type: 'success', onConfirm: closeModal });
                                },
                                onCancel: closeModal
                            });
                        } else {
                            showModal({ title: '錯誤', message: '無效的備份檔案。', type: 'danger', onConfirm: closeModal });
                        }
                    } catch (err) {
                        console.error(err);
                        showModal({ title: '錯誤', message: '無法讀取檔案。', type: 'danger', onConfirm: closeModal });
                    }
                };
                reader.readAsText(file);
            };

            // --- Views ---

            const Sidebar = () => (
                <div className="w-64 bg-white h-screen fixed left-0 top-0 border-r flex flex-col z-10 shadow-lg">
                    <div className="p-6 border-b bg-blue-600 text-white">
                        <h1 className="text-xl font-bold flex items-center gap-2">
                            <Icon name="Activity" className="text-white"/> 
                            物理科追蹤系統
                        </h1>
                        <p className="text-xs text-blue-100 mt-1 opacity-80">HKDSE Physics Tracker</p>
                    </div>
                    <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                        <button onClick={() => setView('upload')} className={`w-full flex items-center gap-3 px-4 py-3 text-left rounded-lg transition ${view === 'upload' ? 'bg-blue-50 text-blue-700 font-bold shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}>
                            <Icon name="Database" size={18} /> 數據庫 (Data)
                        </button>
                        <button onClick={() => setView('dashboard')} disabled={exams.length === 0} className={`w-full flex items-center gap-3 px-4 py-3 text-left rounded-lg transition ${view === 'dashboard' ? 'bg-blue-50 text-blue-700 font-bold shadow-sm' : 'text-gray-600 hover:bg-gray-50 disabled:opacity-50'}`}>
                            <Icon name="LineChart" size={18} /> 成績追蹤 (Trend)
                        </button>
                        <button onClick={() => setView('generate')} disabled={exams.length === 0} className={`w-full flex items-center gap-3 px-4 py-3 text-left rounded-lg transition ${view === 'generate' ? 'bg-blue-50 text-blue-700 font-bold shadow-sm' : 'text-gray-600 hover:bg-gray-50 disabled:opacity-50'}`}>
                            <Icon name="Zap" size={18} /> 練習生成 (AI)
                        </button>
                        <button onClick={() => setView('history')} className={`w-full flex items-center gap-3 px-4 py-3 text-left rounded-lg transition ${view === 'history' ? 'bg-blue-50 text-blue-700 font-bold shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}>
                            <Icon name="ClipboardList" size={18} /> 練習管理 (Tracker)
                        </button>
                    </nav>
                    
                    <div className="p-4 bg-gray-50 border-t text-xs">
                        <div className="font-bold text-gray-500 mb-2">已載入考試 ({exams.length})</div>
                        <ul className="space-y-1 max-h-24 overflow-y-auto">
                            {exams.map(e => (
                                <li key={e.id} className="truncate text-gray-600 flex items-center gap-1">
                                    <span className="w-1.5 h-1.5 rounded-full bg-green-500"></span> {e.name}
                                </li>
                            ))}
                        </ul>
                    </div>
                </div>
            );

            const UploadView = () => {
                const [tempMap, setTempMap] = useState(null);
                const [tempMarks, setTempMarks] = useState(null);
                const [tempMc, setTempMc] = useState(null);
                const [examName, setExamName] = useState('');

                const handleParse = (file, setter) => {
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => setter(results.data)
                    });
                };

                const addExam = () => {
                    if (!tempMap || !tempMarks || !examName) return;
                    const newExam = {
                        id: Date.now().toString(),
                        name: examName,
                        mapData: tempMap,
                        markSheetData: tempMarks,
                        mcData: tempMc || []
                    };
                    setExams([...exams, newExam]);
                    setTempMap(null);
                    setTempMarks(null);
                    setTempMc(null);
                    setExamName('');
                    showModal({ title: '成功', message: `已成功加入考試: ${examName}`, type: 'success', onConfirm: closeModal });
                };

                const confirmRemoveExam = (id) => {
                    showModal({
                        title: '確認刪除',
                        message: '確定要移除此考試數據嗎？此操作無法復原。',
                        type: 'danger',
                        onConfirm: () => {
                            setExams(exams.filter(x => x.id !== id));
                            closeModal();
                        },
                        onCancel: closeModal
                    });
                };

                return (
                    <div className="max-w-4xl mx-auto mt-6 p-6 space-y-8">
                        <div className="card p-6 bg-slate-50 border border-slate-200">
                            <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <Icon name="Save" size={20} /> 系統數據管理
                            </h2>
                            <div className="flex flex-col sm:flex-row gap-4">
                                <button onClick={exportData} className="flex-1 bg-white border border-slate-300 hover:bg-slate-100 text-slate-700 py-3 rounded-lg flex justify-center items-center gap-2 shadow-sm transition">
                                    <Icon name="Download" size={18} /> 匯出備份 (Backup)
                                </button>
                                <div className="flex-1 relative">
                                    <input 
                                        type="file" 
                                        accept=".json" 
                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                        onChange={(e) => importData(e.target.files[0])}
                                    />
                                    <button className="w-full bg-white border border-slate-300 hover:bg-slate-100 text-slate-700 py-3 rounded-lg flex justify-center items-center gap-2 shadow-sm transition pointer-events-none">
                                        <Icon name="Upload" size={18} /> 匯入還原 (Restore)
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="card p-8 border-l-4 border-blue-500 shadow-md">
                            <h2 className="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                                <Icon name="PlusCircle" /> 新增考試數據
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div className="col-span-2">
                                    <label className="block text-sm font-bold text-gray-700 mb-1">考試名稱 (如: S5 Mid-Term)</label>
                                    <input 
                                        type="text" 
                                        value={examName}
                                        onChange={e => setExamName(e.target.value)}
                                        className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                        placeholder="輸入識別名稱..."
                                    />
                                </div>
                                <div>
                                    <FileUpload id="map-upload" label="1. 題目對照表 (MAP)" onUpload={f => handleParse(f, setTempMap)} />
                                    {tempMap && <div className="text-xs text-green-600 flex items-center"><Icon name="Check" size={12}/> 已讀取</div>}
                                </div>
                                <div>
                                    <FileUpload id="mark-upload" label="2. 成績表 (Marksheet)" onUpload={f => handleParse(f, setTempMarks)} />
                                    {tempMarks && <div className="text-xs text-green-600 flex items-center"><Icon name="Check" size={12}/> 已讀取 {tempMarks.length} 學生</div>}
                                </div>
                                <div className="col-span-2">
                                    <FileUpload id="mc-upload" label="3. MC 紀錄 (選填)" onUpload={f => handleParse(f, setTempMc)} />
                                </div>
                            </div>
                            
                            <button 
                                onClick={addExam}
                                disabled={!tempMap || !tempMarks || !examName}
                                className="w-full btn-primary py-3 rounded-lg font-bold shadow disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                確認加入此考試
                            </button>
                        </div>

                        {exams.length > 0 && (
                            <div className="card p-6">
                                <h3 className="font-bold text-gray-700 mb-4">現有考試列表</h3>
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-50 text-left">
                                        <tr>
                                            <th className="p-3">名稱</th>
                                            <th className="p-3">學生人數</th>
                                            <th className="p-3 text-right">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {exams.map((e) => (
                                            <tr key={e.id} className="border-t">
                                                <td className="p-3 font-medium">{e.name}</td>
                                                <td className="p-3">{e.markSheetData.length}</td>
                                                <td className="p-3 text-right">
                                                    <button 
                                                        onClick={() => confirmRemoveExam(e.id)}
                                                        className="text-red-500 hover:text-red-700 text-xs underline"
                                                    >
                                                        移除
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                );
            };

            const DashboardView = () => {
                const lineChartRef = useRef(null);
                const barChartRef = useRef(null);
                const [selectedExamIndex, setSelectedExamIndex] = useState(exams.length - 1); 

                const activeReport = studentTrend ? studentTrend[selectedExamIndex] : null;

                useEffect(() => {
                    if (studentTrend && lineChartRef.current) {
                        if (lineChartRef.current.chartInstance) {
                            lineChartRef.current.chartInstance.destroy();
                        }
                        const ctx = lineChartRef.current.getContext('2d');
                        lineChartRef.current.chartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: studentTrend.map(r => r.examName),
                                datasets: [{
                                    label: '整體得分率 (%)',
                                    data: studentTrend.map(r => r.overallPercentage),
                                    borderColor: '#2563eb',
                                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                                    fill: true,
                                    tension: 0.3
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: { title: { display: true, text: '學生成績趨勢' } },
                                scales: { y: { min: 0, max: 100 } }
                            }
                        });
                    }
                }, [studentTrend]);

                useEffect(() => {
                    if (activeReport && barChartRef.current) {
                        if (barChartRef.current.chartInstance) {
                            barChartRef.current.chartInstance.destroy();
                        }
                        
                        // Sort for chart display as well
                        const topics = Object.entries(activeReport.topics)
                            .sort((a, b) => a[0].localeCompare(b[0], undefined, { numeric: true, sensitivity: 'base' }))
                            .map(([_, t]) => t);

                        const ctx = barChartRef.current.getContext('2d');
                        barChartRef.current.chartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: topics.map(t => t.name.substring(0, 10)),
                                datasets: [{
                                    label: '課題得分率 (%)',
                                    data: topics.map(t => t.percentage),
                                    backgroundColor: topics.map(t => t.percentage < 50 ? '#ef4444' : '#22c55e')
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: { y: { min: 0, max: 100 } }
                            }
                        });
                    }
                }, [activeReport]);

                if (!studentTrend || studentTrend.length === 0) return <div className="p-8 text-center text-gray-500">請先在數據庫上傳考試資料。</div>;

                return (
                    <div className="p-6 space-y-6">
                        <div className="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-lg shadow-sm">
                            <h2 className="text-2xl font-bold text-gray-800">學生成績追蹤</h2>
                            <div className="flex items-center gap-2 mt-4 md:mt-0">
                                <Icon name="User" size={20} className="text-gray-500" />
                                <select 
                                    className="p-2 border rounded-md min-w-[250px] font-medium"
                                    value={selectedStudentId}
                                    onChange={(e) => setSelectedStudentId(e.target.value)}
                                >
                                    {students.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}
                                </select>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="card p-6">
                                <h3 className="font-bold text-gray-700 mb-2">考試趨勢 (Trend)</h3>
                                <canvas ref={lineChartRef} height="150"></canvas>
                            </div>

                            <div className="card p-6 flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-gray-700">弱項分析 (Weaknesses)</h3>
                                    <select 
                                        className="text-sm border rounded p-1"
                                        value={selectedExamIndex}
                                        onChange={e => setSelectedExamIndex(Number(e.target.value))}
                                    >
                                        {studentTrend.map((r, i) => (
                                            <option key={i} value={i}>{r.examName}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                {activeReport && (
                                    <div className="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar" style={{maxHeight: '250px'}}>
                                        {activeReport.weaknesses.length === 0 ? (
                                            <div className="text-center py-10 text-green-600 bg-green-50 rounded">
                                                <Icon name="Award" size={32} className="mx-auto mb-2"/>
                                                此考試表現優異，無顯著弱點
                                            </div>
                                        ) : (
                                            activeReport.weaknesses.map((w, idx) => (
                                                <div key={idx} className="p-3 bg-red-50 border-l-4 border-red-500 rounded text-sm relative group hover:bg-red-100 transition">
                                                    <div className="font-bold text-red-800">{w.topic}</div>
                                                    <div className="text-gray-700">{w.concept}</div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="card p-6">
                            <h3 className="font-bold text-gray-700 mb-4">
                                {activeReport ? `${activeReport.examName} - 課題詳細表現` : '課題表現'}
                            </h3>
                            <div className="h-64 w-full">
                                <canvas ref={barChartRef}></canvas>
                            </div>
                        </div>
                    </div>
                );
            };

            const GenerateView = () => {
                const [selectedTopics, setSelectedTopics] = useState([]);
                const [difficulty, setDifficulty] = useState('Medium');
                const [count, setCount] = useState(5);
                const [promptText, setPromptText] = useState('');
                
                const latestExamReport = studentTrend && studentTrend.length > 0 ? studentTrend[studentTrend.length - 1] : null;

                useEffect(() => {
                    if (latestExamReport) {
                        const weakTopicNames = new Set(latestExamReport.weaknesses.map(w => w.topic));
                        const weakTopicIds = Object.entries(latestExamReport.topics)
                            .filter(([id, t]) => weakTopicNames.has(t.name))
                            .map(([id]) => id);
                        setSelectedTopics(weakTopicIds);
                    }
                }, [latestExamReport]);

                const toggleTopic = (id) => {
                    if (selectedTopics.includes(id)) setSelectedTopics(selectedTopics.filter(t => t !== id));
                    else setSelectedTopics([...selectedTopics, id]);
                };

                const handleGenerate = () => {
                    if (!latestExamReport || selectedTopics.length === 0) {
                         showModal({ title: '注意', message: '請選擇至少一個課題。', type: 'info', onConfirm: closeModal });
                         return;
                    }

                    const student = getStudentData();
                    const targetTopics = Object.entries(latestExamReport.topics)
                        .filter(([id]) => selectedTopics.includes(id))
                        .map(([_, t]) => t);
                    
                    const topicNames = targetTopics.map(t => t.name).join(', ');

                    const prompt = `You are a Physics Tutor. Generate ${count} ${difficulty} questions for HKDSE Physics.
Topics: ${topicNames}
Student Weaknesses: ${latestExamReport.weaknesses.filter(w => selectedTopics.includes(w.topic) || topicNames.includes(w.topic)).map(w => w.concept).join('; ')}
Provide questions, answers, and explanations.`;

                    setPromptText(prompt);

                    const newEntry = {
                        id: Date.now(),
                        date: new Date().toISOString().split('T')[0],
                        studentId: selectedStudentId,
                        studentName: student.label,
                        topics: topicNames,
                        difficulty,
                        count,
                        status: 'pending',
                        score: '',
                        maxScore: count
                    };
                    setHistory([newEntry, ...history]);
                    showModal({ title: '生成成功', message: '練習已生成並添加至進度管理 (Tracker)。', type: 'success', onConfirm: closeModal });
                };

                const getStudentData = () => students.find(s => s.id === selectedStudentId);
                
                if (!latestExamReport) return <div className="p-8 text-center text-gray-500">請先在數據庫加入考試資料。</div>;

                // SORTING LOGIC: Natural sort based on Topic ID (1.1.1, 1.1.2 ...)
                const sortedTopics = Object.entries(latestExamReport.topics).sort((a, b) => {
                    return a[0].localeCompare(b[0], undefined, { numeric: true, sensitivity: 'base' });
                });

                return (
                    <div className="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                        <div className="card p-6 flex flex-col h-full overflow-y-auto">
                            <h2 className="text-xl font-bold mb-4">1. 設定練習參數</h2>
                            <div className="mb-4">
                                <label className="block text-sm font-bold text-gray-700 mb-2">目標學生</label>
                                <div className="p-2 bg-blue-50 text-blue-800 rounded border border-blue-200 font-medium">
                                    {getStudentData().label}
                                </div>
                            </div>
                            
                            <div className="mb-4 flex-1 overflow-hidden flex flex-col">
                                <label className="block text-sm font-bold text-gray-700 mb-2">選擇課題 (根據 Topic ID 排序)</label>
                                <div className="border rounded-md overflow-y-auto p-2 space-y-1 flex-1 bg-gray-50 custom-scrollbar">
                                    {sortedTopics.map(([id, t]) => (
                                        <label key={id} className={`flex items-center gap-3 p-2 rounded cursor-pointer hover:bg-white border border-transparent hover:border-gray-200 ${t.percentage < 50 ? 'text-red-600' : 'text-gray-700'}`}>
                                            <input 
                                                type="checkbox" 
                                                checked={selectedTopics.includes(id)}
                                                onChange={() => toggleTopic(id)}
                                                className="rounded text-blue-600 w-4 h-4"
                                            />
                                            <div className="flex-1">
                                                <div className="text-xs font-bold text-gray-500">{id}</div>
                                                <div className="text-sm">{t.name}</div>
                                            </div>
                                            <span className="text-xs font-mono">{t.percentage.toFixed(0)}%</span>
                                        </label>
                                    ))}
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4 mt-4">
                                <select value={difficulty} onChange={e => setDifficulty(e.target.value)} className="border p-2 rounded">
                                    <option value="High">High (拔尖)</option>
                                    <option value="Medium">Medium (鞏固)</option>
                                    <option value="Low">Low (補底)</option>
                                </select>
                                <input type="number" value={count} onChange={e => setCount(e.target.value)} className="border p-2 rounded" min="1" max="20" />
                            </div>

                            <button onClick={handleGenerate} className="mt-6 btn-primary py-3 rounded-lg font-bold flex justify-center items-center gap-2">
                                <Icon name="Cpu" /> 生成並記錄 (Generate & Track)
                            </button>
                        </div>

                        <div className="card p-6 flex flex-col h-full">
                            <h2 className="text-xl font-bold mb-4">2. AI Prompt & 預覽</h2>
                            <textarea 
                                className="flex-1 w-full bg-slate-900 text-slate-200 p-4 rounded-lg font-mono text-sm resize-none mb-4"
                                readOnly
                                value={promptText || "請先設定左側參數並點擊生成..."}
                            ></textarea>
                            <button 
                                onClick={() => {
                                    navigator.clipboard.writeText(promptText);
                                    showModal({ title: '已複製', message: 'Prompt 已複製到剪貼簿。', type: 'info', onConfirm: closeModal });
                                }} 
                                disabled={!promptText}
                                className="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg flex justify-center gap-2"
                            >
                                <Icon name="Copy" /> 複製 Prompt 到 ChatGPT/Gemini
                            </button>
                        </div>
                    </div>
                );
            };

            const HistoryView = () => {
                const [filter, setFilter] = useState('all'); 
                const [searchTerm, setSearchTerm] = useState('');

                const updateStatus = (id, newStatus) => {
                    const updated = history.map(h => h.id === id ? { ...h, status: newStatus } : h);
                    setHistory(updated);
                };

                const updateScore = (id, score) => {
                    const updated = history.map(h => h.id === id ? { ...h, score: score } : h);
                    setHistory(updated);
                };

                const confirmDeleteRecord = (id) => {
                    showModal({
                        title: '刪除紀錄',
                        message: '確定要刪除這條練習紀錄嗎？',
                        type: 'danger',
                        onConfirm: () => {
                            setHistory(history.filter(h => h.id !== id));
                            closeModal();
                        },
                        onCancel: closeModal
                    });
                };

                const filteredHistory = history.filter(h => {
                    if (filter !== 'all' && h.status !== filter) return false;
                    if (searchTerm && !h.studentName.includes(searchTerm) && !h.topics.includes(searchTerm)) return false;
                    return true;
                });

                return (
                    <div className="p-6 h-screen flex flex-col">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">練習進度管理 (Tracker)</h2>
                            <div className="flex gap-2">
                                <input 
                                    type="text" 
                                    placeholder="搜尋學生/課題..." 
                                    className="p-2 border rounded-lg text-sm w-64"
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                />
                                <select className="p-2 border rounded-lg text-sm" value={filter} onChange={e => setFilter(e.target.value)}>
                                    <option value="all">顯示全部</option>
                                    <option value="pending">未完成 (Pending)</option>
                                    <option value="submitted">已提交 (Submitted)</option>
                                    <option value="graded">已評分 (Graded)</option>
                                </select>
                            </div>
                        </div>

                        <div className="card flex-1 overflow-hidden flex flex-col shadow-md">
                            <div className="overflow-auto flex-1 custom-scrollbar">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-gray-100 text-gray-600 uppercase sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th className="px-4 py-3">日期</th>
                                            <th className="px-4 py-3">學生</th>
                                            <th className="px-4 py-3">課題 & 難度</th>
                                            <th className="px-4 py-3">狀態 (Status)</th>
                                            <th className="px-4 py-3">分數 (Score)</th>
                                            <th className="px-4 py-3 text-right">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {filteredHistory.length === 0 ? (
                                            <tr><td colSpan="6" className="p-8 text-center text-gray-400">暫無相關紀錄</td></tr>
                                        ) : (
                                            filteredHistory.map((h) => (
                                                <tr key={h.id} className="hover:bg-blue-50 transition-colors">
                                                    <td className="px-4 py-3 text-gray-500 whitespace-nowrap">{h.date}</td>
                                                    <td className="px-4 py-3 font-medium text-gray-800">{h.studentName}</td>
                                                    <td className="px-4 py-3">
                                                        <div className="font-medium text-gray-700 truncate max-w-xs" title={h.topics}>{h.topics}</div>
                                                        <div className="text-xs text-gray-400 flex gap-2 mt-1">
                                                            <span className={`px-1.5 rounded ${h.difficulty === 'High' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600'}`}>{h.difficulty}</span>
                                                            <span>{h.count}題</span>
                                                        </div>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <select 
                                                            value={h.status} 
                                                            onChange={(e) => updateStatus(h.id, e.target.value)}
                                                            className={`border-none text-xs font-bold px-2 py-1 rounded-full cursor-pointer outline-none focus:ring-2 focus:ring-offset-1 ${
                                                                h.status === 'pending' ? 'bg-gray-200 text-gray-700' :
                                                                h.status === 'submitted' ? 'bg-yellow-100 text-yellow-800' :
                                                                'bg-green-100 text-green-800'
                                                            }`}
                                                        >
                                                            <option value="pending">未完成</option>
                                                            <option value="submitted">已提交</option>
                                                            <option value="graded">已評分</option>
                                                        </select>
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <ScoreInput 
                                                            value={h.score} 
                                                            max={h.maxScore} 
                                                            onSave={(newScore) => updateScore(h.id, newScore)} 
                                                        />
                                                    </td>
                                                    <td className="px-4 py-3 text-right">
                                                        <button onClick={() => confirmDeleteRecord(h.id)} className="text-gray-400 hover:text-red-500 p-1">
                                                            <Icon name="Trash2" size={16} />
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            <div className="p-3 bg-gray-50 border-t text-xs text-gray-500 flex justify-between">
                                <span>共 {filteredHistory.length} 條紀錄</span>
                                <span>數據儲存於瀏覽器 LocalStorage</span>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex min-h-screen bg-gray-100 text-gray-800 relative">
                    <Sidebar />
                    <div className="flex-1 ml-64 overflow-hidden">
                        {view === 'upload' && <UploadView />}
                        {view === 'dashboard' && <DashboardView />}
                        {view === 'generate' && <GenerateView />}
                        {view === 'history' && <HistoryView />}
                    </div>
                    {/* Modal Overlay */}
                    <Modal {...modalConfig} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>