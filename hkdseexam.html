<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKDSE Physics AI Trainer (Safe Mode)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .sidebar-link { cursor: pointer; }
        .sidebar-link:hover { background-color: #e0e7ff; }
        /* éŒ¯èª¤è¨Šæ¯æ¨£å¼ */
        #error-box { display: none; background: #fee2e2; color: #991b1b; padding: 20px; border: 2px solid #ef4444; margin: 20px; border-radius: 8px; }
    </style>
</head>
<body>
    <div id="error-box">
        <h3 style="font-weight:bold">ç™¼ç”ŸéŒ¯èª¤ (Error Occurred):</h3>
        <pre id="error-message"></pre>
        <p>è«‹æª¢æŸ¥æ‚¨çš„ç¶²çµ¡é€£ç·šï¼Œæˆ–å˜—è©¦ä½¿ç”¨ Chrome / Edge ç€è¦½å™¨æ‰“é–‹ã€‚</p>
    </div>

    <div id="root">
        <div style="text-align: center; padding-top: 50px; color: #666;">
            <h2 style="font-size: 24px;">ğŸš€ ç³»çµ±å•Ÿå‹•ä¸­...</h2>
            <p>æ­£åœ¨è¼‰å…¥çµ„ä»¶ï¼Œè«‹ç¨å€™...</p>
        </div>
    </div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('error-box').style.display = 'block';
            document.getElementById('error-message').textContent = message + '\nLine: ' + lineno;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 1. æ¨¡æ“¬èª²ç¨‹æ•¸æ“šåº« (SYLLABUS) ---
        const SYLLABUS_DATA = {
            "1.1.1": { section: "ç†±å’Œæ°£é«”", topic: "æ¸©åº¦èˆ‡æ¸©åº¦è¨ˆ", desc: "é‡åº¦æ¸©åº¦, èªè­˜æ¸©åº¦ç‚ºç‰©é«”å†·ç†±ç¨‹åº¦çš„æ¨™èªŒ" },
            "1.2.1": { section: "ç†±å’Œæ°£é«”", topic: "å…§èƒ½èˆ‡èƒ½é‡è½‰ç§»", desc: "é—¡é‡‹æ¸©åº¦ç‚ºç³»çµ±å…§åˆ†å­éš¨æ©Ÿé‹å‹•å¹³å‡å‹•èƒ½çš„å®šé‡é—œä¿‚" },
            "1.2.2": { section: "ç†±å’Œæ°£é«”", topic: "ç†±å‚³éæ–¹å¼", desc: "é‘‘å®šèƒ½é‡è½‰ç§»çš„æ–¹å¼å¯åˆ†ç‚ºå‚³å°ã€å°æµå’Œè¼»å°„" },
            "1.3.2": { section: "ç†±å’Œæ°£é«”", topic: "ç†±å®¹é‡å’Œæ¯”ç†±å®¹é‡", desc: "å®šç¾©åŠè§£æ±ºæœ‰é—œæ¯”ç†±å®¹é‡çš„å•é¡Œ (E=mcÎ”T)" },
            "1.4.1": { section: "ç†±å’Œæ°£é«”", topic: "æ½›ç†±", desc: "æ‡‰ç”¨ E=ml è§£æ±ºæœ‰é—œç‰©æ…‹è®ŠåŒ–çš„å•é¡Œ" },
            "1.5.1": { section: "ç†±å’Œæ°£é«”", topic: "æ°£é«”å®šå¾‹", desc: "æ‡‰ç”¨æ™®é©æ°£é«”å®šå¾‹ pV=nRT" },
            "2.1.1": { section: "åŠ›å’Œé‹å‹•", topic: "ä½ç½®å’Œç§»å‹•", desc: "åˆ†æä½ç§»-æ™‚é–“åŠé€Ÿåº¦-æ™‚é–“åœ–åƒ" },
            "2.2.1": { section: "åŠ›å’Œé‹å‹•", topic: "ç‰›é “å®šå¾‹", desc: "æ‡‰ç”¨ç‰›é “ç¬¬äºŒå®šå¾‹ F=ma" },
            "2.9.2": { section: "åŠ›å’Œé‹å‹•", topic: "åœ“å‘¨é‹å‹•", desc: "æ‡‰ç”¨å‘å¿ƒåŠ›å…¬å¼ F=mvÂ²/r" },
            "3.1.1": { section: "æ³¢å‹•", topic: "æ³¢çš„æ€§è³ª", desc: "æè¿°ç¸±æ³¢èˆ‡æ©«æ³¢çš„åˆ†åˆ¥" },
            "E3.1.1": { section: "èƒ½é‡å’Œèƒ½æº (E3)", topic: "å®¶å±…ç”¨é›»", desc: "è¨ˆç®—é›»å™¨çš„èƒ½æºæ•ˆç›Šèˆ‡æˆæœ¬" },
            "E3.4.1": { section: "èƒ½é‡å’Œèƒ½æº (E3)", topic: "å¯å†ç”Ÿèƒ½æº", desc: "æè¿°æ ¸è£‚è®Šèˆ‡æ ¸èšè®Šçš„åŸç†" }
        };

        // --- æ¨¡æ“¬é¡Œç›®åœ°åœ– (Mapping) ---
        const MOCK_QUESTION_MAP = {
            "2023_1A_1": "1.1.1", "2023_1A_2": "1.2.2", "2023_1A_3": "1.3.2",
            "2023_1B_1": "1.5.1", "2023_1B_2": "2.2.1",
            "2022_1A_1": "2.1.1", "2022_1A_2": "2.9.2",
            "2022_1B_1": "E3.1.1", "2022_1B_2": "E3.4.1"
        };

        const App = () => {
            const [view, setView] = useState('dashboard'); 
            const [students, setStudents] = useState([]);
            const [currentStudentId, setCurrentStudentId] = useState('');
            const [records, setRecords] = useState([]);
            const [promptHistory, setPromptHistory] = useState([]);

            // AI Settings
            const [aiSettings, setAiSettings] = useState({
                role: "DSE Physics Expert Tutor",
                language: "ç¹é«”ä¸­æ–‡",
                type: "mixed",
                weaknessFocus: 20,
                customInstructions: ""
            });

            // Load Data
            useEffect(() => {
                try {
                    const savedData = localStorage.getItem('dsePhysicsData');
                    if (savedData) {
                        const parsed = JSON.parse(savedData);
                        setStudents(parsed.students || []);
                        setRecords(parsed.records || []);
                        setPromptHistory(parsed.history || []);
                        if(parsed.students?.[0]) setCurrentStudentId(parsed.students[0].id);
                    } else {
                        const newId = Date.now().toString();
                        setStudents([{ id: newId, name: "é™³å¤§æ–‡ (Demo)" }]);
                        setCurrentStudentId(newId);
                    }
                } catch (e) {
                    console.error("Load Error", e);
                }
            }, []);

            // Auto Save
            useEffect(() => {
                if(students.length > 0) {
                    const data = { students, records, history: promptHistory };
                    localStorage.setItem('dsePhysicsData', JSON.stringify(data));
                }
            }, [students, records, promptHistory]);

            const handleExport = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ students, records, history: promptHistory }));
                const link = document.createElement('a');
                link.href = dataStr;
                link.download = "dse_physics_data.json";
                link.click();
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        setStudents(parsed.students || []);
                        setRecords(parsed.records || []);
                        setPromptHistory(parsed.history || []);
                        alert("âœ… åŒ¯å…¥æˆåŠŸï¼");
                    } catch (err) {
                        alert("âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
                    }
                };
                reader.readAsText(file);
            };

            const getStudentWeaknesses = (studentId) => {
                const studentRecords = records.filter(r => r.studentId === studentId);
                let topicStats = {}; 

                studentRecords.forEach(record => {
                    Object.entries(record.scores).forEach(([qNum, score]) => {
                        const mapKey = `${record.year}_${record.paper}_${qNum}`;
                        const topicId = MOCK_QUESTION_MAP[mapKey] || Object.keys(SYLLABUS_DATA)[qNum % Object.keys(SYLLABUS_DATA).length];

                        if (!topicStats[topicId]) topicStats[topicId] = { obtained: 0, total: 0 };
                        topicStats[topicId].obtained += parseInt(score || 0);
                        topicStats[topicId].total += 10; 
                    });
                });

                let weaknesses = [];
                Object.entries(topicStats).forEach(([id, stats]) => {
                    const pct = (stats.obtained / stats.total) * 100;
                    if (SYLLABUS_DATA[id]) {
                        weaknesses.push({
                            id,
                            name: SYLLABUS_DATA[id].topic,
                            desc: SYLLABUS_DATA[id].desc,
                            pct: pct.toFixed(1)
                        });
                    }
                });

                return weaknesses.sort((a, b) => a.pct - b.pct);
            };

            // --- Views ---

            const Sidebar = () => (
                <div className="w-64 bg-slate-800 text-white flex flex-col h-screen fixed left-0 top-0 shadow-xl overflow-y-auto">
                    <div className="p-6 border-b border-slate-700">
                        <h1 className="font-bold text-lg">âš¡ DSE Phy Trainer</h1>
                    </div>
                    <nav className="flex-1 p-4 space-y-2">
                        <button onClick={() => setView('dashboard')} className={`w-full text-left px-4 py-3 rounded ${view === 'dashboard' ? 'bg-slate-600' : 'hover:bg-slate-700'}`}>
                            ğŸ“Š ç¸½è¦½èˆ‡åˆ†æ
                        </button>
                        <button onClick={() => setView('input')} className={`w-full text-left px-4 py-3 rounded ${view === 'input' ? 'bg-slate-600' : 'hover:bg-slate-700'}`}>
                            ğŸ“ è¼¸å…¥åˆ†æ•¸
                        </button>
                        <button onClick={() => setView('generate')} className={`w-full text-left px-4 py-3 rounded ${view === 'generate' ? 'bg-slate-600' : 'hover:bg-slate-700'}`}>
                            ğŸ§  ç”Ÿæˆ AI ç·´ç¿’
                        </button>
                        <button onClick={() => setView('history')} className={`w-full text-left px-4 py-3 rounded ${view === 'history' ? 'bg-slate-600' : 'hover:bg-slate-700'}`}>
                            ğŸ•’ ç·´ç¿’è¨˜éŒ„
                        </button>
                    </nav>
                    <div className="p-4 bg-slate-900 border-t border-slate-700">
                        <div className="text-xs text-slate-400 mb-2">æ•¸æ“šç®¡ç†</div>
                        <div className="flex gap-2">
                            <button onClick={handleExport} className="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded text-sm">åŒ¯å‡º JSON</button>
                            <label className="flex-1 bg-green-600 hover:bg-green-500 py-2 rounded text-center cursor-pointer text-sm">
                                åŒ¯å…¥
                                <input type="file" onChange={handleImport} className="hidden" accept=".json" />
                            </label>
                        </div>
                    </div>
                </div>
            );

            const InputView = () => {
                const [form, setForm] = useState({ year: '2023', paper: '1A', scores: {} });
                const questionCount = form.paper === '1A' ? 33 : (form.paper === '1B' ? 15 : 10);
                
                const handleSave = () => {
                    if (!currentStudentId) return alert("è«‹å…ˆå»ºç«‹å­¸ç”Ÿ");
                    const newRecord = {
                        id: Date.now(),
                        studentId: currentStudentId,
                        ...form,
                        date: new Date().toISOString()
                    };
                    setRecords([...records, newRecord]);
                    alert("âœ… åˆ†æ•¸å·²å„²å­˜ï¼");
                    setView('dashboard');
                };

                return (
                    <div className="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow">
                        <h2 className="text-xl font-bold mb-4">ğŸ“ è¼¸å…¥æ­·å±†è©¦é¡Œåˆ†æ•¸</h2>
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label className="block text-sm font-bold mb-1">å¹´ä»½</label>
                                <select className="w-full p-2 border rounded" value={form.year} onChange={e => setForm({...form, year: e.target.value})}>
                                    {[2023,2022,2021,2020,2019,2018].map(y => <option key={y} value={y}>{y}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-bold mb-1">è©¦å·</label>
                                <select className="w-full p-2 border rounded" value={form.paper} onChange={e => setForm({...form, paper: e.target.value, scores: {}})}>
                                    <option value="1A">Paper 1A (MC)</option>
                                    <option value="1B">Paper 1B (Long Q)</option>
                                    <option value="2">Paper 2 (Elective)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div className="bg-blue-50 p-4 rounded mb-4">
                            <h3 className="text-sm font-bold text-blue-800 mb-2">æ¯é¡Œåˆ†æ•¸ (æ¸¬è©¦ç”¨ï¼šæ»¿åˆ† 10)</h3>
                            <div className="grid grid-cols-5 gap-2">
                                {Array.from({length: questionCount}).map((_, i) => (
                                    <div key={i}>
                                        <label className="text-xs text-gray-500 block">Q{i+1}</label>
                                        <input 
                                            type="number" 
                                            className="w-full p-1 border rounded text-center"
                                            min="0" max="10"
                                            value={form.scores[i+1] || ''}
                                            onChange={(e) => setForm({
                                                ...form, 
                                                scores: { ...form.scores, [i+1]: e.target.value } 
                                            })}
                                        />
                                    </div>
                                ))}
                            </div>
                        </div>
                        <button onClick={handleSave} className="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">å„²å­˜è¨˜éŒ„</button>
                    </div>
                );
            };

            const DashboardView = () => {
                const weaknesses = useMemo(() => getStudentWeaknesses(currentStudentId), [records, currentStudentId]);
                
                useEffect(() => {
                    if (weaknesses.length > 0) {
                        const ctx = document.getElementById('weaknessChart');
                        if (ctx) {
                            const chartInstance = Chart.getChart("weaknessChart");
                            if (chartInstance) chartInstance.destroy();
                            new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: weaknesses.slice(0, 5).map(w => w.id),
                                    datasets: [{
                                        label: 'å¾—åˆ†ç‡ (%)',
                                        data: weaknesses.slice(0, 5).map(w => w.pct),
                                        backgroundColor: '#ef4444'
                                    }]
                                },
                                options: { scales: { y: { beginAtZero: true, max: 100 } } }
                            });
                        }
                    }
                }, [weaknesses]);

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center bg-white p-4 rounded shadow">
                            <h2 className="text-xl font-bold">ğŸ“Š å­¸ç”Ÿåˆ†æå„€è¡¨æ¿</h2>
                            <select className="p-2 border rounded" value={currentStudentId} onChange={(e) => setCurrentStudentId(e.target.value)}>
                                {students.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>

                        {records.length === 0 ? (
                            <div className="text-center py-20 bg-white rounded border-dashed border-2 border-gray-300">
                                <p className="text-gray-500">æš«ç„¡æ•¸æ“šï¼Œè«‹å…ˆå»ã€ŒğŸ“ è¼¸å…¥åˆ†æ•¸ã€ã€‚</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-white p-6 rounded shadow">
                                    <h3 className="font-bold text-lg mb-4 text-red-600">âš  å¼±é …èª²é¡Œ Top 5</h3>
                                    {weaknesses.slice(0, 5).map(w => (
                                        <div key={w.id} className="mb-3 p-3 bg-red-50 rounded border-l-4 border-red-500 flex justify-between">
                                            <div>
                                                <span className="font-bold block">{w.id} {w.name}</span>
                                                <span className="text-xs text-gray-600">{w.desc}</span>
                                            </div>
                                            <span className="font-bold text-red-700 text-xl">{w.pct}%</span>
                                        </div>
                                    ))}
                                    <button onClick={() => setView('generate')} className="w-full mt-2 py-2 bg-slate-800 text-white rounded hover:bg-slate-700">
                                        é‡å°å¼±é …ç”Ÿæˆç·´ç¿’ â”
                                    </button>
                                </div>
                                <div className="bg-white p-6 rounded shadow">
                                    <h3 className="font-bold text-lg mb-4">è¡¨ç¾åœ–è¡¨</h3>
                                    <canvas id="weaknessChart"></canvas>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const GenerateView = () => {
                const [generatedPrompt, setGeneratedPrompt] = useState('');
                const weaknesses = getStudentWeaknesses(currentStudentId).slice(0, 3);

                const generatePrompt = () => {
                    const weakListText = weaknesses.map(w => `- [${w.id}] ${w.name}: ${w.desc} (å¾—åˆ†ç‡: ${w.pct}%)`).join('\n');
                    const prompt = `**è§’è‰²**: ${aiSettings.role}\n**ä»»å‹™**: é‡å°ä»¥ä¸‹ DSE ç‰©ç†å­¸ç”Ÿå¼±é …è£½ä½œç·´ç¿’ã€‚\n\n**å¼±é …æ•¸æ“š**:\n${weakListText || "ç„¡æ•¸æ“š"}\n\n**è¨­å®š**:\n- èªè¨€: ${aiSettings.language}\n- é¡Œå‹: ${aiSettings.type}\n- å¼±é …ä½”æ¯”: ${aiSettings.weaknessFocus}%\n- æŒ‡ä»¤: ${aiSettings.customInstructions}\n\nè«‹ç”Ÿæˆé¡Œç›®ã€è©³ç´°é¡Œè§£åŠ Marking Schemeã€‚`;
                    setGeneratedPrompt(prompt);
                    setPromptHistory([{id: Date.now(), date: new Date().toLocaleString(), promptSnippet: prompt.substring(0,30)+"...", fullPrompt: prompt}, ...promptHistory]);
                };

                return (
                    <div className="flex flex-col md:flex-row gap-6 h-full">
                        <div className="w-full md:w-1/3 bg-white p-5 rounded shadow space-y-4">
                            <h3 className="font-bold border-b pb-2">âš™ï¸ AI è¨­å®š</h3>
                            <div><label className="text-xs font-bold block">AI è§’è‰²</label><input className="w-full border p-1 rounded" value={aiSettings.role} onChange={e => setAiSettings({...aiSettings, role: e.target.value})} /></div>
                            <div><label className="text-xs font-bold block">èªè¨€</label><select className="w-full border p-1 rounded" value={aiSettings.language} onChange={e => setAiSettings({...aiSettings, language: e.target.value})}><option>ç¹é«”ä¸­æ–‡</option><option>English</option></select></div>
                            <div><label className="text-xs font-bold block">é¡Œå‹</label><select className="w-full border p-1 rounded" value={aiSettings.type} onChange={e => setAiSettings({...aiSettings, type: e.target.value})}><option value="mixed">æ··åˆ</option><option value="mc">MC</option></select></div>
                            <div><label className="text-xs font-bold block">å¼±é …æ¯”ä¾‹ ({aiSettings.weaknessFocus}%)</label><input type="range" className="w-full" min="0" max="100" step="10" value={aiSettings.weaknessFocus} onChange={e => setAiSettings({...aiSettings, weaknessFocus: e.target.value})} /></div>
                            <div><label className="text-xs font-bold block">è‡ªè¨‚æŒ‡ä»¤</label><textarea className="w-full border p-1 rounded" value={aiSettings.customInstructions} onChange={e => setAiSettings({...aiSettings, customInstructions: e.target.value})}></textarea></div>
                            <button onClick={generatePrompt} className="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">ç”Ÿæˆ Prompt âœ¨</button>
                        </div>
                        <div className="flex-1 bg-white p-5 rounded shadow flex flex-col">
                            <h3 className="font-bold mb-2">ğŸ“‹ çµæœ (è¤‡è£½çµ¦ Gemini)</h3>
                            <textarea className="flex-1 w-full bg-gray-50 border p-2 rounded font-mono text-sm" value={generatedPrompt} readOnly></textarea>
                        </div>
                    </div>
                );
            };

            const HistoryView = () => (
                <div className="bg-white p-6 rounded shadow">
                    <h2 className="text-xl font-bold mb-4">ğŸ•’ è¨˜éŒ„</h2>
                    <ul className="space-y-2">
                        {promptHistory.map(h => (
                            <li key={h.id} className="border-b p-2 flex justify-between hover:bg-gray-50">
                                <span><span className="text-gray-500 text-sm">{h.date}</span> - {h.promptSnippet}</span>
                                <button onClick={() => {navigator.clipboard.writeText(h.fullPrompt); alert("å·²è¤‡è£½")}} className="text-blue-600 text-sm">è¤‡è£½</button>
                            </li>
                        ))}
                    </ul>
                </div>
            );

            return (
                <div className="flex min-h-screen">
                    <Sidebar />
                    <div className="flex-1 ml-64 p-8 overflow-y-auto h-screen">
                        {view === 'dashboard' && <DashboardView />}
                        {view === 'input' && <InputView />}
                        {view === 'generate' && <GenerateView />}
                        {view === 'history' && <HistoryView />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
