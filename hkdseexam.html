<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKDSE Physics Trainer V7.3.0 (History Added)</title>
    
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        .sub-topic-tag { font-family: 'Courier New', monospace; font-weight: bold; }
        .stats-list { max-height: 500px; overflow-y: auto; padding-right: 5px; }
        .stats-list::-webkit-scrollbar { width: 6px; }
        .stats-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .stats-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body>
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ==========================================
        // 0. é è¨­æ¨™æº–ç­”æ¡ˆæ•¸æ“šåº« (PRELOADED_KEYS)
        // ==========================================
        
        const PRELOADED_KEYS = {
            "2014_1A": {
                1: "D", 2: "A", 3: "C", 4: "A", 5: "B",
                6: "D", 7: "C", 8: "C", 9: "B", 10: "B",
                11: "B", 12: "B", 13: "B", 14: "A", 15: "C",
                16: "A", 17: "B", 18: "C", 19: "A", 20: "C",
                21: "D", 22: "D", 23: "B", 24: "C", 25: "D",
                26: "A", 27: "D", 28: "D", 29: "B", 30: "B",
                31: "D", 32: "A", 33: "C"
            },
             "2014_2_E3": {
                1: "A", 2: "C", 3: "D", 4: "C", 
                5: "B", 6: "D", 7: "B", 8: "A" 
            },
            "2014_2_E4": {
                1: "A", 2: "D", 3: "B", 4: "C", 
                5: "C", 6: "D", 7: "B", 8: "A" 
            },
            "2016_1A": {
                1: "D", 2: "A", 3: "B", 4: "B", 5: "C",
                6: "D", 7: "A", 8: "C", 9: "B", 10: "B",
                11: "D", 12: "B", 13: "D", 14: "A", 15: "D",
                16: "B", 17: "C", 18: "A", 19: "C", 20: "A",
                21: "C", 22: "D", 23: "D", 24: "B", 25: "C",
                26: "C", 27: "A", 28: "B", 29: "D", 30: "C",
                31: "D", 32: "A", 33: "D"
            },
            "2016_2_E3": {
                1: "A", 2: "C", 3: "B", 4: "D", 
                5: "A", 6: "C", 7: "B", 8: "D" 
            },
            "2016_2_E4": {
                1: "B", 2: "A", 3: "C", 4: "D", 
                5: "B", 6: "A", 7: "C", 8: "D" 
            },
        };

        // ==========================================
        // 1. å®Œæ•´èª²ç¨‹å¤§ç¶± (SYLLABUS)
        // ==========================================
        const SYLLABUS_DATA = {
            "1.1.1": { section: "Heat", topic: "é‡åº¦æ¸©åº¦", desc: "æ¸©åº¦ç‚ºç‰©é«”å†·ç†±ç¨‹åº¦çš„æ¨™èªŒ" },
            "1.1.2": { section: "Heat", topic: "æ”æ°æ¸©æ¨™", desc: "æ”æ°åº¦ç‚ºæ¸©åº¦çš„å–®ä½" },
            "1.2.1": { section: "Heat", topic: "å…§èƒ½èˆ‡èƒ½é‡è½‰ç§»", desc: "æ¸©åº¦ç‚ºåˆ†å­å¹³å‡å‹•èƒ½" },
            "1.2.2": { section: "Heat", topic: "ç†±å‚³éæ–¹å¼", desc: "å‚³å°ã€å°æµå’Œè¼»å°„" },
            "1.3.1": { section: "Heat", topic: "åŠŸç‡èˆ‡èƒ½é‡", desc: "åŠŸç‡ = E/t" },
            "1.3.2": { section: "Heat", topic: "ç†±å®¹é‡å’Œæ¯”ç†±å®¹é‡", desc: "E=mcÎ”T" },
            "1.4.1": { section: "Heat", topic: "æ½›ç†±", desc: "E=ml (ç†”è§£/æ±½åŒ–)" },
            "1.4.2": { section: "Heat", topic: "è’¸ç™¼èˆ‡å‡çµ", desc: "è’¸ç™¼çš„å†·å»æ•ˆæ‡‰" },
            "1.5.1": { section: "Heat", topic: "æ°£é«”å®šå¾‹", desc: "pV=nRT" },
            "1.5.2": { section: "Heat", topic: "æ°£é«”åˆ†å­é‹å‹•è«–", desc: "å¾®è§€è©®é‡‹" },
            "2.1.1": { section: "Mech", topic: "é•·åº¦å’Œæ™‚é–“", desc: "åŸºæœ¬ç‰©ç†é‡" },
            "2.1.2": { section: "Mech", topic: "è·é›¢å’Œä½ç§»", desc: "æ¨™é‡èˆ‡çŸ¢é‡" },
            "2.1.3": { section: "Mech", topic: "é€Ÿç‡ã€é€Ÿåº¦å’ŒåŠ é€Ÿåº¦", desc: "ç¬æ™‚é€Ÿç‡èˆ‡å¹³å‡é€Ÿåº¦" },
            "2.1.4": { section: "Mech", topic: "èª¤å·®ä¼°ç®—", desc: "åæ‡‰æ™‚é–“èˆ‡èª¤å·®" },
            "2.2.1": { section: "Mech", topic: "æè¿°ç›´ç·šé‹å‹•", desc: "çŸ¢é‡æè¿°" },
            "2.2.2": { section: "Mech", topic: "é‹å‹•ç·šåœ–", desc: "s-t, v-t, a-t åœ–åƒ" },
            "2.2.3": { section: "Mech", topic: "å‹»åŠ é€Ÿé‹å‹•æ–¹ç¨‹", desc: "SUVAT æ–¹ç¨‹" },
            "2.2.4": { section: "Mech", topic: "é‡åŠ›ä¸‹çš„å‚ç›´é‹å‹•", desc: "è‡ªç”±è½é«”" },
            "2.3.1": { section: "Mech", topic: "åŠ›", desc: "éš”é›¢é«”åœ– (FBD)" },
            "2.3.2": { section: "Mech", topic: "ç‰›é “ç¬¬ä¸€å®šå¾‹", desc: "æ…£æ€§" },
            "2.3.3": { section: "Mech", topic: "ç‰›é “ç¬¬äºŒå®šå¾‹", desc: "F=ma" },
            "2.3.4": { section: "Mech", topic: "é‡é‡èˆ‡è³ªé‡", desc: "W=mg" },
            "2.3.5": { section: "Mech", topic: "æµé«”é˜»åŠ›", desc: "çµ‚ç«¯é€Ÿåº¦" },
            "2.3.6": { section: "Mech", topic: "æ‘©æ“¦åŠ›", desc: "éœæ‘©æ“¦èˆ‡å‹•æ‘©æ“¦" },
            "2.3.7": { section: "Mech", topic: "ç‰›é “ç¬¬ä¸‰å®šå¾‹", desc: "ä½œç”¨åŠ›èˆ‡åä½œç”¨åŠ›" },
            "2.4.1": { section: "Mech", topic: "ç‰©é«”çµ„æˆçš„ç³»çµ±", desc: "é€£æ¥é«”é‹å‹•" },
            "2.4.2": { section: "Mech", topic: "åŠ›çš„åˆæˆå’Œåˆ†è§£", desc: "çŸ¢é‡åŠ æ³•" },
            "2.4.3": { section: "Mech", topic: "å…±é¢åŠ›", desc: "åŠ›çš„å¹³è¡¡" },
            "2.5.1": { section: "Mech", topic: "åŠ›çš„è½‰å‹•æ•ˆæ‡‰", desc: "åŠ›çŸ© (Moment)" },
            "2.5.2": { section: "Mech", topic: "å‰›é«”çš„å¹³è¡¡", desc: "åŠ›çŸ©å¹³è¡¡" },
            "2.6.1": { section: "Mech", topic: "åŠŸ", desc: "W = Fs cos Î¸" },
            "2.6.2": { section: "Mech", topic: "æ©Ÿæ¢°èƒ½", desc: "å‹•èƒ½èˆ‡å‹¢èƒ½" },
            "2.6.3": { section: "Mech", topic: "èƒ½é‡å®ˆæ†", desc: "èƒ½é‡è½‰æ›èˆ‡æè€—" },
            "2.6.4": { section: "Mech", topic: "åŠŸç‡", desc: "P = Fv" },
            "2.7.1": { section: "Mech", topic: "å‹•é‡å®ˆæ†", desc: "ç¢°æ’" },
            "2.7.2": { section: "Mech", topic: "å‹•é‡è®ŠåŒ–", desc: "è¡é‡ (Impulse)" },
            "2.8.1": { section: "Mech", topic: "æ‹‹é«”é‹å‹• (Ext)", desc: "ç¨ç«‹æ€§åŸç†" },
            "2.8.2": { section: "Mech", topic: "åˆ†ææ‹‹é«”é‹å‹•", desc: "æ°´å¹³èˆ‡å‚ç›´åˆ†é‡" },
            "2.9.1": { section: "Mech", topic: "æè¿°åœ“å‘¨é‹å‹• (Ext)", desc: "è§’é€Ÿåº¦" },
            "2.9.2": { section: "Mech", topic: "å‘å¿ƒåŠ›èˆ‡å‘å¿ƒåŠ é€Ÿåº¦", desc: "a = vÂ²/r" },
            "2.9.3": { section: "Mech", topic: "åœ“å‘¨é‹å‹•çš„ä¾‹å­", desc: "å‚¾æ–œè·¯é¢/å–®æ“º" },
            "2.10.1": { section: "Mech", topic: "è¬æœ‰å¼•åŠ› (Ext)", desc: "GMm/rÂ²" },
            "2.10.2": { section: "Mech", topic: "å¼•åŠ›ä¸‹çš„åœ“å‘¨é‹å‹•", desc: "è¡›æ˜Ÿé‹å‹•" },
            "3.1.1": { section: "Waves", topic: "å…‰ç·š", desc: "å…‰æŸæ€§è³ª" },
            "3.1.2": { section: "Waves", topic: "åå°„èˆ‡å¹³é¢é¡", desc: "åå°„å®šå¾‹" },
            "3.2.1": { section: "Waves", topic: "æŠ˜å°„", desc: "Snell's Law" },
            "3.2.2": { section: "Waves", topic: "å…¨å…§åå°„", desc: "è‡¨ç•Œè§’" },
            "3.3.1": { section: "Waves", topic: "é€é¡ç¨®é¡", desc: "å‡¸é€é¡èˆ‡å‡¹é€é¡" },
            "3.3.2": { section: "Waves", topic: "å‡¸é€é¡æˆåƒ", desc: "ä½œåœ–æ³•" },
            "3.3.3": { section: "Waves", topic: "å‡¹é€é¡æˆåƒ", desc: "ä½œåœ–æ³•" },
            "3.3.4": { section: "Waves", topic: "ç‰©ã€åƒä»¥åŠé€é¡çš„é—œä¿‚", desc: "é€é¡å…¬å¼" },
            "3.4.1": { section: "Waves", topic: "æ³¢çš„ç°¡ä»‹", desc: "ç¸±æ³¢èˆ‡æ©«æ³¢" },
            "3.4.2": { section: "Waves", topic: "æ©«æ³¢çš„æ³¢å‹•", desc: "v = fÎ»" },
            "3.4.3": { section: "Waves", topic: "æ©«æ³¢çš„ç²’å­æŒ¯å‹•", desc: "ç›¸ä½" },
            "3.4.4": { section: "Waves", topic: "ä»¥ç·šåœ–æè¿°æ©«æ³¢", desc: "ä½ç§»-è·é›¢/æ™‚é–“åœ–" },
            "3.5.1": { section: "Waves", topic: "æ°´æ³¢", desc: "æ°´æ³¢æ§½å¯¦é©—" },
            "3.5.2": { section: "Waves", topic: "åå°„èˆ‡æŠ˜å°„(æ³¢)", desc: "æ·±æ·ºæ°´åŸŸ" },
            "3.5.3": { section: "Waves", topic: "è¡å°„èˆ‡å¹²æ¶‰", desc: "è·¯ç¨‹å·®" },
            "3.5.4": { section: "Waves", topic: "é§æ³¢", desc: "æ³¢è…¹èˆ‡æ³¢ç¯€" },
            "3.6.1": { section: "Waves", topic: "å…‰çš„æ³¢å‹•æœ¬è³ª", desc: "å…‰æ˜¯æ©«æ³¢" },
            "3.6.2": { section: "Waves", topic: "æ¥Šæ°é›™ç¸«å¯¦é©—", desc: "Î”y = Î»D/a" },
            "3.6.3": { section: "Waves", topic: "å¹³é¢é€å°„å…‰æŸµ", desc: "d sin Î¸ = nÎ»" },
            "3.6.4": { section: "Waves", topic: "é›»ç£æ³¢", desc: "é›»ç£æ³¢è­œ" },
            "3.7.1": { section: "Waves", topic: "ç¸±æ³¢", desc: "è²æ³¢ç‰¹æ€§" },
            "3.7.2": { section: "Waves", topic: "è²éŸ³çš„æœ¬è³ª", desc: "ä»‹è³ªå‚³æ’­" },
            "3.7.3": { section: "Waves", topic: "è²éŸ³çš„å…¶ä»–ç‰¹æ€§", desc: "è¶…è²æ³¢èˆ‡åˆ†è²" },
            "4.1.1": { section: "Elec", topic: "é›»è·", desc: "æ‘©æ“¦èµ·é›»" },
            "4.1.2": { section: "Elec", topic: "éœé›»åŠ›", desc: "åº«å€«å®šå¾‹" },
            "4.1.3": { section: "Elec", topic: "é›»å ´", desc: "é›»å ´å¼·åº¦ E" },
            "4.2.1": { section: "Elec", topic: "é›»æµ", desc: "I = Q/t" },
            "4.2.2": { section: "Elec", topic: "é›»å£“", desc: "é›»å‹•å‹¢èˆ‡é›»å‹¢å·®" },
            "4.2.3": { section: "Elec", topic: "é›»é˜»", desc: "R = Ïl/A" },
            "4.2.4": { section: "Elec", topic: "é›»é˜»å™¨ç¶²çµ¡", desc: "ä¸²è¯èˆ‡ä¸¦è¯" },
            "4.2.5": { section: "Elec", topic: "é›»åŠŸç‡", desc: "P = VI" },
            "4.3.1": { section: "Elec", topic: "åˆ†æé›»è·¯", desc: "é›»ä½é™èˆ‡åˆ†å£“å™¨" },
            "4.3.2": { section: "Elec", topic: "å¯¦éš›å„€è¡¨", desc: "å…§é˜»å½±éŸ¿" },
            "4.4.1": { section: "Elec", topic: "å®¶ç”¨é›»å™¨", desc: "åŠŸç‡èˆ‡èƒ½é‡ (kWh)" },
            "4.4.2": { section: "Elec", topic: "å®¶å±…å®‰å…¨", desc: "ä¿éšªçµ²èˆ‡æ¥åœ°" },
            "4.4.3": { section: "Elec", topic: "äº¤æµé›» (Ext)", desc: "RMS å€¼" },
            "4.5.1": { section: "Elec", topic: "ç£åŠ›èˆ‡ç£å ´", desc: "ç£å ´ç·š" },
            "4.5.2": { section: "Elec", topic: "é›»æµçš„ç£æ•ˆæ‡‰", desc: "å³æ‰‹æ¡æ‹³å®šå‰‡" },
            "4.6.1": { section: "Elec", topic: "ä½œç”¨æ–¼å°é«”çš„ç£åŠ›", desc: "F = BIL sinÎ¸" },
            "4.6.2": { section: "Elec", topic: "ç›´æµé›»å‹•æ©Ÿ", desc: "æ›å‘å™¨åŸç†" },
            "4.6.3": { section: "Elec", topic: "æ´›å€«èŒ²åŠ›", desc: "F = Bqv" },
            "4.7.1": { section: "Elec", topic: "ç£å ´ç”¢ç”Ÿçš„é›»æµ", desc: "æ¥æ¬¡å®šå¾‹" },
            "4.7.2": { section: "Elec", topic: "é›»ç£æ„Ÿæ‡‰æ‡‰ç”¨", desc: "ç™¼é›»æ©Ÿ" },
            "4.7.3": { section: "Elec", topic: "æ³•æ‹‰ç¬¬å®šå¾‹ (Ext)", desc: "ç£é€šé‡è®ŠåŒ–ç‡" },
            "4.8.1": { section: "Elec", topic: "è®Šå£“å™¨ (Ext)", desc: "Vp/Vs = Np/Ns" },
            "4.8.2": { section: "Elec", topic: "è¼¸é›» (Ext)", desc: "é«˜å£“å‚³è¼¸å„ªå‹¢" },
            "5.1.1": { section: "Rad", topic: "è‡´é›»é›¢è¼»å°„", desc: "Xå°„ç·š" },
            "5.1.2": { section: "Rad", topic: "æ ¸è¼»å°„", desc: "Î±, Î², Î³ æ€§è³ª" },
            "5.1.3": { section: "Rad", topic: "è¼»å°„å®‰å…¨", desc: "åŠ‘é‡ (Sv)" },
            "5.2.1": { section: "Rad", topic: "åŸå­æ¨¡å‹", desc: "åŒä½ç´ " },
            "5.2.2": { section: "Rad", topic: "æ”¾å°„è¡°è®Š", desc: "åŠè¡°æœŸ" },
            "5.2.3": { section: "Rad", topic: "åŒä½ç´ æ‡‰ç”¨", desc: "è¿½è¹¤åŠ‘èˆ‡å®šå¹´æ³•" },
            "5.3.1": { section: "Rad", topic: "è£‚è®Šèˆ‡èšè®Š", desc: "èƒ½é‡ä¾†æº" },
            "5.3.2": { section: "Rad", topic: "è³ªèƒ½é—œä¿‚", desc: "E = mcÂ²" },
            "5.3.3": { section: "Rad", topic: "æ ¸èƒ½", desc: "åæ‡‰å †åŸç†" },
            
// ==========================================
// Elective Section Syllabus Details
// ==========================================

// --- Elective E3: Energy and Use of Energy (èƒ½é‡å’Œèƒ½æºçš„ä½¿ç”¨) ---
"E3.1.1": { section: "E3", topic: "å®¶ç”¨è€—èƒ½é›»å™¨", desc: "é›»èƒ½ä½œç‚ºä¸»è¦èƒ½æºï¼›å®¶ç”¨é›»å™¨èƒ½é‡è½‰æ›ï¼›å®šç¾©æœ€çµ‚èƒ½æºæ•ˆç›Šï¼›é¦™æ¸¯èƒ½æºæ•ˆç›Šæ¨™ç±¤è¨ˆåŠƒ (EELS) çš„ä½¿ç”¨åŠè¨ˆç®— [1]" },
"E3.1.2": { section: "E3", topic: "ç„¡ç«çƒ¹èª¿", desc: "é›»ç†±å¹³æ¿çˆã€é›»ç£çˆå’Œå¾®æ³¢çˆé‹ä½œåŸç†ï¼›ç‚Šå…·æœ€çµ‚èƒ½æºæ•ˆç›Šæ¯”è¼ƒï¼›å„ªç¼ºé»è¨è«–åŠé‹ä½œæˆæœ¬æ¸¬å®š [1]" },
"E3.1.3": { section: "E3", topic: "æŠ½ç†±", desc: "ç©ºèª¿æ©Ÿèˆ‡ç†±æ³µåŸç†ï¼›å®šç¾©è£½å†·èƒ½åŠ› (kW)ï¼›å®šç¾©æ€§èƒ½ä¿‚æ•¸ COPï¼›ä¸­å¤®ç©ºèª¿ç³»çµ±æ’æ”¾ç†±é‡çš„ç”¨é€” [1]" },
"E3.2.1": { section: "E3", topic: "é›»ç‡ˆ", desc: "æè¿°ç™½ç†¾ç‡ˆã€æ°£é«”æ”¾é›»ç‡ˆå’Œ LED é‹ä½œåŸç†ï¼›ä»¥åŸå­èƒ½é‡æ”¹è®Šé—¡é‡‹å…‰çš„æ”¾å°„ï¼›è¨è«–æˆæœ¬æ•ˆç›Š [1]" },
"E3.2.2": { section: "E3", topic: "é‡åº¦äº®åº¦", desc: "å®šç¾©å…‰é€šé‡ (lm) èˆ‡ç…§æ˜åº¦ (lux)ï¼›æ‡‰ç”¨å¹³æ–¹åæ¯”å®šå¾‹å’Œæœ—ä¼¯é¤˜å¼¦å®šå¾‹ï¼›å®šç¾©é›»ç‡ˆæ•ˆèƒ½ (lm/W) [1]" },
"E3.3.1": { section: "E3", topic: "æ¨“å®‡çš„èƒ½æºæ•ˆç›Š", desc: "ç†±å‚³éç‡æ–¹ç¨‹æ‡‰ç”¨ï¼›å®šç¾©å»ºç¯‰ææ–™ U å€¼ï¼›å®šç¾©åŠè¨è«–å½±éŸ¿ OTTV çš„å› ç´ ï¼›å¤ªé™½éš”ç†±è†œçš„ç”¨é€” [1]" },
"E3.3.2": { section: "E3", topic: "äº¤é€šå·¥å…·çš„èƒ½æºæ•ˆç›Š", desc: "é›»å‹•è»Šèˆ‡æ··åˆå‹•åŠ›è»Šå‹•åŠ›ç³»çµ±ä¸»è¦éƒ¨ä»¶ï¼›æ¯”è¼ƒé›»å‹•è»Šèˆ‡åŒ–çŸ³ç‡ƒæ–™è»Šçš„æœ€çµ‚èƒ½æºæ•ˆç›Š [1]" },
"E3.4.1": { section: "E3", topic: "èƒ½æºèˆ‡çµåˆèƒ½", desc: "ä¸å¯å†ç”Ÿèƒ½æºèˆ‡å¯å†ç”Ÿèƒ½æºç‰¹å¾µï¼›å®šç¾©çµåˆèƒ½ (eV)ï¼›æ ¸è£‚è®Šåæ‡‰å †åŸç†ï¼›é¢¨åŠ›ç™¼é›»åŠŸç‡æ–¹ç¨‹ P=1/2Î·ÏAvÂ³ï¼›å¤ªé™½å¸¸æ•¸èˆ‡å¤ªé™½èƒ½é›»æ±  [2]" },
"E3.4.2": { section: "E3", topic: "ç’°å¢ƒè¡æ“Š", desc: "èƒ½æºæå–èˆ‡ä½¿ç”¨çš„ç¤¾æœƒè¡æ“Šï¼›æ¸©å®¤æ°£é«”å°å…¨çƒæš–åŒ–çš„å½±éŸ¿ï¼›åˆ†æé¦™æ¸¯ä¸åŒç‡ƒæ–™æ¶ˆè€—é‡ [2]" },

// --- Elective E4: Medical Physics (é†«å­¸ç‰©ç†å­¸) ---
"E4.1.1": { section: "E4", topic: "äººé¡è¦–è¦º", desc: "çœ¼ç›çš„è¦–è¦ºèª¿ç¯€éç¨‹ï¼›è¦–æ¡¿åŠè¦–éŒç´°èƒçš„åŠŸèƒ½ï¼›å…‰æ„Ÿç´°èƒå°å…‰è­œçš„åæ‡‰åŠå¸æ”¶æ›²ç·š [2]" },
"E4.1.2": { section: "E4", topic: "è¦–è¦ºç¼ºé™·", desc: "å®šç¾©é€é¡ç„¦å¼· (Dioptre)ï¼›çœ¼ç›è¿‘é»èˆ‡é é»ï¼›è¿‘è¦–ã€é è¦–ã€æ•£å…‰åŠå…¶ç³¾æ­£æ–¹æ³• [2]" },
"E4.1.3": { section: "E4", topic: "å…‰çº–å…§çªºé¡", desc: "å…§çªºé¡é‹ä½œåŸç†èˆ‡å…‰çº–ç‰¹æ€§ï¼›ç›¸å¹²èˆ‡éç›¸å¹²å…‰çº–ç®¡æŸé€ åƒï¼›å…§çªºé¡è¨ºæ–·çš„å„ªé»èˆ‡é™åˆ¶ [2]" },
"E4.2.1": { section: "E4", topic: "äººé¡è½è¦º", desc: "ä¸­è€³å£“å¼·å¢ç›ŠåŠŸèƒ½ï¼›å…§è€³å°è²éŸ³åæ‡‰ï¼›ç›¸å°è²å¼·ç´šå°æ•¸æ¨™åº¦ (L = 10 log I/Iâ‚€)ï¼›ç­‰éŸ¿æ›²ç·šèˆ‡å™ªéŸ³å½±éŸ¿ [2]" },
"E4.2.2": { section: "E4", topic: "è¶…è²æ³¢é†«å­¸å½±åƒ", desc: "å£“é›»æ›èƒ½å™¨é‹ä½œåŸç†ï¼›å®šç¾©è²é˜»æŠ— (Z)ï¼›æ¯”è¼ƒäººé«”çµ„ç¹”è²é˜»æŠ—ï¼›æ‡‰ç”¨åå°„è²å¼·ä¿‚æ•¸è§£æ±ºå•é¡Œ [2]" },
"E4.2.3": { section: "E4", topic: "è¶…è²æ³¢æƒæ", desc: "A-æƒæèˆ‡ B-æƒæé‹ä½œåŠåœ–åƒé—¡é‡‹ï¼›è¶…è²æ³¢è¡°æ¸›èˆ‡é »ç‡é—œä¿‚ï¼›è¨ºæ–·çš„å„ªé»å’Œé™åˆ¶ [2]" },
"E4.3.1": { section: "E4", topic: "Xå°„ç·šæˆåƒ", desc: "æ‡‰ç”¨ I = Iâ‚€eâ»áµË£ æ¸¬å®šå¼·åº¦ï¼›ç·šè¡°æ¸›ä¿‚æ•¸èˆ‡åŠå€¼åšåº¦ï¼›äººå·¥é¡¯å½±åŠ‘ï¼ˆå¦‚é‹‡é¤ï¼‰çš„ç”¨é€”åŠé¢¨éšª [2]" },
"E4.3.2": { section: "E4", topic: "CT æƒæ", desc: "é›»è…¦æ–·å±¤é€ å½±æƒæå„€é‹ä½œåŸç†ï¼›åœ–åƒé‡å»ºéç¨‹ï¼›æ¯”è¼ƒ CT èˆ‡å¸¸è¦ X å°„ç·šåœ–åƒ [2]" },
"E4.3.3": { section: "E4", topic: "æ”¾å°„æ€§æ ¸ç´ é€ å½±", desc: "æ”¾å°„æ€§åŒä½ç´ ä½œç‚ºç¤ºè¹¤ç‰© (Tracer)ï¼›ä¼½ç‘ªæ”å½±å„€åŸç†ï¼›å®šç¾©ç”Ÿç‰©åŠè¡°æœŸï¼›é‘‘å®šé€-99mç‰¹æ€§ [2]" },
"E4.3.4": { section: "E4", topic: "è¼»å°„é¢¨éšª", desc: "è‡´é›»é›¢è¼»å°„æˆåƒçš„å¥åº·é¢¨éšªèˆ‡å®‰å…¨æªæ–½ï¼›æ¯”è¼ƒé†«å­¸è¨ºæ–·ä¸­ä¸åŒè¼»å°„çš„æœ‰æ•ˆåŠ‘é‡ [2]" }
        };

        // ==========================================
        // 2. QUESTION MAP DATABASE
        // ==========================================
        const FULL_QUESTION_MAP = {
            "2016_1A": {
                1: "1.2.2", 2: "1.4.1", 3: "1.5.2", 4: "2.1.3", 5: "2.1.3",
                6: "2.3.7", 7: "2.2.3", 8: "2.6.2", 9: "2.6.1", 10: "2.8.2",
                11: "2.5.2", 12: "2.7.1", 13: "2.9.2", 14: "2.10.2", 15: "3.4.4",
                16: "3.4.2", 17: "3.2.1", 18: "3.5.4", 19: "3.5.3", 20: "3.2.1",
                21: "3.5.3", 22: "3.3.4", 23: "3.7.3", 24: "4.1.3", 25: "4.2.4",
                26: "4.2.4", 27: "4.3.1", 28: "4.4.1", 29: "4.7.3", 30: "4.4.3",
                31: "4.8.1", 32: "5.1.2", 33: "5.2.2"
            },
            "2016_1B": [
                { id: "1a", max: 6, tid: "1.3.2" }, { id: "1b", max: 2, tid: "1.3.2" },
                { id: "2a", max: 3, tid: "1.5.1" }, { id: "2bi", max: 1, tid: "1.5.1" }, { id: "2bii", max: 1, tid: "1.5.2" }, { id: "2biii", max: 2, tid: "1.5.1" },
                { id: "3a", max: 2, tid: "2.2.2" }, { id: "3b", max: 3, tid: "2.3.3" }, { id: "3ci", max: 2, tid: "2.2.2" }, { id: "3cii", max: 2, tid: "2.2.2" },
                { id: "4a", max: 3, tid: "2.3.7" }, { id: "4b", max: 1, tid: "2.3.1" }, { id: "4ci", max: 2, tid: "2.7.2" }, { id: "4cii", max: 3, tid: "2.6.4" }, { id: "4d", max: 2, tid: "2.6.3" },
                { id: "5ai", max: 2, tid: "3.3.1" }, { id: "5aii", max: 1, tid: "3.3.2" }, { id: "5bi", max: 2, tid: "3.3.4" }, { id: "5bii", max: 3, tid: "3.3.2" }, { id: "5biii", max: 1, tid: "3.3.4" }, { id: "5biv", max: 2, tid: "3.3.4" },
                { id: "6ai", max: 3, tid: "3.6.2" }, { id: "6aii", max: 2, tid: "3.5.3" }, { id: "6bi", max: 3, tid: "3.6.3" }, { id: "6bii", max: 2, tid: "3.6.3" },
                { id: "7ai", max: 3, tid: "4.3.1" }, { id: "7aii", max: 2, tid: "4.3.2" }, { id: "7bi", max: 2, tid: "4.3.2" }, { id: "7bii", max: 2, tid: "2.1.4" },
                { id: "8ai", max: 1, tid: "4.1.3" }, { id: "8aii", max: 2, tid: "4.1.3" }, { id: "8bi", max: 3, tid: "4.5.2" }, { id: "8bii", max: 3, tid: "4.7.1" }, { id: "8biii", max: 2, tid: "4.7.1" },
                { id: "9a", max: 2, tid: "5.2.2" }, { id: "9bi", max: 2, tid: "5.2.2" }, { id: "9bii", max: 2, tid: "5.2.2" }, { id: "9biii", max: 2, tid: "5.2.2" }
            ],
            "2016_2_E3": {
                1: "E3.1.1", 2: "E3.1.2", 3: "E3.1.3", 4: "E3.2.1",
                5: "E3.2.2", 6: "E3.3.1", 7: "E3.4.1", 8: "E3.4.2"
            },
            "2016_2_E3_LQ": [
                { id: "3a", max: 3, tid: "E3.1.2" }, { id: "3bi", max: 2, tid: "E3.1.3" }, { id: "3bii", max: 2, tid: "E3.2.2" }, { id: "3c", max: 3, tid: "E3.4.1" }
            ],
            "2016_2_E4": {
                1: "E4.1.1", 2: "E4.1.2", 3: "E4.2.1", 4: "E4.2.2",
                5: "E4.3.1", 6: "E4.4.1", 7: "E4.4.1", 8: "E4.5.1"
            },
            "2016_2_E4_LQ": [
                { id: "4ai", max: 2, tid: "E4.1.1" }, { id: "4aii", max: 2, tid: "E4.1.2" }, { id: "4b", max: 3, tid: "E4.3.1" }, { id: "4c", max: 3, tid: "E4.4.1" }
            ]
        };

        const YEAR_OPTIONS = Array.from({length: 12}, (_, i) => 2025 - i);

        const App = () => {
            const [view, setView] = useState('students');
            const [students, setStudents] = useState([]);
            const [records, setRecords] = useState([]);
            // New State for Generation History
            const [genHistory, setGenHistory] = useState([]);

            const [answerKeys, setAnswerKeys] = useState(() => {
                const saved = localStorage.getItem('dsePhysV7');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        const savedKeys = parsed.answerKeys || {};
                        return { ...savedKeys, ...PRELOADED_KEYS }; 
                    } catch(e) { return PRELOADED_KEYS; }
                }
                return PRELOADED_KEYS;
            });

            // UI State
            const [inputForm, setInputForm] = useState({ studentId: '', year: '2016', paper: '1A', answers: {}, scores: {} });
            const [dashStudent, setDashStudent] = useState('');
            const [dashPaperType, setDashPaperType] = useState('core'); 
            
            // AI Settings
            const [genSettings, setGenSettings] = useState({ difficulty: 'medium', type: 'mixed', lang: 'zh' });
            const [selectedTopics, setSelectedTopics] = useState([]);
            const [generatedPrompt, setGeneratedPrompt] = useState('');

            // Load Data
            useEffect(() => {
                const saved = localStorage.getItem('dsePhysV7');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        setStudents(data.students || []);
                        setRecords(data.records || []);
                        setGenHistory(data.genHistory || []); // Load History
                        if(data.students?.[0]) setDashStudent(data.students[0].id);
                    } catch(e) {}
                }
            }, []);

            // Save Data
            useEffect(() => {
                localStorage.setItem('dsePhysV7', JSON.stringify({ 
                    students, 
                    answerKeys, 
                    records,
                    genHistory // Save History
                }));
            }, [students, answerKeys, records, genHistory]);

            const getTopicInfo = (year, paper, qNum) => {
                let mapKeyMC = `${year}_${paper}`;
                let mapKeyLQ = `${year}_${paper}`;
                if (paper.includes('2_')) mapKeyLQ = `${year}_${paper}_LQ`;

                const mapDataMC = FULL_QUESTION_MAP[mapKeyMC];
                const mapDataLQ = FULL_QUESTION_MAP[mapKeyLQ];
                let topicId = null;

                if (paper === '1A' || (paper.includes('2_') && !isNaN(qNum) && parseInt(qNum) <= 8)) {
                    if (mapDataMC && mapDataMC[qNum]) topicId = mapDataMC[qNum];
                } else {
                    if (Array.isArray(mapDataLQ)) {
                        const qItem = mapDataLQ.find(item => item.id === qNum);
                        if (qItem) topicId = qItem.tid;
                    }
                }

                if (!topicId) {
                    const ids = Object.keys(SYLLABUS_DATA);
                    const hash = String(qNum).split('').reduce((a,b)=>a+b.charCodeAt(0),0);
                    topicId = ids[hash % ids.length];
                }
                const topicData = SYLLABUS_DATA[topicId] || { section: 'Gen', topic: `Topic ${topicId}`, desc: 'Unknown' };
                return { id: topicId, ...topicData };
            };

            const Sidebar = () => (
                <div className="w-64 bg-slate-900 text-white h-screen fixed left-0 top-0 flex flex-col shadow-2xl z-10">
                    <div className="p-6 border-b border-slate-700">
                        <h1 className="text-xl font-bold tracking-wider italic">PHY MASTER</h1>
                        <div className="text-xs text-orange-400 mt-1">V7.3.0 History Added</div>
                    </div>
                    <nav className="p-4 space-y-2 flex-1 overflow-y-auto">
                        {[
                            {id: 'students', icon: 'ğŸ‘¥', label: 'å­¸ç”Ÿç®¡ç†'},
                            {id: 'input', icon: 'ğŸ“', label: 'è¼¸å…¥æˆç¸¾'},
                            {id: 'dashboard', icon: 'ğŸ“Š', label: 'è¨ºæ–·å ±å‘Š'},
                            {id: 'generate', icon: 'ğŸ¤–', label: 'AI ç·´ç¿’ç”Ÿæˆ'},
                            {id: 'history', icon: 'ğŸ“œ', label: 'ç”Ÿæˆç´€éŒ„'}, // New Item
                            {id: 'data', icon: 'ğŸ’¾', label: 'æ•¸æ“šå‚™ä»½ (Data)'} 
                        ].map(item => (
                            <button key={item.id} onClick={() => setView(item.id)}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded transition-all ${view===item.id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                                <span>{item.icon}</span> {item.label}
                            </button>
                        ))}
                    </nav>
                </div>
            );

            // ==========================
            // Data Management View
            // ==========================
            const DataView = () => {
                const fileInputRef = useRef(null);

                const handleExport = () => {
                    const data = {
                        version: "7.3.0",
                        timestamp: new Date().toISOString(),
                        students,
                        answerKeys,
                        records,
                        genHistory // Included in backup
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `PHY_MASTER_BACKUP_${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                };

                const handleImport = (e) => {
                    const file = e.target.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if(confirm(`ç¢ºèªå¾æª”æ¡ˆå°å…¥æ•¸æ“šå—ï¼Ÿ\né€™å°‡è¦†è“‹ç¾æœ‰æ•¸æ“šï¼\n(åŒ…å« ${data.students?.length||0} ä½å­¸ç”Ÿ, ${data.records?.length||0} ç­†æˆç¸¾)`)) {
                                if(data.students) setStudents(data.students);
                                if(data.answerKeys) setAnswerKeys(prev => ({...prev, ...data.answerKeys}));
                                if(data.records) setRecords(data.records);
                                if(data.genHistory) setGenHistory(data.genHistory); // Import History
                                alert("âœ… å°å…¥æˆåŠŸï¼");
                            }
                        } catch(err) {
                            alert("âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
                        }
                    };
                    reader.readAsText(file);
                };

                return (
                    <div className="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-sm">
                        <h2 className="text-2xl font-bold mb-6 text-slate-800">ğŸ’¾ æ•¸æ“šå‚™ä»½èˆ‡é‚„åŸ</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="p-6 border-2 border-dashed border-blue-200 rounded-xl bg-blue-50 flex flex-col items-center justify-center text-center">
                                <span className="text-4xl mb-4">ğŸ“¤</span>
                                <h3 className="text-xl font-bold text-slate-700 mb-2">å°å‡ºæ•¸æ“š (Export)</h3>
                                <p className="text-sm text-slate-500 mb-4">å°‡æ‰€æœ‰å­¸ç”Ÿã€æˆç¸¾ã€ç­”æ¡ˆè¨­å®šåŠ<b>ç”Ÿæˆç´€éŒ„</b>ä¸‹è¼‰ç‚º JSON æª”æ¡ˆã€‚</p>
                                <button onClick={handleExport} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 shadow transition">
                                    ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ
                                </button>
                            </div>

                            <div className="p-6 border-2 border-dashed border-orange-200 rounded-xl bg-orange-50 flex flex-col items-center justify-center text-center">
                                <span className="text-4xl mb-4">ğŸ“¥</span>
                                <h3 className="text-xl font-bold text-slate-700 mb-2">å°å…¥æ•¸æ“š (Import)</h3>
                                <p className="text-sm text-slate-500 mb-4">å¾é›»è…¦ä¸Šå‚³ JSON æª”æ¡ˆä»¥é‚„åŸæ•¸æ“šã€‚</p>
                                <input type="file" accept=".json" ref={fileInputRef} onChange={handleImport} className="hidden" />
                                <button onClick={()=>fileInputRef.current.click()} className="bg-orange-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-orange-600 shadow transition">
                                    é¸æ“‡æª”æ¡ˆä¸Šå‚³
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const StudentsView = () => {
                const [name, setName] = useState('');
                const add = () => {
                    if(!name) return;
                    setStudents([...students, { id: Date.now().toString(), name, joinDate: new Date().toLocaleDateString() }]);
                    setName('');
                };
                return (
                    <div className="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-sm">
                        <h2 className="text-2xl font-bold mb-6 text-slate-800">ğŸ‘¥ å­¸ç”Ÿæª”æ¡ˆ</h2>
                        <div className="flex gap-4 mb-8">
                            <input className="flex-1 border p-3 rounded-lg outline-none focus:border-blue-500" placeholder="å­¸ç”Ÿå§“å" value={name} onChange={e=>setName(e.target.value)} />
                            <button onClick={add} className="bg-blue-600 text-white px-8 rounded-lg font-bold hover:bg-blue-700">æ–°å¢</button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {students.map(s => (
                                <div key={s.id} className="p-4 border rounded-lg bg-slate-50 flex justify-between">
                                    <span className="font-bold">{s.name}</span>
                                    <button onClick={()=>{setStudents(students.filter(x=>x.id!==s.id)); setRecords(records.filter(r=>r.studentId!==s.id))}} className="text-red-400 hover:text-red-600">åˆªé™¤</button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const InputView = () => {
                const { studentId, year, paper } = inputForm;
                const keyId = `${year}_${paper}`;
                const sysKey = answerKeys[keyId] || {};
                
                let lqConfig = null;
                if (paper === '1B') lqConfig = FULL_QUESTION_MAP[`${year}_1B`];
                else if (paper.includes('2_')) lqConfig = FULL_QUESTION_MAP[`${year}_${paper}_LQ`];

                useEffect(() => {
                    if (!studentId && students.length > 0) setInputForm(prev => ({ ...prev, studentId: students[0].id }));
                }, [students]);

                const toggleMC = (q, opt) => {
                    const isCorrect = sysKey[q] === opt;
                    setInputForm({
                        ...inputForm, 
                        answers: {...inputForm.answers, [q]: opt},
                        scores: {...inputForm.scores, [q]: isCorrect ? 1 : 0}
                    });
                };

                const updateScore = (qKey, val, max) => {
                    let numVal = parseFloat(val);
                    if(val === '') numVal = ''; 
                    else if(numVal < 0) numVal = 0;
                    else if(numVal > max) numVal = max;
                    setInputForm({ ...inputForm, scores: {...inputForm.scores, [qKey]: numVal} });
                };

                const save = () => {
                    if(!studentId) return alert('è«‹é¸æ“‡å­¸ç”Ÿ');
                    const newRec = { ...inputForm, id: Date.now(), timestamp: new Date().toISOString() };
                    const others = records.filter(r => !(r.studentId===studentId && r.year==year && r.paper===paper));
                    setRecords([...others, newRec]);
                    alert('âœ… å·²å„²å­˜');
                };

                const showMC = paper === '1A' || paper.includes('2_');
                const mcCount = paper === '1A' ? 33 : 8;
                const showLQ = paper === '1B' || paper.includes('2_');

                return (
                    <div className="max-w-5xl mx-auto bg-white p-8 rounded-xl shadow-sm">
                        <h2 className="text-2xl font-bold mb-6">ğŸ“ è¼¸å…¥æˆç¸¾</h2>
                        <div className="grid grid-cols-3 gap-4 mb-6 bg-blue-50 p-4 rounded-lg">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">å­¸ç”Ÿ</label>
                                <select className="w-full border p-2 rounded" value={studentId} onChange={e=>setInputForm({...inputForm, studentId:e.target.value})}>
                                    <option value="">-- è«‹é¸æ“‡ --</option>
                                    {students.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">å¹´ä»½</label>
                                <select className="w-full border p-2 rounded" value={year} onChange={e=>setInputForm({...inputForm, year:e.target.value, answers:{}, scores:{}})}>
                                    {YEAR_OPTIONS.map(y => <option key={y} value={y}>{y}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">è©¦å·</label>
                                <select className="w-full border p-2 rounded font-bold" value={paper} onChange={e=>setInputForm({...inputForm, paper:e.target.value, answers:{}, scores:{}})}>
                                    <optgroup label="Core (å¿…ä¿®)">
                                        <option value="1A">Paper 1A (MC)</option>
                                        <option value="1B">Paper 1B (LQ)</option>
                                    </optgroup>
                                    <optgroup label="Electives (é¸ä¿® Paper 2)">
                                        <option value="2_E3">E3 - Energy (MC+LQ)</option>
                                        <option value="2_E4">E4 - Medical (MC+LQ)</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        
                        {showMC && (
                            <div className="mb-8">
                                <h3 className="font-bold text-slate-600 mb-3 border-b pb-2">MC éƒ¨ä»½ (Q1-{mcCount})</h3>
                                {Object.keys(sysKey).length === 0 && <div className="text-red-500 text-xs mb-2">âš  æ³¨æ„ï¼šæ­¤å¹´ä»½/è©¦å·å°šæœªè¨­å®šæ¨™æº–ç­”æ¡ˆï¼Œç³»çµ±ç„¡æ³•è‡ªå‹•è©•åˆ†ã€‚</div>}
                                <div className={`grid gap-3 ${paper==='1A'?'grid-cols-2 md:grid-cols-4':'grid-cols-2 md:grid-cols-4'}`}>
                                    {Array.from({length: mcCount}).map((_, i) => {
                                        const q = i+1;
                                        const myAns = inputForm.answers[q];
                                        const realAns = sysKey[q];
                                        let statusClass = "border-slate-200";
                                        if(myAns && realAns) statusClass = myAns===realAns ? "bg-green-50 border-green-300" : "bg-red-50 border-red-300";

                                        return (
                                            <div key={q} className={`p-2 border rounded flex flex-col ${statusClass}`}>
                                                <div className="flex justify-between items-center mb-1">
                                                    <span className="font-bold text-slate-500">Q{q}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    {['A','B','C','D'].map(opt => (
                                                        <button key={opt} onClick={()=>toggleMC(q, opt)} 
                                                            className={`w-6 h-6 text-xs rounded font-bold ${myAns===opt?'bg-slate-800 text-white':'bg-white text-slate-400 border'}`}>
                                                            {opt}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        )}

                        {showLQ && (
                            <div>
                                <h3 className="font-bold text-slate-600 mb-3 border-b pb-2">é•·é¡Œç›®éƒ¨ä»½ (LQ)</h3>
                                {lqConfig ? (
                                    <div className="grid grid-cols-3 md:grid-cols-5 gap-4">
                                        {lqConfig.map((item) => (
                                            <div key={item.id} className="flex flex-col">
                                                <div className="flex justify-between items-end mb-1">
                                                    <span className="text-sm font-bold text-slate-700">Q{item.id}</span>
                                                    <span className="text-[10px] text-slate-400 bg-slate-100 px-1 rounded">/{item.max}</span>
                                                </div>
                                                <input type="number" className="border p-2 rounded text-center focus:ring-2 focus:ring-blue-500 outline-none"
                                                    value={inputForm.scores[item.id] ?? ''}
                                                    onChange={e => updateScore(item.id, e.target.value, item.max)}
                                                />
                                                <span className="text-[9px] text-center text-slate-300 mt-1 truncate" title={item.tid}>{item.tid}</span>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-sm text-yellow-600 bg-yellow-50 p-2 rounded">
                                        æ­¤å¹´ä»½ ({year}) å°šæœªè¼‰å…¥è©³ç´°é¡Œç›®åœ°åœ–ã€‚
                                    </div>
                                )}
                            </div>
                        )}

                        <button onClick={save} className="w-full mt-6 bg-slate-800 text-white py-3 rounded font-bold hover:bg-slate-700 shadow-lg">å„²å­˜æˆç¸¾</button>
                    </div>
                );
            };

            const DashboardView = () => {
                useEffect(() => {
                    if (!dashStudent && students.length > 0) setDashStudent(students[0].id);
                }, [students, dashStudent]);

                const subTopicStats = useMemo(() => {
                    if(!dashStudent) return [];
                    const myRecs = records.filter(r => {
                        if (r.studentId !== dashStudent) return false;
                        const isPaper1 = r.paper === '1A' || r.paper === '1B';
                        return dashPaperType === 'core' ? isPaper1 : !isPaper1;
                    });

                    const stats = {};
                    myRecs.forEach(r => {
                        Object.entries(r.scores).forEach(([q, score]) => {
                            const numericScore = parseFloat(score) || 0;
                            const info = getTopicInfo(r.year, r.paper, q);
                            const tid = info.id;
                            
                            if(!stats[tid]) stats[tid] = { ...info, earned: 0, max: 0, count: 0 };
                            
                            stats[tid].earned += numericScore;
                            let qMax = 0;
                            if (r.paper === '1A') qMax = 1;
                            else if (r.paper.includes('2_') && !isNaN(q) && parseInt(q)<=8) qMax = 1;
                            else {
                                let mapKeyLQ = r.paper === '1B' ? `${r.year}_1B` : `${r.year}_${r.paper}_LQ`;
                                const lqList = FULL_QUESTION_MAP[mapKeyLQ];
                                if(Array.isArray(lqList)) {
                                    const qItem = lqList.find(i => i.id === q);
                                    qMax = qItem ? qItem.max : 10;
                                } else qMax = 10;
                            }
                            stats[tid].max += qMax;
                            stats[tid].count++;
                        });
                    });

                    return Object.values(stats).sort((a,b) => {
                        const pctA = a.max > 0 ? (a.earned/a.max) : 0;
                        const pctB = b.max > 0 ? (b.earned/b.max) : 0;
                        return pctA - pctB;
                    });
                }, [records, dashStudent, dashPaperType]);

                const weakestList = subTopicStats.slice(0, 50); 
                const strongestList = [...subTopicStats].reverse().slice(0, 50);

                return (
                    <div className="max-w-6xl mx-auto space-y-6">
                        <div className="bg-white p-4 rounded-xl shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
                            <h2 className="text-xl font-bold">ğŸ“Š å­èª²é¡Œè¨ºæ–·å ±å‘Š</h2>
                            
                            <div className="flex gap-4 items-center">
                                <div className="bg-slate-100 p-1 rounded-lg flex font-bold text-sm">
                                    <button onClick={()=>setDashPaperType('core')} className={`px-4 py-2 rounded-md transition ${dashPaperType==='core'?'bg-white text-blue-600 shadow':'text-slate-400'}`}>Paper 1 (Core)</button>
                                    <button onClick={()=>setDashPaperType('elective')} className={`px-4 py-2 rounded-md transition ${dashPaperType==='elective'?'bg-white text-purple-600 shadow':'text-slate-400'}`}>Paper 2 (Electives)</button>
                                </div>
                                <select className="border p-2 rounded" value={dashStudent} onChange={e=>setDashStudent(e.target.value)}>
                                    {students.length === 0 && <option value="">ç„¡å­¸ç”Ÿè³‡æ–™</option>}
                                    {students.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                        </div>

                        {subTopicStats.length === 0 ? (
                            <div className="p-12 text-center text-slate-400 bg-white rounded-xl">
                                {students.length === 0 ? "è«‹å…ˆæ–°å¢å­¸ç”Ÿ" : "æš«ç„¡æ­¤é¡åˆ¥çš„æˆç¸¾æ•¸æ“šã€‚"}
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 h-[70vh]">
                                <div className="bg-white p-4 rounded-xl shadow-sm border-t-4 border-red-500 flex flex-col h-full">
                                    <h3 className="font-bold text-lg mb-4 text-red-600 flex items-center gap-2 flex-shrink-0">
                                        <span className="text-2xl">âš </span> å¾…æ”¹å–„ (Weakest)
                                    </h3>
                                    <div className="stats-list space-y-3 flex-1">
                                        {weakestList.map(t => (
                                            <div key={t.id} className="p-3 bg-red-50 border border-red-100 rounded-lg flex justify-between items-center">
                                                <div className="overflow-hidden">
                                                    <div className="flex items-center gap-2">
                                                        <span className="sub-topic-tag bg-white text-red-600 px-1 border border-red-200 rounded text-sm">{t.id}</span>
                                                        <span className="font-bold text-slate-800 truncate">{t.topic}</span>
                                                    </div>
                                                    <div className="text-xs text-slate-500 mt-1 pl-1 truncate">{t.desc}</div>
                                                </div>
                                                <div className="text-right flex-shrink-0 ml-2">
                                                    <div className="text-xl font-bold text-red-600">{((t.earned/t.max)*100).toFixed(0)}%</div>
                                                    <div className="text-[10px] text-slate-400">{t.count} é¡Œ</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="bg-white p-4 rounded-xl shadow-sm border-t-4 border-green-500 flex flex-col h-full">
                                    <h3 className="font-bold text-lg mb-4 text-green-600 flex items-center gap-2 flex-shrink-0">
                                        <span className="text-2xl">â˜…</span> è¡¨ç¾å„ªç•° (Strongest)
                                    </h3>
                                    <div className="stats-list space-y-3 flex-1">
                                        {strongestList.map(t => (
                                            <div key={t.id} className="p-3 bg-green-50 border border-green-100 rounded-lg flex justify-between items-center">
                                                <div className="overflow-hidden">
                                                    <div className="flex items-center gap-2">
                                                        <span className="sub-topic-tag bg-white text-green-600 px-1 border border-green-200 rounded text-sm">{t.id}</span>
                                                        <span className="font-bold text-slate-800 truncate">{t.topic}</span>
                                                    </div>
                                                </div>
                                                <div className="text-xl font-bold text-green-600 flex-shrink-0 ml-2">{((t.earned/t.max)*100).toFixed(0)}%</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const GenerateView = () => {
                const [studentStats, setStudentStats] = useState({});

                useEffect(() => {
                    if (!dashStudent) return;
                    const myRecs = records.filter(r => r.studentId === dashStudent);
                    const stats = {};
                    Object.keys(SYLLABUS_DATA).forEach(tid => {
                        stats[tid] = { earned: 0, max: 0 };
                    });

                    myRecs.forEach(r => {
                        Object.entries(r.scores).forEach(([q, score]) => {
                            const numericScore = parseFloat(score) || 0;
                            const info = getTopicInfo(r.year, r.paper, q);
                            const tid = info.id;
                            
                            let qMax = 0;
                            if (r.paper === '1A' || (r.paper.includes('2_') && parseInt(q)<=8)) qMax = 1;
                            else {
                                let mapKeyLQ = r.paper === '1B' ? `${r.year}_1B` : `${r.year}_${r.paper}_LQ`;
                                const lqList = FULL_QUESTION_MAP[mapKeyLQ];
                                if(Array.isArray(lqList)) {
                                    const qItem = lqList.find(i => i.id === q);
                                    qMax = qItem ? qItem.max : 10;
                                } else qMax = 10;
                            }

                            if(stats[tid]) {
                                stats[tid].earned += numericScore;
                                stats[tid].max += qMax;
                            }
                        });
                    });
                    setStudentStats(stats);
                }, [dashStudent, records]);

                const toggleTopic = (tid) => {
                    if (selectedTopics.includes(tid)) setSelectedTopics(selectedTopics.filter(t => t !== tid));
                    else setSelectedTopics([...selectedTopics, tid]);
                };

                const toggleAll = () => {
                    if (selectedTopics.length === Object.keys(SYLLABUS_DATA).length) setSelectedTopics([]);
                    else setSelectedTopics(Object.keys(SYLLABUS_DATA));
                };

                const generate = () => {
                    if (!dashStudent) return alert("è«‹å…ˆé¸æ“‡å­¸ç”Ÿ");
                    if (selectedTopics.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹èª²é¡Œ");

                    const topicListText = selectedTopics.sort().map(tid => {
                        const s = studentStats[tid] || {earned:0, max:0};
                        const pct = s.max > 0 ? Math.round((s.earned / s.max) * 100) + '%' : 'No Data';
                        return `- [${tid}] ${SYLLABUS_DATA[tid].topic} (Student Prev. Performance: ${pct})`;
                    }).join('\n');

                    const difficultyMap = { low: 'Foundation/Easy', medium: 'Standard HKDSE', high: 'Challenging/5**' };
                    const typeMap = { mc: 'Multiple Choice (MC) ONLY', lq: 'Long Questions (LQ) ONLY', mixed: 'Mixed (MC & LQ)' };
                    const langMap = { zh: 'Traditional Chinese (ç¹é«”ä¸­æ–‡)', en: 'English' };

                    const prompt = `
Role: Professional HKDSE Physics Tutor.
Task: Create a practice exercise.

**Configuration:**
- **Student Level:** HKDSE Physics
- **Target Difficulty:** ${difficultyMap[genSettings.difficulty]}
- **Question Format:** ${typeMap[genSettings.type]}
- **Language:** ${langMap[genSettings.lang]}

**Selected Topics & Context:**
The student needs practice on the following topics. (Performance data is provided for context on where they struggle):
${topicListText}

**Requirements:**
1. Generate distinctive questions for the selected topics.
2. Ensure the difficulty matches the "${difficultyMap[genSettings.difficulty]}" setting.
3. Provide a Marking Scheme with detailed explanations.
4. If the format is MC, provide 4 options (A,B,C,D).
`.trim();

                    setGeneratedPrompt(prompt);

                    // ===================================
                    // NEW: Save Generation Record
                    // ===================================
                    const sName = students.find(s=>s.id === dashStudent)?.name || "Unknown";
                    const newHistoryItem = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        studentId: dashStudent,
                        studentName: sName,
                        topics: selectedTopics,
                        settings: genSettings,
                        note: '' // Start with empty note
                    };
                    setGenHistory(prev => [newHistoryItem, ...prev]);
                    alert("Prompt ç”ŸæˆæˆåŠŸï¼\nå·²åŒæ™‚å»ºç«‹ä¸€æ¢ç·´ç¿’ç´€éŒ„ã€‚");
                };

                const sortedTopicKeys = Object.keys(SYLLABUS_DATA).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

                return (
                    <div className="max-w-6xl mx-auto flex gap-6 h-[85vh]">
                        <div className="w-5/12 bg-white p-5 rounded-xl shadow-sm flex flex-col h-full border border-slate-200">
                            <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700">ğŸ› ï¸ ç”Ÿæˆè¨­å®š (Settings)</h2>
                            <div className="grid grid-cols-2 gap-3 mb-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">ç›®æ¨™å­¸ç”Ÿ</label>
                                    <select className="w-full border p-2 rounded text-sm bg-slate-50" value={dashStudent} onChange={e=>setDashStudent(e.target.value)}>
                                        {students.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">èªè¨€ (Lang)</label>
                                    <select className="w-full border p-2 rounded text-sm" value={genSettings.lang} onChange={e=>setGenSettings({...genSettings, lang:e.target.value})}>
                                        <option value="zh">ç¹é«”ä¸­æ–‡</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">é›£åº¦ (Difficulty)</label>
                                    <select className="w-full border p-2 rounded text-sm" value={genSettings.difficulty} onChange={e=>setGenSettings({...genSettings, difficulty:e.target.value})}>
                                        <option value="low">ä½ (åŸºç¤éå›º)</option>
                                        <option value="medium">ä¸­ (DSE æ¨™æº–)</option>
                                        <option value="high">é«˜ (5** æŒ‘æˆ°)</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">é¡Œå‹ (Type)</label>
                                    <select className="w-full border p-2 rounded text-sm" value={genSettings.type} onChange={e=>setGenSettings({...genSettings, type:e.target.value})}>
                                        <option value="mixed">MC + LQ (æ··åˆ)</option>
                                        <option value="mc">MC Only</option>
                                        <option value="lq">LQ Only</option>
                                    </select>
                                </div>
                            </div>
                            <div className="flex-1 flex flex-col min-h-0 border rounded-lg bg-slate-50">
                                <div className="p-2 border-b bg-slate-100 flex justify-between items-center">
                                    <span className="text-xs font-bold text-slate-600">é¸æ“‡èª²é¡Œ ({selectedTopics.length})</span>
                                    <button onClick={toggleAll} className="text-xs text-blue-600 hover:underline">{selectedTopics.length === sortedTopicKeys.length ? 'å…¨ä¸é¸' : 'å…¨é¸'}</button>
                                </div>
                                <div className="overflow-y-auto p-2 space-y-1 flex-1">
                                    {sortedTopicKeys.map(tid => {
                                        const s = studentStats[tid] || {earned:0, max:0};
                                        const hasData = s.max > 0;
                                        const pct = hasData ? Math.round((s.earned / s.max) * 100) : 0;
                                        let scoreColor = 'text-slate-400';
                                        if (hasData) {
                                            if (pct < 40) scoreColor = 'text-red-500 font-bold';
                                            else if (pct < 70) scoreColor = 'text-yellow-600 font-bold';
                                            else scoreColor = 'text-green-600 font-bold';
                                        }

                                        return (
                                            <label key={tid} className="flex items-center gap-2 p-2 hover:bg-white rounded cursor-pointer border border-transparent hover:border-slate-200">
                                                <input type="checkbox" checked={selectedTopics.includes(tid)} onChange={() => toggleTopic(tid)} className="w-4 h-4 rounded text-blue-600" />
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-xs font-mono font-bold text-slate-700">{tid}</span>
                                                        <span className={`text-xs ${scoreColor}`}>{hasData ? `${pct}%` : '--'}</span>
                                                    </div>
                                                    <div className="text-xs text-slate-500 truncate">{SYLLABUS_DATA[tid].topic}</div>
                                                </div>
                                            </label>
                                        );
                                    })}
                                </div>
                            </div>
                            <button onClick={generate} className="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-bold mt-4 shadow hover:shadow-lg">ç”Ÿæˆ Prompt âœ¨</button>
                        </div>
                        <div className="flex-1 bg-white p-6 rounded-xl shadow-sm h-full flex flex-col border border-slate-200">
                            <h3 className="font-bold text-slate-700 mb-2">ğŸ“ ç”Ÿæˆçµæœ (Prompt Output)</h3>
                            <textarea className="flex-1 w-full bg-slate-50 border p-4 rounded-lg font-mono text-sm resize-none outline-none" value={generatedPrompt} readOnly placeholder="è«‹åœ¨å·¦å´é¸æ“‡èª²é¡Œèˆ‡è¨­å®šï¼Œç„¶å¾Œé»æ“Šã€Œç”Ÿæˆ Promptã€..."></textarea>
                            <button onClick={()=>{navigator.clipboard.writeText(generatedPrompt); alert("å·²è¤‡è£½!")}} className="mt-4 py-3 bg-slate-800 text-white rounded-lg hover:bg-slate-700 font-bold flex justify-center gap-2">ğŸ“‹ è¤‡è£½ä¸¦è²¼çµ¦ AI</button>
                        </div>
                    </div>
                );
            };

            // ==========================
            // NEW: History View
            // ==========================
            const HistoryView = () => {
                const updateNote = (id, newNote) => {
                    setGenHistory(prev => prev.map(item => item.id === id ? { ...item, note: newNote } : item));
                };

                const deleteHistory = (id) => {
                    if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„?")) {
                        setGenHistory(prev => prev.filter(item => item.id !== id));
                    }
                };

                return (
                    <div className="max-w-6xl mx-auto bg-white p-8 rounded-xl shadow-sm min-h-[80vh]">
                        <h2 className="text-2xl font-bold mb-6 text-slate-800 flex items-center gap-2">ğŸ“œ ç·´ç¿’ç”Ÿæˆç´€éŒ„ (History)</h2>
                        
                        {genHistory.length === 0 ? (
                            <div className="text-center py-20 text-slate-400 bg-slate-50 rounded-lg">
                                å°šæœªç”Ÿæˆä»»ä½•ç·´ç¿’ã€‚å‰å¾€ã€ŒAI ç·´ç¿’ç”Ÿæˆã€é–‹å§‹å§ï¼
                            </div>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="bg-slate-100 text-slate-600 text-sm">
                                            <th className="p-3 rounded-tl-lg">æ™‚é–“ / å­¸ç”Ÿ</th>
                                            <th className="p-3">è¨­å®š</th>
                                            <th className="p-3">èª²é¡Œ (Topics)</th>
                                            <th className="p-3 w-1/3">å‚™è¨» / åˆ†æ•¸ (Note & Score)</th>
                                            <th className="p-3 rounded-tr-lg text-right">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-sm">
                                        {genHistory.map(item => (
                                            <tr key={item.id} className="border-b border-slate-100 hover:bg-slate-50">
                                                <td className="p-3 align-top">
                                                    <div className="font-bold text-slate-800">{new Date(item.timestamp).toLocaleDateString()}</div>
                                                    <div className="text-xs text-slate-400">{new Date(item.timestamp).toLocaleTimeString()}</div>
                                                    <div className="mt-1 text-blue-600 font-bold">{item.studentName}</div>
                                                </td>
                                                <td className="p-3 align-top">
                                                    <div className="flex flex-col gap-1">
                                                        <span className="bg-gray-200 text-gray-700 px-2 py-0.5 rounded text-xs w-fit">{item.settings.difficulty}</span>
                                                        <span className="bg-gray-200 text-gray-700 px-2 py-0.5 rounded text-xs w-fit">{item.settings.type}</span>
                                                        <span className="bg-gray-200 text-gray-700 px-2 py-0.5 rounded text-xs w-fit">{item.settings.lang}</span>
                                                    </div>
                                                </td>
                                                <td className="p-3 align-top">
                                                    <div className="flex flex-wrap gap-1">
                                                        {item.topics.map(t => (
                                                            <span key={t} className="border border-slate-300 px-1 rounded text-xs font-mono" title={SYLLABUS_DATA[t]?.topic}>
                                                                {t}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </td>
                                                <td className="p-3 align-top">
                                                    <textarea 
                                                        className="w-full border border-blue-200 bg-blue-50 p-2 rounded text-xs focus:ring-1 focus:ring-blue-500 outline-none resize-none"
                                                        rows="3"
                                                        placeholder="åœ¨æ­¤è¼¸å…¥åˆ†æ•¸æˆ–å‚™è¨»..."
                                                        value={item.note || ''}
                                                        onChange={(e) => updateNote(item.id, e.target.value)}
                                                    ></textarea>
                                                </td>
                                                <td className="p-3 align-top text-right">
                                                    <button onClick={() => deleteHistory(item.id)} className="text-slate-400 hover:text-red-500 p-2">
                                                        âœ•
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="flex min-h-screen">
                    <Sidebar />
                    <div className="flex-1 ml-64 p-8 overflow-y-auto h-screen">
                        {view === 'students' && <StudentsView />}
                        {view === 'input' && <InputView />}
                        {view === 'dashboard' && <DashboardView />}
                        {view === 'generate' && <GenerateView />}
                        {view === 'history' && <HistoryView />}
                        {view === 'data' && <DataView />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

