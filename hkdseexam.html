<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKDSE Physics Trainer V5 (Sub-topic Analysis)</title>
    
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        /* Loading & UI Styles */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sub-topic-tag { font-family: 'Courier New', monospace; font-weight: bold; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    
    <div id="loading-screen">
        <div class="spinner"></div>
        <h2 class="text-slate-600 font-bold">Á≥ªÁµ±ËºâÂÖ•‰∏≠...</h2>
        <p class="text-slate-400 text-sm mt-2">Ê≠£Âú®ËºâÂÖ• 2016-2025 Ë©¶È°åÂú∞Âúñ</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 600);
        const { useState, useEffect, useMemo } = React;

        // ==========================================
        // 1. ÂÆåÊï¥Ë™≤Á®ãÂ§ßÁ∂± (SYLLABUS) - Ê†∏ÂøÉÊï∏Êìö
        // ==========================================
        const SYLLABUS_DATA = {
            // Book 1
            "1.1.1": { section: "Heat", topic: "ÈáèÂ∫¶Ê∏©Â∫¶", desc: "Ê∏©Â∫¶ÁÇ∫Áâ©È´îÂÜ∑ÁÜ±Á®ãÂ∫¶ÁöÑÊ®ôË™å" },
            "1.1.2": { section: "Heat", topic: "ÊîùÊ∞èÊ∏©Ê®ô", desc: "ÊîùÊ∞èÂ∫¶ÁÇ∫Ê∏©Â∫¶ÁöÑÂñÆ‰Ωç" },
            "1.2.1": { section: "Heat", topic: "ÂÖßËÉΩËàáËÉΩÈáèËΩâÁßª", desc: "Ê∏©Â∫¶ÁÇ∫ÂàÜÂ≠êÂπ≥ÂùáÂãïËÉΩ" },
            "1.2.2": { section: "Heat", topic: "ÁÜ±ÂÇ≥ÈÅûÊñπÂºè", desc: "ÂÇ≥Â∞é„ÄÅÂ∞çÊµÅÂíåËºªÂ∞Ñ" },
            "1.3.1": { section: "Heat", topic: "ÂäüÁéáËàáËÉΩÈáè", desc: "ÂäüÁéá = E/t" },
            "1.3.2": { section: "Heat", topic: "ÁÜ±ÂÆπÈáèÂíåÊØîÁÜ±ÂÆπÈáè", desc: "E=mcŒîT" },
            "1.4.1": { section: "Heat", topic: "ÊΩõÁÜ±", desc: "E=ml (ÁÜîËß£/Ê±ΩÂåñ)" },
            "1.4.2": { section: "Heat", topic: "Ëí∏ÁôºËàáÂáùÁµê", desc: "Ëí∏ÁôºÁöÑÂÜ∑ÂçªÊïàÊáâ" },
            "1.5.1": { section: "Heat", topic: "Ê∞£È´îÂÆöÂæã", desc: "pV=nRT" },
            "1.5.2": { section: "Heat", topic: "Ê∞£È´îÂàÜÂ≠êÈÅãÂãïË´ñ", desc: "ÂæÆËßÄË©ÆÈáã (Microscopic)" },
            // Book 2
            "2.1.1": { section: "Mech", topic: "Èï∑Â∫¶ÂíåÊôÇÈñì", desc: "Âü∫Êú¨Áâ©ÁêÜÈáè" },
            "2.1.2": { section: "Mech", topic: "Ë∑ùÈõ¢Âíå‰ΩçÁßª", desc: "Ê®ôÈáèËàáÁü¢Èáè" },
            "2.1.3": { section: "Mech", topic: "ÈÄüÁéá„ÄÅÈÄüÂ∫¶ÂíåÂä†ÈÄüÂ∫¶", desc: "Áû¨ÊôÇÈÄüÁéáËàáÂπ≥ÂùáÈÄüÂ∫¶" },
            "2.1.4": { section: "Mech", topic: "Ë™§Â∑Æ‰º∞ÁÆó", desc: "ÂèçÊáâÊôÇÈñìËàáË™§Â∑Æ" },
            "2.2.1": { section: "Mech", topic: "ÊèèËø∞Áõ¥Á∑öÈÅãÂãï", desc: "Áü¢ÈáèÊèèËø∞" },
            "2.2.2": { section: "Mech", topic: "ÈÅãÂãïÁ∑öÂúñ", desc: "s-t, v-t, a-t ÂúñÂÉèÂàÜÊûê" },
            "2.2.3": { section: "Mech", topic: "ÂãªÂä†ÈÄüÈÅãÂãïÊñπÁ®ã", desc: "SUVAT ÊñπÁ®ãÊáâÁî®" },
            "2.2.4": { section: "Mech", topic: "ÈáçÂäõ‰∏ãÁöÑÂûÇÁõ¥ÈÅãÂãï", desc: "Ëá™Áî±ËêΩÈ´î" },
            "2.3.1": { section: "Mech", topic: "Âäõ", desc: "ÈöîÈõ¢È´îÂúñ (Free Body Diagram)" },
            "2.3.2": { section: "Mech", topic: "ÁâõÈ†ìÁ¨¨‰∏ÄÂÆöÂæã", desc: "ÊÖ£ÊÄß" },
            "2.3.3": { section: "Mech", topic: "ÁâõÈ†ìÁ¨¨‰∫åÂÆöÂæã", desc: "F=ma" },
            "2.3.4": { section: "Mech", topic: "ÈáçÈáèËàáË≥™Èáè", desc: "W=mg" },
            "2.3.5": { section: "Mech", topic: "ÊµÅÈ´îÈòªÂäõ", desc: "ÁµÇÁ´ØÈÄüÂ∫¶" },
            "2.3.6": { section: "Mech", topic: "Êë©Êì¶Âäõ", desc: "ÈùúÊë©Êì¶ËàáÂãïÊë©Êì¶" },
            "2.3.7": { section: "Mech", topic: "ÁâõÈ†ìÁ¨¨‰∏âÂÆöÂæã", desc: "‰ΩúÁî®ÂäõËàáÂèç‰ΩúÁî®Âäõ" },
            "2.4.1": { section: "Mech", topic: "Áâ©È´îÁµÑÊàêÁöÑÁ≥ªÁµ±", desc: "ÈÄ£Êé•È´îÈÅãÂãï" },
            "2.4.2": { section: "Mech", topic: "ÂäõÁöÑÂêàÊàêÂíåÂàÜËß£", desc: "Áü¢ÈáèÂä†Ê≥ï" },
            "2.4.3": { section: "Mech", topic: "ÂÖ±Èù¢Âäõ", desc: "ÂäõÁöÑÂπ≥Ë°°" },
            "2.5.1": { section: "Mech", topic: "ÂäõÁöÑËΩâÂãïÊïàÊáâ", desc: "ÂäõÁü© (Moment)" },
            "2.5.2": { section: "Mech", topic: "ÂâõÈ´îÁöÑÂπ≥Ë°°", desc: "ÂäõÁü©Âπ≥Ë°°" },
            "2.6.1": { section: "Mech", topic: "Âäü", desc: "W = Fs cos Œ∏" },
            "2.6.2": { section: "Mech", topic: "Ê©üÊ¢∞ËÉΩ", desc: "ÂãïËÉΩËàáÂã¢ËÉΩ" },
            "2.6.3": { section: "Mech", topic: "ËÉΩÈáèÂÆàÊÅÜ", desc: "ËÉΩÈáèËΩâÊèõËàáÊêçËÄó" },
            "2.6.4": { section: "Mech", topic: "ÂäüÁéá", desc: "P = Fv" },
            "2.7.1": { section: "Mech", topic: "ÂãïÈáèÂÆàÊÅÜ", desc: "Á¢∞Êíû (ÂΩàÊÄß/ÈùûÂΩàÊÄß)" },
            "2.7.2": { section: "Mech", topic: "ÂãïÈáèËÆäÂåñ", desc: "Ë°ùÈáè (Impulse)" },
            "2.8.1": { section: "Mech", topic: "ÊããÈ´îÈÅãÂãï (Ext)", desc: "Áç®Á´ãÊÄßÂéüÁêÜ" },
            "2.8.2": { section: "Mech", topic: "ÂàÜÊûêÊããÈ´îÈÅãÂãï", desc: "Ê∞¥Âπ≥ËàáÂûÇÁõ¥ÂàÜÈáè" },
            "2.9.1": { section: "Mech", topic: "ÊèèËø∞ÂúìÂë®ÈÅãÂãï (Ext)", desc: "ËßíÈÄüÂ∫¶" },
            "2.9.2": { section: "Mech", topic: "ÂêëÂøÉÂäõËàáÂêëÂøÉÂä†ÈÄüÂ∫¶", desc: "a = v¬≤/r" },
            "2.9.3": { section: "Mech", topic: "ÂúìÂë®ÈÅãÂãïÁöÑ‰æãÂ≠ê", desc: "ÂÇæÊñúË∑ØÈù¢/ÂñÆÊì∫" },
            "2.10.1": { section: "Mech", topic: "Ëê¨ÊúâÂºïÂäõ (Ext)", desc: "GMm/r¬≤" },
            "2.10.2": { section: "Mech", topic: "ÂºïÂäõ‰∏ãÁöÑÂúìÂë®ÈÅãÂãï", desc: "Ë°õÊòüÈÅãÂãï" },
            // Book 3
            "3.1.1": { section: "Waves", topic: "ÂÖâÁ∑ö", desc: "ÂÖâÊùüÊÄßË≥™" },
            "3.1.2": { section: "Waves", topic: "ÂèçÂ∞ÑËàáÂπ≥Èù¢Èè°", desc: "ÂèçÂ∞ÑÂÆöÂæã" },
            "3.2.1": { section: "Waves", topic: "ÊäòÂ∞Ñ", desc: "Snell's Law" },
            "3.2.2": { section: "Waves", topic: "ÂÖ®ÂÖßÂèçÂ∞Ñ", desc: "Ëá®ÁïåËßí" },
            "3.3.1": { section: "Waves", topic: "ÈÄèÈè°Á®ÆÈ°û", desc: "Âá∏ÈÄèÈè°ËàáÂáπÈÄèÈè°" },
            "3.3.2": { section: "Waves", topic: "Âá∏ÈÄèÈè°ÊàêÂÉè", desc: "‰ΩúÂúñÊ≥ï" },
            "3.3.3": { section: "Waves", topic: "ÂáπÈÄèÈè°ÊàêÂÉè", desc: "‰ΩúÂúñÊ≥ï" },
            "3.3.4": { section: "Waves", topic: "Áâ©„ÄÅÂÉè‰ª•ÂèäÈÄèÈè°ÁöÑÈóú‰øÇ", desc: "ÈÄèÈè°ÂÖ¨Âºè" },
            "3.4.1": { section: "Waves", topic: "Ê≥¢ÁöÑÁ∞°‰ªã", desc: "Á∏±Ê≥¢ËàáÊ©´Ê≥¢" },
            "3.4.2": { section: "Waves", topic: "Ê©´Ê≥¢ÁöÑÊ≥¢Âãï", desc: "v = fŒª" },
            "3.4.3": { section: "Waves", topic: "Ê©´Ê≥¢ÁöÑÁ≤íÂ≠êÊåØÂãï", desc: "Áõ∏‰Ωç" },
            "3.4.4": { section: "Waves", topic: "‰ª•Á∑öÂúñÊèèËø∞Ê©´Ê≥¢", desc: "‰ΩçÁßª-Ë∑ùÈõ¢/ÊôÇÈñìÂúñ" },
            "3.5.1": { section: "Waves", topic: "Ê∞¥Ê≥¢", desc: "Ê∞¥Ê≥¢ÊßΩÂØ¶È©ó" },
            "3.5.2": { section: "Waves", topic: "ÂèçÂ∞ÑËàáÊäòÂ∞Ñ(Ê≥¢)", desc: "Ê∑±Ê∑∫Ê∞¥Âüü" },
            "3.5.3": { section: "Waves", topic: "Ë°çÂ∞ÑËàáÂπ≤Ê∂â", desc: "Ë∑ØÁ®ãÂ∑Æ" },
            "3.5.4": { section: "Waves", topic: "ÈßêÊ≥¢", desc: "Ê≥¢ËÖπËàáÊ≥¢ÁØÄ" },
            "3.6.1": { section: "Waves", topic: "ÂÖâÁöÑÊ≥¢ÂãïÊú¨Ë≥™", desc: "ÂÖâÊòØÊ©´Ê≥¢" },
            "3.6.2": { section: "Waves", topic: "Ê•äÊ∞èÈõôÁ∏´ÂØ¶È©ó", desc: "Œîy = ŒªD/a" },
            "3.6.3": { section: "Waves", topic: "Âπ≥Èù¢ÈÄèÂ∞ÑÂÖâÊüµ", desc: "d sin Œ∏ = nŒª" },
            "3.6.4": { section: "Waves", topic: "ÈõªÁ£ÅÊ≥¢", desc: "ÈõªÁ£ÅÊ≥¢Ë≠ú" },
            "3.7.1": { section: "Waves", topic: "Á∏±Ê≥¢", desc: "ËÅ≤Ê≥¢ÁâπÊÄß" },
            "3.7.2": { section: "Waves", topic: "ËÅ≤Èü≥ÁöÑÊú¨Ë≥™", desc: "‰ªãË≥™ÂÇ≥Êí≠" },
            "3.7.3": { section: "Waves", topic: "ËÅ≤Èü≥ÁöÑÂÖ∂‰ªñÁâπÊÄß", desc: "Ë∂ÖËÅ≤Ê≥¢ËàáÂàÜË≤ù" },
            // Book 4
            "4.1.1": { section: "Elec", topic: "ÈõªËç∑", desc: "Êë©Êì¶Ëµ∑Èõª" },
            "4.1.2": { section: "Elec", topic: "ÈùúÈõªÂäõ", desc: "Â∫´ÂÄ´ÂÆöÂæã" },
            "4.1.3": { section: "Elec", topic: "ÈõªÂ†¥", desc: "ÈõªÂ†¥Âº∑Â∫¶ E" },
            "4.2.1": { section: "Elec", topic: "ÈõªÊµÅ", desc: "I = Q/t" },
            "4.2.2": { section: "Elec", topic: "ÈõªÂ£ì", desc: "ÈõªÂãïÂã¢ËàáÈõªÂã¢Â∑Æ" },
            "4.2.3": { section: "Elec", topic: "ÈõªÈòª", desc: "R = œÅl/A" },
            "4.2.4": { section: "Elec", topic: "ÈõªÈòªÂô®Á∂≤Áµ°", desc: "‰∏≤ËÅØËàá‰∏¶ËÅØ" },
            "4.2.5": { section: "Elec", topic: "ÈõªÂäüÁéá", desc: "P = VI" },
            "4.3.1": { section: "Elec", topic: "ÂàÜÊûêÈõªË∑Ø", desc: "Èõª‰ΩçÈôçËàáÂàÜÂ£ìÂô®" },
            "4.3.2": { section: "Elec", topic: "ÂØ¶ÈöõÂÑÄË°®", desc: "ÂÖßÈòªÂΩ±Èüø" },
            "4.4.1": { section: "Elec", topic: "ÂÆ∂Áî®ÈõªÂô®", desc: "ÂäüÁéáËàáËÉΩÈáè (kWh)" },
            "4.4.2": { section: "Elec", topic: "ÂÆ∂Â±ÖÂÆâÂÖ®", desc: "‰øùÈö™Áµ≤ËàáÊé•Âú∞" },
            "4.4.3": { section: "Elec", topic: "‰∫§ÊµÅÈõª (Ext)", desc: "RMS ÂÄº" },
            "4.5.1": { section: "Elec", topic: "Á£ÅÂäõËàáÁ£ÅÂ†¥", desc: "Á£ÅÂ†¥Á∑ö" },
            "4.5.2": { section: "Elec", topic: "ÈõªÊµÅÁöÑÁ£ÅÊïàÊáâ", desc: "Âè≥ÊâãÊè°Êã≥ÂÆöÂâá" },
            "4.6.1": { section: "Elec", topic: "‰ΩúÁî®ÊñºÂ∞éÈ´îÁöÑÁ£ÅÂäõ", desc: "F = BIL sinŒ∏" },
            "4.6.2": { section: "Elec", topic: "Áõ¥ÊµÅÈõªÂãïÊ©ü", desc: "ÊèõÂêëÂô®ÂéüÁêÜ" },
            "4.6.3": { section: "Elec", topic: "Ê¥õÂÄ´Ëå≤Âäõ", desc: "F = Bqv" },
            "4.7.1": { section: "Elec", topic: "Á£ÅÂ†¥Áî¢ÁîüÁöÑÈõªÊµÅ", desc: "Ê•ûÊ¨°ÂÆöÂæã" },
            "4.7.2": { section: "Elec", topic: "ÈõªÁ£ÅÊÑüÊáâÊáâÁî®", desc: "ÁôºÈõªÊ©ü" },
            "4.7.3": { section: "Elec", topic: "Ê≥ïÊãâÁ¨¨ÂÆöÂæã (Ext)", desc: "Á£ÅÈÄöÈáèËÆäÂåñÁéá" },
            "4.8.1": { section: "Elec", topic: "ËÆäÂ£ìÂô® (Ext)", desc: "Vp/Vs = Np/Ns" },
            "4.8.2": { section: "Elec", topic: "Ëº∏Èõª (Ext)", desc: "È´òÂ£ìÂÇ≥Ëº∏ÂÑ™Âã¢" },
            // Book 5
            "5.1.1": { section: "Rad", topic: "Ëá¥ÈõªÈõ¢ËºªÂ∞Ñ", desc: "XÂ∞ÑÁ∑ö" },
            "5.1.2": { section: "Rad", topic: "Ê†∏ËºªÂ∞Ñ", desc: "Œ±, Œ≤, Œ≥ ÊÄßË≥™" },
            "5.1.3": { section: "Rad", topic: "ËºªÂ∞ÑÂÆâÂÖ®", desc: "ÂäëÈáè (Sv)" },
            "5.2.1": { section: "Rad", topic: "ÂéüÂ≠êÊ®°Âûã", desc: "Âêå‰ΩçÁ¥†" },
            "5.2.2": { section: "Rad", topic: "ÊîæÂ∞ÑË°∞ËÆä", desc: "ÂçäË°∞Êúü" },
            "5.2.3": { section: "Rad", topic: "Âêå‰ΩçÁ¥†ÊáâÁî®", desc: "ËøΩËπ§ÂäëËàáÂÆöÂπ¥Ê≥ï" },
            "5.3.1": { section: "Rad", topic: "Ë£ÇËÆäËàáËÅöËÆä", desc: "ËÉΩÈáè‰æÜÊ∫ê" },
            "5.3.2": { section: "Rad", topic: "Ë≥™ËÉΩÈóú‰øÇ", desc: "E = mc¬≤" },
            "5.3.3": { section: "Rad", topic: "Ê†∏ËÉΩ", desc: "ÂèçÊáâÂ†ÜÂéüÁêÜ" }
        };

        // ==========================================
        // 2. QUESTION MAP DATABASE (Ë©¶È°åÂú∞Âúñ)
        // ==========================================
        // Áî®Êà∂Êèê‰æõÁöÑ 2016 Êï∏ÊìöÂ∑≤Ê§çÂÖ•„ÄÇ
        // Ëã•Ë¶ÅÂä†ÂÖ•ÂÖ∂‰ªñÂπ¥‰ªΩÔºåË´ãË§áË£Ω 2016 ÁöÑÊ†ºÂºèÂæÄ‰∏ãÊñ∞Â¢û key (e.g., "2017_1A")
        
        const FULL_QUESTION_MAP = {
            "2016_1A": {
                1: "1.2.2", 2: "1.4.1", 3: "1.5.2", 4: "2.1.3", 5: "2.1.3",
                6: "2.3.7", 7: "2.2.3", 8: "2.6.2", 9: "2.6.1", 10: "2.8.2",
                11: "2.5.2", 12: "2.7.1", 13: "2.9.2", 14: "2.10.2", 15: "3.4.4",
                16: "3.4.2", 17: "3.2.1", 18: "3.5.4", 19: "3.5.3", 20: "3.2.1",
                21: "3.5.3", 22: "3.3.4", 23: "3.7.3", 24: "4.1.3", 25: "4.2.4",
                26: "4.2.4", 27: "4.3.1", 28: "4.4.1", 29: "4.7.3", 30: "4.4.3",
                31: "4.8.1", 32: "5.1.2", 33: "5.2.2"
            }
            // Âú®Ê≠§ËôïÂä†ÂÖ•ÂÖ∂‰ªñÂπ¥‰ªΩÔºå‰æãÂ¶Ç:
            // "2017_1A": { 1: "1.1.1", 2: "...", ... },
        };

        const YEAR_OPTIONS = Array.from({length: 12}, (_, i) => 2025 - i); // 2014-2025

        const App = () => {
            const [view, setView] = useState('students');
            const [students, setStudents] = useState([]);
            const [answerKeys, setAnswerKeys] = useState({}); 
            const [records, setRecords] = useState([]);

            // UI State
            const [editingKey, setEditingKey] = useState({ year: 2016, paper: '1A' });
            const [inputForm, setInputForm] = useState({ studentId: '', year: '2016', paper: '1A', answers: {}, scores: {} });
            const [dashStudent, setDashStudent] = useState('');
            
            // AI Settings
            const [aiConfig, setAiConfig] = useState({ type: 'mixed', lang: 'zh' });
            const [generatedPrompt, setGeneratedPrompt] = useState('');

            // Load Data
            useEffect(() => {
                const saved = localStorage.getItem('dsePhysV5');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        setStudents(data.students || []);
                        setAnswerKeys(data.answerKeys || {});
                        setRecords(data.records || []);
                        if(data.students?.[0]) {
                            setDashStudent(data.students[0].id);
                            setInputForm(f => ({...f, studentId: data.students[0].id}));
                        }
                    } catch(e) {}
                }
            }, []);

            // Save Data
            useEffect(() => {
                localStorage.setItem('dsePhysV5', JSON.stringify({ students, answerKeys, records }));
            }, [students, answerKeys, records]);

            // Helper: Question to Topic Logic (Crucial Update)
            const getTopicInfo = (year, paper, qNum) => {
                // 1. Try to find precise map in FULL_QUESTION_MAP
                const mapKey = `${year}_${paper}`;
                if (FULL_QUESTION_MAP[mapKey] && FULL_QUESTION_MAP[mapKey][qNum]) {
                    const topicId = FULL_QUESTION_MAP[mapKey][qNum];
                    return { id: topicId, ...SYLLABUS_DATA[topicId], isReal: true };
                }
                
                // 2. Fallback (if map not entered yet)
                const ids = Object.keys(SYLLABUS_DATA);
                const mockId = ids[(qNum * 13) % ids.length];
                return { id: mockId, ...SYLLABUS_DATA[mockId], isReal: false };
            };

            // --- Sidebar ---
            const Sidebar = () => (
                <div className="w-64 bg-slate-900 text-white h-screen fixed left-0 top-0 flex flex-col shadow-2xl z-10">
                    <div className="p-6 border-b border-slate-700">
                        <h1 className="text-xl font-bold tracking-wider italic">PHY MASTER</h1>
                        <div className="text-xs text-blue-400 mt-1">V5.0 Sub-topic Analysis</div>
                    </div>
                    <nav className="p-4 space-y-2 flex-1 overflow-y-auto">
                        {[
                            {id: 'students', icon: 'üë•', label: 'Â≠∏ÁîüÁÆ°ÁêÜ'},
                            {id: 'marking', icon: 'üîë', label: 'Ê®ôÊ∫ñÁ≠îÊ°à (ANS)'},
                            {id: 'input', icon: 'üìù', label: 'Ëº∏ÂÖ•ÊàêÁ∏æ'},
                            {id: 'dashboard', icon: 'üìä', label: 'Ë®∫Êñ∑Â†±Âëä'},
                            {id: 'generate', icon: 'ü§ñ', label: 'AI Á∑¥ÁøíÁîüÊàê'}
                        ].map(item => (
                            <button key={item.id} onClick={() => setView(item.id)}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded transition-all ${view===item.id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                                <span>{item.icon}</span> {item.label}
                            </button>
                        ))}
                    </nav>
                </div>
            );

            // --- Views ---

            const StudentsView = () => {
                const [name, setName] = useState('');
                const add = () => {
                    if(!name) return;
                    setStudents([...students, { id: Date.now().toString(), name, joinDate: new Date().toLocaleDateString() }]);
                    setName('');
                };
                return (
                    <div className="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-sm">
                        <h2 className="text-2xl font-bold mb-6 text-slate-800">üë• Â≠∏ÁîüÊ™îÊ°à</h2>
                        <div className="flex gap-4 mb-8">
                            <input className="flex-1 border p-3 rounded-lg outline-none focus:border-blue-500" placeholder="Â≠∏ÁîüÂßìÂêç" value={name} onChange={e=>setName(e.target.value)} />
                            <button onClick={add} className="bg-blue-600 text-white px-8 rounded-lg font-bold hover:bg-blue-700">Êñ∞Â¢û</button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {students.map(s => (
                                <div key={s.id} className="p-4 border rounded-lg bg-slate-50 flex justify-between">
                                    <span className="font-bold">{s.name}</span>
                                    <button onClick={()=>{setStudents(students.filter(x=>x.id!==s.id)); setRecords(records.filter(r=>r.studentId!==s.id))}} className="text-red-400 hover:text-red-600">Âà™Èô§</button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const MarkingView = () => {
                const { year, paper } = editingKey;
                const keyId = `${year}_${paper}`;
                const currentKey = answerKeys[keyId] || {};
                const setKey = (q, val) => setAnswerKeys({...answerKeys, [keyId]: {...currentKey, [q]: val}});

                return (
                    <div className="max-w-5xl mx-auto bg-white p-8 rounded-xl shadow-sm">
                        <h2 className="text-2xl font-bold mb-6">üîë Ë®≠ÂÆöÊ®ôÊ∫ñÁ≠îÊ°à (Marking Scheme)</h2>
                        <div className="flex gap-4 mb-6">
                            <select className="border p-2 rounded w-32 font-bold" value={year} onChange={e=>setEditingKey({...editingKey, year: e.target.value})}>
                                {YEAR_OPTIONS.map(y => <option key={y} value={y}>{y}</option>)}
                            </select>
                            <select className="border p-2 rounded w-32 bg-slate-100" disabled><option>Paper 1A</option></select>
                        </div>
                        <div className="grid grid-cols-4 md:grid-cols-8 gap-2">
                            {Array.from({length: 33}).map((_, i) => {
                                const q = i+1;
                                const ans = currentKey[q];
                                return (
                                    <div key={q} className="p-2 border rounded flex flex-col items-center bg-slate-50">
                                        <span className="text-xs font-bold text-slate-400 mb-1">Q{q}</span>
                                        <div className="flex gap-1">
                                            {['A','B','C','D'].map(opt => (
                                                <button key={opt} onClick={()=>setKey(q, opt)} className={`w-5 h-5 text-xs rounded ${ans===opt?'bg-green-600 text-white':'bg-white border'}`}>{opt}</button>
                                            ))}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                );
            };

            const InputView = () => {
                const { studentId, year, paper } = inputForm;
                const keyId = `${year}_${paper}`;
                const sysKey = answerKeys[keyId] || {};
                const hasKey = Object.keys(sysKey).length > 0;

                const toggleMC = (q, opt) => {
                    const isCorrect = sysKey[q] === opt;
                    setInputForm({
                        ...inputForm, 
                        answers: {...inputForm.answers, [q]: opt},
                        scores: {...inputForm.scores, [q]: isCorrect ? 1 : 0}
                    });
                };

                const save = () => {
                    if(!studentId) return alert('Ë´ãÈÅ∏ÊìáÂ≠∏Áîü');
                    const newRec = { ...inputForm, id: Date.now(), timestamp: new Date().toISOString() };
                    const others = records.filter(r => !(r.studentId===studentId && r.year==year && r.paper===paper));
                    setRecords([...others, newRec]);
                    alert('‚úÖ Â∑≤ÂÑ≤Â≠ò');
                };

                return (
                    <div className="max-w-5xl mx-auto bg-white p-8 rounded-xl shadow-sm">
                        <h2 className="text-2xl font-bold mb-6">üìù Ëº∏ÂÖ•ÊàêÁ∏æ</h2>
                        <div className="grid grid-cols-3 gap-4 mb-6 bg-blue-50 p-4 rounded-lg">
                            <select className="border p-2 rounded" value={studentId} onChange={e=>setInputForm({...inputForm, studentId:e.target.value})}>
                                {students.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                            <select className="border p-2 rounded" value={year} onChange={e=>setInputForm({...inputForm, year:e.target.value, answers:{}, scores:{}})}>
                                {YEAR_OPTIONS.map(y => <option key={y} value={y}>{y}</option>)}
                            </select>
                            <select className="border p-2 rounded" value={paper} onChange={e=>setInputForm({...inputForm, paper:e.target.value, answers:{}, scores:{}})}>
                                <option value="1A">Paper 1A (MC)</option>
                                <option value="1B">Paper 1B</option>
                            </select>
                        </div>
                        
                        {paper === '1A' && (
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                {Array.from({length: 33}).map((_, i) => {
                                    const q = i+1;
                                    const myAns = inputForm.answers[q];
                                    const realAns = sysKey[q];
                                    const topicInfo = getTopicInfo(year, paper, q); // Ëé∑ÂèñËØæÈ¢ò‰ø°ÊÅØ
                                    const isRealMap = topicInfo.isReal;

                                    let statusClass = "border-slate-200";
                                    if(myAns && realAns) statusClass = myAns===realAns ? "bg-green-50 border-green-300" : "bg-red-50 border-red-300";

                                    return (
                                        <div key={q} className={`p-2 border rounded flex flex-col ${statusClass}`}>
                                            <div className="flex justify-between items-center mb-1">
                                                <span className="font-bold text-slate-500">Q{q}</span>
                                                {/* ÊòæÁ§∫Â≠êËØæÈ¢ò ID */}
                                                <span className={`text-[10px] px-1 rounded ${isRealMap ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-400'}`} title={topicInfo.topic}>
                                                    {topicInfo.id}
                                                </span>
                                            </div>
                                            <div className="flex justify-between">
                                                {['A','B','C','D'].map(opt => (
                                                    <button key={opt} onClick={()=>toggleMC(q, opt)} 
                                                        className={`w-6 h-6 text-xs rounded font-bold ${myAns===opt?'bg-slate-800 text-white':'bg-white text-slate-400 border'}`}>
                                                        {opt}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        )}
                         {paper !== '1A' && <div className="text-center p-8 text-gray-400">Èï∑È°åÁõÆË´ãÁõ¥Êé•Ëº∏ÂÖ•ÂàÜÊï∏</div>}

                        <button onClick={save} className="w-full mt-6 bg-slate-800 text-white py-3 rounded font-bold hover:bg-slate-700">ÂÑ≤Â≠ò</button>
                    </div>
                );
            };

            const DashboardView = () => {
                const subTopicStats = useMemo(() => {
                    if(!dashStudent) return [];
                    const myRecs = records.filter(r => r.studentId === dashStudent);
                    const stats = {};

                    myRecs.forEach(r => {
                        Object.entries(r.scores).forEach(([q, score]) => {
                            const info = getTopicInfo(r.year, r.paper, q);
                            const tid = info.id;
                            if(!stats[tid]) stats[tid] = { ...info, earned: 0, max: 0, count: 0 };
                            
                            stats[tid].earned += Number(score);
                            stats[tid].max += (r.paper==='1A' ? 1 : 10);
                            stats[tid].count++;
                        });
                    });

                    return Object.values(stats).sort((a,b) => (a.earned/a.max) - (b.earned/b.max)); // Weakest first
                }, [records, dashStudent]);

                return (
                    <div className="max-w-6xl mx-auto space-y-6">
                        <div className="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center">
                            <h2 className="text-xl font-bold">üìä Â≠êË™≤È°åË®∫Êñ∑Â†±Âëä (Sub-topic Diagnosis)</h2>
                            <select className="border p-2 rounded" value={dashStudent} onChange={e=>setDashStudent(e.target.value)}>
                                {students.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>

                        {subTopicStats.length === 0 ? (
                            <div className="p-12 text-center text-slate-400 bg-white rounded-xl">ÁÑ°Êï∏Êìö</div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Weaknesses */}
                                <div className="bg-white p-6 rounded-xl shadow-sm border-t-4 border-red-500">
                                    <h3 className="font-bold text-lg mb-4 text-red-600 flex items-center gap-2">
                                        <span className="text-2xl">‚ö†</span> ÊÄ•ÈúÄÊîπÂñÑ (Weakest Sub-topics)
                                    </h3>
                                    <div className="space-y-3">
                                        {subTopicStats.slice(0, 8).map(t => (
                                            <div key={t.id} className="p-3 bg-red-50 border border-red-100 rounded-lg flex justify-between items-center group">
                                                <div>
                                                    <div className="flex items-center gap-2">
                                                        <span className="sub-topic-tag bg-white text-red-600 px-1 border border-red-200 rounded text-sm">{t.id}</span>
                                                        <span className="font-bold text-slate-800">{t.topic}</span>
                                                    </div>
                                                    <div className="text-xs text-slate-500 mt-1 pl-1">{t.desc}</div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-xl font-bold text-red-600">{((t.earned/t.max)*100).toFixed(0)}%</div>
                                                    <div className="text-[10px] text-slate-400">{t.count} È°å</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Strengths */}
                                <div className="bg-white p-6 rounded-xl shadow-sm border-t-4 border-green-500">
                                    <h3 className="font-bold text-lg mb-4 text-green-600 flex items-center gap-2">
                                        <span className="text-2xl">‚òÖ</span> Ë°®ÁèæÂÑ™Áï∞ (Strongest)
                                    </h3>
                                    <div className="space-y-3">
                                        {[...subTopicStats].reverse().slice(0, 8).map(t => (
                                            <div key={t.id} className="p-3 bg-green-50 border border-green-100 rounded-lg flex justify-between items-center">
                                                <div>
                                                    <div className="flex items-center gap-2">
                                                        <span className="sub-topic-tag bg-white text-green-600 px-1 border border-green-200 rounded text-sm">{t.id}</span>
                                                        <span className="font-bold text-slate-800">{t.topic}</span>
                                                    </div>
                                                </div>
                                                <div className="text-xl font-bold text-green-600">{((t.earned/t.max)*100).toFixed(0)}%</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const GenerateView = () => {
                const generate = () => {
                    if(!dashStudent) return alert("Ë´ãÂÖàÂú®ÂàÜÊûêÈ†ÅÈù¢ÈÅ∏ÊìáÂ≠∏Áîü");
                    
                    // Logic to find weaknesses
                    const myRecs = records.filter(r => r.studentId === dashStudent);
                    const stats = {};
                    myRecs.forEach(r => {
                        Object.entries(r.scores).forEach(([q, score]) => {
                            const info = getTopicInfo(r.year, r.paper, q);
                            const tid = info.id;
                            if(!stats[tid]) stats[tid] = { ...info, earned: 0, max: 0 };
                            stats[tid].earned += Number(score);
                            stats[tid].max += (r.paper==='1A' ? 1 : 10);
                        });
                    });
                    
                    const weaknesses = Object.values(stats)
                        .sort((a,b) => (a.earned/a.max) - (b.earned/b.max))
                        .slice(0, 5); // Take top 5

                    const prompt = `
Role: Professional HKDSE Physics Tutor.
Task: Create a practice exercise for a student based on their specific weaknesses.
Language: ${aiConfig.lang === 'zh' ? 'Traditional Chinese (ÁπÅÈ´î‰∏≠Êñá)' : 'English'}
Format: ${aiConfig.type === 'mc' ? 'Multiple Choice (MC)' : 'Mixed (MC + Long Questions)'}

Student Weakness Report (Sub-topic Level):
${weaknesses.map(w => `- [${w.id}] ${w.topic}: ${w.desc} (Score: ${((w.earned/w.max)*100).toFixed(0)}%)`).join('\n')}

Requirements:
1. Create 1-2 challenging questions for EACH weakness listed above.
2. Ensure questions follow the HKDSE style and difficulty.
3. Provide detailed step-by-step solutions and marking schemes.
4. Explain the common misconceptions for these specific sub-topics.
                    `.trim();

                    setGeneratedPrompt(prompt);
                };

                return (
                    <div className="max-w-5xl mx-auto flex gap-6 h-[80vh]">
                        <div className="w-1/3 bg-white p-6 rounded-xl shadow-sm h-full flex flex-col">
                            <h2 className="text-xl font-bold mb-6 flex items-center gap-2">ü§ñ Ë®≠ÂÆöÁîüÊàêÂèÉÊï∏</h2>
                            
                            <div className="space-y-4 flex-1">
                                <div>
                                    <label className="block text-sm font-bold text-slate-500 mb-1">ÁõÆÊ®ôÂ≠∏Áîü</label>
                                    <select className="w-full border p-2 rounded" value={dashStudent} onChange={e=>setDashStudent(e.target.value)}>
                                        {students.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-500 mb-1">Ë™ûË®Ä</label>
                                    <select className="w-full border p-2 rounded" value={aiConfig.lang} onChange={e=>setAiConfig({...aiConfig, lang:e.target.value})}>
                                        <option value="zh">ÁπÅÈ´î‰∏≠Êñá</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-500 mb-1">È°åÂûã</label>
                                    <select className="w-full border p-2 rounded" value={aiConfig.type} onChange={e=>setAiConfig({...aiConfig, type:e.target.value})}>
                                        <option value="mixed">Ê∑∑Âêà (Mixed)</option>
                                        <option value="mc">MC Only</option>
                                    </select>
                                </div>
                            </div>

                            <button onClick={generate} className="w-full py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 shadow-lg mt-4">
                                ÁîüÊàê Prompt ‚ú®
                            </button>
                        </div>

                        <div className="flex-1 bg-white p-6 rounded-xl shadow-sm h-full flex flex-col">
                            <h3 className="font-bold text-slate-700 mb-2">ÁîüÊàêÁµêÊûú (Ë§áË£Ω‰∏¶Ë≤ºÁµ¶ AI)</h3>
                            <textarea 
                                className="flex-1 w-full bg-slate-50 border p-4 rounded-lg font-mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-purple-500"
                                value={generatedPrompt}
                                readOnly
                                placeholder="ÈªûÊìäÂ∑¶ÂÅ¥ÊåâÈàïÁîüÊàê..."
                            ></textarea>
                            <button onClick={()=>{navigator.clipboard.writeText(generatedPrompt); alert("Â∑≤Ë§áË£Ω!")}} className="mt-4 py-2 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 font-bold">
                                üìã ‰∏ÄÈçµË§áË£Ω Prompt
                            </button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex min-h-screen">
                    <Sidebar />
                    <div className="flex-1 ml-64 p-8 overflow-y-auto h-screen">
                        {view === 'students' && <StudentsView />}
                        {view === 'marking' && <MarkingView />}
                        {view === 'input' && <InputView />}
                        {view === 'dashboard' && <DashboardView />}
                        {view === 'generate' && <GenerateView />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
