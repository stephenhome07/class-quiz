<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快樂學習測驗站</title>
    
    <!-- 1. 載入必要的工具 (React, Tailwind, Babel) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. 載入 Firebase (使用相容性較好的 CDN) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ==========================================
        // 重要：請在這裡填入您的 Firebase 設定
        // ==========================================
        // 1. 前往 https://console.firebase.google.com/ 建立新專案
        // 2. 進入「專案設定 (Project Settings)」 -> 下方的「您的應用程式」
        // 3. 選擇網頁 (< /> 圖示)，註冊後複製 firebaseConfig 的內容貼在下方
        
const firebaseConfig = {
  apiKey: "AIzaSyDLoHH3xJcg8RP135anypHnT--rY2O_8ag",
  authDomain: "test-235ba.firebaseapp.com",
  databaseURL: "https://test-235ba-default-rtdb.firebaseio.com",
  projectId: "test-235ba",
  storageBucket: "test-235ba.firebasestorage.app",
  messagingSenderId: "956103447126",
  appId: "1:956103447126:web:23fb288d99c599c053a1f7",
  measurementId: "G-73095GCTJ9"
};

        // Gemini API Key (選填，若要用 AI 出題請填入)
        const GEMINI_API_KEY = ""; 

        // 檢查使用者是否已經設定了 Config
        const isConfigured = !firebaseConfig.apiKey.includes("您的_API_KEY");

        // 初始化變數
        let app, auth, db;
        let initError = null;

        if (isConfigured) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase 初始化成功");
            } catch (e) {
                console.error("Firebase 初始化失敗:", e);
                initError = e.message;
            }
        }

        // 將 Firebase 功能掛載到 window 以便 React 使用
        window.dbServices = { 
            auth, db, 
            signInAnonymously, onAuthStateChanged, 
            collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit, 
            GEMINI_API_KEY,
            isConfigured,
            initError
        };
    </script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // 簡單的 SVG 圖示組件
        const Icons = {
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Trophy: () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            Warning: () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-500"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        };

        const DEFAULT_QUESTIONS = [
            { id: 1, question: "「與其」的關聯詞下句通常接什麼？", options: ["不如", "因為", "雖然", "而且"], correctAnswer: "不如" },
            { id: 2, question: "5 x 8 + 4 = ?", options: ["42", "44", "40", "48"], correctAnswer: "44" },
            { id: 3, question: "光合作用主要是植物的哪個部分進行？", options: ["根", "莖", "葉", "花"], correctAnswer: "葉" }
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [studentName, setStudentName] = useState("");
            const [appState, setAppState] = useState('login'); 
            const [score, setScore] = useState(0);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [isAnswerChecked, setIsAnswerChecked] = useState(false);
            const [questions, setQuestions] = useState(DEFAULT_QUESTIONS);
            const [leaderboard, setLeaderboard] = useState([]);
            const [loading, setLoading] = useState(true);
            const [topic, setTopic] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [quizMode, setQuizMode] = useState('default');
            const [errorMsg, setErrorMsg] = useState("");

            // 取得 Firebase 服務
            const { auth, db, signInAnonymously, onAuthStateChanged, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, GEMINI_API_KEY, isConfigured, initError } = window.dbServices;

            useEffect(() => {
                // 如果沒有設定 Firebase，就停止載入並顯示警告
                if (!isConfigured) {
                    setLoading(false);
                    return;
                }
                
                if (initError) {
                    setErrorMsg("Firebase 初始化失敗: " + initError);
                    setLoading(false);
                    return;
                }

                if (!auth) {
                    setLoading(false);
                    return; 
                }

                signInAnonymously(auth).catch(e => {
                    console.error("登入失敗", e);
                    setErrorMsg(`連線失敗 (${e.code})。請檢查您的 API Key 是否正確，或是否在 Firebase Console 開啟了匿名登入權限。`);
                    setLoading(false);
                });

                return onAuthStateChanged(auth, u => {
                    setUser(u);
                    setLoading(false);
                });
            }, []);

            // 監聽排行榜
            useEffect(() => {
                if (!user || !db) return;
                // 讀取全班成績
                const q = query(collection(db, 'class_scores')); 
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // 簡單排序
                    records.sort((a, b) => b.score - a.score);
                    setLeaderboard(records);
                }, (err) => {
                    console.error("讀取排行榜失敗", err);
                });
                return () => unsubscribe();
            }, [user]);

            // Gemini API 呼叫
            const generateAIQuiz = async () => {
                if (!GEMINI_API_KEY) {
                    alert("請先在程式碼中填入 Gemini API Key");
                    return;
                }
                setIsGenerating(true);
                try {
                    const prompt = `Create 5 multiple choice questions about "${topic}" in Traditional Chinese. Format: JSON array. { "question": "", "options": ["","","",""], "correctAnswer": "" }.`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    const json = JSON.parse(text.replace(/```json|```/g, '').trim());
                    setQuestions(json);
                    startQuiz();
                } catch (e) {
                    alert("生成失敗，請檢查 API Key 或網路");
                    console.error(e);
                }
                setIsGenerating(false);
            };

            const startQuiz = () => {
                if (!studentName) return alert("請輸入姓名");
                if (!auth) return alert("請先設定 Firebase API Key");
                setScore(0);
                setCurrentQuestionIndex(0);
                setAppState('quiz');
                setIsAnswerChecked(false);
                setSelectedOption(null);
            };

            const handleAnswer = (option) => {
                if(isAnswerChecked) return;
                setSelectedOption(option);
            }

            const check = () => {
                setIsAnswerChecked(true);
                if (selectedOption === questions[currentQuestionIndex].correctAnswer) {
                    setScore(s => s + 20);
                }
            }

            const next = () => {
                if (currentQuestionIndex < questions.length - 1) {
                    setCurrentQuestionIndex(i => i + 1);
                    setIsAnswerChecked(false);
                    setSelectedOption(null);
                } else {
                    finish();
                }
            }

            const finish = async () => {
                setAppState('result');
                if (user && db) {
                    await addDoc(collection(db, 'class_scores'), {
                        studentName,
                        score,
                        timestamp: serverTimestamp(),
                        topic: quizMode === 'ai' ? topic : '一般測驗'
                    });
                }
            }

            // --- 錯誤處理畫面 ---
            if (!isConfigured) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                        <div className="max-w-md w-full bg-white p-8 rounded-2xl shadow-xl text-center">
                            <div className="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-red-100 text-red-500">
                                <Icons.Warning />
                            </div>
                            <h2 className="text-xl font-bold mb-2">尚未設定資料庫</h2>
                            <p className="text-slate-600 mb-6 text-sm text-left">
                                您目前的 <code>firebaseConfig</code> 還是預設值。請用記事本打開這個 HTML 檔案，找到第 25 行，並填入您自己的 Firebase 設定。
                            </p>
                            <div className="text-left bg-slate-100 p-4 rounded text-xs font-mono mb-4 text-slate-500">
                                const firebaseConfig = &#123;<br/>
                                &nbsp;&nbsp;apiKey: "您的_API_KEY...",<br/>
                                &nbsp;&nbsp;...<br/>
                                &#125;;
                            </div>
                            <a href="https://console.firebase.google.com/" target="_blank" className="block w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700">前往 Firebase Console</a>
                        </div>
                    </div>
                );
            }

            if (errorMsg) {
                return (
                     <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                        <div className="max-w-md w-full bg-white p-8 rounded-2xl shadow-xl text-center">
                             <div className="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-red-100 text-red-500">
                                <Icons.Warning />
                            </div>
                            <h2 className="text-xl font-bold mb-2">連線發生錯誤</h2>
                            <p className="text-red-600 mb-4">{errorMsg}</p>
                            <button onClick={() => window.location.reload()} className="px-4 py-2 bg-slate-200 rounded hover:bg-slate-300">重新整理</button>
                        </div>
                    </div>
                );
            }

            if (loading) return <div className="flex h-screen items-center justify-center text-blue-600 font-bold">載入系統中...</div>;

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex justify-center p-4">
                    <div className="w-full max-w-2xl">
                        
                        <header className="mb-8 text-center mt-8">
                            <div className="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-blue-600 text-white shadow-lg">
                                <Icons.Book />
                            </div>
                            <h1 className="text-3xl font-bold text-slate-900">快樂學習測驗站</h1>
                        </header>

                        <div className="overflow-hidden rounded-2xl bg-white shadow-xl ring-1 ring-slate-900/5">
                            {appState === 'login' && (
                                <div className="p-8 space-y-6">
                                    <div className="text-center">
                                        <h2 className="text-xl font-semibold">歡迎挑戰</h2>
                                        <p className="text-slate-500">輸入名字開始</p>
                                    </div>
                                    <input 
                                        type="text" 
                                        className="w-full border rounded-lg p-3" 
                                        placeholder="學生姓名" 
                                        value={studentName} 
                                        onChange={e => setStudentName(e.target.value)}
                                    />
                                    
                                    <div className="flex gap-2">
                                        <button onClick={() => { setQuizMode('default'); setQuestions(DEFAULT_QUESTIONS); }} className={`flex-1 py-2 rounded ${quizMode==='default' ? 'bg-blue-100 text-blue-700' : 'bg-slate-100'}`}>一般練習</button>
                                        <button onClick={() => setQuizMode('ai')} className={`flex-1 py-2 rounded ${quizMode==='ai' ? 'bg-purple-100 text-purple-700' : 'bg-slate-100'}`}>AI 出題</button>
                                    </div>

                                    {quizMode === 'ai' && (
                                        <input 
                                            type="text" 
                                            className="w-full border rounded-lg p-3 border-purple-200" 
                                            placeholder="輸入主題 (例如: 恐龍)" 
                                            value={topic} 
                                            onChange={e => setTopic(e.target.value)}
                                        />
                                    )}

                                    <button 
                                        onClick={quizMode === 'ai' ? generateAIQuiz : startQuiz}
                                        disabled={isGenerating}
                                        className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-bold"
                                    >
                                        {isGenerating ? "生成題目中..." : "開始測驗"}
                                    </button>
                                    
                                    <button onClick={() => setAppState('leaderboard')} className="w-full text-sm text-slate-500 hover:text-blue-600">
                                        查看排行榜
                                    </button>
                                </div>
                            )}

                            {appState === 'quiz' && (
                                <div className="p-8">
                                    <div className="flex justify-between mb-6 text-sm font-bold text-slate-500">
                                        <span>第 {currentQuestionIndex + 1} / {questions.length} 題</span>
                                        <span className="text-blue-600">得分: {score}</span>
                                    </div>
                                    <h2 className="text-xl font-bold mb-6">{questions[currentQuestionIndex].question}</h2>
                                    <div className="space-y-3">
                                        {questions[currentQuestionIndex].options.map(opt => {
                                            let bg = "bg-white hover:bg-slate-50";
                                            if (isAnswerChecked) {
                                                if (opt === questions[currentQuestionIndex].correctAnswer) bg = "bg-green-100 border-green-500 text-green-800";
                                                else if (opt === selectedOption) bg = "bg-red-50 border-red-300 text-red-800";
                                            } else if (selectedOption === opt) {
                                                bg = "bg-blue-50 border-blue-500 ring-1 ring-blue-500";
                                            }
                                            return (
                                                <button key={opt} onClick={() => handleAnswer(opt)} disabled={isAnswerChecked} className={`w-full text-left p-4 border rounded-xl transition ${bg}`}>
                                                    <div className="flex justify-between">
                                                        {opt}
                                                        {isAnswerChecked && opt === questions[currentQuestionIndex].correctAnswer && <Icons.Check />}
                                                    </div>
                                                </button>
                                            )
                                        })}
                                    </div>
                                    <div className="mt-8">
                                        {!isAnswerChecked ? 
                                            <button onClick={check} disabled={!selectedOption} className="w-full bg-slate-900 text-white py-3 rounded-lg font-bold disabled:opacity-50">送出答案</button> :
                                            <button onClick={next} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">下一題</button>
                                        }
                                    </div>
                                </div>
                            )}

                            {appState === 'result' && (
                                <div className="p-8 text-center">
                                    <div className="text-yellow-500 flex justify-center mb-4"><Icons.Trophy /></div>
                                    <h2 className="text-2xl font-bold">測驗結束！</h2>
                                    <p className="mt-2 text-slate-600">{studentName}，你的分數是</p>
                                    <div className="text-6xl font-black text-blue-600 my-6">{score}</div>
                                    <div className="space-y-3">
                                        <button onClick={() => setAppState('leaderboard')} className="w-full bg-slate-900 text-white py-3 rounded-lg font-bold">查看排行榜</button>
                                        <button onClick={() => setAppState('login')} className="w-full border py-3 rounded-lg font-bold hover:bg-slate-50">回首頁</button>
                                    </div>
                                </div>
                            )}

                            {appState === 'leaderboard' && (
                                <div className="flex flex-col h-[500px]">
                                    <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                                        <h3 className="font-bold flex gap-2"><Icons.Trophy size="20"/> 排行榜</h3>
                                        <button onClick={() => setAppState('login')} className="text-sm text-blue-600 font-bold">關閉</button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-slate-50 text-slate-500">
                                                <tr><th className="p-4">排名</th><th className="p-4">姓名</th><th className="p-4 text-right">得分</th></tr>
                                            </thead>
                                            <tbody className="divide-y">
                                                {leaderboard.map((r, i) => (
                                                    <tr key={r.id}>
                                                        <td className="p-4 font-bold text-slate-500">#{i+1}</td>
                                                        <td className="p-4 font-medium">{r.studentName} <span className="text-xs text-slate-400 block">{r.topic}</span></td>
                                                        <td className="p-4 text-right font-bold text-blue-600">{r.score}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>