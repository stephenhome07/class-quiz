<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.2 ç§‘å­¸æ¸¬é©—ï¼šHOYU COINS ç­éš›ä¿è¡›æˆ°</title>
    
    <!-- 1. è¼‰å…¥å¿…è¦çš„å·¥å…· -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>

    <!-- å‹•ç•«æ¨£å¼ -->
    <style>
        @keyframes bounce-coin {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(251, 191, 36, 0.5); }
            50% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.8); }
        }
        @keyframes float-up {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .coin-icon {
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }
        .animate-coin-bounce {
            animation: bounce-coin 2s infinite ease-in-out;
        }
        .animate-float-up {
            animation: float-up 0.5s ease-out forwards;
        }
        .progress-bar-striped {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
        }
    </style>

    <!-- 2. è¼‰å…¥ Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit, deleteDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDLoHH3xJcg8RP135anypHnT--rY2O_8ag",
            authDomain: "test-235ba.firebaseapp.com",
            databaseURL: "https://test-235ba-default-rtdb.firebaseio.com",
            projectId: "test-235ba",
            storageBucket: "test-235ba.firebasestorage.app",
            messagingSenderId: "956103447126",
            appId: "1:956103447126:web:23fb288d99c599c053a1f7",
            measurementId: "G-73095GCTJ9"
        };

        // AI API è¨­å®š
        const AI_PROXY_URL = "https://apiproxy.k12gpt.ai/NPcj-7_"; 
        const AI_AUTH_KEY = ""; 

        let app, auth, db;
        let initError = null;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
            initError = e.message;
        }

        window.dbServices = { 
            auth, db, 
            signInAnonymously, onAuthStateChanged, 
            collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit, deleteDoc, doc, getDocs,
            AI_PROXY_URL, AI_AUTH_KEY, initError
        };
    </script>
</head>
<body class="bg-slate-50 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // --- åœ–ç¤º ---
        const Icons = {
            Atom: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500" {...props}><circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5Z"/><path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5Z"/></svg>,
            Car: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-red-500" {...props}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>,
            Box: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-amber-600" {...props}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></svg>,
            Ball: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-slate-700" {...props}><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>,
            Apple: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-red-500" {...props}><path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 6-8 6-12.22A4.91 4.91 0 0 0 17 5c-2.22 0-4 1.44-5 2-1-.56-2.78-2-5-2a4.9 4.9 0 0 0-5 4.78C2 14 5 22 8 22c1.25 0 2.5-1.06 4-1.06Z"/><path d="M10 2c1 .5 2 2 2 5"/></svg>,
            Arrow: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-blue-600" {...props}><path d="M18 8L22 12L18 16"/><path d="M2 12H22"/></svg>,
            Force: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-purple-600" {...props}><path d="m15 5 4 4-4 4"/><path d="M5 9h14"/><path d="m9 19-4-4 4-4"/><path d="M19 15H5"/></svg>,
            Skater: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-cyan-500" {...props}><path d="M15 12h-2"/><path d="M13 14v-2"/><path d="M9 4a2 2 0 1 0 2 2"/><path d="m16 20 2-2-4-5-2 2 3 5"/><path d="m2 16 6-5 2 4-2 5"/></svg>,
            Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-green-600" {...props}><polyline points="20 6 9 17 4 12"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-500" {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Bot: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-purple-600" {...props}><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>,
            Flame: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-orange-500" {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.7 3.7 4.4 4.5 4.5 3.3z"/></svg>,
            Teacher: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-slate-600" {...props}><path d="M2 20h20"/><path d="M5 20v-8a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8"/><path d="M12 14v-2"/><circle cx="12" cy="8" r="4"/></svg>,
            Chart: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
            Trash: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Bulb: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-500" {...props}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.8.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
            ChevronDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6 9 6 6 6-6"/></svg>,
            ChevronUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m18 15-6-6-6 6"/></svg>,
            Coin: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#FBBF24" stroke="#B45309" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="coin-icon" {...props}><circle cx="12" cy="12" r="9"/><path d="M10 10c0-1.333.8-2 2-2s2 .667 2 2c0 2.667-4 2.667-4 5.333 0 1.333.8 2 2 2s2-.667 2-2"/><path d="M12 18h.01"/></svg>,
            Users: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        };

        const CLASS_OPTIONS = ["S2A", "S2B", "S2C", "S2D", "S2E"];
        const POINTS_PER_COIN = 800; // 800åˆ† = 1 Coin

        // é¡Œç›®è³‡æ–™
        const QUESTIONS_DATA = [
             {
                id: 1,
                question: "ä¸€è¼›æ‰‹æ¨è»ŠåŸæœ¬è™•æ–¼éœæ­¢ç‹€æ…‹ã€‚å¦‚åœ–æ‰€ç¤ºï¼Œå®ƒå—åˆ°å‘å·¦ 10 N å’Œå‘å³ 10 N çš„åŠ›åŒæ™‚ä½œç”¨ã€‚é æ¸¬é€™è¼›æ‰‹æ¨è»Šçš„é‹å‹•ç‹€æ…‹ã€‚",
                options: ["ä¿æŒéœæ­¢ (Remain at rest)", "å‹»é€Ÿé‹å‹• (Uniform motion)", "éå‹»é€Ÿé‹å‹• (Non-uniform motion)", "ç„¡æ³•åˆ¤æ–·"],
                correctAnswer: "ä¿æŒéœæ­¢ (Remain at rest)",
                explanation: "å‘å·¦ 10N å’Œå‘å³ 10N çš„åŠ›å¤§å°ç›¸ç­‰ã€æ–¹å‘ç›¸åï¼ŒåˆåŠ›ç‚º 0ï¼ˆå¹³è¡¡åŠ›ï¼‰ã€‚æ ¹æ“šç‰›é “ç¬¬ä¸€å®šå¾‹ï¼ŒåŸæœ¬éœæ­¢çš„ç‰©é«”åœ¨å—å¹³è¡¡åŠ›ä½œç”¨ä¸‹æœƒä¿æŒéœæ­¢ã€‚",
                keywords: ["cart", "force"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘ä¸€æœ¬æ›¸éœç½®åœ¨æ¡Œé¢ä¸Šï¼Œå°æ˜å¾å·¦é‚Šæ–½åŠ› 5 Nï¼Œå°è¯å¾å³é‚Šæ–½åŠ› 5 Nã€‚è«‹å•é€™æœ¬æ›¸æœƒå¦‚ä½•é‹å‹•ï¼Ÿ",
                    options: ["å‘å³ç§»å‹•", "å‘å·¦ç§»å‹•", "ä¿æŒéœæ­¢", "è½‰å‹•"],
                    correctAnswer: "ä¿æŒéœæ­¢",
                    explanation: "å·¦å³å…©é‚Šçš„åŠ›å¤§å°ç›¸åŒä¸”æ–¹å‘ç›¸åï¼Œäº’ç›¸æŠµéŠ·ï¼ŒåˆåŠ›ç‚ºé›¶ï¼Œæ•…ç‰©é«”ä¿æŒåŸæœ¬çš„éœæ­¢ç‹€æ…‹ã€‚"
                }
            },
            {
                id: 2,
                question: "ä¸€å€‹ç®±å­æ­£åœ¨å…‰æ»‘çš„åœ°é¢ä¸Šå‘å³ç§»å‹•ã€‚æ­¤æ™‚ï¼Œå®ƒå—åˆ°å‘å·¦ 5 N å’Œå‘å³ 5 N çš„åŠ›ä½œç”¨ã€‚é æ¸¬ç®±å­æ¥ä¸‹ä¾†çš„é‹å‹•ã€‚",
                options: ["ç«‹å³åœæ­¢", "ä¿æŒéœæ­¢ (Remain at rest)", "å‹»é€Ÿé‹å‹• (Uniform motion)", "éå‹»é€Ÿé‹å‹• (Non-uniform motion)"],
                correctAnswer: "å‹»é€Ÿé‹å‹• (Uniform motion)",
                explanation: "å·¦å³å—åŠ›å„ 5Nï¼ŒåˆåŠ›ç‚º 0ã€‚é›–ç„¶æœ‰åŠ›ä½œç”¨ï¼Œä½†å› ç‚ºæ˜¯ã€Œå¹³è¡¡åŠ›ã€ï¼Œç‰©é«”æœƒç¶­æŒåŸæœ¬çš„é‹å‹•ç‹€æ…‹ã€‚æ—¢ç„¶åŸæœ¬åœ¨å‘å³å‹•ï¼Œå°±æœƒç¹¼çºŒä»¥åŒæ¨£é€Ÿåº¦å‘å³åšå‹»é€Ÿé‹å‹•ã€‚",
                keywords: ["box", "force"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘å†°çƒåœ¨å†°é¢ä¸Šä»¥ 2 m/s å‘å‰æ»‘è¡Œï¼Œå‡è¨­æ‘©æ“¦åŠ›å¿½ç•¥ä¸è¨ˆï¼Œä¸”æ²’æœ‰å…¶ä»–å¤–åŠ›ä½œç”¨ï¼Œå†°çƒæœƒï¼Ÿ",
                    options: ["è¶Šä¾†è¶Šæ…¢", "ä¿æŒ 2 m/s å‹»é€Ÿç›´ç·šé‹å‹•", "è¶Šä¾†è¶Šå¿«", "ç«‹å³åœæ­¢"],
                    correctAnswer: "ä¿æŒ 2 m/s å‹»é€Ÿç›´ç·šé‹å‹•",
                    explanation: "ä¸å—å¤–åŠ›ï¼ˆæˆ–åˆåŠ›ç‚ºé›¶ï¼‰æ™‚ï¼Œé‹å‹•ä¸­çš„ç‰©é«”æœƒç¶­æŒåŸæœ¬çš„é€Ÿåº¦å’Œæ–¹å‘ï¼Œé€™å°±æ˜¯æ…£æ€§ã€‚"
                }
            },
            {
                id: 3,
                question: "ä¸€è¼›ç©å…·è»Šéœæ­¢åœ¨åœ°é¢ä¸Šï¼Œå—åˆ°å‘å³ 20 N çš„æ¨åŠ›å’Œå‘å·¦ 5 N çš„æ‘©æ“¦åŠ›ä½œç”¨ã€‚é æ¸¬ç©å…·è»Šçš„é‹å‹•ã€‚",
                options: ["ä¿æŒéœæ­¢", "å‹»é€Ÿé‹å‹•", "éå‹»é€Ÿé‹å‹• (Non-uniform motion)", "å…ˆå‘å·¦ç§»å‹•ï¼Œå†å‘å³ç§»å‹•"],
                correctAnswer: "éå‹»é€Ÿé‹å‹• (Non-uniform motion)",
                explanation: "å‘å³ 20Nï¼Œå‘å·¦ 5Nï¼ŒåˆåŠ› = 20 - 5 = 15N å‘å³ã€‚å› ç‚ºå—åŠ›ã€Œä¸å¹³è¡¡ã€ï¼Œç‰©é«”æœƒç”¢ç”ŸåŠ é€Ÿåº¦ï¼Œå¾éœæ­¢é–‹å§‹è®Šå¿«ï¼Œé€™å±¬æ–¼éå‹»é€Ÿé‹å‹•ã€‚",
                keywords: ["car", "force"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘ä¸€è‰˜å¿«è‰‡å¼•æ“æä¾›å‘å‰ 5000 N çš„æ¨åŠ›ï¼Œæ°´é˜»åŠ›ç‚º 2000 Nã€‚è«‹å•å¿«è‰‡çš„é‹å‹•ç‹€æ…‹ï¼Ÿ",
                    options: ["éœæ­¢", "å‹»é€Ÿé‹å‹•", "å‘å‰åŠ é€Ÿ (éå‹»é€Ÿé‹å‹•)", "å‘å¾ŒåŠ é€Ÿ"],
                    correctAnswer: "å‘å‰åŠ é€Ÿ (éå‹»é€Ÿé‹å‹•)",
                    explanation: "æ¨åŠ›å¤§æ–¼é˜»åŠ›ï¼ŒåˆåŠ›ä¸ç‚ºé›¶ä¸”å‘å‰ï¼Œç‰©é«”æœƒæ²¿åˆåŠ›æ–¹å‘åŠ é€Ÿã€‚"
                }
            },
            {
                id: 4,
                question: "åœ–ç‰‡é¡¯ç¤ºä¸€å€‹è¶³çƒåœ¨è‰åœ°ä¸Šæ»¾å‹•ï¼Œæœ€çµ‚åœäº†ä¸‹ä¾†ã€‚é€™éç¨‹ä¸­ï¼Œè¶³çƒè™•æ–¼ä»€éº¼é‹å‹•ç‹€æ…‹ï¼Ÿé€™æš—ç¤ºäº†ä»€éº¼ï¼Ÿ",
                options: ["å‹»é€Ÿé‹å‹•ï¼›å—åŠ›å¹³è¡¡", "éå‹»é€Ÿé‹å‹•ï¼›å—åŠ›å¹³è¡¡", "éå‹»é€Ÿé‹å‹•ï¼›å—åŠ›ä¸å¹³è¡¡ (Unbalanced forces)", "ä¿æŒéœæ­¢ï¼›å—åŠ›ä¸å¹³è¡¡"],
                correctAnswer: "éå‹»é€Ÿé‹å‹• (Non-uniform motion)ï¼›å—åŠ›ä¸å¹³è¡¡ (Unbalanced forces)",
                explanation: "è¶³çƒå¾æ»¾å‹•åˆ°åœæ­¢ï¼Œé€Ÿåº¦åœ¨æ”¹è®Šï¼ˆæ¸›é€Ÿï¼‰ï¼Œæ‰€ä»¥æ˜¯ã€Œéå‹»é€Ÿé‹å‹•ã€ã€‚é€Ÿåº¦æ”¹è®Šå¿…å®šæ˜¯å› ç‚ºå—åˆ°ã€Œä¸å¹³è¡¡åŠ›ã€ï¼ˆæ‘©æ“¦åŠ›ï¼‰çš„ä½œç”¨ã€‚",
                keywords: ["ball", "force"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘é¨è…³è¸è»Šæ™‚åœæ­¢è¸©è¸æ¿ï¼Œè»Šå­æœƒæ…¢æ…¢åœä¸‹ä¾†ï¼Œé€™æ˜¯å› ç‚ºå—åˆ°ä»€éº¼åŠ›çš„ä½œç”¨ï¼Ÿæ­¤æ™‚åˆåŠ›æ˜¯å¦ç‚ºé›¶ï¼Ÿ",
                    options: ["é‡åŠ›ï¼›åˆåŠ›ç‚ºé›¶", "æ‘©æ“¦åŠ›ï¼›åˆåŠ›ä¸ç‚ºé›¶", "æ¨åŠ›ï¼›åˆåŠ›ç‚ºé›¶", "æ”¯æ’åŠ›ï¼›åˆåŠ›ä¸ç‚ºé›¶"],
                    correctAnswer: "æ‘©æ“¦åŠ›ï¼›åˆåŠ›ä¸ç‚ºé›¶",
                    explanation: "è»Šå­æ¸›é€Ÿæ˜¯åŠ é€Ÿåº¦é‹å‹•ï¼ˆéå‹»é€Ÿï¼‰ï¼Œä»£è¡¨åˆåŠ›ä¸ç‚ºé›¶ï¼Œä¸»è¦å—åˆ°åœ°é¢çš„æ‘©æ“¦åŠ›é˜»ç¤™é‹å‹•ã€‚"
                }
            },
            {
                id: 5,
                question: "ä¸€å€‹ç‰©é«”æ‡¸æ›åœ¨ç¹©å­ä¸Šä¿æŒéœæ­¢ï¼ˆå¦‚åœ–ï¼‰ã€‚ä¸‹åˆ—å“ªé …é—œæ–¼å—åŠ›çš„æè¿°æ˜¯æ­£ç¢ºçš„ï¼Ÿ",
                options: ["ç‰©é«”æ²’æœ‰å—åˆ°ä»»ä½•åŠ›çš„ä½œç”¨", "ä½œç”¨åœ¨ç‰©é«”ä¸Šçš„åŠ›æ˜¯ä¸å¹³è¡¡åŠ›", "ä½œç”¨åœ¨ç‰©é«”ä¸Šçš„åŠ›æ˜¯å¹³è¡¡åŠ› (Balanced forces)", "é‡åŠ›å¤§æ–¼æ‹‰åŠ›"],
                correctAnswer: "ä½œç”¨åœ¨ç‰©é«”ä¸Šçš„åŠ›æ˜¯å¹³è¡¡åŠ› (Balanced forces)",
                explanation: "ç‰©é«”éœæ­¢ä¸å‹•ï¼Œä»£è¡¨åˆåŠ›ç‚º 0ã€‚å®ƒå—åˆ°å‘ä¸‹çš„é‡åŠ›å’Œå‘ä¸Šçš„ç¹©å­æ‹‰åŠ›ï¼Œé€™å…©å€‹åŠ›å¤§å°ç›¸ç­‰ã€æ–¹å‘ç›¸åï¼Œå±¬æ–¼å¹³è¡¡åŠ›ã€‚",
                keywords: ["box", "arrow"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘é›»ç‡ˆåŠåœ¨å¤©èŠ±æ¿ä¸Šéœæ­¢ä¸å‹•ã€‚è«‹å•é›»ç‡ˆå—åˆ°çš„é‡åŠ›å’Œé›»ç·šçš„æ‹‰åŠ›é—œä¿‚ç‚ºä½•ï¼Ÿ",
                    options: ["é‡åŠ› > æ‹‰åŠ›", "æ‹‰åŠ› > é‡åŠ›", "å¤§å°ç›¸ç­‰ï¼Œæ–¹å‘ç›¸å", "å¤§å°ç›¸ç­‰ï¼Œæ–¹å‘ç›¸åŒ"],
                    correctAnswer: "å¤§å°ç›¸ç­‰ï¼Œæ–¹å‘ç›¸å",
                    explanation: "éœæ­¢ä»£è¡¨å—å¹³è¡¡åŠ›ä½œç”¨ï¼Œæ•…å‘ä¸‹çš„é‡åŠ›èˆ‡å‘ä¸Šçš„æ‹‰åŠ›å¿…é ˆæŠµéŠ·ã€‚"
                }
            },
            {
                id: 6,
                question: "å°æ˜åœ¨æºœå†°å ´ä¸Šæ»‘è¡Œã€‚å‡è¨­å†°é¢å®Œå…¨æ²’æœ‰æ‘©æ“¦åŠ›ï¼Œæ ¹æ“šç‰›é “ç¬¬ä¸€å®šå¾‹ï¼Œä»–åœ¨åœæ­¢ç”¨åŠ›å¾Œæœƒå¦‚ä½•é‹å‹•ï¼Ÿ",
                options: ["ç«‹å³åœæ­¢", "æ…¢æ…¢åœä¸‹ä¾†", "ä»¥å‹»é€Ÿé‹å‹•ç¹¼çºŒæ»‘è¡Œ (Uniform motion)", "è¶Šæ»‘è¶Šå¿«"],
                correctAnswer: "ä»¥å‹»é€Ÿé‹å‹•ç¹¼çºŒæ»‘è¡Œ (Uniform motion)",
                explanation: "å¦‚æœæ²’æœ‰æ‘©æ“¦åŠ›ï¼ˆåˆåŠ›ç‚º 0ï¼‰ï¼Œæ ¹æ“šç‰›é “ç¬¬ä¸€å®šå¾‹ï¼ˆæ…£æ€§å®šå¾‹ï¼‰ï¼Œé‹å‹•ä¸­çš„ç‰©é«”æœƒä¸€ç›´ä¿æŒåŸæœ¬çš„é€Ÿåº¦å’Œæ–¹å‘å‰é€²ï¼Œå³å‹»é€Ÿé‹å‹•ã€‚",
                keywords: ["skater"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘åœ¨å¤–å¤ªç©ºä¸­ï¼Œå¤ªç©ºèˆ¹é—œé–‰å¼•æ“å¾Œï¼Œè‹¥ä¸è€ƒæ…®é™„è¿‘æ˜Ÿçƒçš„å¼•åŠ›ï¼Œå®ƒæœƒï¼Ÿ",
                    options: ["åœä¸‹ä¾†", "ä¿æŒåŸæœ¬é€Ÿåº¦ç›´ç·šé£›è¡Œ", "é–‹å§‹è½‰åœˆ", "æ¸›é€Ÿ"],
                    correctAnswer: "ä¿æŒåŸæœ¬é€Ÿåº¦ç›´ç·šé£›è¡Œ",
                    explanation: "å¤ªç©ºä¸­å¹¾ä¹æ²’æœ‰é˜»åŠ›ï¼Œä¸€æ—¦å—åŠ›ç‚ºé›¶ï¼Œç‰©é«”å°‡ä¾æ…£æ€§ç¶­æŒå‹»é€Ÿç›´ç·šé‹å‹•ã€‚"
                }
            },
            {
                id: 7,
                question: "ä¸€è¼›æ±½è»Šåœ¨é«˜é€Ÿå…¬è·¯ä¸Šè¡Œé§›ã€‚å¼•æ“æä¾›å‘å³ 5000 N çš„å‹•åŠ›ï¼Œç©ºæ°£é˜»åŠ›å’Œæ‘©æ“¦åŠ›ç¸½å…±å‘å·¦ 5000 Nã€‚è«‹å•æ±½è»Šçš„å„€è¡¨æ¿é€Ÿåº¦é‡æœƒå¦‚ä½•è®ŠåŒ–ï¼Ÿ",
                options: ["æŒ‡é‡æœƒå‘ä¸Šè½‰ï¼ˆåŠ é€Ÿï¼‰", "æŒ‡é‡æœƒå‘ä¸‹è½‰ï¼ˆæ¸›é€Ÿï¼‰", "æŒ‡é‡ä¿æŒä¸è®Šï¼ˆå‹»é€Ÿé‹å‹•ï¼‰", "æŒ‡é‡æœƒæ­¸é›¶ï¼ˆåœæ­¢ï¼‰"],
                correctAnswer: "æŒ‡é‡ä¿æŒä¸è®Šï¼ˆå‹»é€Ÿé‹å‹•ï¼‰",
                explanation: "å‹•åŠ› 5000N èˆ‡é˜»åŠ› 5000N æŠµéŠ·ï¼ŒåˆåŠ›ç‚º 0ï¼ˆå¹³è¡¡åŠ›ï¼‰ã€‚æ±½è»Šä¸æœƒåŠ é€Ÿä¹Ÿä¸æœƒæ¸›é€Ÿï¼Œè€Œæ˜¯ç¶­æŒç›®å‰çš„æ™‚é€Ÿè¡Œé§›ï¼Œæ‰€ä»¥é€Ÿåº¦é‡ä¸å‹•ã€‚",
                keywords: ["car", "force"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘è·³å‚˜å“¡æ‰“é–‹é™è½å‚˜å¾Œï¼Œç•¶ç©ºæ°£é˜»åŠ›ç­‰æ–¼ä»–çš„é‡é‡æ™‚ï¼Œä»–æœƒå‘ˆç¾ä»€éº¼ç‹€æ…‹ï¼Ÿ",
                    options: ["éœæ­¢åœ¨ç©ºä¸­", "å‘ä¸Šé£›", "ä»¥çµ‚ç«¯é€Ÿåº¦åšå‹»é€Ÿä¸‹é™", "ç¹¼çºŒåŠ é€Ÿä¸‹é™"],
                    correctAnswer: "ä»¥çµ‚ç«¯é€Ÿåº¦åšå‹»é€Ÿä¸‹é™",
                    explanation: "å‘ä¸‹é‡åŠ›ç­‰æ–¼å‘ä¸Šé˜»åŠ›æ™‚ï¼ŒåˆåŠ›ç‚ºé›¶ï¼ŒåŠ é€Ÿåº¦ç‚ºé›¶ï¼Œæ•…ç¶­æŒå›ºå®šé€Ÿåº¦ï¼ˆçµ‚ç«¯é€Ÿåº¦ï¼‰ä¸‹é™ã€‚"
                }
            },
            {
                id: 8,
                question: "(æƒ…å¢ƒé¡Œ) åƒè€ƒèª²å ‚ä¾‹å­ï¼šæ˜Ÿå¦‚å‘å³æ¨è»Šï¼Œæœ—è»’å‘å·¦æ¨è»Šã€‚å¦‚æœæ˜Ÿå¦‚çš„åŠ›æ¯”æœ—è»’çš„å¤§ï¼Œæ‰‹æ¨è»Šæœƒå‘ˆç¾ä»€éº¼é‹å‹•ç‹€æ…‹ï¼Ÿ",
                options: ["ä¿æŒéœæ­¢", "å‹»é€Ÿé‹å‹•", "éå‹»é€Ÿé‹å‹• (å‘å³åŠ é€Ÿ)", "éå‹»é€Ÿé‹å‹• (å‘å·¦åŠ é€Ÿ)"],
                correctAnswer: "éå‹»é€Ÿé‹å‹• (å‘å³åŠ é€Ÿ)",
                explanation: "æ˜Ÿå¦‚ï¼ˆå‘å³ï¼‰çš„åŠ› > æœ—è»’ï¼ˆå‘å·¦ï¼‰çš„åŠ›ï¼ŒåˆåŠ›ä¸ç‚º 0 ä¸”æ–¹å‘å‘å³ã€‚å—ä¸å¹³è¡¡åŠ›ä½œç”¨ï¼Œç‰©é«”æœƒå‘åˆåŠ›æ–¹å‘åŠ é€Ÿï¼Œå³å‘å³åšéå‹»é€Ÿé‹å‹•ã€‚",
                keywords: ["cart", "force"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘æ‹”æ²³æ¯”è³½ä¸­ï¼Œç”²éšŠæ‹‰åŠ›å¤§æ–¼ä¹™éšŠæ‹‰åŠ›ã€‚ç¹©å­ä¸­å¿ƒé»æœƒï¼Ÿ",
                    options: ["éœæ­¢", "å‘ç”²éšŠæ–¹å‘åŠ é€Ÿç§»å‹•", "å‘ä¹™éšŠæ–¹å‘åŠ é€Ÿç§»å‹•", "å‹»é€Ÿç§»å‹•"],
                    correctAnswer: "å‘ç”²éšŠæ–¹å‘åŠ é€Ÿç§»å‹•",
                    explanation: "åˆåŠ›æ–¹å‘æŒ‡å‘åŠ›å¤§çš„ä¸€æ–¹ï¼ˆç”²éšŠï¼‰ï¼Œæ•…ç‰©é«”æœƒå‘è©²æ–¹å‘ç”¢ç”ŸåŠ é€Ÿåº¦ã€‚"
                }
            },
            {
                id: 9,
                question: "ä¸€å€‹è˜‹æœæ”¾åœ¨æ¡Œé¢ä¸Šã€‚ä¸‹åœ–æ˜¯å®ƒçš„å­¤ç«‹ç‰©é«”åœ– (Free-body diagram)ã€‚è«‹å•åœ–ä¸­å‘ä¸Šçš„ç®­é ­ (A) å’Œå‘ä¸‹çš„ç®­é ­ (B) åˆ†åˆ¥ä»£è¡¨ä»€éº¼åŠ›ï¼Ÿ",
                options: ["Aæ˜¯é‡åŠ›ï¼ŒBæ˜¯æ”¯æ’åŠ›", "Aæ˜¯æ”¯æ’åŠ› (Supporting force)ï¼ŒBæ˜¯é‡åŠ› (Gravity)", "Aæ˜¯æ‘©æ“¦åŠ›ï¼ŒBæ˜¯é‡åŠ›", "Aæ˜¯æ”¯æ’åŠ›ï¼ŒBæ˜¯æ‘©æ“¦åŠ›"],
                correctAnswer: "Aæ˜¯æ”¯æ’åŠ› (Supporting force)ï¼ŒBæ˜¯é‡åŠ› (Gravity)",
                explanation: "è˜‹æœå—åœ°å¿ƒå¼•åŠ›ï¼ˆé‡åŠ›ï¼‰å‘ä¸‹ï¼Œæ‰€ä»¥ B æ˜¯é‡åŠ›ã€‚æ¡Œå­çµ¦è˜‹æœä¸€å€‹å‘ä¸Šçš„æ”¯æ’åŠ›ï¼ˆæˆ–ç¨±æ­£å‘åŠ›ï¼‰æŠµæŠ—é‡åŠ›ï¼Œæ‰€ä»¥ A æ˜¯æ”¯æ’åŠ›ã€‚",
                keywords: ["apple", "arrow"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘ä¸€å€‹äººç«™åœ¨åœ°é¢ä¸Šï¼Œé—œæ–¼ä»–å—åŠ›çš„æè¿°ï¼Œå“ªçµ„æ˜¯ä½œç”¨åŠ›èˆ‡åä½œç”¨åŠ›ï¼Ÿ",
                    options: ["äººçš„é‡åŠ›èˆ‡åœ°é¢çµ¦äººçš„æ”¯æ’åŠ›", "è…³è¸©åœ°çš„åŠ›èˆ‡åœ°é¢æ¨è…³çš„åŠ›", "äººçš„é‡åŠ›èˆ‡äººå°åœ°çƒçš„å¼•åŠ›", "ä»¥ä¸Šçš†é"],
                    correctAnswer: "äººçš„é‡åŠ›èˆ‡äººå°åœ°çƒçš„å¼•åŠ›",
                    explanation: "é€™æ˜¯è§€å¿µå»¶ä¼¸é¡Œã€‚åœ¨æœ¬é¡Œæƒ…å¢ƒåœ–ä¸­ï¼Œå‘ä¸Šç®­é ­æ˜¯åœ°é¢çµ¦äººçš„æ”¯æ’åŠ›ï¼Œå‘ä¸‹æ˜¯äººçš„é‡åŠ›ï¼Œé€™å…©è€…æ˜¯å¹³è¡¡åŠ›ã€‚"
                }
            },
            {
                id: 10,
                question: "åœ¨ç¹ªç•«å­¤ç«‹ç‰©é«”åœ– (Free-body diagram) æ™‚ï¼Œæˆ‘å€‘ç”¨ç®­é ­çš„é•·åº¦ä¾†ä»£è¡¨ä»€éº¼ï¼Ÿ",
                options: ["ç‰©é«”ç§»å‹•çš„é€Ÿåº¦", "åŠ›çš„å¤§å° (Magnitude of force)", "ç‰©é«”çš„é‡é‡", "åŠ›çš„ç¨®é¡"],
                correctAnswer: "åŠ›çš„å¤§å° (Magnitude of force)",
                explanation: "åœ¨åŠ›åœ–ä¸­ï¼Œç®­é ­çš„æ–¹å‘ä»£è¡¨åŠ›çš„æ–¹å‘ï¼Œè€Œç®­é ­çš„é•·åº¦å‰‡ä»£è¡¨åŠ›çš„å¤§å°ï¼ˆMagnitudeï¼‰ã€‚åŠ›è¶Šå¤§ï¼Œç®­é ­ç•«å¾—è¶Šé•·ã€‚",
                keywords: ["arrow", "force"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘åœ¨åŠ›åœ–ä¸­ï¼Œè‹¥ç•«äº†å…©å€‹ç®­é ­ï¼Œç®­é ­ A æ¯”ç®­é ­ B é•·å…©å€ï¼Œé€™ä»£è¡¨ï¼Ÿ",
                    options: ["åŠ› A çš„ä½œç”¨æ™‚é–“è¼ƒé•·", "åŠ› A çš„å¤§å°æ˜¯åŠ› B çš„å…©å€", "åŠ› A çš„é€Ÿåº¦è¼ƒå¿«", "ç‰©é«” A æ¯”è¼ƒé‡"],
                    correctAnswer: "åŠ› A çš„å¤§å°æ˜¯åŠ› B çš„å…©å€",
                    explanation: "ç®­é ­é•·åº¦èˆ‡åŠ›çš„å¤§å°æˆæ­£æ¯”ã€‚"
                }
            }
        ];

        // æ´—ç‰Œå‡½æ•¸
        function shuffle(array) {
            let currentIndex = array.length,  randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function SmartImage({ question }) {
            let StaticIcon = Icons.Atom;
            const text = (question.question + " " + (question.keywords?.join(" ") || "")).toLowerCase();
            
            if (text.includes("è»Š") || text.includes("car") || text.includes("cart")) StaticIcon = Icons.Car;
            else if (text.includes("çƒ") || text.includes("ball") || text.includes("soccer")) StaticIcon = Icons.Ball;
            else if (text.includes("ç®±") || text.includes("box")) StaticIcon = Icons.Box;
            else if (text.includes("æœ") || text.includes("apple")) StaticIcon = Icons.Apple;
            else if (text.includes("æºœå†°") || text.includes("skater")) StaticIcon = Icons.Skater;
            else if (text.includes("åœ–") || text.includes("diagram") || text.includes("arrow")) StaticIcon = Icons.Arrow;
            else if (text.includes("åŠ›") || text.includes("force")) StaticIcon = Icons.Force;

            return (
                <div className="w-full flex justify-center mb-6">
                    <div className="p-6 bg-blue-50 rounded-full ring-4 ring-blue-100 shadow-sm">
                        <StaticIcon />
                    </div>
                </div>
            );
        }

        async function callDeepSeek(systemPrompt, userPrompt, { AI_PROXY_URL, AI_AUTH_KEY }) {
            if (!AI_PROXY_URL) throw new Error("è«‹å…ˆè¨­å®š API URL");
            const headers = { 'Content-Type': 'application/json' };
            if (AI_AUTH_KEY) { headers['Authorization'] = `Bearer ${AI_AUTH_KEY}`; }
            const payload = { model: "deepseek-chat", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }], stream: false };
            const doFetch = async (url) => {
                const response = await fetch(url, { method: 'POST', headers: headers, body: JSON.stringify(payload) });
                if (!response.ok) { const errText = await response.text().catch(() => "No error text"); throw new Error(`API Error ${response.status}: ${errText}`); }
                return await response.json();
            };
            try {
                console.log("Attempting direct connection...");
                const data = await doFetch(AI_PROXY_URL);
                return data.choices?.[0]?.message?.content || "";
            } catch (e1) {
                console.warn("Direct connection failed, trying Proxy 1...", e1);
                try {
                    const proxyUrl1 = "https://corsproxy.io/?" + encodeURIComponent(AI_PROXY_URL);
                    const data = await doFetch(proxyUrl1);
                    return data.choices?.[0]?.message?.content || "";
                } catch (e2) {
                    console.warn("Proxy 1 failed, trying Proxy 2...", e2);
                    try {
                        const proxyUrl2 = "https://thingproxy.freeboard.io/fetch/" + AI_PROXY_URL;
                        const data = await doFetch(proxyUrl2);
                        return data.choices?.[0]?.message?.content || "";
                    } catch (e3) {
                        if (e1.message.includes("Failed to fetch") || e1.name === 'TypeError') { throw new Error("CORS_BLOCK"); }
                        throw e3;
                    }
                }
            }
        }

        function ClassCoinWidget({ className, totalScore }) {
            const coins = Math.floor(totalScore / POINTS_PER_COIN);
            const progress = (totalScore % POINTS_PER_COIN) / POINTS_PER_COIN * 100;
            
            return (
                <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 shadow-sm relative overflow-hidden">
                    <div className="flex justify-between items-center mb-2">
                        <div className="flex items-center gap-2">
                            <span className="font-bold text-amber-800 text-lg">{className || "å…¨ç­"} é‡‘åº«</span>
                            <span className="text-xs text-amber-600 bg-amber-100 px-2 py-0.5 rounded-full">æ¯ {POINTS_PER_COIN} åˆ† +1</span>
                        </div>
                        <div className="flex items-center gap-1">
                            <div className="text-2xl font-black text-amber-500 drop-shadow-sm flex items-center gap-1">
                                <span className={coins > 0 ? "animate-coin-bounce inline-block" : ""}>ğŸ’°</span> x {coins}
                            </div>
                        </div>
                    </div>
                    
                    <div className="relative pt-1">
                        <div className="flex mb-1 items-center justify-between">
                            <div className="text-xs font-semibold text-amber-600">
                                ä¸‹ä¸€æšé‡‘å¹£é€²åº¦: {Math.round(progress)}%
                            </div>
                            <div className="text-xs font-bold text-amber-600">
                                {totalScore % POINTS_PER_COIN} / {POINTS_PER_COIN}
                            </div>
                        </div>
                        <div className="overflow-hidden h-3 mb-1 text-xs flex rounded-full bg-amber-200">
                            <div style={{ width: `${progress}%` }} className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-amber-500 progress-bar-striped animate-pulse"></div>
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [studentName, setStudentName] = useState("");
            const [studentClass, setStudentClass] = useState("S2A"); 
            const [appState, setAppState] = useState('login'); 
            const [score, setScore] = useState(0);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [isAnswerChecked, setIsAnswerChecked] = useState(false);
            const [leaderboard, setLeaderboard] = useState([]);
            const [loading, setLoading] = useState(true);
            const [errorMsg, setErrorMsg] = useState("");
            
            // æ•™å¸«ç«¯ç‹€æ…‹
            const [teacherClassFilter, setTeacherClassFilter] = useState("ALL"); 
            const [isDeleting, setIsDeleting] = useState(false);
            const [showTeacherSuggestions, setShowTeacherSuggestions] = useState(false); 
            const [passThreshold, setPassThreshold] = useState(60); // æ–°å¢ï¼šåˆæ ¼åˆ†æ•¸ç·š

            // ç‹€æ…‹ç®¡ç†
            const [practiceMode, setPracticeMode] = useState(false); 
            const [challengeMode, setChallengeMode] = useState(false); 
            // æ–°å¢ï¼šå­˜å„²éš¨æ©ŸåŒ–å¾Œçš„é¡Œç›®åˆ—è¡¨
            const [quizQuestions, setQuizQuestions] = useState([]);
            const [currentQuestionData, setCurrentQuestionData] = useState(QUESTIONS_DATA[0]);
            const [showHint, setShowHint] = useState(false); 
            const [isGenerating, setIsGenerating] = useState(false); 
            const [isAnalyzing, setIsAnalyzing] = useState(false); 
            const [aiAnalysisResult, setAiAnalysisResult] = useState(""); 
            const [teacherAnalysis, setTeacherAnalysis] = useState({ main: "", suggestions: "" });
            const wrongAnswers = useRef([]); 
            const [leaderboardTab, setLeaderboardTab] = useState("student"); 

            const { auth, db, signInAnonymously, onAuthStateChanged, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit, deleteDoc, doc, getDocs, AI_PROXY_URL, AI_AUTH_KEY, initError } = window.dbServices;

            useEffect(() => {
                if (initError) { setLoading(false); return; }
                if (auth) {
                    signInAnonymously(auth).catch(e => {
                        // Firestore might work in offline mode, so auth error is not always blocking
                        console.warn("Auth failed, but Firestore might work offline", e);
                        if(e.code === 'auth/configuration-not-found' || e.code === 'auth/admin-restricted-operation') {
                            setErrorMsg("âš ï¸ è«‹è‡³ Firebase Console é–‹å•Ÿã€ŒåŒ¿åç™»å…¥ã€æ¬Šé™");
                        } else {
                            // Don't block UI for network errors, just log
                            console.warn("Network error during auth", e);
                        }
                        setLoading(false);
                    });
                    return onAuthStateChanged(auth, u => {
                        setUser(u);
                        setLoading(false);
                    });
                } else {
                    setLoading(false);
                }
            }, []);

            useEffect(() => {
                if (!user && !db) return; 
                // Even if user is null, we might try to read if rules allow. But best practice is usually with user.
                // If auth failed due to network, user is null. 
                // We can try to read anyway, or just wait. 
                // For this app, let's try reading if db exists.
                if (!db) return;

                const q = query(collection(db, 'class_scores')); 
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    records.sort((a, b) => b.score - a.score);
                    setLeaderboard(records);
                }, (error) => {
                     console.warn("Firestore snapshot error (likely offline):", error);
                     // Do not set errorMsg to block UI, just let it be empty or show cached data if available
                });
                return () => unsubscribe();
            }, [user]);

            const currentClassTotalScore = useMemo(() => {
                if (!studentClass) return 0;
                return leaderboard
                    .filter(r => r.classId === studentClass)
                    .reduce((acc, curr) => acc + (curr.score || 0), 0);
            }, [leaderboard, studentClass]);

            // --- é‚è¼¯ ---

            const startQuiz = () => {
                if (!studentName) return alert("è«‹è¼¸å…¥å§“å");
                setScore(0);
                setCurrentQuestionIndex(0);
                setPracticeMode(false);
                setChallengeMode(false);
                
                // 1. æ·±åº¦è¤‡è£½é¡Œç›®
                let randomizedQuestions = JSON.parse(JSON.stringify(QUESTIONS_DATA));
                // 2. éš¨æ©Ÿæ’åºé¡Œç›®
                randomizedQuestions = shuffle(randomizedQuestions);
                // 3. éš¨æ©Ÿæ’åºæ¯ä¸€é¡Œçš„é¸é …
                randomizedQuestions.forEach(q => {
                    q.options = shuffle(q.options);
                });

                setQuizQuestions(randomizedQuestions);
                setCurrentQuestionData(randomizedQuestions[0]);
                
                wrongAnswers.current = []; 
                setAiAnalysisResult("");
                setAppState('quiz');
                setIsAnswerChecked(false);
                setSelectedOption(null);
                setShowHint(false);
            };

            const handleAnswer = (option) => {
                if(isAnswerChecked) return;
                setSelectedOption(option);
            }

            const check = () => {
                setIsAnswerChecked(true);
                const isCorrect = selectedOption === currentQuestionData.correctAnswer;
                
                if (isCorrect) {
                    if (!practiceMode && !challengeMode) setScore(s => s + 10); 
                } else {
                    const isRecorded = wrongAnswers.current.find(w => w.id === currentQuestionData.id);
                    if (!isRecorded && !challengeMode && !practiceMode) {
                        wrongAnswers.current.push({
                            ...currentQuestionData,
                            studentAnswer: selectedOption
                        });
                    }
                }
            };

            const startPrebuiltPractice = () => {
                // å–å¾—é¡ä¼¼é¡Œä¸¦éš¨æ©ŸåŒ–å…¶é¸é …
                const similarQ = JSON.parse(JSON.stringify(currentQuestionData.similar));
                if (similarQ) {
                    similarQ.options = shuffle(similarQ.options);
                    
                    setPracticeMode(true);
                    setSelectedOption(null);
                    setIsAnswerChecked(false);
                    setShowHint(false);
                    setCurrentQuestionData({
                        ...similarQ,
                        id: `p-${currentQuestionData.id}`,
                        isPractice: true
                    });
                }
            };

            const generateAIPractice = async () => {
                if (!AI_PROXY_URL) { alert("è«‹å…ˆè¨­å®š AI URL"); return; }
                setIsGenerating(true);
                try {
                    const systemPrompt = `ä½ æ˜¯ä¸€ä½ç‰©ç†è€å¸«ã€‚è«‹æ ¹æ“šç”¨æˆ¶æä¾›çš„é¡Œç›®ï¼Œç”Ÿæˆä¸€é¡Œã€Œè§€å¿µç›¸ä¼¼ä½†æ›´åŠ æ·ºé¡¯æ˜“æ‡‚ (Easier/Simpler Level)ã€çš„å–®é¸é¡Œï¼Œé©åˆè£œæ•‘æ•™å­¸ã€‚
                    æ ¼å¼å¿…é ˆæ˜¯ç´” JSONï¼ŒåŒ…å«ï¼š
                    - question (å­—ä¸²)
                    - options (å­—ä¸²é™£åˆ—, ä¸å« A. B. C. D. ç·¨è™Ÿ)
                    - correctAnswer (å­—ä¸², å°æ‡‰ options å…¶ä¸­çš„ä¸€é …å…§å®¹)
                    - explanation (å­—ä¸²)
                    - hint (å­—ä¸², çµ¦å­¸ç”Ÿçš„è§£é¡Œæç¤ºï¼Œå¼•å°æ€è€ƒ)
                    
                    åš´æ ¼éµå®ˆ JSON æ ¼å¼ï¼Œä¸è¦ Markdownã€‚`;
                    
                    const userPrompt = `åŸé¡Œç›®ï¼š${currentQuestionData.question}ã€‚æ­£ç¢ºç­”æ¡ˆï¼š${currentQuestionData.correctAnswer}ã€‚è«‹ç”Ÿæˆä¸€é¡Œæ›´æ·ºçš„ç·´ç¿’é¡Œï¼Œé™„å¸¶æç¤ºã€‚`;
                    
                    const result = await callDeepSeek(systemPrompt, userPrompt, { AI_PROXY_URL, AI_AUTH_KEY });
                    const cleanJson = result.replace(/```json/g, '').replace(/```/g, '').trim();
                    const newQ = JSON.parse(cleanJson);

                    // éš¨æ©ŸåŒ– AI ç”Ÿæˆçš„é¸é …
                    if(newQ.options) {
                        newQ.options = shuffle(newQ.options);
                    }

                    setPracticeMode(true);
                    setSelectedOption(null);
                    setIsAnswerChecked(false);
                    setShowHint(false);
                    setCurrentQuestionData({
                        ...newQ,
                        id: `ai-${Date.now()}`,
                        isPractice: true,
                        isAI: true
                    });

                } catch (e) {
                    console.error(e);
                    if (e.message === "CORS_BLOCK") {
                        alert("âš ï¸ AI é€£ç·šå—é™ (CORS)ï¼Œåˆ‡æ›è‡³é è¨­ç·´ç¿’ã€‚");
                        startPrebuiltPractice();
                    } else {
                        alert("AI ç”Ÿæˆå¤±æ•—ï¼Œåˆ‡æ›è‡³é è¨­ç·´ç¿’ã€‚");
                        startPrebuiltPractice();
                    }
                }
                setIsGenerating(false);
            };

            const startChallenge = async () => {
                setIsGenerating(true);
                try {
                    const systemPrompt = `ä½ æ˜¯ä¸€ä½åš´æ ¼çš„ç‰©ç†æ•™ç·´ã€‚è«‹ç”Ÿæˆ 2 é¡Œé—œæ–¼ã€Œå¹³è¡¡åŠ›èˆ‡ç‰›é “å®šå¾‹ã€çš„é«˜é›£åº¦ã€æŒ‘æˆ°æ€§å–®é¸é¡Œï¼Œé©åˆç¨‹åº¦å¥½çš„åœ‹ä¸­ç”Ÿã€‚
                    æ ¼å¼å¿…é ˆæ˜¯ç´” JSON Arrayï¼Œæ¯å€‹ç‰©ä»¶åŒ…å« question, options (Array, ä¸å« A. B. ç·¨è™Ÿ), correctAnswer, explanationã€‚`;
                    
                    const result = await callDeepSeek(systemPrompt, "è«‹çµ¦æˆ‘ 2 é¡ŒæŒ‘æˆ°é¡Œã€‚", { AI_PROXY_URL, AI_AUTH_KEY });
                    const cleanJson = result.replace(/```json/g, '').replace(/```/g, '').trim();
                    const challengeQs = JSON.parse(cleanJson);

                    if (Array.isArray(challengeQs) && challengeQs.length > 0) {
                        // éš¨æ©ŸåŒ–æŒ‘æˆ°é¡Œçš„é¸é …
                        challengeQs.forEach(q => {
                            if(q.options) q.options = shuffle(q.options);
                        });

                        setChallengeMode(true);
                        setPracticeMode(false); 
                        setCurrentQuestionIndex(0);
                        setShowHint(false);
                        setCurrentQuestionData({ ...challengeQs[0], isChallenge: true, totalChallenge: challengeQs.length, challengeList: challengeQs });
                        setSelectedOption(null);
                        setIsAnswerChecked(false);
                    }
                } catch (e) {
                    console.error(e);
                    if (e.message === "CORS_BLOCK") {
                        alert("âš ï¸ ç„¡æ³•é–‹å•ŸæŒ‘æˆ°æ¨¡å¼ (CORS é™åˆ¶)ã€‚");
                    } else {
                        alert("æŒ‘æˆ°é¡Œç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                    }
                }
                setIsGenerating(false);
            };

            const analyzeWeakness = async () => {
                if (wrongAnswers.current.length === 0) {
                    setAiAnalysisResult("æ­å–œï¼ä½ å…¨å°äº†ï¼Œæ²’æœ‰é¡¯è‘—çš„å¼±é»ã€‚ä¿æŒä¸‹å»ï¼");
                    return;
                }

                setIsAnalyzing(true);
                try {
                    const wrongSummary = wrongAnswers.current.map(w => `é¡Œç›®ï¼š${w.question} (é—œéµå­—:${w.keywords})`).join("\n");
                    const systemPrompt = `ä½ æ˜¯ä¸€ä½å­¸ç¿’åˆ†æå¸«ã€‚è«‹æ ¹æ“šå­¸ç”Ÿç­”éŒ¯çš„é¡Œç›®ï¼Œç”¨ç¹é«”ä¸­æ–‡ç¸½çµä»–çš„å¼±é»ï¼Œä¸¦çµ¦å‡ºä¸€å¥å…·é«”çš„å­¸ç¿’å»ºè­°ã€‚å­—æ•¸ 100 å­—ä»¥å…§ã€‚`;
                    const result = await callDeepSeek(systemPrompt, wrongSummary, { AI_PROXY_URL, AI_AUTH_KEY });
                    setAiAnalysisResult(result);
                } catch (e) {
                    console.error(e);
                    if (e.message === "CORS_BLOCK") {
                        setAiAnalysisResult("âš ï¸ åˆ†æå¤±æ•—ï¼šç€è¦½å™¨é€£ç·šè¢«é˜»æ“‹ (CORS)ã€‚");
                    } else {
                        setAiAnalysisResult("åˆ†æé€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                    }
                }
                setIsAnalyzing(false);
            };

            const analyzeClassWeakness = async () => {
                let targetStudents = leaderboard;
                if (teacherClassFilter !== "ALL") {
                    targetStudents = leaderboard.filter(s => s.classId === teacherClassFilter);
                }

                if (targetStudents.length === 0) {
                    setTeacherAnalysis({ main: `ç›®å‰ ${teacherClassFilter === "ALL" ? "å…¨æ ¡" : teacherClassFilter} æ²’æœ‰è¶³å¤ çš„æ•¸æ“šå¯ä¾›åˆ†æã€‚`, suggestions: "" });
                    return;
                }
                
                setIsAnalyzing(true);
                setShowTeacherSuggestions(false); 
                try {
                    let allWrongQs = [];
                    targetStudents.forEach(student => {
                        if (student.wrongAnswers && Array.isArray(student.wrongAnswers)) {
                            student.wrongAnswers.forEach(q => {
                                allWrongQs.push(`é¡Œç›®ID:${q.id} é—œéµå­—:${q.keywords}`);
                            });
                        }
                    });

                    if (allWrongQs.length === 0) {
                        setTeacherAnalysis({ main: "æ­å–œï¼é¸å®šç¯„åœå…§çš„å­¸ç”Ÿæ²’æœ‰éŒ¯é¡Œç´€éŒ„ã€‚", suggestions: "" });
                        setIsAnalyzing(false);
                        return;
                    }

                    const sampleData = allWrongQs.slice(0, 50).join("\n");
                    const scopeText = teacherClassFilter === "ALL" ? "å…¨ç´š S.2" : `${teacherClassFilter} ç­`;

                    const systemPrompt = `ä½ æ˜¯ä¸€ä½è³‡æ·±ç‰©ç†æ•™å¸«ã€‚é€™æ˜¯ ${scopeText} å­¸ç”Ÿçš„éŒ¯é¡Œç´€éŒ„æ‘˜è¦ã€‚è«‹é€²è¡Œå…©éƒ¨åˆ†åˆ†æï¼Œä¸¦ç”¨ "|||SEPARATOR|||" åˆ†éš”é€™å…©éƒ¨åˆ†ã€‚
                    ç¬¬ä¸€éƒ¨åˆ†ï¼ˆç›´æ¥é¡¯ç¤ºçµ¦è€å¸«ï¼‰ï¼š
                    1. âŒ å­¸ç”Ÿå¸¸è¦‹éŒ¯èª¤ï¼šå…·é«”æŒ‡å‡ºå­¸ç”Ÿæœ€å¸¸éŒ¯çš„æ¦‚å¿µã€‚
                    2. âœ… è§€å¿µæŒ‡æ­£ç¯„ä¾‹ï¼šèˆ‰ä¸€å€‹å…·é«”çš„ç‰©ç†ä¾‹å­ä¾†èªªæ˜æ­£ç¢ºè§€å¿µï¼Œç³¾æ­£ä¸Šè¿°éŒ¯èª¤ã€‚
                    è«‹ä¿æŒç°¡æ½”ã€æ¢ç†åˆ†æ˜ï¼Œé©åˆå¿«é€Ÿé–±è®€ã€‚
                    |||SEPARATOR|||
                    ç¬¬äºŒéƒ¨åˆ†ï¼ˆæ•™å­¸åŠ å¼·å»ºè­°ï¼‰ï¼š
                    é‡å°ä¸Šè¿°éŒ¯èª¤ï¼Œçµ¦è€å¸«çš„å…·é«”æ•™å­¸æ´»å‹•æˆ–è§£èªªç­–ç•¥å»ºè­°ã€‚`;
                    
                    const rawResult = await callDeepSeek(systemPrompt, sampleData, { AI_PROXY_URL, AI_AUTH_KEY });
                    
                    const parts = rawResult.split("|||SEPARATOR|||");
                    if (parts.length >= 2) {
                        setTeacherAnalysis({ main: parts[0].trim(), suggestions: parts[1].trim() });
                    } else {
                        setTeacherAnalysis({ main: rawResult, suggestions: "" });
                    }

                } catch (e) {
                    console.error(e);
                    if (e.message === "CORS_BLOCK") {
                        setTeacherAnalysis({ main: "âš ï¸ åˆ†æå¤±æ•—ï¼šAPI é€£ç·šè¢«ç€è¦½å™¨é˜»æ“‹ (CORS)ã€‚", suggestions: "" });
                    } else {
                        setTeacherAnalysis({ main: "åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", suggestions: "" });
                    }
                }
                setIsAnalyzing(false);
            }

            const resetDatabase = async () => {
                if (!window.confirm("âš ï¸ å±éšªæ“ä½œï¼\n\nç¢ºå®šè¦åˆªé™¤ã€Œæ‰€æœ‰ã€å­¸ç”Ÿçš„æˆç¸¾ç´€éŒ„å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼")) {
                    return;
                }
                const confirm2 = prompt("è«‹è¼¸å…¥ 'DELETE' ä»¥ç¢ºèªåˆªé™¤ï¼š");
                if (confirm2 !== "DELETE") return;

                setIsDeleting(true);
                try {
                    const querySnapshot = await getDocs(collection(db, "class_scores"));
                    const deletePromises = querySnapshot.docs.map((d) => deleteDoc(doc(db, "class_scores", d.id)));
                    await Promise.all(deletePromises);
                    alert("âœ… è³‡æ–™åº«å·²æ¸…ç©ºã€‚");
                    setLeaderboard([]); 
                } catch (e) {
                    console.error(e);
                    alert("åˆªé™¤å¤±æ•—ï¼š" + e.message);
                }
                setIsDeleting(false);
            };

            const next = () => {
                setShowHint(false);
                if (currentQuestionData.isChallenge) {
                    const nextIdx = currentQuestionIndex + 1;
                    if (nextIdx < currentQuestionData.challengeList.length) {
                        setCurrentQuestionIndex(nextIdx);
                        setCurrentQuestionData({ 
                            ...currentQuestionData.challengeList[nextIdx], 
                            isChallenge: true, 
                            totalChallenge: currentQuestionData.challengeList.length, 
                            challengeList: currentQuestionData.challengeList 
                        });
                        setIsAnswerChecked(false);
                        setSelectedOption(null);
                    } else {
                        setAppState('result');
                    }
                    return;
                }

                if (practiceMode) {
                    setPracticeMode(false);
                }
                
                let nextIdx = practiceMode ? currentQuestionIndex + 1 : currentQuestionIndex + 1;
                
                if (nextIdx < quizQuestions.length) {
                    setCurrentQuestionIndex(nextIdx);
                    setCurrentQuestionData(quizQuestions[nextIdx]);
                    setIsAnswerChecked(false);
                    setSelectedOption(null);
                } else {
                    finish();
                }
            };

            const finish = async () => {
                setAppState('result');
                // Only attempt to save score if user is authenticated (even anonymously)
                // Note: if offline, Firebase SDK will queue this write locally
                if (user && db) {
                    try {
                        await addDoc(collection(db, 'class_scores'), {
                            studentName,
                            classId: studentClass, 
                            score,
                            timestamp: serverTimestamp(),
                            topic: 'å¹³è¡¡åŠ›æ¸¬é©—',
                            wrongAnswers: wrongAnswers.current 
                        });
                    } catch (e) {
                        console.error("ä¸Šå‚³åˆ†æ•¸å¤±æ•— (å¯èƒ½é›¢ç·š)", e);
                    }
                }
            };

            const getClassStats = () => {
                const classStats = {};
                CLASS_OPTIONS.forEach(c => { classStats[c] = { total: 0, count: 0 }; });
                
                leaderboard.forEach(r => {
                    if (r.classId && classStats[r.classId]) {
                        classStats[r.classId].total += r.score;
                        classStats[r.classId].count += 1;
                    }
                });

                return CLASS_OPTIONS.map(c => ({
                    classId: c,
                    total: classStats[c].total,
                    avg: classStats[c].count > 0 ? Math.round(classStats[c].total / classStats[c].count) : 0,
                    count: classStats[c].count,
                    coins: Math.floor(classStats[c].total / POINTS_PER_COIN),
                    progress: (classStats[c].total % POINTS_PER_COIN) / POINTS_PER_COIN * 100
                })).sort((a, b) => b.total - a.total);
            };

            if (loading) return <div className="flex h-screen items-center justify-center text-blue-600 font-bold">è¼‰å…¥ä¸­...</div>;

            return (
                <div className="min-h-screen bg-slate-100 font-sans text-slate-800 flex justify-center p-4">
                    <div className="w-full max-w-2xl">
                        
                        <header className="mb-6 text-center mt-4">
                            <h1 className="text-2xl font-bold text-slate-900 flex items-center justify-center gap-2">
                                <span className="text-3xl">ğŸ›¡ï¸</span> S.2 ç­éš›ä¿è¡›æˆ°
                            </h1>
                            <p className="text-slate-500 text-sm">å–®å…ƒ 11.3 å¹³è¡¡åŠ›èˆ‡é‹å‹•</p>
                        </header>

                        {errorMsg && (
                            <div className="mb-4 p-4 bg-red-100 text-red-700 rounded-lg text-sm font-bold text-center">
                                {errorMsg}
                            </div>
                        )}

                        <div className="overflow-hidden rounded-2xl bg-white shadow-xl ring-1 ring-slate-900/5">
                            {appState === 'login' && (
                                <div className="p-8 space-y-6 relative">
                                    <div className="text-center">
                                        <div className="mx-auto mb-2 w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 shadow-inner">
                                            <Icons.Atom />
                                        </div>
                                        <h2 className="text-xl font-bold text-slate-800">æº–å‚™å¥½äº†å—ï¼Ÿ</h2>
                                        <p className="text-slate-500 text-sm">ç‚ºä½ çš„ç­ç´šè´å– HOYU COINSï¼</p>
                                    </div>
                                    
                                    {/* é¡¯ç¤ºç•¶å‰é¸ä¸­ç­ç´šçš„å½©æ± ç‹€æ³ */}
                                    <ClassCoinWidget className={studentClass} totalScore={currentClassTotalScore} />

                                    <div className="grid grid-cols-3 gap-2">
                                        <select 
                                            value={studentClass} 
                                            onChange={(e) => setStudentClass(e.target.value)}
                                            className="col-span-1 border-2 border-slate-200 rounded-xl p-3 bg-slate-50 text-center font-bold text-slate-700 focus:border-blue-500 focus:ring-blue-500"
                                        >
                                            {CLASS_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                        <input 
                                            type="text" 
                                            className="col-span-2 border-2 border-slate-200 rounded-xl p-3 focus:border-blue-500 focus:ring-blue-500" 
                                            placeholder="è¼¸å…¥ä½ çš„åå­—" 
                                            value={studentName} 
                                            onChange={e => setStudentName(e.target.value)}
                                        />
                                    </div>

                                    <button 
                                        onClick={startQuiz}
                                        className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-200 hover:bg-blue-700 transform transition active:scale-95"
                                    >
                                        ğŸš€ é–‹å§‹æŒ‘æˆ°
                                    </button>
                                    <button onClick={() => setAppState('leaderboard')} className="w-full text-sm font-bold text-slate-500 hover:text-blue-600">
                                        ğŸ† æŸ¥çœ‹å„ç­æˆ°æ³
                                    </button>

                                    <div className="pt-6 border-t mt-4">
                                        <button onClick={() => setAppState('teacher')} className="text-xs text-slate-300 hover:text-slate-500 flex items-center gap-1 mx-auto">
                                            <Icons.Teacher /> ğŸ‘¨â€ğŸ« æ•™å¸«å°ˆå€
                                        </button>
                                    </div>
                                </div>
                            )}

                            {appState === 'teacher' && (
                                <div className="p-8">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl font-bold flex items-center gap-2"><Icons.Teacher /> æ•™å¸«å¾Œå°</h2>
                                        <button onClick={() => setAppState('login')} className="text-sm text-blue-600 font-bold">å›é¦–é </button>
                                    </div>

                                    <div className="space-y-6">
                                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                            <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2"><Icons.Chart /> ç­ç´šæˆ°æ³ç¸½è¦½</h3>
                                            <div className="space-y-3">
                                                {getClassStats().map(c => (
                                                    <div key={c.classId} className="flex justify-between items-center bg-white p-2 rounded border border-slate-100">
                                                        <span className="font-bold text-slate-700 w-12">{c.classId}</span>
                                                        <div className="flex items-center gap-1 text-amber-500 font-bold">
                                                            <Icons.Coin /> {c.coins}
                                                        </div>
                                                        <span className="text-xs text-slate-400">ç¸½åˆ† {c.total}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                            <h3 className="font-bold text-blue-800 mb-2 flex items-center gap-2"><Icons.Bot /> AI æ•¸æ“šåˆ†æ</h3>
                                            <div className="flex items-center gap-2 mb-3">
                                                <span className="text-sm text-slate-600">ç›®æ¨™ï¼š</span>
                                                <select 
                                                    value={teacherClassFilter} 
                                                    onChange={(e) => setTeacherClassFilter(e.target.value)}
                                                    className="border rounded px-2 py-1 bg-white font-bold text-sm"
                                                >
                                                    <option value="ALL">å…¨ç´š (All Classes)</option>
                                                    {CLASS_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                                                </select>
                                            </div>
                                            <button 
                                                onClick={analyzeClassWeakness} 
                                                disabled={isAnalyzing} 
                                                className="w-full bg-indigo-600 text-white py-2.5 rounded-lg font-bold hover:bg-indigo-700 shadow-md transition flex items-center justify-center gap-2 text-sm"
                                            >
                                                {isAnalyzing ? "AI åˆ†æä¸­..." : `ç”Ÿæˆ ${teacherClassFilter === 'ALL' ? 'å…¨ç´š' : teacherClassFilter} å¼±é»å ±å‘Š`}
                                            </button>
                                        </div>

                                        {teacherAnalysis.main && (
                                            <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm animate-in fade-in slide-in-from-top-2">
                                                <h4 className="font-bold text-indigo-800 mb-3 pb-2 border-b">ğŸ“ è¨ºæ–·å ±å‘Š</h4>
                                                <div className="prose prose-sm text-slate-700 whitespace-pre-wrap leading-relaxed mb-4">
                                                    {teacherAnalysis.main}
                                                </div>
                                                {teacherAnalysis.suggestions && (
                                                    <div className="mt-4 pt-4 border-t border-indigo-50">
                                                        <button 
                                                            onClick={() => setShowTeacherSuggestions(!showTeacherSuggestions)}
                                                            className="flex items-center gap-2 text-xs font-bold text-indigo-600 hover:text-indigo-800 transition"
                                                        >
                                                            <Icons.Bulb /> 
                                                            {showTeacherSuggestions ? "éš±è—å»ºè­°" : "é¡¯ç¤ºæ•™å­¸å»ºè­°"}
                                                            {showTeacherSuggestions ? <Icons.ChevronUp /> : <Icons.ChevronDown />}
                                                        </button>
                                                        {showTeacherSuggestions && (
                                                            <div className="mt-2 p-3 bg-indigo-50 rounded-lg text-xs text-slate-700 whitespace-pre-wrap leading-relaxed">
                                                                {teacherAnalysis.suggestions}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {/* æ–°å¢ï¼šå­¸ç”Ÿç”±ç¸¾åˆ—è¡¨ */}
                                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm mt-6">
                                            <h3 className="font-bold text-slate-700 mb-4 flex items-center justify-between">
                                                <span className="flex items-center gap-2"><Icons.Users /> å­¸ç”Ÿç”±ç¸¾åˆ—è¡¨</span>
                                                
                                                <div className="flex items-center gap-2 text-sm font-normal">
                                                    <label className="text-slate-500">åˆæ ¼åˆ†æ•¸:</label>
                                                    <input 
                                                        type="number" 
                                                        value={passThreshold} 
                                                        onChange={(e) => setPassThreshold(Number(e.target.value))}
                                                        className="w-16 border rounded px-2 py-1 text-center font-bold text-slate-700"
                                                    />
                                                </div>
                                            </h3>

                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm text-left">
                                                    <thead className="bg-slate-50 text-slate-500 font-bold border-b">
                                                        <tr>
                                                            <th className="p-3">ç­åˆ¥</th>
                                                            <th className="p-3">å§“å</th>
                                                            <th className="p-3 text-right">åˆ†æ•¸</th>
                                                            <th className="p-3 text-center">ç‹€æ…‹</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-100">
                                                        {leaderboard
                                                            .filter(s => teacherClassFilter === "ALL" || s.classId === teacherClassFilter)
                                                            .sort((a, b) => (a.classId || "").localeCompare(b.classId || "") || b.score - a.score)
                                                            .map((r) => {
                                                                const isFail = r.score < passThreshold;
                                                                return (
                                                                    <tr key={r.id} className={isFail ? "bg-red-50/50" : ""}>
                                                                        <td className="p-3"><span className="font-mono bg-slate-100 px-1.5 py-0.5 rounded text-slate-600 text-xs">{r.classId}</span></td>
                                                                        <td className="p-3 font-medium text-slate-700">{r.studentName}</td>
                                                                        <td className={`p-3 text-right font-bold ${isFail ? "text-red-600" : "text-blue-600"}`}>
                                                                            {r.score}
                                                                        </td>
                                                                        <td className="p-3 text-center">
                                                                            {isFail ? 
                                                                                <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-red-100 text-red-600 text-xs font-bold">
                                                                                    <Icons.X size={12}/> æœªé”æ¨™
                                                                                </span> 
                                                                                : 
                                                                                <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-100 text-green-600 text-xs font-bold">
                                                                                    <Icons.Check size={12}/> åˆæ ¼
                                                                                </span>
                                                                            }
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                    </tbody>
                                                </table>
                                                {leaderboard.filter(s => teacherClassFilter === "ALL" || s.classId === teacherClassFilter).length === 0 && (
                                                    <div className="p-4 text-center text-slate-400 text-xs">æš«ç„¡è³‡æ–™</div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="border-t pt-6 mt-4">
                                            <button 
                                                onClick={resetDatabase}
                                                disabled={isDeleting}
                                                className="w-full border-2 border-red-100 bg-red-50 text-red-600 py-3 rounded-xl text-sm font-bold hover:bg-red-100 hover:border-red-200 flex items-center justify-center gap-2 transition"
                                            >
                                                {isDeleting ? "æ¸…ç†ä¸­..." : <><Icons.Trash /> âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™ (é‡ç½®å½©æ± )</>}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {appState === 'quiz' && (
                                <div className="p-8">
                                    <div className="flex justify-between mb-6 text-sm font-bold items-center">
                                        <span className={practiceMode ? "text-purple-600 bg-purple-50 px-2 py-1 rounded" : challengeMode ? "text-orange-600 bg-orange-50 px-2 py-1 rounded" : "text-slate-500"}>
                                            {practiceMode ? "âœ¨ è£œæ•‘ç·´ç¿’" : challengeMode ? `ğŸ”¥ æŒ‘æˆ° ${currentQuestionIndex + 1}` : `ç¬¬ ${currentQuestionIndex + 1} / ${QUESTIONS_DATA.length} é¡Œ`}
                                        </span>
                                        {!challengeMode && <span className="text-blue-600 bg-blue-50 px-3 py-1 rounded-full border border-blue-100">å¾—åˆ†: {score}</span>}
                                    </div>

                                    {!challengeMode && <SmartImage question={currentQuestionData} />}

                                    <h2 className="text-xl font-bold mb-6 leading-relaxed text-slate-800">
                                        {currentQuestionData.question}
                                    </h2>

                                    <div className="space-y-3">
                                        {currentQuestionData.options.map((opt, index) => {
                                            let bg = "bg-white hover:bg-slate-50 border-2 border-slate-100";
                                            
                                            if (isAnswerChecked) {
                                                if (opt === currentQuestionData.correctAnswer) {
                                                    bg = "bg-green-50 border-green-500 text-green-800";
                                                } else if (opt === selectedOption) {
                                                    bg = "bg-red-50 border-red-300 text-red-800";
                                                } else {
                                                    bg = "opacity-50 border-slate-100";
                                                }
                                            } else if (selectedOption === opt) {
                                                bg = "bg-blue-50 border-blue-500 text-blue-800";
                                            }
                                            return (
                                                <button 
                                                    key={index} 
                                                    onClick={() => handleAnswer(opt)} 
                                                    disabled={isAnswerChecked} 
                                                    className={`w-full text-left p-4 rounded-xl transition-all font-medium ${bg}`}
                                                >
                                                    <div className="flex justify-between items-center">
                                                        <span><span className="font-bold text-slate-400 mr-2">{String.fromCharCode(65 + index)}.</span> {opt}</span>
                                                        {isAnswerChecked && opt === currentQuestionData.correctAnswer && <Icons.Check />}
                                                        {isAnswerChecked && opt === selectedOption && opt !== currentQuestionData.correctAnswer && <Icons.X />}
                                                    </div>
                                                </button>
                                            )
                                        })}
                                    </div>

                                    <div className="mt-8">
                                        {!isAnswerChecked ? (
                                            <>
                                                {currentQuestionData.hint && (
                                                    <div className="mb-4">
                                                        <button 
                                                            onClick={() => setShowHint(!showHint)}
                                                            className="text-amber-600 text-sm font-bold hover:text-amber-700 flex items-center gap-1 transition"
                                                        >
                                                            <Icons.Bulb /> {showHint ? "éš±è—æç¤º" : "å¡é—œäº†å—ï¼Ÿé»æˆ‘é¡¯ç¤ºæç¤º"}
                                                        </button>
                                                        {showHint && (
                                                            <div className="mt-2 p-3 bg-amber-50 border border-amber-200 rounded-xl text-sm text-amber-800 animate-in fade-in slide-in-from-top-1">
                                                                ğŸ’¡ æç¤ºï¼š{currentQuestionData.hint}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                                <button 
                                                    onClick={check} 
                                                    disabled={!selectedOption} 
                                                    className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold disabled:opacity-50 hover:bg-slate-800 transition shadow-lg"
                                                >
                                                    é€å‡ºç­”æ¡ˆ
                                                </button>
                                            </>
                                        ) : (
                                            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                                                <div className={`p-5 rounded-xl mb-4 border ${selectedOption === currentQuestionData.correctAnswer ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                                    <h3 className={`font-bold mb-2 flex items-center gap-2 ${selectedOption === currentQuestionData.correctAnswer ? 'text-green-800' : 'text-red-800'}`}>
                                                        {selectedOption === currentQuestionData.correctAnswer ? 'ğŸ‰ ç­”å°äº†ï¼' : 'ğŸ’ª åŠ æ²¹ï¼Œå†æ¥å†å²ï¼'}
                                                    </h3>
                                                    <p className="text-sm text-slate-700 leading-relaxed">
                                                        <span className="font-bold">è§£æï¼š</span>{currentQuestionData.explanation}
                                                    </p>
                                                </div>

                                                {selectedOption !== currentQuestionData.correctAnswer && !practiceMode && !challengeMode ? (
                                                    <div className="flex flex-col gap-2 sm:flex-row">
                                                        {currentQuestionData.similar && (
                                                            <button onClick={startPrebuiltPractice} className="flex-1 bg-purple-100 text-purple-700 py-3 rounded-xl font-bold hover:bg-purple-200 border border-purple-200 transition">
                                                                ğŸ“ åŸºç¤ç·´ç¿’ (é è¨­)
                                                            </button>
                                                        )}
                                                        
                                                        <button onClick={generateAIPractice} disabled={isGenerating} className="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-bold hover:opacity-90 shadow-lg shadow-purple-200 transition flex items-center justify-center gap-2">
                                                            {isGenerating ? <span className="animate-spin">ğŸ§ </span> : <Icons.Bot />} 
                                                            {isGenerating ? "AI æ€è€ƒä¸­..." : "AI ç”Ÿæˆæ·ºç™½ç·´ç¿’ (+æç¤º)"}
                                                        </button>

                                                        <button onClick={next} className="px-6 py-3 border-2 border-slate-200 rounded-xl font-bold text-slate-500 hover:bg-slate-50 hover:text-slate-700">
                                                            è·³é &rarr;
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <button onClick={next} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition transform active:scale-95">
                                                        {currentQuestionIndex < quizQuestions.length - 1 || practiceMode || (challengeMode && currentQuestionIndex < currentQuestionData.totalChallenge - 1) ? 'ä¸‹ä¸€é¡Œ &rarr;' : 'æŸ¥çœ‹æˆç¸¾ ğŸ†'}
                                                    </button>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {appState === 'result' && (
                                <div className="p-8 text-center">
                                    <div className="mx-auto w-24 h-24 bg-yellow-50 rounded-full flex items-center justify-center text-yellow-500 mb-4 animate-float-up">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                                    </div>
                                    
                                    <h2 className="text-3xl font-black text-slate-900 mb-1">æ¸¬é©—çµæŸï¼</h2>
                                    <p className="text-slate-500 mb-6">
                                        <span className="font-bold bg-slate-100 px-2 py-1 rounded">{studentClass}</span> {studentName}
                                    </p>

                                    <div className="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-6 text-white shadow-lg mb-6 transform hover:scale-105 transition duration-300">
                                        <div className="text-sm opacity-80 mb-1">å€‹äººå¾—åˆ†</div>
                                        <div className="text-6xl font-black mb-2">{score}</div>
                                        <div className="border-t border-white/20 pt-2 mt-2 flex items-center justify-center gap-2 text-sm font-bold shine-text">
                                            <Icons.Coin /> å·²ç‚ºç­ç´šè²¢ç» {score} ç©åˆ†ï¼
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-3">
                                        {score >= 80 && !challengeMode && (
                                            <button onClick={startChallenge} disabled={isGenerating} className="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-4 rounded-xl font-bold shadow-lg hover:from-orange-600 hover:to-red-600 animate-pulse flex items-center justify-center gap-2">
                                                {isGenerating ? "æº–å‚™é¡Œç›®ä¸­..." : <><Icons.Flame /> æŒ‘æˆ°é«˜é›£åº¦é¡Œç›® (+åŠ åˆ†)</>}
                                            </button>
                                        )}

                                        {!aiAnalysisResult ? (
                                            <button onClick={analyzeWeakness} disabled={isAnalyzing} className="w-full bg-white border-2 border-blue-100 text-blue-600 py-3 rounded-xl font-bold hover:bg-blue-50 flex items-center justify-center gap-2">
                                                {isAnalyzing ? "ğŸ¤– AI åˆ†æä¸­..." : "ğŸ¤– AI éŒ¯é¡Œè¨ºæ–·"}
                                            </button>
                                        ) : (
                                            <div className="bg-blue-50 p-4 rounded-xl text-left border border-blue-100">
                                                <h4 className="font-bold text-blue-800 mb-1 flex items-center gap-2"><Icons.Bot /> è¨ºæ–·å ±å‘Šï¼š</h4>
                                                <p className="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap">{aiAnalysisResult}</p>
                                            </div>
                                        )}

                                        <button onClick={() => setAppState('leaderboard')} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900">æŸ¥çœ‹å…¨æ ¡æˆ°æ³</button>
                                        <button onClick={() => setAppState('login')} className="w-full border border-slate-300 py-3 rounded-xl font-bold hover:bg-slate-50 text-slate-600">å›é¦–é </button>
                                    </div>
                                </div>
                            )}

                            {appState === 'leaderboard' && (
                                <div className="flex flex-col h-[500px]">
                                    <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                                        <h3 className="font-bold flex gap-2 text-slate-800 items-center text-lg">ğŸ† æ¦®è­½æ¦œ</h3>
                                        <button onClick={() => setAppState('login')} className="text-sm text-blue-600 font-bold hover:underline">é—œé–‰</button>
                                    </div>
                                    
                                    <div className="flex p-2 bg-slate-50 gap-2">
                                        <button 
                                            onClick={() => setLeaderboardTab('student')}
                                            className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${leaderboardTab === 'student' ? 'bg-white text-blue-600 shadow-sm ring-1 ring-slate-200' : 'text-slate-400 hover:bg-slate-100'}`}
                                        >
                                            å€‹äººæ’å
                                        </button>
                                        <button 
                                            onClick={() => setLeaderboardTab('class')}
                                            className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${leaderboardTab === 'class' ? 'bg-white text-amber-600 shadow-sm ring-1 ring-slate-200' : 'text-slate-400 hover:bg-slate-100'}`}
                                        >
                                            ç­éš›çˆ­éœ¸ (é‡‘å¹£)
                                        </button>
                                    </div>

                                    <div className="flex-1 overflow-y-auto bg-white">
                                        {leaderboardTab === 'student' ? (
                                            <table className="w-full text-left text-sm">
                                                <thead className="bg-slate-50 text-slate-500 sticky top-0 z-10 shadow-sm">
                                                    <tr><th className="p-4">æ’å</th><th className="p-4">å§“å</th><th className="p-4 text-right">å¾—åˆ†</th></tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {leaderboard.map((r, i) => (
                                                        <tr key={r.id} className={i < 3 ? 'bg-yellow-50/30' : ''}>
                                                            <td className="p-4 font-bold text-slate-500">
                                                                {i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `#${i+1}`}
                                                            </td>
                                                            <td className="p-4 font-medium text-slate-900">
                                                                <span className="font-mono text-xs bg-slate-100 px-1.5 py-0.5 rounded mr-2 text-slate-500 border border-slate-200">{r.classId || '-'}</span>
                                                                {r.studentName}
                                                            </td>
                                                            <td className="p-4 text-right font-bold text-blue-600">{r.score}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        ) : (
                                            <div className="p-4 space-y-4">
                                                {getClassStats().map((c, i) => (
                                                    <div key={c.classId} className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm relative overflow-hidden">
                                                        {i === 0 && <div className="absolute top-0 right-0 bg-yellow-400 text-white text-xs font-bold px-2 py-1 rounded-bl-lg">ğŸ‘‘ ç›®å‰é ˜å…ˆ</div>}
                                                        
                                                        <div className="flex justify-between items-center mb-3">
                                                            <div>
                                                                <div className="text-lg font-black text-slate-800">{c.classId}</div>
                                                                <div className="text-xs text-slate-400">åƒèˆ‡äººæ•¸: {c.count} | å¹³å‡åˆ†: {c.avg}</div>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className="text-2xl font-black text-amber-500 flex items-center justify-end gap-1 drop-shadow-sm">
                                                                    <Icons.Coin /> {c.coins}
                                                                </div>
                                                                <div className="text-xs text-amber-600 font-bold">HOYU COINS</div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="relative h-3 bg-slate-100 rounded-full overflow-hidden">
                                                            <div 
                                                                className="absolute top-0 left-0 h-full bg-amber-400 rounded-full transition-all duration-1000" 
                                                                style={{ width: `${c.progress}%` }}
                                                            ></div>
                                                        </div>
                                                        <div className="flex justify-between mt-1 text-xs text-slate-400">
                                                            <span>ä¸‹ä¸€æšé€²åº¦: {Math.round(c.progress)}%</span>
                                                            <span>{Math.round(c.total % POINTS_PER_COIN)} / {POINTS_PER_COIN} åˆ†</span>
                                                        </div>
                                                    </div>
                                                ))}
                                                
                                                <div className="text-center p-4 text-slate-400 text-xs">
                                                    æ¯ç´¯ç© 800 åˆ† = 1 æšé‡‘å¹£<br/>
                                                    å…¨ç­ä¸€èµ·åŠ æ²¹ï¼
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="text-center mt-6 text-xs text-slate-400">
                            S.2 Science | AI-Powered Learning
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
