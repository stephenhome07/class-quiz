<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.2 Science Quiz: Class Battle (ç­éš›ä¿è¡›æˆ°)</title>
    
    <!-- 1. è¼‰å…¥å¿…è¦çš„å·¥å…· -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>

    <!-- å‹•ç•«æ¨£å¼ -->
    <style>
        @keyframes bounce-coin {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(251, 191, 36, 0.5); }
            50% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.8); }
        }
        @keyframes float-up {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .coin-icon {
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }
        .animate-coin-bounce {
            animation: bounce-coin 2s infinite ease-in-out;
        }
        .animate-float-up {
            animation: float-up 0.5s ease-out forwards;
        }
        .progress-bar-striped {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
        }
    </style>

    <!-- 2. è¼‰å…¥ Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit, deleteDoc, doc, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDLoHH3xJcg8RP135anypHnT--rY2O_8ag",
            authDomain: "test-235ba.firebaseapp.com",
            databaseURL: "https://test-235ba-default-rtdb.firebaseio.com",
            projectId: "test-235ba",
            storageBucket: "test-235ba.firebasestorage.app",
            messagingSenderId: "956103447126",
            appId: "1:956103447126:web:23fb288d99c599c053a1f7",
            measurementId: "G-73095GCTJ9"
        };

        // AI API è¨­å®š
        const AI_PROXY_URL = "https://apiproxy.k12gpt.ai/NPcj-7_"; 
        const AI_AUTH_KEY = ""; 

        let app, auth, db;
        let initError = null;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            enableIndexedDbPersistence(db).catch((err) => {
                console.log('Persistence failed:', err.code);
            });
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
            initError = e.message;
        }

        window.dbServices = { 
            auth, db, 
            signInAnonymously, onAuthStateChanged, 
            collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit, deleteDoc, doc, getDocs,
            AI_PROXY_URL, AI_AUTH_KEY, initError
        };
    </script>
</head>
<body class="bg-slate-50 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // --- åœ–ç¤º ---
        const Icons = {
            Atom: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500" {...props}><circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5Z"/><path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5Z"/></svg>,
            Car: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-red-500" {...props}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>,
            Box: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-amber-600" {...props}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></svg>,
            Ball: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-slate-700" {...props}><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>,
            Apple: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-red-500" {...props}><path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 6-8 6-12.22A4.91 4.91 0 0 0 17 5c-2.22 0-4 1.44-5 2-1-.56-2.78-2-5-2a4.9 4.9 0 0 0-5 4.78C2 14 5 22 8 22c1.25 0 2.5-1.06 4-1.06Z"/><path d="M10 2c1 .5 2 2 2 5"/></svg>,
            Arrow: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-blue-600" {...props}><path d="M18 8L22 12L18 16"/><path d="M2 12H22"/></svg>,
            Force: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-purple-600" {...props}><path d="m15 5 4 4-4 4"/><path d="M5 9h14"/><path d="m9 19-4-4 4-4"/><path d="M19 15H5"/></svg>,
            Skater: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="text-cyan-500" {...props}><path d="M15 12h-2"/><path d="M13 14v-2"/><path d="M9 4a2 2 0 1 0 2 2"/><path d="m16 20 2-2-4-5-2 2 3 5"/><path d="m2 16 6-5 2 4-2 5"/></svg>,
            Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-green-600" {...props}><polyline points="20 6 9 17 4 12"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-500" {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Bot: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-purple-600" {...props}><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>,
            Flame: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-orange-500" {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.7 3.7 4.4 4.5 4.5 3.3z"/></svg>,
            Teacher: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-slate-600" {...props}><path d="M2 20h20"/><path d="M5 20v-8a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8"/><path d="M12 14v-2"/><circle cx="12" cy="8" r="4"/></svg>,
            Chart: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
            Trash: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Bulb: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-500" {...props}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.8.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
            ChevronDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6 9 6 6 6-6"/></svg>,
            ChevronUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m18 15-6-6-6 6"/></svg>,
            Coin: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#FBBF24" stroke="#B45309" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className="coin-icon" {...props}><circle cx="12" cy="12" r="9"/><path d="M10 10c0-1.333.8-2 2-2s2 .667 2 2c0 2.667-4 2.667-4 5.333 0 1.333.8 2 2 2s2-.667 2-2"/><path d="M12 18h.01"/></svg>,
            Users: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Wifi: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className} {...props}><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>,
            WifiOff: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className} {...props}><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>
        };

        const CLASS_OPTIONS = ["S2A", "S2B", "S2C", "S2D", "S2E", "TEST"];
        const POINTS_PER_COIN = 800; 

        // é¡Œç›®è³‡æ–™ (ä¸­è‹±å°ç…§)
        const QUESTIONS_DATA = [
             {
                id: 1,
                question: "ä¸€è¼›æ‰‹æ¨è»ŠåŸæœ¬è™•æ–¼éœæ­¢ç‹€æ…‹ã€‚å¦‚åœ–æ‰€ç¤ºï¼Œå®ƒå—åˆ°å‘å·¦ 10 N å’Œå‘å³ 10 N çš„åŠ›åŒæ™‚ä½œç”¨ã€‚é æ¸¬é€™è¼›æ‰‹æ¨è»Šçš„é‹å‹•ç‹€æ…‹ã€‚\n(A handcart is initially at rest. It is acted upon by a force of 10 N to the left and 10 N to the right. Predict its motion.)",
                options: ["ä¿æŒéœæ­¢ (Remain at rest)", "å‹»é€Ÿé‹å‹• (Uniform motion)", "éå‹»é€Ÿé‹å‹• (Non-uniform motion)", "ç„¡æ³•åˆ¤æ–· (Cannot be determined)"],
                correctAnswer: "ä¿æŒéœæ­¢ (Remain at rest)",
                explanation: "å‘å·¦ 10N å’Œå‘å³ 10N çš„åŠ›å¤§å°ç›¸ç­‰ã€æ–¹å‘ç›¸åï¼ŒåˆåŠ›ç‚º 0ï¼ˆå¹³è¡¡åŠ›ï¼‰ã€‚æ ¹æ“šç‰›é “ç¬¬ä¸€å®šå¾‹ï¼ŒåŸæœ¬éœæ­¢çš„ç‰©é«”åœ¨å—å¹³è¡¡åŠ›ä½œç”¨ä¸‹æœƒä¿æŒéœæ­¢ã€‚\n(Forces are equal and opposite, net force is 0. According to Newton's 1st Law, object remains at rest.)",
                keywords: ["cart", "force"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘ä¸€æœ¬æ›¸éœç½®åœ¨æ¡Œé¢ä¸Šï¼Œå°æ˜å¾å·¦é‚Šæ–½åŠ› 5 Nï¼Œå°è¯å¾å³é‚Šæ–½åŠ› 5 Nã€‚è«‹å•é€™æœ¬æ›¸æœƒå¦‚ä½•é‹å‹•ï¼Ÿ\n(A book is on a table. 5 N force from left, 5 N force from right. How will it move?)",
                    options: ["å‘å³ç§»å‹• (Move right)", "å‘å·¦ç§»å‹• (Move left)", "ä¿æŒéœæ­¢ (Remain at rest)", "è½‰å‹• (Rotate)"],
                    correctAnswer: "ä¿æŒéœæ­¢ (Remain at rest)",
                    explanation: "å·¦å³å…©é‚Šçš„åŠ›å¤§å°ç›¸åŒä¸”æ–¹å‘ç›¸åï¼Œäº’ç›¸æŠµéŠ·ï¼ŒåˆåŠ›ç‚ºé›¶ã€‚\n(Forces cancel out, net force is zero.)"
                }
            },
            {
                id: 2,
                question: "ä¸€å€‹ç®±å­æ­£åœ¨å…‰æ»‘çš„åœ°é¢ä¸Šå‘å³ç§»å‹•ã€‚æ­¤æ™‚ï¼Œå®ƒå—åˆ°å‘å·¦ 5 N å’Œå‘å³ 5 N çš„åŠ›ä½œç”¨ã€‚é æ¸¬ç®±å­æ¥ä¸‹ä¾†çš„é‹å‹•ã€‚\n(A box moving right on smooth floor is acted upon by 5 N left and 5 N right. Predict its motion.)",
                options: ["ç«‹å³åœæ­¢ (Stop immediately)", "ä¿æŒéœæ­¢ (Remain at rest)", "å‹»é€Ÿé‹å‹• (Uniform motion)", "éå‹»é€Ÿé‹å‹• (Non-uniform motion)"],
                correctAnswer: "å‹»é€Ÿé‹å‹• (Uniform motion)",
                explanation: "åˆåŠ›ç‚º 0ã€‚å› ç‚ºæ˜¯ã€Œå¹³è¡¡åŠ›ã€ï¼Œç‰©é«”æœƒç¶­æŒåŸæœ¬çš„é‹å‹•ç‹€æ…‹ï¼ˆå‘å³å‹»é€Ÿï¼‰ã€‚\n(Net force is 0. Under balanced forces, it maintains original uniform motion to the right.)",
                keywords: ["box", "force"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘å†°çƒåœ¨å†°é¢ä¸Šä»¥ 2 m/s å‘å‰æ»‘è¡Œï¼Œå‡è¨­æ‘©æ“¦åŠ›å¿½ç•¥ä¸è¨ˆï¼Œä¸”æ²’æœ‰å…¶ä»–å¤–åŠ›ä½œç”¨ï¼Œå†°çƒæœƒï¼Ÿ\n(An ice puck slides at 2 m/s with no friction or external forces. It will?)",
                    options: ["è¶Šä¾†è¶Šæ…¢ (Slow down)", "ä¿æŒ 2 m/s å‹»é€Ÿç›´ç·šé‹å‹• (Keep 2 m/s uniform motion)", "è¶Šä¾†è¶Šå¿« (Speed up)", "ç«‹å³åœæ­¢ (Stop immediately)"],
                    correctAnswer: "ä¿æŒ 2 m/s å‹»é€Ÿç›´ç·šé‹å‹• (Keep 2 m/s uniform motion)",
                    explanation: "ä¸å—å¤–åŠ›æ™‚ï¼Œç‰©é«”ç¶­æŒåŸæœ¬é€Ÿåº¦ï¼ˆæ…£æ€§ï¼‰ã€‚\n(No external force means maintaining original velocity due to inertia.)"
                }
            },
            {
                id: 3,
                question: "ä¸€è¼›ç©å…·è»Šéœæ­¢åœ¨åœ°é¢ä¸Šï¼Œå—åˆ°å‘å³ 20 N çš„æ¨åŠ›å’Œå‘å·¦ 5 N çš„æ‘©æ“¦åŠ›ä½œç”¨ã€‚é æ¸¬ç©å…·è»Šçš„é‹å‹•ã€‚\n(A toy car at rest: 20 N push to right, 5 N friction to left. Predict motion.)",
                options: ["ä¿æŒéœæ­¢ (Remain at rest)", "å‹»é€Ÿé‹å‹• (Uniform motion)", "éå‹»é€Ÿé‹å‹• (Non-uniform motion)", "å…ˆå·¦å¾Œå³ (Left then right)"],
                correctAnswer: "éå‹»é€Ÿé‹å‹• (Non-uniform motion)",
                explanation: "åˆåŠ› = 15N å‘å³ã€‚å—åŠ›ã€Œä¸å¹³è¡¡ã€ï¼Œç‰©é«”æœƒåŠ é€Ÿï¼ˆéå‹»é€Ÿï¼‰ã€‚\n(Net force = 15N right. Unbalanced force causes acceleration/non-uniform motion.)",
                keywords: ["car", "force"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘å¿«è‰‡å¼•æ“æä¾›å‘å‰ 5000 N æ¨åŠ›ï¼Œæ°´é˜»åŠ› 2000 Nã€‚å¿«è‰‡ç‹€æ…‹ï¼Ÿ\n(Speedboat: 5000 N forward thrust, 2000 N resistance. Motion state?)",
                    options: ["éœæ­¢ (At rest)", "å‹»é€Ÿé‹å‹• (Uniform motion)", "å‘å‰åŠ é€Ÿ (Accelerate forward)", "å‘å¾ŒåŠ é€Ÿ (Accelerate backward)"],
                    correctAnswer: "å‘å‰åŠ é€Ÿ (Accelerate forward)",
                    explanation: "æ¨åŠ›å¤§æ–¼é˜»åŠ›ï¼ŒåˆåŠ›å‘å‰ï¼Œç‰©é«”åŠ é€Ÿã€‚\n(Thrust > Resistance, net force forward causes acceleration.)"
                }
            },
            {
                id: 4,
                question: "åœ–ç‰‡é¡¯ç¤ºä¸€å€‹è¶³çƒåœ¨è‰åœ°ä¸Šæ»¾å‹•ï¼Œæœ€çµ‚åœäº†ä¸‹ä¾†ã€‚é€™éç¨‹ä¸­ï¼Œè¶³çƒè™•æ–¼ä»€éº¼é‹å‹•ç‹€æ…‹ï¼Ÿé€™æš—ç¤ºäº†ä»€éº¼ï¼Ÿ\n(A soccer ball rolls and stops. What is its motion state and implication?)",
                options: ["å‹»é€Ÿï¼›å—åŠ›å¹³è¡¡ (Uniform; Balanced)", "éå‹»é€Ÿï¼›å—åŠ›å¹³è¡¡ (Non-uniform; Balanced)", "éå‹»é€Ÿï¼›å—åŠ›ä¸å¹³è¡¡ (Non-uniform; Unbalanced)", "éœæ­¢ï¼›å—åŠ›ä¸å¹³è¡¡ (Rest; Unbalanced)"],
                correctAnswer: "éå‹»é€Ÿï¼›å—åŠ›ä¸å¹³è¡¡ (Non-uniform; Unbalanced)",
                explanation: "é€Ÿåº¦æ”¹è®Šï¼ˆæ¸›é€Ÿï¼‰æ˜¯ã€Œéå‹»é€Ÿé‹å‹•ã€ï¼Œå¿…å®šå—åˆ°ã€Œä¸å¹³è¡¡åŠ›ã€ï¼ˆæ‘©æ“¦åŠ›ï¼‰ã€‚\n(Changing speed (deceleration) is non-uniform motion caused by unbalanced force/friction.)",
                keywords: ["ball", "force"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘é¨è…³è¸è»Šåœæ­¢è¸©è¸æ¿å¾Œæ…¢æ…¢åœä¸‹ï¼Œæ˜¯å› ç‚ºä»€éº¼åŠ›ï¼Ÿ\n(Bicycle stops after pedaling stops due to what force?)",
                    options: ["é‡åŠ› (Gravity)", "æ‘©æ“¦åŠ› (Friction)", "æ¨åŠ› (Thrust)", "æ”¯æ’åŠ› (Support force)"],
                    correctAnswer: "æ‘©æ“¦åŠ› (Friction)",
                    explanation: "æ¸›é€Ÿæ˜¯å› ç‚ºåœ°é¢æ‘©æ“¦åŠ›ã€‚\n(Deceleration is caused by ground friction.)"
                }
            },
            {
                id: 5,
                question: "ä¸€å€‹ç‰©é«”æ‡¸æ›åœ¨ç¹©å­ä¸Šä¿æŒéœæ­¢ã€‚ä¸‹åˆ—å“ªé …æ­£ç¢ºï¼Ÿ\n(An object hanging on a rope is stationary. Which is true?)",
                options: ["æ²’å—åŠ› (No force)", "å—ä¸å¹³è¡¡åŠ› (Unbalanced forces)", "å—å¹³è¡¡åŠ› (Balanced forces)", "é‡åŠ› > æ‹‰åŠ› (Gravity > Tension)"],
                correctAnswer: "å—å¹³è¡¡åŠ› (Balanced forces)",
                explanation: "éœæ­¢ä»£è¡¨åˆåŠ›ç‚º 0ï¼ˆå¹³è¡¡åŠ›ï¼‰ã€‚é‡åŠ›èˆ‡æ‹‰åŠ›æŠµéŠ·ã€‚\n(Stationary means net force 0. Gravity and tension cancel out.)",
                keywords: ["box", "arrow"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘é›»ç‡ˆåŠåœ¨å¤©èŠ±æ¿ä¸Šéœæ­¢ã€‚é‡åŠ›å’Œæ‹‰åŠ›é—œä¿‚ï¼Ÿ\n(Lamp hanging stationary. Gravity vs Tension?)",
                    options: ["é‡åŠ› > æ‹‰åŠ› (Gravity > Tension)", "æ‹‰åŠ› > é‡åŠ› (Tension > Gravity)", "å¤§å°ç›¸ç­‰ï¼Œæ–¹å‘ç›¸å (Equal & Opposite)", "å¤§å°ç›¸ç­‰ï¼Œæ–¹å‘ç›¸åŒ (Equal & Same dir)"],
                    correctAnswer: "å¤§å°ç›¸ç­‰ï¼Œæ–¹å‘ç›¸å (Equal & Opposite)",
                    explanation: "éœæ­¢ = å¹³è¡¡åŠ›ã€‚\n(Stationary = Balanced forces.)"
                }
            },
            {
                id: 6,
                question: "å°æ˜åœ¨ç„¡æ‘©æ“¦åŠ›çš„æºœå†°å ´æ»‘è¡Œã€‚åœæ­¢ç”¨åŠ›å¾Œä»–æœƒï¼Ÿ\n(Xiao Ming skates on frictionless ice. After stopping pushing, he will?)",
                options: ["ç«‹å³åœæ­¢ (Stop now)", "æ…¢æ…¢åœä¸‹ (Stop slowly)", "å‹»é€Ÿæ»‘è¡Œ (Uniform motion)", "è¶Šæ»‘è¶Šå¿« (Faster)"],
                correctAnswer: "å‹»é€Ÿæ»‘è¡Œ (Uniform motion)",
                explanation: "ç„¡æ‘©æ“¦åŠ›ï¼ˆåˆåŠ› 0ï¼‰ï¼Œæ ¹æ“šæ…£æ€§ï¼Œä¿æŒå‹»é€Ÿé‹å‹•ã€‚\n(No friction/net force 0. Maintains uniform motion due to inertia.)",
                keywords: ["skater"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘å¤ªç©ºä¸­ï¼Œå¤ªç©ºèˆ¹é—œé–‰å¼•æ“å¾Œæœƒï¼Ÿ\n(Spaceship in space turns off engine. It will?)",
                    options: ["åœä¸‹ä¾† (Stop)", "ä¿æŒåŸé€Ÿç›´ç·šé£›è¡Œ (Keep speed & straight line)", "è½‰åœˆ (Spin)", "æ¸›é€Ÿ (Slow down)"],
                    correctAnswer: "ä¿æŒåŸé€Ÿç›´ç·šé£›è¡Œ (Keep speed & straight line)",
                    explanation: "å¤ªç©ºä¸­ç„¡é˜»åŠ›ï¼Œæ…£æ€§ç¶­æŒé‹å‹•ã€‚\n(No resistance in space, inertia maintains motion.)"
                }
            },
            {
                id: 7,
                question: "æ±½è»Šåœ¨å…¬è·¯è¡Œé§›ã€‚å¼•æ“å‹•åŠ› 5000N å‘å³ï¼Œé˜»åŠ› 5000N å‘å·¦ã€‚é€Ÿåº¦é‡æœƒï¼Ÿ\n(Car on highway. Power 5000N right, Resistance 5000N left. Speedometer?)",
                options: ["å‘ä¸Šè½‰/åŠ é€Ÿ (Up/Accelerate)", "å‘ä¸‹è½‰/æ¸›é€Ÿ (Down/Decelerate)", "ä¿æŒä¸è®Š/å‹»é€Ÿ (Unchanged/Uniform)", "æ­¸é›¶/åœæ­¢ (Zero/Stop)"],
                correctAnswer: "ä¿æŒä¸è®Š/å‹»é€Ÿ (Unchanged/Uniform)",
                explanation: "å‹•åŠ›èˆ‡é˜»åŠ›æŠµéŠ·ï¼ŒåˆåŠ›ç‚º 0ï¼Œç¶­æŒå‹»é€Ÿã€‚\n(Forces cancel out, net force 0, maintains uniform speed.)",
                keywords: ["car", "force"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘è·³å‚˜å“¡æ‰“é–‹å‚˜å¾Œï¼Œç•¶é˜»åŠ›ç­‰æ–¼é‡é‡æ™‚ï¼Ÿ\n(Skydiver: Air resistance equals weight. State?)",
                    options: ["éœæ­¢ (Stationary)", "å‘ä¸Šé£› (Fly up)", "çµ‚ç«¯é€Ÿåº¦å‹»é€Ÿä¸‹é™ (Terminal velocity)", "åŠ é€Ÿä¸‹é™ (Accelerate down)"],
                    correctAnswer: "çµ‚ç«¯é€Ÿåº¦å‹»é€Ÿä¸‹é™ (Terminal velocity)",
                    explanation: "åˆåŠ›ç‚ºé›¶ï¼ŒåŠ é€Ÿåº¦ç‚ºé›¶ã€‚\n(Net force 0, acceleration 0.)"
                }
            },
            {
                id: 8,
                question: "æ˜Ÿå¦‚å‘å³æ¨è»Šï¼Œæœ—è»’å‘å·¦æ¨è»Šã€‚æ˜Ÿå¦‚åŠ›æ°£è¼ƒå¤§ï¼Œè»Šå­æœƒï¼Ÿ\n(Xingru pushes right, Langxuan pushes left. Xingru is stronger. Cart moves?)",
                options: ["ä¿æŒéœæ­¢ (Rest)", "å‹»é€Ÿé‹å‹• (Uniform)", "éå‹»é€Ÿ (å‘å³åŠ é€Ÿ) (Accelerate Right)", "éå‹»é€Ÿ (å‘å·¦åŠ é€Ÿ) (Accelerate Left)"],
                correctAnswer: "éå‹»é€Ÿ (å‘å³åŠ é€Ÿ) (Accelerate Right)",
                explanation: "åˆåŠ›å‘å³ï¼ˆä¸ç‚º 0ï¼‰ï¼Œç‰©é«”å‘åˆåŠ›æ–¹å‘åŠ é€Ÿã€‚\n(Net force is to the right, causing acceleration to the right.)",
                keywords: ["cart", "force"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘æ‹”æ²³æ¯”è³½ç”²éšŠåŠ›å¤§æ–¼ä¹™éšŠã€‚ç¹©å­ä¸­å¿ƒæœƒï¼Ÿ\n(Tug of war: Team A stronger than Team B. Rope center?)",
                    options: ["éœæ­¢ (Rest)", "å‘ç”²éšŠåŠ é€Ÿ (Accelerate to A)", "å‘ä¹™éšŠåŠ é€Ÿ (Accelerate to B)", "å‹»é€Ÿ (Uniform)"],
                    correctAnswer: "å‘ç”²éšŠåŠ é€Ÿ (Accelerate to A)",
                    explanation: "åˆåŠ›æŒ‡å‘åŠ›å¤§çš„ä¸€æ–¹ã€‚\n(Net force points to stronger side.)"
                }
            },
            {
                id: 9,
                question: "è˜‹æœåœ¨æ¡Œä¸Šã€‚å­¤ç«‹ç‰©é«”åœ–ä¸­ï¼Œå‘ä¸Šç®­é ­(A)å’Œå‘ä¸‹ç®­é ­(B)ä»£è¡¨ï¼Ÿ\n(Apple on table. Free-body diagram: Up arrow (A) & Down arrow (B) represent?)",
                options: ["Aé‡åŠ› Bæ”¯æ’åŠ› (A:Gravity B:Support)", "Aæ”¯æ’åŠ› Bé‡åŠ› (A:Support B:Gravity)", "Aæ‘©æ“¦åŠ› Bé‡åŠ› (A:Friction B:Gravity)", "Aæ”¯æ’åŠ› Bæ‘©æ“¦åŠ› (A:Support B:Friction)"],
                correctAnswer: "Aæ”¯æ’åŠ› Bé‡åŠ› (A:Support B:Gravity)",
                explanation: "Bæ˜¯åœ°å¿ƒå¼•åŠ›ï¼ˆé‡åŠ›ï¼‰ï¼ŒAæ˜¯æ¡Œå­çš„æ”¯æ’åŠ›ã€‚\n(B is Gravity downwards, A is Support force upwards.)",
                keywords: ["apple", "arrow"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘äººç«™åœ°é¢ï¼Œå“ªçµ„æ˜¯ä½œç”¨åŠ›èˆ‡åä½œç”¨åŠ›ï¼Ÿ\n(Person on ground. Action-Reaction pair?)",
                    options: ["é‡åŠ›èˆ‡æ”¯æ’åŠ› (Gravity & Support)", "è…³è¸©åœ°èˆ‡åœ°æ¨è…³ (Foot on ground & Ground on foot)", "é‡åŠ›èˆ‡äººå¸åœ°çƒ (Gravity & Person pulls Earth)", "ä»¥ä¸Šçš†é (None)"],
                    correctAnswer: "äººçš„é‡åŠ›èˆ‡äººå°åœ°çƒçš„å¼•åŠ› (Gravity & Person pulls Earth)",
                    explanation: "é€™æ˜¯è§€å¿µå»¶ä¼¸é¡Œã€‚\n(Conceptual extension.)"
                }
            },
            {
                id: 10,
                question: "ç¹ªç•«å­¤ç«‹ç‰©é«”åœ–æ™‚ï¼Œç®­é ­é•·åº¦ä»£è¡¨ï¼Ÿ\n(In Free-body diagram, arrow length represents?)",
                options: ["é€Ÿåº¦ (Speed)", "åŠ›çš„å¤§å° (Magnitude)", "é‡é‡ (Weight)", "ç¨®é¡ (Type)"],
                correctAnswer: "åŠ›çš„å¤§å° (Magnitude)",
                explanation: "ç®­é ­æ–¹å‘ä»£è¡¨åŠ›çš„æ–¹å‘ï¼Œé•·åº¦ä»£è¡¨åŠ›çš„å¤§å°ã€‚\n(Direction shows force direction, length shows magnitude.)",
                keywords: ["arrow", "force"],
                similar: {
                    question: "ã€åŸºç¤é¡ä¼¼é¡Œã€‘åŠ›åœ–ä¸­ï¼Œç®­é ­Aæ¯”ç®­é ­Bé•·å…©å€ï¼Œä»£è¡¨ï¼Ÿ\n(Arrow A is twice as long as Arrow B. Meaning?)",
                    options: ["ä½œç”¨æ™‚é–“é•· (Longer time)", "åŠ›Aæ˜¯åŠ›Bå…©å€å¤§ (Force A is 2x Force B)", "é€Ÿåº¦å¿« (Faster)", "è¼ƒé‡ (Heavier)"],
                    correctAnswer: "åŠ›Aæ˜¯åŠ›Bå…©å€å¤§ (Force A is 2x Force B)",
                    explanation: "é•·åº¦èˆ‡åŠ›çš„å¤§å°æˆæ­£æ¯”ã€‚\n(Length proportional to magnitude.)"
                }
            }
        ];

        // æ´—ç‰Œå‡½æ•¸
        function shuffle(array) {
            let currentIndex = array.length,  randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function SmartImage({ question }) {
            let StaticIcon = Icons.Atom;
            const text = (question.question + " " + (question.keywords?.join(" ") || "")).toLowerCase();
            
            if (text.includes("è»Š") || text.includes("car") || text.includes("cart")) StaticIcon = Icons.Car;
            else if (text.includes("çƒ") || text.includes("ball") || text.includes("soccer")) StaticIcon = Icons.Ball;
            else if (text.includes("ç®±") || text.includes("box")) StaticIcon = Icons.Box;
            else if (text.includes("æœ") || text.includes("apple")) StaticIcon = Icons.Apple;
            else if (text.includes("æºœå†°") || text.includes("skater")) StaticIcon = Icons.Skater;
            else if (text.includes("åœ–") || text.includes("diagram") || text.includes("arrow")) StaticIcon = Icons.Arrow;
            else if (text.includes("åŠ›") || text.includes("force")) StaticIcon = Icons.Force;

            return (
                <div className="w-full flex justify-center mb-6">
                    <div className="p-6 bg-blue-50 rounded-full ring-4 ring-blue-100 shadow-sm">
                        <StaticIcon />
                    </div>
                </div>
            );
        }

        async function callDeepSeek(systemPrompt, userPrompt, { AI_PROXY_URL, AI_AUTH_KEY }) {
            if (!AI_PROXY_URL) throw new Error("è«‹å…ˆè¨­å®š API URL");
            const headers = { 'Content-Type': 'application/json' };
            if (AI_AUTH_KEY) { headers['Authorization'] = `Bearer ${AI_AUTH_KEY}`; }
            const payload = { model: "deepseek-chat", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }], stream: false };
            const doFetch = async (url) => {
                const response = await fetch(url, { method: 'POST', headers: headers, body: JSON.stringify(payload) });
                if (!response.ok) { const errText = await response.text().catch(() => "No error text"); throw new Error(`API Error ${response.status}: ${errText}`); }
                return await response.json();
            };
            try {
                console.log("Attempting direct connection...");
                const data = await doFetch(AI_PROXY_URL);
                return data.choices?.[0]?.message?.content || "";
            } catch (e1) {
                console.warn("Direct connection failed, trying Proxy 1...", e1);
                try {
                    const proxyUrl1 = "https://corsproxy.io/?" + encodeURIComponent(AI_PROXY_URL);
                    const data = await doFetch(proxyUrl1);
                    return data.choices?.[0]?.message?.content || "";
                } catch (e2) {
                    console.warn("Proxy 1 failed, trying Proxy 2...", e2);
                    try {
                        const proxyUrl2 = "https://thingproxy.freeboard.io/fetch/" + AI_PROXY_URL;
                        const data = await doFetch(proxyUrl2);
                        return data.choices?.[0]?.message?.content || "";
                    } catch (e3) {
                        if (e1.message.includes("Failed to fetch") || e1.name === 'TypeError') { throw new Error("CORS_BLOCK"); }
                        throw e3;
                    }
                }
            }
        }

        function ClassCoinWidget({ className, totalScore }) {
            const coins = Math.floor(totalScore / POINTS_PER_COIN);
            const progress = (totalScore % POINTS_PER_COIN) / POINTS_PER_COIN * 100;
            
            return (
                <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 shadow-sm relative overflow-hidden">
                    <div className="flex justify-between items-center mb-2">
                        <div className="flex items-center gap-2">
                            <span className="font-bold text-amber-800 text-lg">{className || "å…¨ç­ All Classes"} é‡‘åº«</span>
                            <span className="text-xs text-amber-600 bg-amber-100 px-2 py-0.5 rounded-full">æ¯ {POINTS_PER_COIN} åˆ† +1 / per {POINTS_PER_COIN} pts +1</span>
                        </div>
                        <div className="flex items-center gap-1">
                            <div className="text-2xl font-black text-amber-500 drop-shadow-sm flex items-center gap-1">
                                <span className={coins > 0 ? "animate-coin-bounce inline-block" : ""}>ğŸ’°</span> x {coins}
                            </div>
                        </div>
                    </div>
                    
                    <div className="relative pt-1">
                        <div className="flex mb-1 items-center justify-between">
                            <div className="text-xs font-semibold text-amber-600">
                                ä¸‹ä¸€æšé‡‘å¹£é€²åº¦ / Next Coin: {Math.round(progress)}%
                            </div>
                            <div className="text-xs font-bold text-amber-600">
                                {totalScore % POINTS_PER_COIN} / {POINTS_PER_COIN}
                            </div>
                        </div>
                        <div className="overflow-hidden h-3 mb-1 text-xs flex rounded-full bg-amber-200">
                            <div style={{ width: `${progress}%` }} className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-amber-500 progress-bar-striped animate-pulse"></div>
                        </div>
                    </div>
                </div>
            );
        }

        function DeleteModal({ isOpen, onClose, onConfirm }) {
            const [password, setPassword] = useState("");

            if (!isOpen) return null;

            const handleConfirm = () => {
                if (password === "96084601") {
                    onConfirm();
                    setPassword(""); 
                } else {
                    alert("å¯†ç¢¼éŒ¯èª¤ / Incorrect Password");
                }
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl animate-float-up">
                        <h3 className="text-xl font-bold text-red-600 mb-2 flex items-center gap-2">
                            <Icons.Trash size={24} /> è­¦å‘Š Warning
                        </h3>
                        <p className="text-slate-600 mb-4 text-sm">
                            ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚<br/>
                            Are you sure to delete ALL data? Irreversible.
                        </p>
                        <input 
                            type="password" 
                            placeholder="è¼¸å…¥å¯†ç¢¼ Enter Password" 
                            className="w-full border rounded-lg p-3 mb-4 font-mono"
                            value={password}
                            onChange={e => setPassword(e.target.value)}
                        />
                        <div className="flex gap-2">
                            <button onClick={onClose} className="flex-1 py-3 rounded-lg border font-bold hover:bg-slate-50">
                                å–æ¶ˆ Cancel
                            </button>
                            <button onClick={handleConfirm} className="flex-1 py-3 rounded-lg bg-red-600 text-white font-bold hover:bg-red-700">
                                ç¢ºèªåˆªé™¤ Delete
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [studentName, setStudentName] = useState("");
            const [studentClass, setStudentClass] = useState("S2A"); 
            const [appState, setAppState] = useState('login'); 
            const [score, setScore] = useState(0);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [isAnswerChecked, setIsAnswerChecked] = useState(false);
            const [leaderboard, setLeaderboard] = useState([]);
            const [loading, setLoading] = useState(true);
            const [errorMsg, setErrorMsg] = useState("");
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            
            const [teacherClassFilter, setTeacherClassFilter] = useState("ALL"); 
            const [isDeleting, setIsDeleting] = useState(false);
            const [showTeacherSuggestions, setShowTeacherSuggestions] = useState(false); 
            const [passThreshold, setPassThreshold] = useState(60); 
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);

            const [practiceMode, setPracticeMode] = useState(false); 
            const [challengeMode, setChallengeMode] = useState(false); 
            const [quizQuestions, setQuizQuestions] = useState([]);
            const [currentQuestionData, setCurrentQuestionData] = useState(QUESTIONS_DATA[0]);
            const [showHint, setShowHint] = useState(false); 
            const [isGenerating, setIsGenerating] = useState(false); 
            const [isAnalyzing, setIsAnalyzing] = useState(false); 
            const [aiAnalysisResult, setAiAnalysisResult] = useState(""); 
            const [teacherAnalysis, setTeacherAnalysis] = useState({ main: "", suggestions: "" });
            const wrongAnswers = useRef([]); 
            const [leaderboardTab, setLeaderboardTab] = useState("student"); 

            const { auth, db, signInAnonymously, onAuthStateChanged, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit, deleteDoc, doc, getDocs, AI_PROXY_URL, AI_AUTH_KEY, initError } = window.dbServices;

            useEffect(() => {
                window.addEventListener('online', () => setIsOnline(true));
                window.addEventListener('offline', () => setIsOnline(false));
                return () => {
                    window.removeEventListener('online', () => setIsOnline(true));
                    window.removeEventListener('offline', () => setIsOnline(false));
                };
            }, []);

            useEffect(() => {
                if (initError) { setLoading(false); return; }
                if (auth) {
                    signInAnonymously(auth).catch(e => {
                        console.warn("Auth failed, network issue?", e);
                        if(e.code === 'auth/configuration-not-found' || e.code === 'auth/admin-restricted-operation') {
                            setErrorMsg("âš ï¸ è«‹è‡³ Firebase Console é–‹å•Ÿã€ŒåŒ¿åç™»å…¥ã€æ¬Šé™");
                        }
                        setLoading(false);
                    });
                    return onAuthStateChanged(auth, u => {
                        setUser(u);
                        setLoading(false);
                    });
                } else {
                    setLoading(false);
                }
            }, []);

            useEffect(() => {
                if (!user && !db) return; 
                if (!db) return;

                const q = query(collection(db, 'class_scores')); 
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    records.sort((a, b) => b.score - a.score);
                    setLeaderboard(records);
                }, (error) => {
                     console.warn("Firestore snapshot error (likely offline):", error);
                });
                return () => unsubscribe();
            }, [user]);

            const currentClassTotalScore = useMemo(() => {
                if (!studentClass) return 0;
                return leaderboard
                    .filter(r => r.classId === studentClass)
                    .reduce((acc, curr) => acc + (curr.score || 0), 0);
            }, [leaderboard, studentClass]);

            const startQuiz = () => {
                if (!studentName) return alert("è«‹è¼¸å…¥å§“å / Please enter name");
                setScore(0);
                setCurrentQuestionIndex(0);
                setPracticeMode(false);
                setChallengeMode(false);
                
                let randomizedQuestions = JSON.parse(JSON.stringify(QUESTIONS_DATA));
                randomizedQuestions = shuffle(randomizedQuestions);
                randomizedQuestions.forEach(q => {
                    q.options = shuffle(q.options);
                });

                setQuizQuestions(randomizedQuestions);
                setCurrentQuestionData(randomizedQuestions[0]);
                
                wrongAnswers.current = []; 
                setAiAnalysisResult("");
                setAppState('quiz');
                setIsAnswerChecked(false);
                setSelectedOption(null);
                setShowHint(false);
            };

            const handleAnswer = (option) => {
                if(isAnswerChecked) return;
                setSelectedOption(option);
            }

            const check = () => {
                setIsAnswerChecked(true);
                const isCorrect = selectedOption === currentQuestionData.correctAnswer;
                
                if (isCorrect) {
                    if (!practiceMode && !challengeMode) setScore(s => s + 10); 
                } else {
                    const isRecorded = wrongAnswers.current.find(w => w.id === currentQuestionData.id);
                    if (!isRecorded && !challengeMode && !practiceMode) {
                        wrongAnswers.current.push({
                            ...currentQuestionData,
                            studentAnswer: selectedOption
                        });
                    }
                }
            };

            const startPrebuiltPractice = () => {
                const similarQ = JSON.parse(JSON.stringify(currentQuestionData.similar));
                if (similarQ) {
                    similarQ.options = shuffle(similarQ.options);
                    setPracticeMode(true);
                    setSelectedOption(null);
                    setIsAnswerChecked(false);
                    setShowHint(false);
                    setCurrentQuestionData({
                        ...similarQ,
                        id: `p-${currentQuestionData.id}`,
                        isPractice: true
                    });
                }
            };

            const generateAIPractice = async () => {
                if (!AI_PROXY_URL) { alert("è«‹å…ˆè¨­å®š AI URL / Please set AI URL"); return; }
                setIsGenerating(true);
                try {
                    const systemPrompt = `ä½ æ˜¯ä¸€ä½é›™èªç‰©ç†è€å¸« (Bilingual Physics Teacher)ã€‚è«‹æ ¹æ“šç”¨æˆ¶æä¾›çš„é¡Œç›®ï¼Œç”Ÿæˆä¸€é¡Œã€Œè§€å¿µç›¸ä¼¼ä½†æ›´åŠ æ·ºé¡¯æ˜“æ‡‚ (Easier/Simpler Level)ã€çš„å–®é¸é¡Œï¼Œé©åˆè£œæ•‘æ•™å­¸ã€‚
                    æ ¼å¼å¿…é ˆæ˜¯ç´” JSONï¼ŒåŒ…å«ï¼š
                    - question (å­—ä¸², å¿…é ˆä¸­è‹±å°ç…§)
                    - options (å­—ä¸²é™£åˆ—, ä¸å« A. B. C. D. ç·¨è™Ÿ, å¿…é ˆä¸­è‹±å°ç…§)
                    - correctAnswer (å­—ä¸², å°æ‡‰ options å…¶ä¸­çš„ä¸€é …å…§å®¹, å¿…é ˆä¸­è‹±å°ç…§)
                    - explanation (å­—ä¸², å¿…é ˆä¸­è‹±å°ç…§)
                    - hint (å­—ä¸², çµ¦å­¸ç”Ÿçš„è§£é¡Œæç¤ºï¼Œå¼•å°æ€è€ƒ, å¿…é ˆä¸­è‹±å°ç…§)
                    
                    åš´æ ¼éµå®ˆ JSON æ ¼å¼ï¼Œä¸è¦ Markdownã€‚`;
                    
                    const userPrompt = `åŸé¡Œç›®ï¼š${currentQuestionData.question}ã€‚æ­£ç¢ºç­”æ¡ˆï¼š${currentQuestionData.correctAnswer}ã€‚è«‹ç”Ÿæˆä¸€é¡Œæ›´æ·ºçš„ç·´ç¿’é¡Œï¼Œé™„å¸¶æç¤ºï¼Œä¸¦æä¾›ä¸­è‹±å°ç…§ã€‚`;
                    
                    const result = await callDeepSeek(systemPrompt, userPrompt, { AI_PROXY_URL, AI_AUTH_KEY });
                    const cleanJson = result.replace(/```json/g, '').replace(/```/g, '').trim();
                    const newQ = JSON.parse(cleanJson);

                    if(newQ.options) {
                        newQ.options = shuffle(newQ.options);
                    }

                    setPracticeMode(true);
                    setSelectedOption(null);
                    setIsAnswerChecked(false);
                    setShowHint(false);
                    setCurrentQuestionData({
                        ...newQ,
                        id: `ai-${Date.now()}`,
                        isPractice: true,
                        isAI: true
                    });

                } catch (e) {
                    console.error(e);
                    if (e.message === "CORS_BLOCK") {
                        alert("âš ï¸ AI é€£ç·šå—é™ (CORS)ï¼Œåˆ‡æ›è‡³é è¨­ç·´ç¿’ã€‚/ AI Connection Restricted (CORS), switching to default practice.");
                        startPrebuiltPractice();
                    } else {
                        alert("AI ç”Ÿæˆå¤±æ•—ï¼Œåˆ‡æ›è‡³é è¨­ç·´ç¿’ã€‚/ AI Generation Failed, switching to default practice.");
                        startPrebuiltPractice();
                    }
                }
                setIsGenerating(false);
            };

            const startChallenge = async () => {
                setIsGenerating(true);
                try {
                    const systemPrompt = `ä½ æ˜¯ä¸€ä½åš´æ ¼çš„é›™èªç‰©ç†æ•™ç·´ (Strict Bilingual Physics Coach)ã€‚è«‹ç”Ÿæˆ 2 é¡Œé—œæ–¼ã€Œå¹³è¡¡åŠ›èˆ‡ç‰›é “å®šå¾‹ã€çš„é«˜é›£åº¦ã€æŒ‘æˆ°æ€§å–®é¸é¡Œï¼Œé©åˆç¨‹åº¦å¥½çš„åœ‹ä¸­ç”Ÿã€‚
                    æ ¼å¼å¿…é ˆæ˜¯ç´” JSON Arrayï¼Œæ¯å€‹ç‰©ä»¶åŒ…å« question (ä¸­è‹±å°ç…§), options (Array, ä¸å« A. B. ç·¨è™Ÿ, ä¸­è‹±å°ç…§), correctAnswer (ä¸­è‹±å°ç…§), explanation (ä¸­è‹±å°ç…§)ã€‚`;
                    
                    const result = await callDeepSeek(systemPrompt, "è«‹çµ¦æˆ‘ 2 é¡ŒæŒ‘æˆ°é¡Œï¼Œä¸­è‹±å°ç…§ã€‚", { AI_PROXY_URL, AI_AUTH_KEY });
                    const cleanJson = result.replace(/```json/g, '').replace(/```/g, '').trim();
                    const challengeQs = JSON.parse(cleanJson);

                    if (Array.isArray(challengeQs) && challengeQs.length > 0) {
                        challengeQs.forEach(q => {
                            if(q.options) q.options = shuffle(q.options);
                        });

                        setChallengeMode(true);
                        setPracticeMode(false); 
                        setCurrentQuestionIndex(0);
                        setShowHint(false);
                        setCurrentQuestionData({ ...challengeQs[0], isChallenge: true, totalChallenge: challengeQs.length, challengeList: challengeQs });
                        setSelectedOption(null);
                        setIsAnswerChecked(false);
                    }
                } catch (e) {
                    console.error(e);
                    if (e.message === "CORS_BLOCK") {
                        alert("âš ï¸ ç„¡æ³•é–‹å•ŸæŒ‘æˆ°æ¨¡å¼ (CORS é™åˆ¶)ã€‚/ Cannot start challenge mode (CORS restricted).");
                    } else {
                        alert("æŒ‘æˆ°é¡Œç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚/ Challenge generation failed, please try again later.");
                    }
                }
                setIsGenerating(false);
            };

            const analyzeWeakness = async () => {
                if (wrongAnswers.current.length === 0) {
                    setAiAnalysisResult("æ­å–œï¼ä½ å…¨å°äº†ï¼Œæ²’æœ‰é¡¯è‘—çš„å¼±é»ã€‚ä¿æŒä¸‹å»ï¼\nCongratulations! You got everything right, no significant weaknesses. Keep it up!");
                    return;
                }

                setIsAnalyzing(true);
                try {
                    const wrongSummary = wrongAnswers.current.map(w => `é¡Œç›®ï¼š${w.question} (é—œéµå­—:${w.keywords})`).join("\n");
                    const systemPrompt = `ä½ æ˜¯ä¸€ä½é›™èªå­¸ç¿’åˆ†æå¸«ã€‚è«‹æ ¹æ“šå­¸ç”Ÿç­”éŒ¯çš„é¡Œç›®ï¼Œç”¨ç¹é«”ä¸­æ–‡å’Œè‹±æ–‡ç¸½çµä»–çš„å¼±é»ï¼ˆä¾‹å¦‚ï¼šåˆ†ä¸æ¸…å¹³è¡¡åŠ›èˆ‡ä½œç”¨åŠ›åä½œç”¨åŠ›ï¼‰ï¼Œä¸¦çµ¦å‡ºä¸€å¥å…·é«”çš„å­¸ç¿’å»ºè­°ã€‚å­—æ•¸ 200 å­—ä»¥å…§ã€‚`;
                    const result = await callDeepSeek(systemPrompt, wrongSummary, { AI_PROXY_URL, AI_AUTH_KEY });
                    setAiAnalysisResult(result);
                } catch (e) {
                    console.error(e);
                    if (e.message === "CORS_BLOCK") {
                        setAiAnalysisResult("âš ï¸ åˆ†æå¤±æ•—ï¼šç€è¦½å™¨é€£ç·šè¢«é˜»æ“‹ (CORS)ã€‚/ Analysis failed: Browser connection blocked (CORS).");
                    } else {
                        setAiAnalysisResult("åˆ†æé€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚/ Analysis connection failed, please try again later.");
                    }
                }
                setIsAnalyzing(false);
            };

            const analyzeClassWeakness = async () => {
                let targetStudents = leaderboard;
                if (teacherClassFilter !== "ALL") {
                    targetStudents = leaderboard.filter(s => s.classId === teacherClassFilter);
                } else {
                    targetStudents = leaderboard.filter(s => s.classId !== "TEST");
                }

                if (targetStudents.length === 0) {
                    setTeacherAnalysis({ main: `ç›®å‰ ${teacherClassFilter === "ALL" ? "å…¨æ ¡" : teacherClassFilter} æ²’æœ‰è¶³å¤ çš„æ•¸æ“šå¯ä¾›åˆ†æã€‚/ Currently no enough data for ${teacherClassFilter === "ALL" ? "all classes" : teacherClassFilter} to analyze.`, suggestions: "" });
                    return;
                }
                
                setIsAnalyzing(true);
                setShowTeacherSuggestions(false); 
                try {
                    let allWrongQs = [];
                    targetStudents.forEach(student => {
                        if (student.wrongAnswers && Array.isArray(student.wrongAnswers)) {
                            student.wrongAnswers.forEach(q => {
                                allWrongQs.push(`é¡Œç›®ID:${q.id} é—œéµå­—:${q.keywords}`);
                            });
                        }
                    });

                    if (allWrongQs.length === 0) {
                        setTeacherAnalysis({ main: "æ­å–œï¼é¸å®šç¯„åœå…§çš„å­¸ç”Ÿæ²’æœ‰éŒ¯é¡Œç´€éŒ„ã€‚/ Congratulations! No wrong answers recorded for the selected scope.", suggestions: "" });
                        setIsAnalyzing(false);
                        return;
                    }

                    const sampleData = allWrongQs.slice(0, 50).join("\n");
                    const scopeText = teacherClassFilter === "ALL" ? "å…¨ç´š S.2" : `${teacherClassFilter} ç­`;

                    const systemPrompt = `ä½ æ˜¯ä¸€ä½è³‡æ·±é›™èªç‰©ç†æ•™å¸«ã€‚é€™æ˜¯ ${scopeText} å­¸ç”Ÿçš„éŒ¯é¡Œç´€éŒ„æ‘˜è¦ã€‚è«‹é€²è¡Œå…©éƒ¨åˆ†åˆ†æï¼Œä¸¦ç”¨ "|||SEPARATOR|||" åˆ†éš”é€™å…©éƒ¨åˆ†ï¼Œå…§å®¹å¿…é ˆåŒ…å«ä¸­æ–‡å’Œè‹±æ–‡ã€‚
                    ç¬¬ä¸€éƒ¨åˆ†ï¼ˆç›´æ¥é¡¯ç¤ºçµ¦è€å¸«ï¼‰ï¼š
                    1. âŒ å­¸ç”Ÿå¸¸è¦‹éŒ¯èª¤ (Common Mistakes)ï¼šå…·é«”æŒ‡å‡ºå­¸ç”Ÿæœ€å¸¸éŒ¯çš„æ¦‚å¿µã€‚
                    2. âœ… è§€å¿µæŒ‡æ­£ç¯„ä¾‹ (Correction Example)ï¼šèˆ‰ä¸€å€‹å…·é«”çš„ç‰©ç†ä¾‹å­ä¾†èªªæ˜æ­£ç¢ºè§€å¿µï¼Œç³¾æ­£ä¸Šè¿°éŒ¯èª¤ã€‚
                    è«‹ä¿æŒç°¡æ½”ã€æ¢ç†åˆ†æ˜ï¼Œé©åˆå¿«é€Ÿé–±è®€ã€‚
                    |||SEPARATOR|||
                    ç¬¬äºŒéƒ¨åˆ†ï¼ˆæ•™å­¸åŠ å¼·å»ºè­° / Teaching Suggestionsï¼‰ï¼š
                    é‡å°ä¸Šè¿°éŒ¯èª¤ï¼Œçµ¦è€å¸«çš„å…·é«”æ•™å­¸æ´»å‹•æˆ–è§£èªªç­–ç•¥å»ºè­° (ä¸­è‹±å°ç…§)ã€‚`;
                    
                    const rawResult = await callDeepSeek(systemPrompt, sampleData, { AI_PROXY_URL, AI_AUTH_KEY });
                    
                    const parts = rawResult.split("|||SEPARATOR|||");
                    if (parts.length >= 2) {
                        setTeacherAnalysis({ main: parts[0].trim(), suggestions: parts[1].trim() });
                    } else {
                        setTeacherAnalysis({ main: rawResult, suggestions: "" });
                    }

                } catch (e) {
                    console.error(e);
                    if (e.message === "CORS_BLOCK") {
                        setTeacherAnalysis({ main: "âš ï¸ åˆ†æå¤±æ•—ï¼šAPI é€£ç·šè¢«ç€è¦½å™¨é˜»æ“‹ (CORS)ã€‚/ Analysis failed: API connection blocked by browser (CORS).", suggestions: "" });
                    } else {
                        setTeacherAnalysis({ main: "åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚/ Analysis failed, please try again later.", suggestions: "" });
                    }
                }
                setIsAnalyzing(false);
            }

            const handleDeleteConfirm = async () => {
                setIsDeleteModalOpen(false);
                setIsDeleting(true);
                try {
                    const querySnapshot = await getDocs(collection(db, "class_scores"));
                    const deletePromises = querySnapshot.docs.map((d) => deleteDoc(doc(db, "class_scores", d.id)));
                    await Promise.all(deletePromises);
                    alert("âœ… è³‡æ–™åº«å·²æ¸…ç©º / Database cleared.");
                    setLeaderboard([]); 
                } catch (e) {
                    console.error(e);
                    alert("åˆªé™¤å¤±æ•— / Delete failed: " + e.message);
                }
                setIsDeleting(false);
            };

            const next = () => {
                setShowHint(false);
                if (currentQuestionData.isChallenge) {
                    const nextIdx = currentQuestionIndex + 1;
                    if (nextIdx < currentQuestionData.challengeList.length) {
                        setCurrentQuestionIndex(nextIdx);
                        setCurrentQuestionData({ 
                            ...currentQuestionData.challengeList[nextIdx], 
                            isChallenge: true, 
                            totalChallenge: currentQuestionData.challengeList.length, 
                            challengeList: currentQuestionData.challengeList 
                        });
                        setIsAnswerChecked(false);
                        setSelectedOption(null);
                    } else {
                        setAppState('result');
                    }
                    return;
                }

                if (practiceMode) {
                    setPracticeMode(false);
                }
                
                let nextIdx = practiceMode ? currentQuestionIndex + 1 : currentQuestionIndex + 1;
                
                if (nextIdx < quizQuestions.length) {
                    setCurrentQuestionIndex(nextIdx);
                    setCurrentQuestionData(quizQuestions[nextIdx]);
                    setIsAnswerChecked(false);
                    setSelectedOption(null);
                } else {
                    finish();
                }
            };

            const finish = async () => {
                setAppState('result');
                if (user && db) {
                    try {
                        await addDoc(collection(db, 'class_scores'), {
                            studentName,
                            classId: studentClass, 
                            score,
                            timestamp: serverTimestamp(),
                            topic: 'å¹³è¡¡åŠ›æ¸¬é©—',
                            wrongAnswers: wrongAnswers.current 
                        });
                    } catch (e) {
                        console.error("ä¸Šå‚³åˆ†æ•¸å¤±æ•— (å¯èƒ½é›¢ç·š)", e);
                    }
                }
            };

            const getClassStats = () => {
                const classStats = {};
                CLASS_OPTIONS.forEach(c => { classStats[c] = { total: 0, count: 0 }; });
                
                leaderboard.forEach(r => {
                    if (r.classId && classStats[r.classId]) {
                        classStats[r.classId].total += r.score;
                        classStats[r.classId].count += 1;
                    }
                });

                return CLASS_OPTIONS.map(c => ({
                    classId: c,
                    total: classStats[c].total,
                    avg: classStats[c].count > 0 ? Math.round(classStats[c].total / classStats[c].count) : 0,
                    count: classStats[c].count,
                    coins: Math.floor(classStats[c].total / POINTS_PER_COIN),
                    progress: (classStats[c].total % POINTS_PER_COIN) / POINTS_PER_COIN * 100
                })).sort((a, b) => b.total - a.total);
            };

            if (loading) return <div className="flex h-screen items-center justify-center text-blue-600 font-bold">è¼‰å…¥ä¸­... / Loading...</div>;

            return (
                <div className="min-h-screen bg-slate-100 font-sans text-slate-800 flex justify-center p-4">
                    <div className="w-full max-w-2xl">
                        
                        <header className="mb-6 text-center mt-4">
                            <h1 className="text-2xl font-bold text-slate-900 flex items-center justify-center gap-2">
                                <span className="text-3xl">ğŸ›¡ï¸</span> S.2 ç­éš›ä¿è¡›æˆ° / Class Battle
                            </h1>
                            <p className="text-slate-500 text-sm">å–®å…ƒ 11.3 å¹³è¡¡åŠ›èˆ‡é‹å‹• / Unit 11.3 Balanced Forces and Motion</p>
                        </header>

                        {errorMsg && (
                            <div className="mb-4 p-4 bg-red-100 text-red-700 rounded-lg text-sm font-bold text-center">
                                {errorMsg}
                            </div>
                        )}

                        <div className="overflow-hidden rounded-2xl bg-white shadow-xl ring-1 ring-slate-900/5">
                            {appState === 'login' && (
                                <div className="p-8 space-y-6 relative">
                                    <div className="text-center">
                                        <div className="mx-auto mb-2 w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 shadow-inner">
                                            <Icons.Atom />
                                        </div>
                                        <h2 className="text-xl font-bold text-slate-800">æº–å‚™å¥½äº†å—ï¼Ÿ/ Ready?</h2>
                                        <p className="text-slate-500 text-sm">ç‚ºä½ çš„ç­ç´šè´å– HOYU COINSï¼/ Earn HOYU COINS for your class!</p>
                                    </div>
                                    
                                    <ClassCoinWidget className={studentClass} totalScore={currentClassTotalScore} />

                                    <div className="grid grid-cols-3 gap-2">
                                        <select 
                                            value={studentClass} 
                                            onChange={(e) => setStudentClass(e.target.value)}
                                            className="col-span-1 border-2 border-slate-200 rounded-xl p-3 bg-slate-50 text-center font-bold text-slate-700 focus:border-blue-500 focus:ring-blue-500"
                                        >
                                            {CLASS_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                        <input 
                                            type="text" 
                                            className="col-span-2 border-2 border-slate-200 rounded-xl p-3 focus:border-blue-500 focus:ring-blue-500" 
                                            placeholder="è¼¸å…¥ä½ çš„åå­— / Enter your name" 
                                            value={studentName} 
                                            onChange={e => setStudentName(e.target.value)}
                                        />
                                    </div>

                                    <button 
                                        onClick={startQuiz}
                                        className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-200 hover:bg-blue-700 transform transition active:scale-95"
                                    >
                                        ğŸš€ é–‹å§‹æŒ‘æˆ° / Start Challenge
                                    </button>
                                    <button onClick={() => setAppState('leaderboard')} className="w-full text-sm font-bold text-slate-500 hover:text-blue-600">
                                        ğŸ† æŸ¥çœ‹å„ç­æˆ°æ³ / View Leaderboard
                                    </button>

                                    <div className="pt-6 border-t mt-4">
                                        <button onClick={() => setAppState('teacher')} className="text-xs text-slate-300 hover:text-slate-500 flex items-center gap-1 mx-auto">
                                            <Icons.Teacher /> ğŸ‘¨â€ğŸ« æ•™å¸«å°ˆå€ / Teacher Zone
                                        </button>
                                    </div>
                                </div>
                            )}

                            {appState === 'teacher' && (
                                <div className="p-8">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl font-bold flex items-center gap-2"><Icons.Teacher /> æ•™å¸«å¾Œå° / Dashboard</h2>
                                        <button onClick={() => setAppState('login')} className="text-sm text-blue-600 font-bold">å›é¦–é  / Home</button>
                                    </div>

                                    <div className="space-y-6">
                                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                            <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2"><Icons.Chart /> ç­ç´šæˆ°æ³ç¸½è¦½ / Class Overview</h3>
                                            <div className="space-y-3">
                                                {getClassStats().map(c => (
                                                    <div key={c.classId} className="flex justify-between items-center bg-white p-2 rounded border border-slate-100">
                                                        <span className="font-bold text-slate-700 w-12">{c.classId}</span>
                                                        <div className="flex items-center gap-1 text-amber-500 font-bold">
                                                            <Icons.Coin /> {c.coins}
                                                        </div>
                                                        <span className="text-xs text-slate-400">ç¸½åˆ† {c.total}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                            <h3 className="font-bold text-blue-800 mb-2 flex items-center gap-2"><Icons.Bot /> AI æ•¸æ“šåˆ†æ / AI Analysis</h3>
                                            <div className="flex items-center gap-2 mb-3">
                                                <span className="text-sm text-slate-600">ç›®æ¨™ / Targetï¼š</span>
                                                <select 
                                                    value={teacherClassFilter} 
                                                    onChange={(e) => setTeacherClassFilter(e.target.value)}
                                                    className="border rounded px-2 py-1 bg-white font-bold text-sm"
                                                >
                                                    <option value="ALL">å…¨ç´š (All Classes)</option>
                                                    {CLASS_OPTIONS.map(c => <option key={c} value={c}>{c}</option>)}
                                                </select>
                                            </div>
                                            <button 
                                                onClick={analyzeClassWeakness} 
                                                disabled={isAnalyzing} 
                                                className="w-full bg-indigo-600 text-white py-2.5 rounded-lg font-bold hover:bg-indigo-700 shadow-md transition flex items-center justify-center gap-2 text-sm"
                                            >
                                                {isAnalyzing ? "AI åˆ†æä¸­... / Analyzing..." : `ç”Ÿæˆ ${teacherClassFilter === 'ALL' ? 'å…¨ç´š' : teacherClassFilter} å¼±é»å ±å‘Š / Generate Report`}
                                            </button>
                                        </div>

                                        {teacherAnalysis.main && (
                                            <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm animate-in fade-in slide-in-from-top-2">
                                                <h4 className="font-bold text-indigo-800 mb-3 pb-2 border-b">ğŸ“ è¨ºæ–·å ±å‘Š / Diagnostic Report</h4>
                                                <div className="prose prose-sm text-slate-700 whitespace-pre-wrap leading-relaxed mb-4">
                                                    {teacherAnalysis.main}
                                                </div>
                                                {teacherAnalysis.suggestions && (
                                                    <div className="mt-4 pt-4 border-t border-indigo-50">
                                                        <button 
                                                            onClick={() => setShowTeacherSuggestions(!showTeacherSuggestions)}
                                                            className="flex items-center gap-2 text-xs font-bold text-indigo-600 hover:text-indigo-800 transition"
                                                        >
                                                            <Icons.Bulb /> 
                                                            {showTeacherSuggestions ? "éš±è—å»ºè­° / Hide Suggestions" : "é¡¯ç¤ºæ•™å­¸å»ºè­° / Show Teaching Suggestions"}
                                                            {showTeacherSuggestions ? <Icons.ChevronUp /> : <Icons.ChevronDown />}
                                                        </button>
                                                        {showTeacherSuggestions && (
                                                            <div className="mt-2 p-3 bg-indigo-50 rounded-lg text-xs text-slate-700 whitespace-pre-wrap leading-relaxed">
                                                                {teacherAnalysis.suggestions}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm mt-6">
                                            <h3 className="font-bold text-slate-700 mb-4 flex items-center justify-between">
                                                <span className="flex items-center gap-2"><Icons.Users /> å­¸ç”Ÿæˆç¸¾åˆ—è¡¨ / Student List</span>
                                                
                                                <div className="flex items-center gap-2 text-sm font-normal">
                                                    <label className="text-slate-500">åˆæ ¼åˆ†æ•¸ / Pass Mark:</label>
                                                    <input 
                                                        type="number" 
                                                        value={passThreshold} 
                                                        onChange={(e) => setPassThreshold(Number(e.target.value))}
                                                        className="w-16 border rounded px-2 py-1 text-center font-bold text-slate-700"
                                                    />
                                                </div>
                                            </h3>

                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm text-left">
                                                    <thead className="bg-slate-50 text-slate-500 font-bold border-b">
                                                        <tr>
                                                            <th className="p-3">Class</th>
                                                            <th className="p-3">Name</th>
                                                            <th className="p-3 text-right">Score</th>
                                                            <th className="p-3 text-center">Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-100">
                                                        {leaderboard
                                                            .filter(s => teacherClassFilter === "ALL" || s.classId === teacherClassFilter)
                                                            .sort((a, b) => {
                                                                const classA = a.classId ? String(a.classId) : "";
                                                                const classB = b.classId ? String(b.classId) : "";
                                                                return classA.localeCompare(classB) || b.score - a.score;
                                                            })
                                                            .map((r) => {
                                                                const isFail = r.score < passThreshold;
                                                                return (
                                                                    <tr key={r.id} className={isFail ? "bg-red-50/50" : ""}>
                                                                        <td className="p-3"><span className="font-mono bg-slate-100 px-1.5 py-0.5 rounded text-slate-600 text-xs">{r.classId || "-"}</span></td>
                                                                        <td className="p-3 font-medium text-slate-700">{r.studentName}</td>
                                                                        <td className={`p-3 text-right font-bold ${isFail ? "text-red-600" : "text-blue-600"}`}>
                                                                            {r.score}
                                                                        </td>
                                                                        <td className="p-3 text-center">
                                                                            {isFail ? 
                                                                                <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-red-100 text-red-600 text-xs font-bold">
                                                                                    <Icons.X size={12}/> Fail
                                                                                </span> 
                                                                                : 
                                                                                <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-100 text-green-600 text-xs font-bold">
                                                                                    <Icons.Check size={12}/> Pass
                                                                                </span>
                                                                            }
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                    </tbody>
                                                </table>
                                                {leaderboard.filter(s => teacherClassFilter === "ALL" || s.classId === teacherClassFilter).length === 0 && (
                                                    <div className="p-4 text-center text-slate-400 text-xs">æš«ç„¡è³‡æ–™ / No Data</div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="border-t pt-6 mt-4">
                                            <button 
                                                onClick={() => setIsDeleteModalOpen(true)}
                                                disabled={isDeleting}
                                                className="w-full border-2 border-red-100 bg-red-50 text-red-600 py-3 rounded-xl text-sm font-bold hover:bg-red-100 hover:border-red-200 flex items-center justify-center gap-2 transition"
                                            >
                                                {isDeleting ? "æ¸…ç†ä¸­... / Cleaning..." : <><Icons.Trash /> âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™ (Clear All Data)</>}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {appState === 'quiz' && (
                                <div className="p-8">
                                    <div className="flex justify-between mb-6 text-sm font-bold items-center">
                                        <span className={practiceMode ? "text-purple-600 bg-purple-50 px-2 py-1 rounded" : challengeMode ? "text-orange-600 bg-orange-50 px-2 py-1 rounded" : "text-slate-500"}>
                                            {practiceMode ? "âœ¨ è£œæ•‘ç·´ç¿’ / Practice" : challengeMode ? `ğŸ”¥ æŒ‘æˆ° / Challenge ${currentQuestionIndex + 1}` : `Q ${currentQuestionIndex + 1} / ${QUESTIONS_DATA.length}`}
                                        </span>
                                        {!challengeMode && <span className="text-blue-600 bg-blue-50 px-3 py-1 rounded-full border border-blue-100">Score: {score}</span>}
                                    </div>

                                    {!challengeMode && <SmartImage question={currentQuestionData} />}

                                    <h2 className="text-xl font-bold mb-6 leading-relaxed text-slate-800 whitespace-pre-line">
                                        {currentQuestionData.question}
                                    </h2>

                                    <div className="space-y-3">
                                        {currentQuestionData.options.map((opt, index) => {
                                            let bg = "bg-white hover:bg-slate-50 border-2 border-slate-100";
                                            
                                            if (isAnswerChecked) {
                                                if (opt === currentQuestionData.correctAnswer) {
                                                    bg = "bg-green-50 border-green-500 text-green-800";
                                                } else if (opt === selectedOption) {
                                                    bg = "bg-red-50 border-red-300 text-red-800";
                                                } else {
                                                    bg = "opacity-50 border-slate-100";
                                                }
                                            } else if (selectedOption === opt) {
                                                bg = "bg-blue-50 border-blue-500 text-blue-800";
                                            }
                                            return (
                                                <button 
                                                    key={index} 
                                                    onClick={() => handleAnswer(opt)} 
                                                    disabled={isAnswerChecked} 
                                                    className={`w-full text-left p-4 rounded-xl transition-all font-medium ${bg}`}
                                                >
                                                    <div className="flex justify-between items-center">
                                                        <span><span className="font-bold text-slate-400 mr-2">{String.fromCharCode(65 + index)}.</span> {opt}</span>
                                                        {isAnswerChecked && opt === currentQuestionData.correctAnswer && <Icons.Check />}
                                                        {isAnswerChecked && opt === selectedOption && opt !== currentQuestionData.correctAnswer && <Icons.X />}
                                                    </div>
                                                </button>
                                            )
                                        })}
                                    </div>

                                    <div className="mt-8">
                                        {!isAnswerChecked ? (
                                            <>
                                                {currentQuestionData.hint && (
                                                    <div className="mb-4">
                                                        <button 
                                                            onClick={() => setShowHint(!showHint)}
                                                            className="text-amber-600 text-sm font-bold hover:text-amber-700 flex items-center gap-1 transition"
                                                        >
                                                            <Icons.Bulb /> {showHint ? "éš±è—æç¤º / Hide Hint" : "å¡é—œäº†å—ï¼Ÿé»æˆ‘é¡¯ç¤ºæç¤º / Need a hint?"}
                                                        </button>
                                                        {showHint && (
                                                            <div className="mt-2 p-3 bg-amber-50 border border-amber-200 rounded-xl text-sm text-amber-800 animate-in fade-in slide-in-from-top-1 whitespace-pre-line">
                                                                ğŸ’¡ æç¤º / Hintï¼š{currentQuestionData.hint}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                                <button 
                                                    onClick={check} 
                                                    disabled={!selectedOption} 
                                                    className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold disabled:opacity-50 hover:bg-slate-800 transition shadow-lg"
                                                >
                                                    é€å‡ºç­”æ¡ˆ / Submit
                                                </button>
                                            </>
                                        ) : (
                                            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                                                <div className={`p-5 rounded-xl mb-4 border ${selectedOption === currentQuestionData.correctAnswer ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                                    <h3 className={`font-bold mb-2 flex items-center gap-2 ${selectedOption === currentQuestionData.correctAnswer ? 'text-green-800' : 'text-red-800'}`}>
                                                        {selectedOption === currentQuestionData.correctAnswer ? 'ğŸ‰ ç­”å°äº†ï¼ / Correct!' : 'ğŸ’ª åŠ æ²¹ï¼ / Incorrect'}
                                                    </h3>
                                                    <p className="text-sm text-slate-700 leading-relaxed whitespace-pre-line">
                                                        <span className="font-bold">è§£æ / Explanationï¼š</span>{currentQuestionData.explanation}
                                                    </p>
                                                </div>

                                                {selectedOption !== currentQuestionData.correctAnswer && !practiceMode && !challengeMode ? (
                                                    <div className="flex flex-col gap-2 sm:flex-row">
                                                        {currentQuestionData.similar && (
                                                            <button onClick={startPrebuiltPractice} className="flex-1 bg-purple-100 text-purple-700 py-3 rounded-xl font-bold hover:bg-purple-200 border border-purple-200 transition">
                                                                ğŸ“ åŸºç¤ç·´ç¿’ / Basic Practice
                                                            </button>
                                                        )}
                                                        
                                                        <button onClick={generateAIPractice} disabled={isGenerating} className="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-bold hover:opacity-90 shadow-lg shadow-purple-200 transition flex items-center justify-center gap-2">
                                                            {isGenerating ? <span className="animate-spin">ğŸ§ </span> : <Icons.Bot />} 
                                                            {isGenerating ? "AI æ€è€ƒä¸­... / Thinking..." : "AI ç”Ÿæˆæ·ºç™½ç·´ç¿’ / AI Practice"}
                                                        </button>

                                                        <button onClick={next} className="px-6 py-3 border-2 border-slate-200 rounded-xl font-bold text-slate-500 hover:bg-slate-50 hover:text-slate-700">
                                                            è·³é / Skip &rarr;
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <button onClick={next} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition transform active:scale-95">
                                                        {currentQuestionIndex < quizQuestions.length - 1 || practiceMode || (challengeMode && currentQuestionIndex < currentQuestionData.totalChallenge - 1) ? 'ä¸‹ä¸€é¡Œ / Next &rarr;' : 'æŸ¥çœ‹æˆç¸¾ / View Results ğŸ†'}
                                                    </button>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {appState === 'result' && (
                                <div className="p-8 text-center">
                                    <div className="mx-auto w-24 h-24 bg-yellow-50 rounded-full flex items-center justify-center text-yellow-500 mb-4 animate-float-up">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                                    </div>
                                    
                                    <h2 className="text-3xl font-black text-slate-900 mb-1">æ¸¬é©—çµæŸï¼/ Finished!</h2>
                                    <p className="text-slate-500 mb-6">
                                        <span className="font-bold bg-slate-100 px-2 py-1 rounded">{studentClass}</span> {studentName}
                                    </p>

                                    <div className="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-6 text-white shadow-lg mb-6 transform hover:scale-105 transition duration-300">
                                        <div className="text-sm opacity-80 mb-1">å€‹äººå¾—åˆ† / Score</div>
                                        <div className="text-6xl font-black mb-2">{score}</div>
                                        <div className="border-t border-white/20 pt-2 mt-2 flex items-center justify-center gap-2 text-sm font-bold shine-text">
                                            <Icons.Coin /> å·²ç‚ºç­ç´šè²¢ç» {score} ç©åˆ†ï¼/ Contributed {score} pts!
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-3">
                                        {score >= 80 && !challengeMode && (
                                            <button onClick={startChallenge} disabled={isGenerating} className="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-4 rounded-xl font-bold shadow-lg hover:from-orange-600 hover:to-red-600 animate-pulse flex items-center justify-center gap-2">
                                                {isGenerating ? "æº–å‚™é¡Œç›®ä¸­... / Preparing..." : <><Icons.Flame /> æŒ‘æˆ°é«˜é›£åº¦é¡Œç›® (+åŠ åˆ†) / Challenge Mode</>}
                                            </button>
                                        )}

                                        {!aiAnalysisResult ? (
                                            <button onClick={analyzeWeakness} disabled={isAnalyzing} className="w-full bg-white border-2 border-blue-100 text-blue-600 py-3 rounded-xl font-bold hover:bg-blue-50 flex items-center justify-center gap-2">
                                                {isAnalyzing ? "ğŸ¤– AI åˆ†æä¸­... / Analyzing..." : "ğŸ¤– AI éŒ¯é¡Œè¨ºæ–· / AI Diagnosis"}
                                            </button>
                                        ) : (
                                            <div className="bg-blue-50 p-4 rounded-xl text-left border border-blue-100">
                                                <h4 className="font-bold text-blue-800 mb-1 flex items-center gap-2"><Icons.Bot /> è¨ºæ–·å ±å‘Š / Reportï¼š</h4>
                                                <p className="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap">{aiAnalysisResult}</p>
                                            </div>
                                        )}

                                        <button onClick={() => setAppState('leaderboard')} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900">æŸ¥çœ‹å…¨æ ¡æˆ°æ³ / View Leaderboard</button>
                                        <button onClick={() => setAppState('login')} className="w-full border border-slate-300 py-3 rounded-xl font-bold hover:bg-slate-50 text-slate-600">å›é¦–é  / Home</button>
                                    </div>
                                </div>
                            )}

                            {appState === 'leaderboard' && (
                                <div className="flex flex-col h-[500px]">
                                    <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                                        <h3 className="font-bold flex gap-2 text-slate-800 items-center text-lg">ğŸ† æ¦®è­½æ¦œ / Leaderboard</h3>
                                        <button onClick={() => setAppState('login')} className="text-sm text-blue-600 font-bold hover:underline">é—œé–‰ / Close</button>
                                    </div>
                                    
                                    <div className="flex p-2 bg-slate-50 gap-2">
                                        <button 
                                            onClick={() => setLeaderboardTab('student')}
                                            className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${leaderboardTab === 'student' ? 'bg-white text-blue-600 shadow-sm ring-1 ring-slate-200' : 'text-slate-400 hover:bg-slate-100'}`}
                                        >
                                            å€‹äººæ’å / Students
                                        </button>
                                        <button 
                                            onClick={() => setLeaderboardTab('class')}
                                            className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${leaderboardTab === 'class' ? 'bg-white text-amber-600 shadow-sm ring-1 ring-slate-200' : 'text-slate-400 hover:bg-slate-100'}`}
                                        >
                                            ç­éš›çˆ­éœ¸ / Classes
                                        </button>
                                    </div>

                                    <div className="flex-1 overflow-y-auto bg-white">
                                        {leaderboardTab === 'student' ? (
                                            <table className="w-full text-left text-sm">
                                                <thead className="bg-slate-50 text-slate-500 sticky top-0 z-10 shadow-sm">
                                                    <tr><th className="p-4">Rank</th><th className="p-4">Name</th><th className="p-4 text-right">Score</th></tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {leaderboard.map((r, i) => (
                                                        <tr key={r.id} className={i < 3 ? 'bg-yellow-50/30' : ''}>
                                                            <td className="p-4 font-bold text-slate-500">
                                                                {i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `#${i+1}`}
                                                            </td>
                                                            <td className="p-4 font-medium text-slate-900">
                                                                <span className="font-mono text-xs bg-slate-100 px-1.5 py-0.5 rounded mr-2 text-slate-500 border border-slate-200">{r.classId || '-'}</span>
                                                                {r.studentName}
                                                            </td>
                                                            <td className="p-4 text-right font-bold text-blue-600">{r.score}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        ) : (
                                            <div className="p-4 space-y-4">
                                                {getClassStats().map((c, i) => (
                                                    <div key={c.classId} className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm relative overflow-hidden">
                                                        {i === 0 && <div className="absolute top-0 right-0 bg-yellow-400 text-white text-xs font-bold px-2 py-1 rounded-bl-lg">ğŸ‘‘ Leader</div>}
                                                        
                                                        <div className="flex justify-between items-center mb-3">
                                                            <div>
                                                                <div className="text-lg font-black text-slate-800">{c.classId}</div>
                                                                <div className="text-xs text-slate-400">Students: {c.count} | Avg: {c.avg}</div>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className="text-2xl font-black text-amber-500 flex items-center justify-end gap-1 drop-shadow-sm">
                                                                    <Icons.Coin /> {c.coins}
                                                                </div>
                                                                <div className="text-xs text-amber-600 font-bold">HOYU COINS</div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="relative h-3 bg-slate-100 rounded-full overflow-hidden">
                                                            <div 
                                                                className="absolute top-0 left-0 h-full bg-amber-400 rounded-full transition-all duration-1000" 
                                                                style={{ width: `${c.progress}%` }}
                                                            ></div>
                                                        </div>
                                                        <div className="flex justify-between mt-1 text-xs text-slate-400">
                                                            <span>Next Coin: {Math.round(c.progress)}%</span>
                                                            <span>{Math.round(c.total % POINTS_PER_COIN)} / {POINTS_PER_COIN} pts</span>
                                                        </div>
                                                    </div>
                                                ))}
                                                
                                                <div className="text-center p-4 text-slate-400 text-xs">
                                                    {POINTS_PER_COIN} pts = 1 Coin<br/>
                                                    Keep fighting!
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="fixed bottom-2 right-2 z-50">
                            <div className={`px-3 py-1 rounded-full text-xs font-bold shadow-md flex items-center gap-1 ${isOnline ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                {isOnline ? <Icons.Wifi className="w-3 h-3" /> : <Icons.WifiOff className="w-3 h-3" />}
                                {isOnline ? 'Online' : 'Offline'}
                            </div>
                        </div>
                        <div className="text-center mt-6 text-xs text-slate-400">
                            S.2 Science | AI-Powered Learning
                        </div>
                        <DeleteModal 
                            isOpen={isDeleteModalOpen} 
                            onClose={() => setIsDeleteModalOpen(false)} 
                            onConfirm={handleDeleteConfirm}
                        />
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
